<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>드래곤 비벨/이벨 계산기</title>
<style>
  body { font-family: Consolas, "Noto Sans KR", sans-serif; margin: 24px; background:#f7f7f9; }
  h2 { margin-bottom: 8px; }
  .hint { color:#666; margin-bottom: 14px; }
  fieldset { background:#fff; border:1px solid #ccc; padding:12px; margin-bottom:14px; }
  legend { font-weight:bold; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .row label { margin-right:8px; }
  input[type="number"] { width:84px; text-align:center; }
  .acc-list { max-height:180px; overflow:auto; border:1px solid #ddd; padding:8px; background:#fcfcfc; }
  .btn { padding:8px 14px; cursor:pointer; border:1px solid #999; background:#fff; }
  .btn:hover { background:#f0f0f0; }
  .btn.primary { border-color:#2d6cdf; background:#2d6cdf; color:#fff; }
  .toolbar { display:flex; gap:8px; margin:8px 0; flex-wrap:wrap; }
  #result { white-space:pre; background:#111; color:#e5e5e5; padding:12px; border-radius:6px; min-height:220px; }
  .small { color:#888; font-size:12px; }
</style>
</head>
<body>
  <h2>드래곤 비벨/이벨 계산기</h2>
  <div class="hint small">모든 입력 값은 HP/ATK/DEF 순서를 따릅니다. · made by 헬릭스</div>

  <!-- 등급 / 타입 -->
  <fieldset>
    <legend>등급 / 타입 선택</legend>
    <div class="row">
      <label><input type="radio" name="level" value="7.0" checked>7.0</label>
      <label><input type="radio" name="level" value="8.0">8.0</label>
      <label><input type="radio" name="level" value="9.0">9.0</label>
    </div>
    <div class="row" style="margin-top:6px">
      <label><input type="checkbox" class="dtype" value="공격형" checked>공격형</label>
      <label><input type="checkbox" class="dtype" value="방어형" checked>방어형</label>
      <label><input type="checkbox" class="dtype" value="체력형" checked>체력형</label>
      <label><input type="checkbox" class="dtype" value="공방형" checked>공방형</label>
      <label><input type="checkbox" class="dtype" value="체공형" checked>체공형</label>
      <label><input type="checkbox" class="dtype" value="체방형" checked>체방형</label>
    </div>
  </fieldset>

  <!-- 젬 선택 -->
  <fieldset>
    <legend>젬 선택 (※ 복수 선택 불가)</legend>
    <div class="row">
      <strong>HP</strong>
      <label><input type="radio" name="gem_hp" value="160">160</label>
      <label><input type="radio" name="gem_hp" value="156" checked>156</label>
      <label><input type="radio" name="gem_hp" value="152">152</label>
      <label><input type="radio" name="gem_hp" value="148">148</label>
    </div>
    <div class="row">
      <strong>ATK</strong>
      <label><input type="radio" name="gem_atk" value="40">40</label>
      <label><input type="radio" name="gem_atk" value="39" checked>39</label>
      <label><input type="radio" name="gem_atk" value="38">38</label>
      <label><input type="radio" name="gem_atk" value="37">37</label>
    </div>
    <div class="row">
      <strong>DEF</strong>
      <label><input type="radio" name="gem_df" value="40">40</label>
      <label><input type="radio" name="gem_df" value="39" checked>39</label>
      <label><input type="radio" name="gem_df" value="38">38</label>
      <label><input type="radio" name="gem_df" value="37">37</label>
    </div>
  </fieldset>

  <!-- 장신구 -->
  <fieldset>
    <legend>장신구 선택 (복수 선택 가능)</legend>
    <div class="toolbar">
      <button class="btn" type="button" onclick="toggleLevel(19)">Lv19 전체 선택</button>
      <button class="btn" type="button" onclick="toggleLevel(18)">Lv18 전체 선택</button>
      <button class="btn" type="button" onclick="toggleLevel(17)">Lv17 전체 선택</button>
      <button class="btn" type="button" onclick="selectNone()">전체 해제</button>
    </div>
    <div id="accList" class="acc-list"></div>
  </fieldset>

<!-- 펜던트 -->
<fieldset>
  <legend>펜던트</legend>

  <div class="row" style="margin-bottom:8px;">
    <strong>버전 선택:</strong>
    <label><input type="radio" name="pendant_ver" value="v1" checked>Ver1 (자동 분배)</label>
    <label><input type="radio" name="pendant_ver" value="v2">Ver2 (지정 분배)</label>
  </div>

  <div class="row">
    <strong>종류 / 값 입력:</strong>
    <label><input type="radio" name="pendant_mode" value="별" checked>별</label>
    <label><input type="radio" name="pendant_mode" value="달">달</label>
    <label><input type="radio" name="pendant_mode" value="태양">태양</label>
    <input id="pendant_value" type="number" value="12" style="width:90px;"> %
    <span class="small" id="pendantHint">별 ≤ 6, 달 ≤ 12, 태양 ≤ 18</span>
  </div>

  <div class="row" id="pendant_stats_row" style="margin-top:8px;">
    <strong>Ver2 스탯 선택:</strong>
    <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
    <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
    <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
  </div>
</fieldset>

 <!-- 정령 / 버프 / 디버프 -->
<fieldset>
  <legend>정령 / 버프 / 디버프</legend>
  <div style="font-weight:bold; color:black; margin-bottom:6px;">(HP / ATK / DEF)</div>

  <div class="row-spirit">
    <strong>정령 + (플옵)</strong>
    <input id="sf_hp" type="number" value="0">
    <input id="sf_atk" type="number" value="0">
    <input id="sf_df" type="number" value="0">
  </div>

  <div class="row-spirit">
    <strong>정령 % (퍼옵)</strong>
    <input id="sp_hp" type="number" value="0">
    <input id="sp_atk" type="number" value="0">
    <input id="sp_df" type="number" value="0">
    <span class="small">(% 입력)</span>
  </div>

  <div class="row-spirit">
    <strong>정령 부가옵</strong>
    <input id="se_hp" type="number" value="0">
    <input id="se_atk" type="number" value="0">
    <input id="se_df" type="number" value="0">
  </div>

  <div class="row-spirit">
    <strong>버프 (%)</strong>
    <input id="bf_hp" type="number" value="0">
    <input id="bf_atk" type="number" value="0">
    <input id="bf_df" type="number" value="0">
  </div>

  <div class="row-spirit">
    <strong>디버프 (%)</strong>
    <input id="db_hp" type="number" value="0">
    <input id="db_atk" type="number" value="0">
    <input id="db_df" type="number" value="0">
  </div>
</fieldset>

  <!-- 기타 -->
  <fieldset><legend>기타</legend><div class="row">Top N <input id="top_n" type="number" value="5"></div></fieldset>

  <div class="toolbar">
    <button class="btn primary" type="button" onclick="calc()">계산하기</button>
    <button class="btn" type="button" onclick="downloadTxt()">저장하기 (.txt)</button>
  </div>

  <h3>결과</h3>
  <div id="result"></div>

<script>
  document.addEventListener("submit", e => e.preventDefault());
/* =========================
   장신구 테이블
   ========================= */
const ACC_TABLE = [
  ["바뿔(공/방)",19,0,10,9],["바뿔(체/방)",19,10,0,9],["바뿔(공/체)",19,9,10,0],
  ["불뿔(공/체)",19,6,13,0],["불뿔(공/방)",19,0,13,6],
  ["물뿔(체/방)",19,13,0,6],["물뿔(체/공)",19,13,6,0],
  ["대뿔(방/공)",19,0,6,13],["대뿔(방/체)",19,6,0,13],
  ["여보",19,0,0,19],["황보",19,0,19,0],["악보",19,19,0,0],
  ["바뿔(공/방)",18,0,9,9],["바뿔(체/방)",18,9,0,9],["바뿔(공/체)",18,9,9,0],
  ["불뿔(공/체)",18,6,12,0],["불뿔(공/방)",18,0,12,6],
  ["물뿔(체/방)",18,12,0,6],["물뿔(체/공)",18,12,6,0],
  ["대뿔(방/공)",18,0,6,12],["대뿔(방/체)",18,6,0,12],
  ["여보",18,0,0,18],["황보",18,0,18,0],["악보",18,18,0,0],
  ["바뿔(공/방)",17,0,9,8],["바뿔(체/방)",17,9,0,8],["바뿔(공/체)",17,9,8,0],
  ["불뿔(공/체)",17,6,11,0],["불뿔(공/방)",17,0,11,6],
  ["물뿔(체/방)",17,11,0,6],["물뿔(체/공)",17,11,6,0],
  ["대뿔(방/공)",17,0,6,11],["대뿔(방/체)",17,6,0,11],
  ["여보",17,0,0,17],["황보",17,0,17,0],["악보",17,17,0,0],
];

/* =========================
   장신구 렌더링
   ========================= */
let accCheckboxes = [];
const accListEl = document.getElementById('accList');

function renderAccessories() {
  accListEl.innerHTML = '';
  accCheckboxes = [];
  ACC_TABLE.forEach((r, i) => {
    const [n, l, h, a, d] = r;
    const id = 'acc_' + i;
    const line = document.createElement('div');
    line.innerHTML = `<label><input type="checkbox" id="${id}"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%</label>`;
    accListEl.appendChild(line);
    accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d });
  });
}
renderAccessories();

function selectNone() {
  accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
}
function toggleLevel(level) {
  const t = accCheckboxes.filter(o => o.level === level);
  const allOn = t.every(o => document.getElementById(o.id).checked);
  t.forEach(o => document.getElementById(o.id).checked = !allOn);
}

/* =========================
   계산 로직
   ========================= */
class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}
function eVal(s){return s.hp+4*s.atk+4*s.df;}
function bVal(s){return s.hp*s.atk*s.df;}

function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
  const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
  const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
  const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                     Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                     Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
  const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
  const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
  const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
  const f = new Stats(
    s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
    s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
    s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
  );
  return [f, eVal(f), bVal(f)];
}

const dragon={
 "7.0":{공격형:new Stats(876,285,161),방어형:new Stats(788,185,283),체력형:new Stats(1252,176,176),공방형:new Stats(720,242,243),체공형:new Stats(1080,262,133),체방형:new Stats(1080,133,262)},
 "8.0":{공격형:new Stats(876,305,161),방어형:new Stats(788,185,303),체력형:new Stats(1332,176,176),공방형:new Stats(720,252,253),체공형:new Stats(1120,272,133),체방형:new Stats(1120,133,272)},
 "9.0":{공격형:new Stats(876,325,161),방어형:new Stats(788,185,323),체력형:new Stats(1412,176,176),공방형:new Stats(720,262,263),체공형:new Stats(1160,282,133),체방형:new Stats(1160,133,282)}
};

function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
  const c = [];
  const M = 6;
  if (total <= 0) return [[[0,0,0]]];

  const useHP = selectedStats.includes("HP");
  const useATK = selectedStats.includes("ATK");
  const useDEF = selectedStats.includes("DEF");

  // 선택된 스탯 인덱스만 사용
  const statIdx = [];
  if (useHP) statIdx.push(0);
  if (useATK) statIdx.push(1);
  if (useDEF) statIdx.push(2);

  if (mode === "별") {
    const v = Math.min(total, M);
    const combos = statIdx.map(i => {
      const a = [0,0,0];
      a[i] = v;
      return [a];
    });
    return combos;
  }

  if (mode === "달") {
    for (let x=1;x<=M;x++)
      for (let y=1;y<=M;y++)
        if (x+y===total)
          for (let i of statIdx)
            for (let j of statIdx) {
              const a=[0,0,0]; const b=[0,0,0];
              a[i]=x; b[j]=y;
              c.push([a,b]);
            }
    return c;
  }

  if (mode === "태양") {
    for (let x=1;x<=M;x++)
      for (let y=1;y<=M;y++)
        for (let z=1;z<=M;z++)
          if (x+y+z===total)
            for (let i of statIdx)
              for (let j of statIdx)
                for (let k of statIdx) {
                  const a=[0,0,0], b=[0,0,0], d=[0,0,0];
                  a[i]=x; b[j]=y; d[k]=z;
                  c.push([a,b,d]);
                }
    return c;
  }
  return [[[0,0,0]]];
}

function val(id){ return Number(document.getElementById(id).value||0); }

function calc(){
  const R=document.getElementById("result"); R.textContent="";
  const lvl=document.querySelector('input[name="level"]:checked').value;
  const T={}; document.querySelectorAll(".dtype").forEach(cb=>T[cb.value]=cb.checked);

  const gem={
    hp:Number(document.querySelector('input[name="gem_hp"]:checked').value),
    atk:Number(document.querySelector('input[name="gem_atk"]:checked').value),
    df:Number(document.querySelector('input[name="gem_df"]:checked').value)
  };

  const acc=[]; accCheckboxes.forEach(o=>{ if(document.getElementById(o.id).checked) acc.push(o); });
  if(!acc.length){ R.textContent="장신구가 선택되지 않았습니다."; return; }

  const pm = document.querySelector('input[name="pendant_mode"]:checked').value;
  const pv = Number(document.getElementById("pendant_value").value || 0);
  const pver = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
  const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  const topn = Number(document.getElementById("top_n").value || 5);
  const ench = 21,
        pot = new Stats(24,6,6),
        col = new Stats(240,60,60);

  // 입력 요소를 명시적으로 읽기 (암묵 전역 의존 제거)
  const spf = new Stats(val('sf_hp'), val('sf_atk'), val('sf_df'));
  const spp = new Stats(val('sp_hp')/100, val('sp_atk')/100, val('sp_df')/100);
  const spe = new Stats(val('se_hp'), val('se_atk'), val('se_df'));
  const bf  = new Stats(val('bf_hp')/100, val('bf_atk')/100, val('bf_df')/100);
  const db  = new Stats(val('db_hp')/100, val('db_atk')/100, val('db_df')/100);

  const selT = Object.keys(T).filter(k => T[k]);
  if (!selT.length) {
    R.textContent = "드래곤 타입이 선택되지 않았습니다.";
    return;
  }

  const lim = {별:6, 달:12, 태양:18}[pm] || 0;
  if (pv > lim || pv <= 0) {
    R.textContent = "펜던트를 다시 확인해주세요.";
    return;
  }

  // ✅ 여기 핵심 변경
  const pendComb = genPend(
    pv,
    pm,
    pver === "v2" ? selectedStats : ["HP", "ATK", "DEF"]
  );

  if (!pendComb.length) {
    R.textContent = "펜던트 조합 오류";
    return;
  }

  const results=[];
  for(const a of acc){
    const ah=a.hp/100, aa=a.atk/100, ad=a.df/100;
    for(const t of selT){
      const base=dragon[lvl][t];
      for(let h=0;h<=5;h++){
        for(let at=0;at<=5-h;at++){
          const d=5-h-at;
          const gemTot=new Stats(gem.hp*h, gem.atk*at, gem.df*d);
          for(const enchDir of ["hp","atk","df"]){
            const enchPct=new Stats(enchDir==="hp"?ench/100:0, enchDir==="atk"?ench/100:0, enchDir==="df"?ench/100:0);
            const accPct=new Stats(ah+enchPct.hp, aa+enchPct.atk, ad+enchPct.df);
            for(const pend of pendComb){
              const ph=pend.reduce((s,v)=>s+v[0],0);
              const pa=pend.reduce((s,v)=>s+v[1],0);
              const pd=pend.reduce((s,v)=>s+v[2],0);
              const pendStat=new Stats(ph/100, pa/100, pd/100);
              const [fin,E,B]=calcPredict(base,gemTot,pot,accPct,pendStat,spf,spp,spe,col,bf,db);
              const slotStr=pend.map(s=>["HP","ATK","DEF"].map((k,i)=>s[i]>0?`${k}${s[i]}`:"").filter(Boolean).join(" ")).join(" / ");
              const enchLabel={hp:"HP",atk:"ATK",df:"DEF"}[enchDir];
              const l1=`${t} | ${a.name} Lv${a.level} | 젬: HP${h} ATK${at} DEF${d} | 펜던트: ${pm} (${slotStr}) | 인첸트: ${enchLabel} +${ench}%\n`;
              const l2=`HP=${fin.hp} | ATK=${fin.atk} | DEF=${fin.df} | E=${E.toFixed(0)} | B=${(B/1e6).toFixed(3)}\n`;
              results.push({B,display_line1:l1,display_line2:l2});
            }
          }
        }
      }
    }
  }
  if(!results.length){ R.textContent="결과가 생성되지 않았습니다."; return; }
  results.sort((a,b)=>b.B-a.B);
  const out=results.slice(0,topn).map((r,i)=>`[${i+1}위] ${r.display_line1}${r.display_line2}`).join("\n");
  R.textContent=out;
}

/* =========================
   저장 기능
   ========================= */
function downloadTxt(){
  const text=document.getElementById("result").textContent||"";
  if(!text.trim()) return;
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="dragon_result.txt";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
