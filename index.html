<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</title>
<style>
  :root{
    --bg:#ffffff; --ink:#1a1a1a;
    --card-bg:#f8f9fa; --border:#e5e7eb;
    --accent:#3b82f6; --accent-hover:#2563eb;
    --radius:8px; --radius-sm:5px;
    --shadow:0 1px 2px rgba(0,0,0,0.08);
    --shadow-md:0 2px 4px rgba(0,0,0,0.08);
  }
  body{font-family:-apple-system,BlinkMacSystemFont,"Malgun Gothic","ë§‘ì€ ê³ ë”•","Noto Sans KR","Apple SD Gothic Neo","Helvetica Neue",sans-serif;margin:8px 12px;background:var(--bg);color:var(--ink);line-height:1.35;font-size:13px}
  h2{margin:0 0 2px;font-weight:700;color:var(--ink);font-size:16px}
  .hint{color:#6b7280;margin-bottom:4px;font-size:11px}
  .small{color:#9ca3af;font-size:11px}

  .header-fixed{position:sticky;top:0;background:var(--bg);z-index:100;padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:8px}
  .modebar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:2px}
  .tab-btn{padding:5px 14px;border:none;background:transparent;cursor:pointer;border-radius:0;font-size:13px;font-weight:500;color:#6b7280;position:relative;transition:color 0.2s}
  .tab-btn:hover{color:var(--accent);background:#f3f4f6}
  .tab-btn.active{color:var(--accent);font-weight:600}
  .tab-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent);border-radius:1px}
  .btn{padding:5px 12px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:var(--radius-sm);font-size:12px;font-weight:500;transition:all 0.2s;box-shadow:var(--shadow)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:var(--shadow-md)}
  .btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
  .btn:hover{background:#f9fafb;border-color:#d1d5db}

  .calc-container{display:none;overflow-y:auto;height:100%}
  .calc-container.active{display:block}

  fieldset{background:var(--card-bg);border:none;padding:10px 12px;margin-bottom:8px;border-radius:var(--radius);box-shadow:var(--shadow)}
  legend{font-weight:700;font-size:13px;color:var(--ink);padding:0 3px}
  .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:4px}
  label{display:inline-flex;gap:4px;align-items:center;cursor:pointer;font-size:13px}
  input[type="number"],select{height:28px;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:center;background:#fff;font-size:12px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="number"]:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,0.12)}
  input[type="text"]{height:28px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;padding:0 8px;font-size:12px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,0.12)}
  input[type="checkbox"],input[type="radio"]{width:14px;height:14px;accent-color:var(--accent)}

  .acc-list{max-height:180px;overflow:auto;border:1px solid var(--border);padding:6px 8px;background:#fff;border-radius:var(--radius-sm);font-size:12px}
  .toolbar{display:flex;gap:6px;margin:6px 0;flex-wrap:wrap}

  /* ì •ë ¹/ë²„í”„/ë””ë²„í”„ */
  .row-spirit{
    display:grid;
    grid-template-columns: 120px 70px 70px 70px auto;
    align-items:center;
    column-gap:4px;
    margin-bottom:3px
  }
  .row-spirit strong{text-align:right;padding-right:2px;font-weight:700;font-size:12px}

  /* ìˆ˜ë™ê²°ê³¼ ì‹œíŠ¸ - ë°ì€ í…Œë§ˆ */
  .results-wrap{margin-top:8px}
  .results-row{display:inline-flex;gap:10px;align-items:flex-start;flex-wrap:nowrap}
  .sheet{
    background:#fff; color:var(--ink);
    padding:10px; border-radius:var(--radius);
    display:inline-block; min-width:460px;
    box-shadow:var(--shadow-md);
    border:1px solid var(--border);
  }
  .sheet .name{
    font-weight:700; font-size:15px; letter-spacing:.3px; margin-bottom:6px; text-align:center;
    color:var(--accent);
  }
  .grid{
    display:grid;
    grid-template-columns: 120px 100px 100px 100px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:var(--radius-sm);
    overflow:hidden;
  }
  .cell{
    border:1px solid var(--border);
    padding:4px 6px; line-height:1.2;
    font-size:12px; background:#fff;
    color:var(--ink);
  }
  .cell.h{background:#f1f5f9;font-weight:600;color:#475569;font-size:11px}
  .cell.section{background:#e0f2fe;color:#0369a1;font-weight:700;text-align:center;font-size:12px}
  .cell.sum{background:#f8fafc;border-color:var(--border);color:var(--ink);font-size:13px;font-weight:600}
  .cell.big{font-size:18px;font-weight:700;letter-spacing:1px;text-align:center;background:#eff6ff;color:var(--accent)}
  .center{text-align:center}
  .right{text-align:right}
  pre.result{
    white-space:pre; background:#f8fafc; color:var(--ink);
    padding:10px; border-radius:var(--radius-sm); min-height:160px;
    border:1px solid var(--border);
    font-family:'Consolas',monospace;
    font-size:12px;
    line-height:1.35;
  }

  /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    body{margin:6px;}
    .header-fixed{padding:6px 0;}
    h2{font-size:15px;}
    .hint{font-size:11px;}

    .modebar{gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .tab-btn{padding:5px 10px;font-size:12px;white-space:nowrap;}
    .btn{padding:5px 8px;font-size:11px;}

    .row{flex-direction:column;align-items:flex-start;gap:4px;}
    .row label{width:100%;}

    .row-spirit{
      grid-template-columns:1fr;
      gap:4px;
    }
    .row-spirit strong{text-align:left;padding-right:0;margin-bottom:2px;}
    .row-spirit input{width:100%;}

    input[type="number"],select,input[type="text"]{width:100% !important;box-sizing:border-box;height:32px;}

    .toolbar{gap:4px;}
    .toolbar .btn{font-size:11px;padding:5px 8px;}

    .acc-list{max-height:150px;font-size:12px;}

    fieldset{padding:8px;border-radius:var(--radius-sm);}
    legend{font-size:12px;}

    .sheet{
      min-width:unset;
      width:100%;
      padding:8px;
      overflow-x:auto;
    }
    .sheet .name{font-size:14px;}

    .grid{
      grid-template-columns:70px repeat(3, 1fr);
      font-size:10px;
      min-width:280px;
    }
    .cell{padding:3px 4px;font-size:10px;}
    .cell.h{font-size:9px;padding:3px 3px;}
    .cell.big{font-size:14px;}
    .cell.sum{font-size:11px;}
    .cell.section{grid-column:1/5 !important;}

    .results-row{flex-direction:column;gap:8px;}

    pre.result{font-size:11px;padding:8px;min-height:120px;overflow-x:auto;}
  }

  /* ===== 3ë‹¨ ë ˆì´ì•„ì›ƒ ===== */
  .calc-layout {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    align-items: start;
  }
  .calc-column {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  @media (max-width: 1024px) {
    .calc-layout {
      grid-template-columns: 1fr;
    }
  }

  /* ë“œë˜ê³¤ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .dragon-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
  }
  .dragon-card .info {
    flex: 1;
    font-size: 12px;
  }
  .dragon-card .info strong {
    color: var(--accent);
    font-size: 13px;
  }
  .dragon-card .btn-remove {
    background: #ff6b6b;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 3px 8px;
    cursor: pointer;
    font-size: 11px;
  }
  .dragon-card .btn-remove:hover {
    background: #ee5a5a;
  }

  /* ë“œë˜ê³¤ ë¦¬ìŠ¤íŠ¸ */
  .dragon-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 200px;
    overflow-y: auto;
    padding: 4px 0;
  }

  /* ë“œë˜ê³¤ë³„ ì„¤ì • íƒ­ */
  .dragon-tabs {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    margin-bottom: 6px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 4px;
  }
  .dragon-tab {
    padding: 4px 10px;
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
  }
  .dragon-tab:hover {
    background: #f3f4f6;
  }
  .dragon-tab.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }

  /* ë“œë˜ê³¤ë³„ ì„¤ì • íŒ¨ë„ */
  .dragon-settings-panel {
    display: none;
  }
  .dragon-settings-panel.active {
    display: block;
  }
</style>
</head>

<body>
  <div class="header-fixed">
    <h2>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</h2>
    <div class="modebar">
      <button class="tab-btn active" id="btnAuto">ìë™ ê³„ì‚°ê¸°</button>
      <button class="tab-btn" id="btnManual">ìˆ˜ë™ ê³„ì‚°ê¸°</button>
      <button class="tab-btn" id="btnSpirit">ì •ë ¹ ì˜ˆì¸¡ê¸°</button>
    </div>
    <div class="hint small">
      ëª¨ë“  ì…ë ¥ì€ <b>HP / ATK / DEF</b> ìˆœì„œì…ë‹ˆë‹¤. Â· made by í—¬ë¦­ìŠ¤
      <button onclick="openHelpModal()" style="margin-left:8px;padding:2px 8px;background:#667eea;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;">ğŸ“– ì‚¬ìš©ë²•</button>
    </div>
  </div>

  <div id="autoCalc" class="calc-container active">
    <div class="calc-layout">
      <!-- ===== ì™¼ìª½ ì»¬ëŸ¼: ê³„ì‚°ëª¨ë“œ, ë“œë˜ê³¤ ì¶”ê°€, ì ¬ ===== -->
      <div class="calc-column">
        <!-- ê³„ì‚° ëª¨ë“œ (ë§¨ ìœ„) -->
        <fieldset>
          <legend>ê³„ì‚° ëª¨ë“œ</legend>
          <div class="row">
            <label><input type="radio" name="calc_mode" value="normal" checked onchange="onCalcModeChange()">Normal (ë“œë˜ê³¤ë³„ ê°œë³„ ê³„ì‚°)</label>
          </div>
          <div class="row">
            <label><input type="radio" name="calc_mode" value="optimize" onchange="onCalcModeChange()">Optimize (ìµœì  ë¶„ë°°)</label>
          </div>
          <div id="topNRow" style="margin-top:4px;">
            <div class="row">Top N <input id="top_n" type="number" value="5" style="width:80px"></div>
          </div>
        </fieldset>

        <!-- ë“œë˜ê³¤ ì¶”ê°€ íŒ¨ë„ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì¶”ê°€ (ìµœëŒ€ 9ë§ˆë¦¬)</legend>
          <div class="row">
            <label>ë“±ê¸‰
              <select id="add_dragon_grade">
                <option value="7.0">7.0</option>
                <option value="8.0">8.0</option>
                <option value="9.0" selected>9.0</option>
              </select>
            </label>
            <label>íƒ€ì…
              <select id="add_dragon_type">
                <option value="ê³µê²©í˜•">ê³µê²©í˜•</option>
                <option value="ë°©ì–´í˜•">ë°©ì–´í˜•</option>
                <option value="ì²´ë ¥í˜•">ì²´ë ¥í˜•</option>
                <option value="ê³µë°©í˜•">ê³µë°©í˜•</option>
                <option value="ì²´ê³µí˜•">ì²´ê³µí˜•</option>
                <option value="ì²´ë°©í˜•">ì²´ë°©í˜•</option>
              </select>
            </label>
            <button class="btn primary" type="button" onclick="addDragon()">ì¶”ê°€</button>
          </div>
          <div id="dragonListDisplay" class="dragon-list">
            <p style="color:#999;text-align:center;padding:10px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
          </div>
        </fieldset>

        <!-- ì ¬ ì„ íƒ (ê³µí†µ) -->
        <fieldset>
          <legend>ì ¬ ì„ íƒ</legend>
          <div class="row">
            <strong>HP</strong>
            <label><input type="radio" name="gem_hp" value="160">160</label>
            <label><input type="radio" name="gem_hp" value="156" checked>156</label>
            <label><input type="radio" name="gem_hp" value="152">152</label>
            <label><input type="radio" name="gem_hp" value="148">148</label>
          </div>
          <div class="row">
            <strong>ATK</strong>
            <label><input type="radio" name="gem_atk" value="40">40</label>
            <label><input type="radio" name="gem_atk" value="39" checked>39</label>
            <label><input type="radio" name="gem_atk" value="38">38</label>
            <label><input type="radio" name="gem_atk" value="37">37</label>
          </div>
          <div class="row">
            <strong>DEF</strong>
            <label><input type="radio" name="gem_df" value="40">40</label>
            <label><input type="radio" name="gem_df" value="39" checked>39</label>
            <label><input type="radio" name="gem_df" value="38">38</label>
            <label><input type="radio" name="gem_df" value="37">37</label>
          </div>
        </fieldset>

        <!-- ì¥ì‹ êµ¬ ì„ íƒ -->
        <fieldset>
          <legend>ì¥ì‹ êµ¬ ì„ íƒ</legend>
          <div class="toolbar">
            <button class="btn" type="button" id="btnToggleFavorites" onclick="toggleFavoritesFilter()">ì¦ê²¨ì°¾ê¸°ë§Œ</button>
            <button class="btn" type="button" onclick="toggleLevel(20)">Lv20</button>
            <button class="btn" type="button" onclick="toggleLevel(19)">Lv19</button>
            <button class="btn" type="button" onclick="toggleLevel(18)">Lv18</button>
            <button class="btn" type="button" onclick="toggleLevel(17)">Lv17</button>
            <button class="btn" type="button" onclick="selectNone()">í•´ì œ</button>
          </div>
          <div id="accList" class="acc-list"></div>

          <!-- ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ (Optimize ëª¨ë“œì—ì„œëŠ” ê°œìˆ˜ ì…ë ¥ í¬í•¨) -->
          <div id="selectedAccDisplay" style="margin-top:6px;padding:6px 8px;background:#e8f5e9;border-radius:4px;display:none;">
            <div style="font-weight:700;color:#2e7d32;margin-bottom:3px;font-size:12px;">ì„ íƒëœ ì¥ì‹ êµ¬:</div>
            <div id="selectedAccList" style="font-size:12px;"></div>
          </div>
        </fieldset>
      </div>

      <!-- ===== ê°€ìš´ë° ì»¬ëŸ¼: íœë˜íŠ¸ ===== -->
      <div class="calc-column">
        <!-- íœë˜íŠ¸ / ì •ë ¹ / ë²„í”„ / ë””ë²„í”„ (ë“œë˜ê³¤ë³„ ì„¤ì •) -->
        <fieldset>
          <legend>íœë˜íŠ¸ / ì •ë ¹ / ë²„í”„ / ë””ë²„í”„
            <button class="btn" type="button" onclick="resetAllDragonSpiritBuffs()" style="margin-left:8px;font-size:11px;padding:3px 8px;">ì´ˆê¸°í™”</button>
          </legend>
          <div id="dragonSpiritBuffContainer">
            <p style="color:#999;text-align:center;padding:10px 0;">ë“œë˜ê³¤ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
          </div>
        </fieldset>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ê³„ì‚° ë²„íŠ¼, ê²°ê³¼ ===== -->
      <div class="calc-column">
        <!-- ê³„ì‚° ë²„íŠ¼ -->
        <div class="toolbar" style="flex-direction:column;">
          <button class="btn primary" type="button" onclick="calcAuto()" style="width:100%;font-size:14px;padding:8px;">ê³„ì‚°í•˜ê¸°</button>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">
            <button class="btn" type="button" onclick="downloadTxt()">Excel ì €ì¥</button>
            <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff9800;color:#fff;border-color:#ff9800;">ì´ˆê¸°í™”</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ê²°ê³¼ -->
        <fieldset>
          <legend>ê³„ì‚° ê²°ê³¼</legend>
          <div style="font-size:11px;color:#666;margin-bottom:4px;">ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ë™ê³„ì‚°ê¸°ë¡œ ê°’ì´ ì „ì†¡ë©ë‹ˆë‹¤.</div>
          <pre id="autoResult" class="result"></pre>
        </fieldset>
      </div>
    </div>
  </div>

  <div id="manualCalc" class="calc-container">
    <h3 style="margin:0 0 8px;font-size:14px">ìˆ˜ë™ ê³„ì‚°ê¸° (ìµœëŒ€ 9ë§ˆë¦¬ ë¹„êµ)</h3>

    <div class="calc-layout">
      <!-- ===== ì™¼ìª½ ì»¬ëŸ¼: ë“œë˜ê³¤ ì¶”ê°€ ë° íƒ­ ===== -->
      <div class="calc-column" style="grid-column: 1 / 3;">
        <!-- ë“œë˜ê³¤ ì¶”ê°€ íŒ¨ë„ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì¶”ê°€ (ìˆ˜ë™ê³„ì‚°ê¸°)</legend>
          <div class="row">
            <button class="btn primary" type="button" onclick="addManualDragon()">ë“œë˜ê³¤ ì¶”ê°€</button>
            <span class="small" id="manualDragonCount">(í˜„ì¬: 3ë§ˆë¦¬)</span>
            <span class="small" style="color:#999;">ë“±ê¸‰/íƒ€ì…ì€ ë“œë˜ê³¤ ì„¤ì •ì—ì„œ ë³€ê²½</span>
          </div>
        </fieldset>

        <!-- ë“œë˜ê³¤ íƒ­ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì„¤ì •</legend>
          <div id="manualDragonTabs" class="dragon-tabs"></div>
          <div id="inputsWrap"></div>
        </fieldset>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ê³„ì‚°ë²„íŠ¼ ===== -->
      <div class="calc-column">
        <fieldset>
          <legend>ê³„ì‚° ë° ì €ì¥</legend>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn primary" onclick="manualCalcAll()" style="width:100%;">ìˆ˜ë™ ê³„ì‚°</button>
            <button class="btn" onclick="savePngAll()" style="width:100%;">ê²°ê³¼ë¥¼ PNGë¡œ ì €ì¥</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;width:100%;">ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™”</button>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- ê²°ê³¼ ë“œë˜ê³¤ ì„ íƒ (4ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div id="dragonSelectPanel" style="display:none;margin-top:10px;padding:8px 12px;background:#fff3e0;border-radius:6px;border:1px solid #ffcc80;">
      <div style="font-weight:bold;margin-bottom:6px;color:#e65100;font-size:13px;">ğŸ“‹ ê²°ê³¼ì— í‘œì‹œí•  ë“œë˜ê³¤ ì„ íƒ (ìµœëŒ€ 3ê°œ)</div>
      <div id="dragonSelectCheckboxes" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>

    <!-- ê²°ê³¼ ì‹œíŠ¸ (ê°€ë¡œ ë¹„êµ) -->
    <div class="results-wrap" style="margin-top:10px;">
      <div id="allResults" class="results-row"></div>
    </div>
  </div>

  <div id="spiritCalc" class="calc-container">
    <h3 style="margin:0 0 8px;font-size:14px">ì •ë ¹ ì˜ˆì¸¡ê¸°</h3>

    <div class="calc-layout" style="grid-template-columns:1fr 1fr;">
      <!-- ===== ì™¼ìª½: ì…ë ¥ ===== -->
      <div class="calc-column">
        <!-- ë“±ê¸‰ & ì¥ì‹ êµ¬ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ë“±ê¸‰</legend>
          <div class="row">
            <label><input type="radio" name="sp_grade" value="7.0">7.0</label>
            <label><input type="radio" name="sp_grade" value="8.0">8.0</label>
            <label><input type="radio" name="sp_grade" value="9.0" checked>9.0</label>
          </div>
        </fieldset>

        <fieldset>
          <legend>ì¥ì‹ êµ¬</legend>
          <div class="row">
            <select id="sp_acc_select" onchange="onSpiritPredAccChange(this.value)" style="width:100%;">
              <option value="">-- ì¥ì‹ êµ¬ ì„ íƒ --</option>
            </select>
          </div>
          <div class="row" style="margin-top:3px;">
            <span class="small">ë˜ëŠ” ì§ì ‘ ì…ë ¥:</span>
          </div>
          <div class="row">
            HP <input id="sp_acc_hp" type="number" value="0" style="width:50px">%
            ATK <input id="sp_acc_atk" type="number" value="0" style="width:50px">%
            DEF <input id="sp_acc_df" type="number" value="0" style="width:50px">%
          </div>
        </fieldset>

        <fieldset>
          <legend>ì ¬ ì„ íƒ</legend>
          <div class="row">
            <strong>HP</strong>
            <label><input type="radio" name="sp_gem_hp" value="160">160</label>
            <label><input type="radio" name="sp_gem_hp" value="156" checked>156</label>
            <label><input type="radio" name="sp_gem_hp" value="152">152</label>
            <label><input type="radio" name="sp_gem_hp" value="148">148</label>
          </div>
          <div class="row">
            <strong>ATK</strong>
            <label><input type="radio" name="sp_gem_atk" value="40">40</label>
            <label><input type="radio" name="sp_gem_atk" value="39" checked>39</label>
            <label><input type="radio" name="sp_gem_atk" value="38">38</label>
            <label><input type="radio" name="sp_gem_atk" value="37">37</label>
          </div>
          <div class="row">
            <strong>DEF</strong>
            <label><input type="radio" name="sp_gem_df" value="40">40</label>
            <label><input type="radio" name="sp_gem_df" value="39" checked>39</label>
            <label><input type="radio" name="sp_gem_df" value="38">38</label>
            <label><input type="radio" name="sp_gem_df" value="37">37</label>
          </div>
        </fieldset>

        <fieldset>
          <legend>ì¸ì±ˆíŠ¸</legend>
          <div class="row">
            HP <select id="sp_ench_hp"><option value="0" selected>-</option><option value="21">21</option></select>
            ATK <select id="sp_ench_atk"><option value="0" selected>-</option><option value="21">21</option></select>
            DEF <select id="sp_ench_df"><option value="0" selected>-</option><option value="21">21</option></select>
          </div>
        </fieldset>

        <fieldset>
          <legend>íœë˜íŠ¸ (%)</legend>
          <div class="row">
            HP <input id="sp_pend_hp" type="number" value="0" style="width:50px">%
            ATK <input id="sp_pend_atk" type="number" value="0" style="width:50px">%
            DEF <input id="sp_pend_df" type="number" value="0" style="width:50px">%
          </div>
        </fieldset>

        <!-- ì •ë ¹ ì…ë ¥ -->
        <fieldset>
          <legend>ì •ë ¹ (ë¶„ì„ ëŒ€ìƒ)</legend>
          <div class="row" style="margin-bottom:4px;">
            <label><input type="radio" name="sp_spirit_mode" value="slot" checked onchange="toggleSpiritPredMode()">ìŠ¬ë¡¯ ì„ íƒ</label>
            <label><input type="radio" name="sp_spirit_mode" value="manual" onchange="toggleSpiritPredMode()">ì§ì ‘ ì…ë ¥</label>
          </div>

          <!-- ìŠ¬ë¡¯ ëª¨ë“œ -->
          <div id="sp_spirit_slot_mode">
            <div style="font-size:12px;margin-bottom:4px;color:#666;">ì •ë ¹ ìŠ¬ë¡¯:</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;">
              <div style="display:flex;gap:4px;">
                <select id="sp_slot1_stat" style="flex:1;"><option value="none">-</option><option value="hp">HP</option><option value="atk">ATK</option><option value="df">DEF</option></select>
                <select id="sp_slot1_type" style="width:45px;"><option value="flat">+</option><option value="pct">%</option></select>
              </div>
              <div style="display:flex;gap:4px;">
                <select id="sp_slot2_stat" style="flex:1;"><option value="none">-</option><option value="hp">HP</option><option value="atk">ATK</option><option value="df">DEF</option></select>
                <select id="sp_slot2_type" style="width:45px;"><option value="flat">+</option><option value="pct">%</option></select>
              </div>
              <div style="display:flex;gap:4px;">
                <select id="sp_slot3_stat" style="flex:1;"><option value="none">-</option><option value="hp">HP</option><option value="atk">ATK</option><option value="df">DEF</option></select>
                <select id="sp_slot3_type" style="width:45px;"><option value="flat">+</option><option value="pct">%</option></select>
              </div>
              <div style="display:flex;gap:4px;">
                <select id="sp_slot4_stat" style="flex:1;"><option value="none">-</option><option value="hp">HP</option><option value="atk">ATK</option><option value="df">DEF</option></select>
                <select id="sp_slot4_type" style="width:45px;"><option value="flat">+</option><option value="pct">%</option></select>
              </div>
            </div>
            <div style="margin-bottom:4px;">
              <span style="font-size:12px;color:#666;">ë¶€ê°€ì˜µ:</span>
              <select id="sp_sub" style="margin-left:4px;">
                <option value="0">ì—†ìŒ</option>
                <option value="1">ì²´ë ¥40</option>
                <option value="2">ê³µê²©ë ¥10</option>
                <option value="3">ë°©ì–´ë ¥10</option>
              </select>
            </div>
          </div>

          <!-- ì§ì ‘ ì…ë ¥ ëª¨ë“œ -->
          <div id="sp_spirit_manual_mode" style="display:none;">
            <div style="font-weight:700;margin-bottom:3px;font-size:12px;">(HP / ATK / DEF)</div>
            <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
              <input id="sp_sf_hp" type="number" value="0">
              <input id="sp_sf_atk" type="number" value="0">
              <input id="sp_sf_df" type="number" value="0">
            </div>
            <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
              <input id="sp_sp_hp" type="number" value="0">
              <input id="sp_sp_atk" type="number" value="0">
              <input id="sp_sp_df" type="number" value="0">
              <span class="small">% ì…ë ¥</span>
            </div>
            <div class="row-spirit"><strong>ì •ë ¹ ë¶€ê°€ì˜µ</strong>
              <input id="sp_se_hp" type="number" value="0">
              <input id="sp_se_atk" type="number" value="0">
              <input id="sp_se_df" type="number" value="0">
            </div>
          </div>
        </fieldset>

        <!-- ë²„í”„/ë””ë²„í”„ -->
        <fieldset>
          <legend>ë²„í”„ / ë””ë²„í”„</legend>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;">
                <select id="sp_bf_hp"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="sp_bf_atk"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="sp_bf_df"><option value="0" selected>-</option><option value="20">20</option></select>
              </div>
            </div>
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë””ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;">
                <select id="sp_db_hp"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="sp_db_atk"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="sp_db_df"><option value="0" selected>-</option><option value="20">20</option></select>
              </div>
            </div>
          </div>
        </fieldset>

        <button class="btn primary" onclick="runSpiritPredictor()" style="width:100%;font-size:14px;padding:8px;">ì •ë ¹ ì˜ˆì¸¡ ê³„ì‚°</button>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½: ê²°ê³¼ ===== -->
      <div class="calc-column">
        <fieldset>
          <legend>ì˜ˆì¸¡ ê²°ê³¼</legend>
          <div style="font-size:11px;color:#666;margin-bottom:4px;">ë™ì¼ ì¡°ê±´ì—ì„œ ì •ë ¹ì„ ì ìš©í–ˆì„ ë•Œ ìš© íƒ€ì…ë³„ ë¹„ë²¨(B-Value) ë¹„êµ</div>
          <div id="spiritPredResult" style="min-height:200px;">
            <p style="color:#999;text-align:center;padding:20px 0;">ì •ë ¹ ì„¤ì • í›„ ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
          </div>
        </fieldset>
      </div>
    </div>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- SheetJS (Excel íŒŒì¼ ìƒì„±) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  // ===== ë°ì´í„° êµ¬ì¡° ì •ì˜ =====
  class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}

  // ===== ìƒˆë¡œìš´ ìƒíƒœ ê´€ë¦¬ êµ¬ì¡° =====
  class DragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;      // "7.0" | "8.0" | "9.0"
      this.type = type;        // "ê³µê²©í˜•" | "ë°©ì–´í˜•" | etc.
      this.pendant = { hp: 0, atk: 0, df: 0 };
      this.pendantSettings = {
        ver: 'v1',           // v1: ìë™, v2: ì§€ì •, v3: ìˆ˜ë™
        mode: 'ë‹¬',          // ë‹¬, íƒœì–‘
        value: 12,           // íœë˜íŠ¸ ê°’
        stats: ['HP', 'ATK', 'DEF']  // ì§€ì • ëª¨ë“œì—ì„œ ì„ íƒëœ ìŠ¤íƒ¯
      };
      this.spirit = {
        flat: { hp: 0, atk: 0, df: 0 },
        pct: { hp: 0, atk: 0, df: 0 },
        extra: { hp: 0, atk: 0, df: 0 }
      };
      this.spiritSlots = {
        slot1: { stat: 'none', type: 'pct' },
        slot2: { stat: 'none', type: 'pct' },
        slot3: { stat: 'none', type: 'pct' },
        slot4: { stat: 'none', type: 'pct' },
        sub: 0
      };
      this.buff = { hp: 0, atk: 0, df: 0 };
      this.debuff = { hp: 0, atk: 0, df: 0 };
    }
  }

  const AppState = {
    dragons: [],
    maxDragons: 9,
    gems: { hp: 156, atk: 39, df: 39 },
    nextDragonId: 1
  };

  // ===== ë“œë˜ê³¤ ì¶”ê°€/ì œê±° í•¨ìˆ˜ =====
  function addDragon() {
    if (AppState.dragons.length >= AppState.maxDragons) {
      alert(`ìµœëŒ€ ${AppState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    const gradeSelect = document.getElementById('add_dragon_grade');
    const typeSelect = document.getElementById('add_dragon_type');
    const grade = gradeSelect ? gradeSelect.value : '9.0';
    const type = typeSelect ? typeSelect.value : 'ê³µê²©í˜•';

    const newDragon = new DragonConfig(AppState.nextDragonId++, grade, type);
    newDragon.displayNumber = AppState.dragons.length + 1;
    AppState.dragons.push(newDragon);

    renderDragonList();
    renderSpiritBuffSections();
  }

  function removeDragon(dragonId) {
    const index = AppState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    // ë“œë˜ê³¤ ì œê±°
    AppState.dragons.splice(index, 1);

    // ë¦¬ë„˜ë²„ë§
    AppState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });

    renderDragonList();
    renderSpiritBuffSections();
  }

  function renderDragonList() {
    const container = document.getElementById('dragonListDisplay');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:10px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      return;
    }

    container.innerHTML = AppState.dragons.map(d => `
      <div class="dragon-card">
        <div class="info">
          <strong>ë“œë˜ê³¤ ${d.displayNumber}</strong>
          <span style="margin-left:6px;color:#666;font-size:12px;">${d.grade} / ${d.type}</span>
        </div>
        <button class="btn-remove" onclick="removeDragon(${d.id})">ì‚­ì œ</button>
      </div>
    `).join('');
  }

  function renderSpiritBuffSections() {
    const container = document.getElementById('dragonSpiritBuffContainer');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:10px 0;">ë“œë˜ê³¤ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      return;
    }

    // íƒ­ ìƒì„±
    const tabsHtml = AppState.dragons.map((d, i) => `
      <button class="dragon-tab ${i === 0 ? 'active' : ''}" onclick="switchDragonTab(${d.id})" data-dragon-id="${d.id}">
        ë“œë˜ê³¤ ${d.displayNumber}
      </button>
    `).join('');

    // ì •ë ¹ ìŠ¬ë¡¯ ì˜µì…˜ ìƒì„± í•¨ìˆ˜ (ì €ì¥ëœ ê°’ ë°˜ì˜)
    const genStatOptions = (selected) => `
      <option value="none" ${selected === 'none' ? 'selected' : ''}>-</option>
      <option value="hp" ${selected === 'hp' ? 'selected' : ''}>HP</option>
      <option value="atk" ${selected === 'atk' ? 'selected' : ''}>ATK</option>
      <option value="df" ${selected === 'df' ? 'selected' : ''}>DEF</option>
    `;
    const genTypeOptions = (selected) => `
      <option value="flat" ${selected === 'flat' ? 'selected' : ''}>+</option>
      <option value="pct" ${selected === 'pct' ? 'selected' : ''}>%</option>
    `;
    const genSubOptions = (selected) => SPIRIT_SUB_OPTIONS.map((opt, i) =>
      `<option value="${i}" ${selected === i ? 'selected' : ''}>${opt.label}</option>`
    ).join('');

    // ê° ë“œë˜ê³¤ë³„ ì„¤ì • íŒ¨ë„
    const panelsHtml = AppState.dragons.map((d, i) => {
      const slots = d.spiritSlots || { slot1: {stat:'none',type:'flat'}, slot2: {stat:'none',type:'flat'}, slot3: {stat:'none',type:'flat'}, slot4: {stat:'none',type:'flat'}, sub: 0 };
      const ps = d.pendantSettings || { ver: 'v1', mode: 'ë‹¬', value: 12, stats: ['HP', 'ATK', 'DEF'] };
      return `
      <div class="dragon-settings-panel ${i === 0 ? 'active' : ''}" id="dragonPanel_${d.id}">
        <div style="background:#e3f2fd;padding:4px 8px;border-radius:4px;margin-bottom:6px;font-size:12px;">
          <strong style="color:#1565c0;">ë“œë˜ê³¤ ${d.displayNumber}</strong>
          <span style="margin-left:6px;color:#666;">(${d.grade} / ${d.type})</span>
        </div>

        <!-- íœë˜íŠ¸ ì„¤ì • -->
        <div style="border:1px solid #c8e6c9;background:#f1f8e9;padding:6px 8px;border-radius:4px;margin-bottom:6px;">
          <div style="font-weight:bold;color:#2e7d32;margin-bottom:4px;font-size:12px;">íœë˜íŠ¸</div>
          <div class="row" style="margin-bottom:3px;">
            <label><input type="radio" name="dragon_${d.id}_pendant_ver" value="v1" ${ps.ver === 'v1' ? 'checked' : ''} onchange="toggleDragonPendantMode(${d.id})">ìë™</label>
            <label><input type="radio" name="dragon_${d.id}_pendant_ver" value="v2" ${ps.ver === 'v2' ? 'checked' : ''} onchange="toggleDragonPendantMode(${d.id})">ì§€ì •</label>
            <label><input type="radio" name="dragon_${d.id}_pendant_ver" value="v3" ${ps.ver === 'v3' ? 'checked' : ''} onchange="toggleDragonPendantMode(${d.id})">ìˆ˜ë™</label>
          </div>
          <div id="dragon_${d.id}_pendant_auto" style="${ps.ver === 'v3' ? 'display:none;' : ''}">
            <div class="row" style="margin-bottom:2px;">
              <label><input type="radio" name="dragon_${d.id}_pendant_mode" value="ë‹¬" ${ps.mode === 'ë‹¬' ? 'checked' : ''} onchange="updateDragonPendant(${d.id})">ë‹¬</label>
              <label><input type="radio" name="dragon_${d.id}_pendant_mode" value="íƒœì–‘" ${ps.mode === 'íƒœì–‘' ? 'checked' : ''} onchange="updateDragonPendant(${d.id})">íƒœì–‘</label>
              <input id="dragon_${d.id}_pendant_value" type="number" value="${ps.value}" style="width:50px;" onchange="updateDragonPendant(${d.id})"> %
            </div>
            <div id="dragon_${d.id}_pendant_stats" class="row" style="${ps.ver === 'v1' ? 'display:none;' : ''}">
              <label><input type="checkbox" class="dragon_${d.id}_pendStat" value="HP" ${ps.stats.includes('HP') ? 'checked' : ''} onchange="updateDragonPendant(${d.id})">HP</label>
              <label><input type="checkbox" class="dragon_${d.id}_pendStat" value="ATK" ${ps.stats.includes('ATK') ? 'checked' : ''} onchange="updateDragonPendant(${d.id})">ATK</label>
              <label><input type="checkbox" class="dragon_${d.id}_pendStat" value="DEF" ${ps.stats.includes('DEF') ? 'checked' : ''} onchange="updateDragonPendant(${d.id})">DEF</label>
            </div>
          </div>
          <div id="dragon_${d.id}_pendant_manual" style="${ps.ver !== 'v3' ? 'display:none;' : ''}">
            HP <input id="dragon_${d.id}_pend_hp" type="number" value="${d.pendant.hp}" style="width:45px;" onchange="updateDragonPendant(${d.id})">%
            ATK <input id="dragon_${d.id}_pend_atk" type="number" value="${d.pendant.atk}" style="width:45px;" onchange="updateDragonPendant(${d.id})">%
            DEF <input id="dragon_${d.id}_pend_df" type="number" value="${d.pendant.df}" style="width:45px;" onchange="updateDragonPendant(${d.id})">%
          </div>
        </div>

        <!-- ì •ë ¹ ì…ë ¥ ëª¨ë“œ ì„ íƒ -->
        <div class="row" style="margin-bottom:4px;">
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="slot" checked onchange="toggleSpiritInputMode(${d.id})">ìŠ¬ë¡¯ ì„ íƒ</label>
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="manual" onchange="toggleSpiritInputMode(${d.id})">ì§ì ‘ ì…ë ¥</label>
        </div>

        <!-- ìŠ¬ë¡¯ ì„ íƒ ëª¨ë“œ (2x2 ì‚¬ë¶„ë©´ ë°°ì¹˜) -->
        <div id="dragon_${d.id}_slot_mode">
          <div style="font-size:12px;margin-bottom:4px;color:#666;">ì •ë ¹ ìŠ¬ë¡¯:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;">
            <!-- 2ì‚¬ë¶„ë©´(ì¢Œìƒ)=ìŠ¬ë¡¯1, 1ì‚¬ë¶„ë©´(ìš°ìƒ)=ìŠ¬ë¡¯2 -->
            <div style="display:flex;gap:4px;">
              <select id="dragon_${d.id}_slot1_stat" onchange="calculateSpiritFromSlots(${d.id})" style="flex:1;">${genStatOptions(slots.slot1.stat)}</select>
              <select id="dragon_${d.id}_slot1_type" onchange="calculateSpiritFromSlots(${d.id})" style="width:45px;">${genTypeOptions(slots.slot1.type)}</select>
            </div>
            <div style="display:flex;gap:4px;">
              <select id="dragon_${d.id}_slot2_stat" onchange="calculateSpiritFromSlots(${d.id})" style="flex:1;">${genStatOptions(slots.slot2.stat)}</select>
              <select id="dragon_${d.id}_slot2_type" onchange="calculateSpiritFromSlots(${d.id})" style="width:45px;">${genTypeOptions(slots.slot2.type)}</select>
            </div>
            <!-- 3ì‚¬ë¶„ë©´(ì¢Œí•˜)=ìŠ¬ë¡¯3, 4ì‚¬ë¶„ë©´(ìš°í•˜)=ìŠ¬ë¡¯4 -->
            <div style="display:flex;gap:4px;">
              <select id="dragon_${d.id}_slot3_stat" onchange="calculateSpiritFromSlots(${d.id})" style="flex:1;">${genStatOptions(slots.slot3.stat)}</select>
              <select id="dragon_${d.id}_slot3_type" onchange="calculateSpiritFromSlots(${d.id})" style="width:45px;">${genTypeOptions(slots.slot3.type)}</select>
            </div>
            <div style="display:flex;gap:4px;">
              <select id="dragon_${d.id}_slot4_stat" onchange="calculateSpiritFromSlots(${d.id})" style="flex:1;">${genStatOptions(slots.slot4.stat)}</select>
              <select id="dragon_${d.id}_slot4_type" onchange="calculateSpiritFromSlots(${d.id})" style="width:45px;">${genTypeOptions(slots.slot4.type)}</select>
            </div>
          </div>
          <div style="margin-bottom:4px;">
            <span style="font-size:12px;color:#666;">ë¶€ê°€ì˜µ:</span>
            <select id="dragon_${d.id}_sub" onchange="calculateSpiritFromSlots(${d.id})" style="margin-left:4px;">${genSubOptions(slots.sub)}</select>
          </div>
          <div id="dragon_${d.id}_spirit_summary"></div>
        </div>

        <!-- ì§ì ‘ ì…ë ¥ ëª¨ë“œ -->
        <div id="dragon_${d.id}_manual_mode" style="display:none;">
          <div style="font-weight:bold;color:black;margin-bottom:3px;font-size:12px;">(HP / ATK / DEF)</div>
          <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
            <input id="dragon_${d.id}_sf_hp" type="number" value="${d.spirit.flat.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_atk" type="number" value="${d.spirit.flat.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_df" type="number" value="${d.spirit.flat.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
            <input id="dragon_${d.id}_sp_hp" type="number" value="${d.spirit.pct.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_atk" type="number" value="${d.spirit.pct.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_df" type="number" value="${d.spirit.pct.df}" onchange="updateDragonSpirit(${d.id})">
            <span class="small">(% ì…ë ¥)</span>
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ ì˜µ</strong>
            <input id="dragon_${d.id}_se_hp" type="number" value="${d.spirit.extra.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_atk" type="number" value="${d.spirit.extra.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_df" type="number" value="${d.spirit.extra.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
        </div>

        <!-- ë²„í”„/ë””ë²„í”„ (2x2 ì‚¬ë¶„ë©´ í˜•íƒœ) -->
        <div style="border-top:1px solid #ddd;margin-top:6px;padding-top:6px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;">
                <select id="dragon_${d.id}_bf_hp" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.buff.hp === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.buff.hp === 20 ? 'selected' : ''}>20</option>
                </select>
                <select id="dragon_${d.id}_bf_atk" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.buff.atk === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.buff.atk === 20 ? 'selected' : ''}>20</option>
                </select>
                <select id="dragon_${d.id}_bf_df" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.buff.df === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.buff.df === 20 ? 'selected' : ''}>20</option>
                </select>
              </div>
            </div>
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë””ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
                <select id="dragon_${d.id}_db_hp" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.debuff.hp === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.debuff.hp === 20 ? 'selected' : ''}>20</option>
                </select>
                <select id="dragon_${d.id}_db_atk" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.debuff.atk === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.debuff.atk === 20 ? 'selected' : ''}>20</option>
                </select>
                <select id="dragon_${d.id}_db_df" onchange="updateDragonSpirit(${d.id})">
                  <option value="0" ${d.debuff.df === 0 ? 'selected' : ''}>-</option>
                  <option value="20" ${d.debuff.df === 20 ? 'selected' : ''}>20</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    `; }).join('');

    container.innerHTML = `
      <div class="dragon-tabs">${tabsHtml}</div>
      ${panelsHtml}
    `;

    // ê° ë“œë˜ê³¤ì˜ ì •ë ¹ ê°’ ì´ˆê¸° ê³„ì‚°
    AppState.dragons.forEach(d => {
      calculateSpiritFromSlots(d.id);
    });
  }

  function toggleSpiritInputMode(dragonId) {
    const mode = document.querySelector(`input[name="dragon_${dragonId}_input_mode"]:checked`)?.value;
    const slotMode = document.getElementById(`dragon_${dragonId}_slot_mode`);
    const manualMode = document.getElementById(`dragon_${dragonId}_manual_mode`);

    if (mode === 'slot') {
      slotMode.style.display = 'block';
      manualMode.style.display = 'none';
    } else {
      slotMode.style.display = 'none';
      manualMode.style.display = 'block';
    }
  }

  function switchDragonTab(dragonId) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    document.querySelector(`.dragon-tab[data-dragon-id="${dragonId}"]`)?.classList.add('active');
    document.getElementById(`dragonPanel_${dragonId}`)?.classList.add('active');
  }

  function updateDragonSpirit(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    dragon.spirit.flat.hp = Number(document.getElementById(`dragon_${dragonId}_sf_hp`)?.value || 0);
    dragon.spirit.flat.atk = Number(document.getElementById(`dragon_${dragonId}_sf_atk`)?.value || 0);
    dragon.spirit.flat.df = Number(document.getElementById(`dragon_${dragonId}_sf_df`)?.value || 0);
    dragon.spirit.pct.hp = Number(document.getElementById(`dragon_${dragonId}_sp_hp`)?.value || 0);
    dragon.spirit.pct.atk = Number(document.getElementById(`dragon_${dragonId}_sp_atk`)?.value || 0);
    dragon.spirit.pct.df = Number(document.getElementById(`dragon_${dragonId}_sp_df`)?.value || 0);
    dragon.spirit.extra.hp = Number(document.getElementById(`dragon_${dragonId}_se_hp`)?.value || 0);
    dragon.spirit.extra.atk = Number(document.getElementById(`dragon_${dragonId}_se_atk`)?.value || 0);
    dragon.spirit.extra.df = Number(document.getElementById(`dragon_${dragonId}_se_df`)?.value || 0);
    dragon.buff.hp = Number(document.getElementById(`dragon_${dragonId}_bf_hp`)?.value || 0);
    dragon.buff.atk = Number(document.getElementById(`dragon_${dragonId}_bf_atk`)?.value || 0);
    dragon.buff.df = Number(document.getElementById(`dragon_${dragonId}_bf_df`)?.value || 0);
    dragon.debuff.hp = Number(document.getElementById(`dragon_${dragonId}_db_hp`)?.value || 0);
    dragon.debuff.atk = Number(document.getElementById(`dragon_${dragonId}_db_atk`)?.value || 0);
    dragon.debuff.df = Number(document.getElementById(`dragon_${dragonId}_db_df`)?.value || 0);
  }

  // ===== ë“œë˜ê³¤ë³„ íœë˜íŠ¸ ì„¤ì • í•¨ìˆ˜ =====
  function toggleDragonPendantMode(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    const ver = document.querySelector(`input[name="dragon_${dragonId}_pendant_ver"]:checked`)?.value || 'v1';
    dragon.pendantSettings.ver = ver;

    const autoDiv = document.getElementById(`dragon_${dragonId}_pendant_auto`);
    const manualDiv = document.getElementById(`dragon_${dragonId}_pendant_manual`);
    const statsDiv = document.getElementById(`dragon_${dragonId}_pendant_stats`);

    if (ver === 'v3') {
      autoDiv.style.display = 'none';
      manualDiv.style.display = 'block';
    } else {
      autoDiv.style.display = 'block';
      manualDiv.style.display = 'none';
      statsDiv.style.display = ver === 'v2' ? 'flex' : 'none';
    }

    updateDragonPendant(dragonId);
  }

  function updateDragonPendant(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    const ver = document.querySelector(`input[name="dragon_${dragonId}_pendant_ver"]:checked`)?.value || 'v1';
    dragon.pendantSettings.ver = ver;

    if (ver === 'v3') {
      dragon.pendant.hp = Number(document.getElementById(`dragon_${dragonId}_pend_hp`)?.value || 0);
      dragon.pendant.atk = Number(document.getElementById(`dragon_${dragonId}_pend_atk`)?.value || 0);
      dragon.pendant.df = Number(document.getElementById(`dragon_${dragonId}_pend_df`)?.value || 0);
    } else {
      dragon.pendantSettings.mode = document.querySelector(`input[name="dragon_${dragonId}_pendant_mode"]:checked`)?.value || 'ë‹¬';
      dragon.pendantSettings.value = Number(document.getElementById(`dragon_${dragonId}_pendant_value`)?.value || 12);
      dragon.pendantSettings.stats = Array.from(document.querySelectorAll(`.dragon_${dragonId}_pendStat:checked`)).map(cb => cb.value);
    }
  }

  // ===== ì •ë ¹ ìŠ¬ë¡¯ë³„ ìˆ˜ì¹˜ í…Œì´ë¸” =====
  const SPIRIT_FLAT_TBL = {
    1: { hp: 216, atk: 54, df: 54 },
    2: { hp: 240, atk: 60, df: 60 },
    3: { hp: 264, atk: 66, df: 66 },
    4: { hp: 480, atk: 120, df: 120 }
  };
  const SPIRIT_PCT_TBL = {
    1: { hp: 24, atk: 24, df: 24 },
    2: { hp: 28, atk: 28, df: 28 },
    3: { hp: 32, atk: 32, df: 32 },
    4: { hp: 40, atk: 40, df: 40 }
  };
  const SPIRIT_SUB_OPTIONS = [
    { label: 'ì—†ìŒ', hp: 0, atk: 0, df: 0 },
    { label: 'ì²´ë ¥40', hp: 40, atk: 0, df: 0 },
    { label: 'ê³µê²©ë ¥10', hp: 0, atk: 10, df: 0 },
    { label: 'ë°©ì–´ë ¥10', hp: 0, atk: 0, df: 10 }
  ];

  // ì •ë ¹ ìŠ¬ë¡¯ ì„ íƒì—ì„œ ê°’ ê³„ì‚°
  function calculateSpiritFromSlots(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    let flatTotal = { hp: 0, atk: 0, df: 0 };
    let pctTotal = { hp: 0, atk: 0, df: 0 };
    let extraTotal = { hp: 0, atk: 0, df: 0 };

    // ìŠ¬ë¡¯ 1~4 ê³„ì‚° ë° ì €ì¥
    for (let slot = 1; slot <= 4; slot++) {
      const statEl = document.getElementById(`dragon_${dragonId}_slot${slot}_stat`);
      const typeEl = document.getElementById(`dragon_${dragonId}_slot${slot}_type`);
      if (!statEl || !typeEl) continue;

      const stat = statEl.value; // hp, atk, df, none
      const type = typeEl.value; // flat, pct

      // ìŠ¬ë¡¯ ì„ íƒê°’ ì €ì¥
      dragon.spiritSlots[`slot${slot}`] = { stat, type };

      if (stat && stat !== 'none') {
        if (type === 'flat') {
          flatTotal[stat] += SPIRIT_FLAT_TBL[slot][stat];
        } else if (type === 'pct') {
          pctTotal[stat] += SPIRIT_PCT_TBL[slot][stat];
        }
      }
    }

    // ë¶€ê°€ì˜µ ê³„ì‚° ë° ì €ì¥
    const subEl = document.getElementById(`dragon_${dragonId}_sub`);
    if (subEl) {
      const subIdx = parseInt(subEl.value) || 0;
      dragon.spiritSlots.sub = subIdx;
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      extraTotal.hp = sub.hp;
      extraTotal.atk = sub.atk;
      extraTotal.df = sub.df;
    }

    // DragonConfig ì—…ë°ì´íŠ¸
    dragon.spirit.flat = flatTotal;
    dragon.spirit.pct = pctTotal;
    dragon.spirit.extra = extraTotal;

    // í•©ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateSpiritSummary(dragonId, flatTotal, pctTotal, extraTotal);
  }

  function updateSpiritSummary(dragonId, flat, pct, extra) {
    const summaryEl = document.getElementById(`dragon_${dragonId}_spirit_summary`);
    if (summaryEl) {
      summaryEl.innerHTML = `
        <div style="background:#e8f5e9;padding:4px 6px;border-radius:3px;font-size:11px;">
          <strong>ê³„ì‚°ëœ ì •ë ¹ ê°’:</strong><br>
          í”Œì˜µ: HP+${flat.hp} ATK+${flat.atk} DEF+${flat.df}<br>
          í¼ì˜µ: HP+${pct.hp}% ATK+${pct.atk}% DEF+${pct.df}%<br>
          ë¶€ê°€ì˜µ: HP+${extra.hp} ATK+${extra.atk} DEF+${extra.df}
        </div>
      `;
    }
  }

  // ë“œë˜ê³¤ ê¸°ë³¸ ìŠ¤íƒ¯ (ë“±ê¸‰ë³„/íƒ€ì…ë³„)
  const dragon={
   "7.0":{ê³µê²©í˜•:new Stats(876,285,161),ë°©ì–´í˜•:new Stats(788,185,283),ì²´ë ¥í˜•:new Stats(1252,176,176),ê³µë°©í˜•:new Stats(720,242,243),ì²´ê³µí˜•:new Stats(1080,262,133),ì²´ë°©í˜•:new Stats(1080,133,262)},
   "8.0":{ê³µê²©í˜•:new Stats(876,305,161),ë°©ì–´í˜•:new Stats(788,185,303),ì²´ë ¥í˜•:new Stats(1332,176,176),ê³µë°©í˜•:new Stats(720,252,253),ì²´ê³µí˜•:new Stats(1120,272,133),ì²´ë°©í˜•:new Stats(1120,133,272)},
   "9.0":{ê³µê²©í˜•:new Stats(876,325,161),ë°©ì–´í˜•:new Stats(788,185,323),ì²´ë ¥í˜•:new Stats(1412,176,176),ê³µë°©í˜•:new Stats(720,262,263),ì²´ê³µí˜•:new Stats(1160,282,133),ì²´ë°©í˜•:new Stats(1160,133,282)}
  };

  // ===== í•µì‹¬ ê³„ì‚° í•¨ìˆ˜ =====
  function eVal(s){return s.hp+4*s.atk+4*s.df;}
  function bVal(s){return s.hp*s.atk*s.df;}

  // ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚° (ëª¨ë“  ë³´ë„ˆìŠ¤ ì ìš©)
  function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
    const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
    const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
    const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                       Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                       Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
    const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
    const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
    const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
    const f = new Stats(
      s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
      s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
      s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
    );
    return [f, eVal(f), bVal(f)];
  }

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  // ëª¨ë“  ë“œë˜ê³¤ì˜ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ì´ˆê¸°í™”
  function resetAllDragonSpiritBuffs() {
    AppState.dragons.forEach(dragon => {
      // íœë˜íŠ¸ ì´ˆê¸°í™”
      dragon.pendant = { hp: 0, atk: 0, df: 0 };
      dragon.pendantSettings = { ver: 'v1', mode: 'ë‹¬', value: 12, stats: ['HP', 'ATK', 'DEF'] };
      // ì •ë ¹ ì´ˆê¸°í™”
      dragon.spirit.flat = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.pct = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.extra = { hp: 0, atk: 0, df: 0 };
      dragon.spiritSlots = { slot1: {stat:'none',type:'pct'}, slot2: {stat:'none',type:'pct'}, slot3: {stat:'none',type:'pct'}, slot4: {stat:'none',type:'pct'}, sub: 0 };
      // ë²„í”„/ë””ë²„í”„ ì´ˆê¸°í™”
      dragon.buff = { hp: 0, atk: 0, df: 0 };
      dragon.debuff = { hp: 0, atk: 0, df: 0 };
    });
    renderSpiritBuffSections();
  }

  // ===== ì¥ì‹ êµ¬ ì¦ê²¨ì°¾ê¸° ê´€ë¦¬ =====
  function resetFavorites() {
    const confirmed = confirm(
      'ì¥ì‹ êµ¬ ì¦ê²¨ì°¾ê¸°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'â€» ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    );

    if (confirmed) {
      try {
        localStorage.removeItem('accFavorites');
        alert('ì¦ê²¨ì°¾ê¸°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        location.reload();
      } catch (e) {
        console.error('ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  }

  // ===== ì¥ì‹ êµ¬ ë°ì´í„° í…Œì´ë¸” =====
  // í˜•ì‹: [ì´ë¦„, ë ˆë²¨, HP%, ATK%, DEF%]
  const ACC_TABLE = [ ["ì•…ë³´(ì²´)",20,20,0,0], ["ì—¬ë³´(ë°©)",20,0,0,20], ["í™©ë³´(ê³µ)",20,0,20,0], ["ë°”ë¿”(ê³µ/ë°©)",20,0,10,10], ["ë°”ë¿”(ì²´/ë°©)",20,10,0,10], ["ë°”ë¿”(ì²´/ê³µ)",20,10,10,0],
    ["ë°”ë¿”(ê³µ/ë°©)",19,0,10,9],["ë°”ë¿”(ì²´/ë°©)",19,10,0,9],["ë°”ë¿”(ê³µ/ì²´)",19,9,10,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",19,6,13,0],["ë¶ˆë¿”(ê³µ/ë°©)",19,0,13,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",19,13,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",19,13,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",19,0,6,13],["ëŒ€ë¿”(ë°©/ì²´)",19,6,0,13],
    ["ì—¬ë³´",19,0,0,19],["í™©ë³´",19,0,19,0],["ì•…ë³´",19,19,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",18,0,9,9],["ë°”ë¿”(ì²´/ë°©)",18,9,0,9],["ë°”ë¿”(ê³µ/ì²´)",18,9,9,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",18,6,12,0],["ë¶ˆë¿”(ê³µ/ë°©)",18,0,12,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",18,12,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",18,12,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",18,0,6,12],["ëŒ€ë¿”(ë°©/ì²´)",18,6,0,12],
    ["ì—¬ë³´",18,0,0,18],["í™©ë³´",18,0,18,0],["ì•…ë³´",18,18,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",17,0,9,8],["ë°”ë¿”(ì²´/ë°©)",17,9,0,8],["ë°”ë¿”(ê³µ/ì²´)",17,9,8,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",17,6,11,0],["ë¶ˆë¿”(ê³µ/ë°©)",17,0,11,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",17,11,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",17,11,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",17,0,6,11],["ëŒ€ë¿”(ë°©/ì²´)",17,6,0,11],
    ["ì—¬ë³´",17,0,0,17],["í™©ë³´",17,0,17,0],["ì•…ë³´",17,17,0,0],
  ];

  // ì „ì—­ ë³€ìˆ˜
  let accCheckboxes = [];
  let accFavorites = new Set();
  let showOnlyFavorites = false;

  // ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
  function loadFavorites() {
    try {
      const saved = localStorage.getItem('accFavorites');
      if (saved) {
        accFavorites = new Set(JSON.parse(saved));
      }
    } catch (e) {
      console.error('ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    }
  }

  // ì¦ê²¨ì°¾ê¸° ì €ì¥
  function saveFavorites() {
    try {
      localStorage.setItem('accFavorites', JSON.stringify([...accFavorites]));
    } catch (e) {
      console.error('ì¦ê²¨ì°¾ê¸° ì €ì¥ ì‹¤íŒ¨:', e);
    }
  }

  // ì¦ê²¨ì°¾ê¸° í† ê¸€
  function toggleFavorite(accId) {
    if (accFavorites.has(accId)) {
      accFavorites.delete(accId);
    } else {
      accFavorites.add(accId);
    }
    saveFavorites();
    renderAccessories();
  }

  function renderAccessories() {
    const accListEl = document.getElementById('accList');
    accListEl.innerHTML = '';
    accCheckboxes = [];

    // ì¦ê²¨ì°¾ê¸° ì •ë ¬: ì¦ê²¨ì°¾ê¸°ê°€ ìœ„ë¡œ
    const sortedTable = [...ACC_TABLE].map((r, i) => ({ data: r, index: i }))
      .sort((a, b) => {
        const aFav = accFavorites.has('acc_' + a.index);
        const bFav = accFavorites.has('acc_' + b.index);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return 0;
      });

    sortedTable.forEach(({ data: r, index: i }) => {
      const [n, l, h, a, d] = r;
      const id = 'acc_' + i;
      const isFavorite = accFavorites.has(id);

      // ì¦ê²¨ì°¾ê¸° í•„í„° ì ìš©
      if (showOnlyFavorites && !isFavorite) return;

      const line = document.createElement('div');
      line.style.cssText = 'display:flex;align-items:center;gap:6px;padding:2px 0;';

      const starBtn = document.createElement('button');
      starBtn.textContent = isFavorite ? 'â­' : 'â˜†';
      starBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:2px 6px;';
      starBtn.title = isFavorite ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€';
      starBtn.onclick = (e) => {
        e.preventDefault();
        toggleFavorite(id);
      };

      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}" onchange="onAccCheckboxChange()"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%`;
      label.style.flex = '1';

      line.appendChild(starBtn);
      line.appendChild(label);
      accListEl.appendChild(line);
      accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d, index: i });
    });

    // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateSelectedAccDisplay();
  }

  // ì¦ê²¨ì°¾ê¸° í•„í„° í† ê¸€
  function toggleFavoritesFilter() {
    showOnlyFavorites = !showOnlyFavorites;
    const btn = document.getElementById('btnToggleFavorites');
    if (btn) {
      btn.textContent = showOnlyFavorites ? 'ì „ì²´ ë³´ê¸°' : 'ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°';
      btn.classList.toggle('primary', showOnlyFavorites);
    }
    renderAccessories();
  }

  loadFavorites();
  renderAccessories();

  // ===== ê³„ì‚° ëª¨ë“œ ì „í™˜ =====
  function onCalcModeChange() {
    const mode = document.querySelector('input[name="calc_mode"]:checked')?.value || 'normal';
    const topNRow = document.getElementById('topNRow');

    if (mode === 'normal') {
      topNRow.style.display = 'block';
    } else {
      topNRow.style.display = 'none';
    }

    // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸ (ëª¨ë“œì— ë”°ë¼ UI ë³€ê²½)
    updateSelectedAccDisplay();
  }

  // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateSelectedAccDisplay() {
    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id)?.checked);
    const display = document.getElementById('selectedAccDisplay');
    const list = document.getElementById('selectedAccList');
    const isOptimize = document.querySelector('input[name="calc_mode"]:checked')?.value === 'optimize';

    if (selectedAcc.length === 0) {
      display.style.display = 'none';
      return;
    }

    display.style.display = 'block';

    if (isOptimize) {
      // Optimize ëª¨ë“œ: ê° ì¥ì‹ êµ¬ë³„ ê°œìˆ˜ ì…ë ¥
      list.innerHTML = selectedAcc.map((acc, idx) => {
        const currentQty = document.getElementById(`acc_qty_${acc.index}`)?.value || 1;
        return `<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">
          <span style="flex:1;">â€¢ ${acc.name} Lv${acc.level}</span>
          <span style="color:#666;font-size:12px;">(${acc.hp}/${acc.atk}/${acc.df})</span>
          <input type="number" id="acc_qty_${acc.index}" value="${currentQty}" min="1" max="9"
                 style="width:40px;height:24px;text-align:center;border:1px solid #ccc;border-radius:4px;">
        </div>`;
      }).join('');
    } else {
      // Normal ëª¨ë“œ: ë‹¨ìˆœ ëª©ë¡
      list.innerHTML = selectedAcc.map(acc =>
        `<div style="padding:2px 0;">â€¢ ${acc.name} Lv${acc.level} (HP+${acc.hp}% ATK+${acc.atk}% DEF+${acc.df}%)</div>`
      ).join('');
    }
  }

  // ì¥ì‹ êµ¬ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ í˜¸ì¶œ
  function onAccCheckboxChange() {
    updateSelectedAccDisplay();
  }

  function selectNone(){
    accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
    updateSelectedAccDisplay();
  }

  function toggleLevel(level){
    const filtered = accCheckboxes.filter(o => o.level === level);
    const allChecked = filtered.every(o => document.getElementById(o.id).checked);
    filtered.forEach(o => document.getElementById(o.id).checked = !allChecked);
    updateSelectedAccDisplay();
  }

  // ===== íœë˜íŠ¸ ì¡°í•© ìƒì„± =====
  function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
    const MAX = 6;
    const combos = [];

    if (total <= 0) return [[[0,0,0]]];

    // ì„ íƒëœ ìŠ¤íƒ¯ì˜ ì¸ë±ìŠ¤ ë°°ì—´ ìƒì„± (HP:0, ATK:1, DEF:2)
    const statIdx = [];
    if (selectedStats.includes("HP"))  statIdx.push(0);
    if (selectedStats.includes("ATK")) statIdx.push(1);
    if (selectedStats.includes("DEF")) statIdx.push(2);

    // ë‹¬ íœë˜íŠ¸: 2ìŠ¬ë¡¯
    if (mode === "ë‹¬") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          if (x+y === total)
            for (let i of statIdx)
              for (let j of statIdx) {
                const slot1=[0,0,0], slot2=[0,0,0];
                slot1[i]=x; slot2[j]=y;
                combos.push([slot1, slot2]);
              }
      return combos;
    }

    // íƒœì–‘ íœë˜íŠ¸: 3ìŠ¬ë¡¯
    if (mode === "íƒœì–‘") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          for (let z=1; z<=MAX; z++)
            if (x+y+z === total)
              for (let i of statIdx)
                for (let j of statIdx)
                  for (let k of statIdx) {
                    const slot1=[0,0,0], slot2=[0,0,0], slot3=[0,0,0];
                    slot1[i]=x; slot2[j]=y; slot3[k]=z;
                    combos.push([slot1, slot2, slot3]);
                  }
      return combos;
    }

    return [[[0,0,0]]];
  }

  // ===== ìë™ ê³„ì‚°ê¸° =====
  function calcAuto(){
    const resultBox = document.getElementById("autoResult");
    resultBox.innerHTML = '<div style="text-align:center;padding:40px;color:#666;"><div style="font-weight:700;margin-bottom:4px;">ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</div><small style="color:#999;">ì¡°í•©ì´ ë§ì„ ê²½ìš° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small></div>';

    // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§§ì€ ë”œë ˆì´
    setTimeout(async () => {
      await calcAutoCore();
    }, 50);
  }

  // ëª¨ë“  ë“œë˜ê³¤ì˜ íœë˜íŠ¸/ì •ë ¹/ë²„í”„/ë””ë²„í”„ ê°’ì„ UIì—ì„œ ì½ì–´ì„œ ì—…ë°ì´íŠ¸
  function syncAllDragonValues() {
    AppState.dragons.forEach(dragon => {
      // íœë˜íŠ¸ ì„¤ì • ë™ê¸°í™”
      updateDragonPendant(dragon.id);
      // ì •ë ¹ ìŠ¬ë¡¯ì—ì„œ ê³„ì‚°
      calculateSpiritFromSlots(dragon.id);
      // ë²„í”„/ë””ë²„í”„ë„ UIì—ì„œ ì½ê¸°
      dragon.buff.hp = Number(document.getElementById(`dragon_${dragon.id}_bf_hp`)?.value || 0);
      dragon.buff.atk = Number(document.getElementById(`dragon_${dragon.id}_bf_atk`)?.value || 0);
      dragon.buff.df = Number(document.getElementById(`dragon_${dragon.id}_bf_df`)?.value || 0);
      dragon.debuff.hp = Number(document.getElementById(`dragon_${dragon.id}_db_hp`)?.value || 0);
      dragon.debuff.atk = Number(document.getElementById(`dragon_${dragon.id}_db_atk`)?.value || 0);
      dragon.debuff.df = Number(document.getElementById(`dragon_${dragon.id}_db_df`)?.value || 0);
    });
  }

  // ë“œë˜ê³¤ë³„ íœë˜íŠ¸ ì¡°í•© ìƒì„± í•¨ìˆ˜
  function getDragonPendantCombinations(dragonConfig) {
    const ps = dragonConfig.pendantSettings;
    const ver = ps.ver;
    const mode = ps.mode;
    const value = ps.value;
    const stats = ps.stats;

    if (ver === 'v3') {
      // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ
      const ph = dragonConfig.pendant.hp / 100;
      const pa = dragonConfig.pendant.atk / 100;
      const pd = dragonConfig.pendant.df / 100;
      const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
      return {
        combinations: [[[ph, pa, pd]]],
        manualStr: `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`,
        ver: ver,
        mode: 'ìˆ˜ë™ì…ë ¥'
      };
    } else {
      // ìë™/ì§€ì • ëª¨ë“œ
      const maxValues = {ë‹¬:12, íƒœì–‘:18};
      const limit = maxValues[mode] || 0;
      if (value > limit || value <= 0) {
        return { combinations: [], manualStr: '', ver: ver, mode: mode, error: true };
      }
      const selectedStats = (ver === 'v2') ? stats : ['HP', 'ATK', 'DEF'];
      const combinations = genPend(value, mode, selectedStats);
      return {
        combinations: combinations,
        manualStr: '',
        ver: ver,
        mode: mode
      };
    }
  }

  async function calcAutoCore(){
    const resultBox = document.getElementById("autoResult");

    // 0. ëª¨ë“  ë“œë˜ê³¤ì˜ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ê°’ ë™ê¸°í™”
    syncAllDragonValues();

    // 1. ë“œë˜ê³¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (AppState.dragons.length === 0) {
      resultBox.textContent = "ë“œë˜ê³¤ì´ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
      return;
    }

    // 2. ì ¬ ê¸°ë³¸ê°’
    const gemBase = {
      hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 160),
      atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 40),
      df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 40)
    };

    // 3. ì¥ì‹ êµ¬ ì„ íƒ í™•ì¸
    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id).checked);
    if (!selectedAcc.length) {
      resultBox.textContent = "ì¥ì‹ êµ¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      return;
    }

    // ìƒìˆ˜ ë° ê¸°íƒ€
    const topN = Number(document.getElementById("top_n").value || 5);
    const ENCHANT = 21;  // ì¸ì²¸íŠ¸ % (HP/ATK/DEF ê° ë°©í–¥)
    const pot = new Stats(24, 6, 6);    // í¬í…ì…œ (ê³ ì •)
    const col = new Stats(240, 60, 60); // ìˆ˜ì§‘ íš¨ê³¼ (ê³ ì •)

    // 4. ê³„ì‚° ëª¨ë“œ í™•ì¸
    const calcMode = document.querySelector('input[name="calc_mode"]:checked')?.value || 'normal';

    // Optimize ëª¨ë“œ: ë“œë˜ê³¤ë³„ ìµœì  ì¥ì‹ êµ¬ ë°°ë¶„ ê³„ì‚°
    if (calcMode === 'optimize') {
      // ê° ì¥ì‹ êµ¬ë³„ ë³´ìœ  ê°œìˆ˜ ìˆ˜ì§‘
      const accInventoryMap = new Map();
      selectedAcc.forEach(acc => {
        const qty = Number(document.getElementById(`acc_qty_${acc.index}`)?.value || 1);
        accInventoryMap.set(acc.index, qty);
      });
      await calcAutoOptimizeMode(selectedAcc, gemBase, pot, col, ENCHANT, accInventoryMap);
      return;
    }

    // Normal ëª¨ë“œ: ë“œë˜ê³¤ë³„ë¡œ ëª¨ë“  ì¥ì‹ êµ¬ ì ìš©
    const allResults = [];

    AppState.dragons.forEach((dragonConfig) => {
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];

      // ë“œë˜ê³¤ë³„ íœë˜íŠ¸ ì¡°í•© ìƒì„±
      const pendantData = getDragonPendantCombinations(dragonConfig);
      if (pendantData.error) {
        return; // íœë˜íŠ¸ ì„¤ì • ì˜¤ë¥˜ ì‹œ í•´ë‹¹ ë“œë˜ê³¤ ìŠ¤í‚µ
      }
      const pendantCombinations = pendantData.combinations;
      const pendantVer = pendantData.ver;
      const pendantMode = pendantData.mode;
      const manualPendantStr = pendantData.manualStr;

      // ë“œë˜ê³¤ë³„ ì •ë ¹/ë²„í”„/ë””ë²„í”„
      const spiritFlat = new Stats(
        dragonConfig.spirit.flat.hp,
        dragonConfig.spirit.flat.atk,
        dragonConfig.spirit.flat.df
      );
      const spiritPct = new Stats(
        dragonConfig.spirit.pct.hp / 100,
        dragonConfig.spirit.pct.atk / 100,
        dragonConfig.spirit.pct.df / 100
      );
      const spiritExtra = new Stats(
        dragonConfig.spirit.extra.hp,
        dragonConfig.spirit.extra.atk,
        dragonConfig.spirit.extra.df
      );
      const buff = new Stats(
        dragonConfig.buff.hp / 100,
        dragonConfig.buff.atk / 100,
        dragonConfig.buff.df / 100
      );
      const debuff = new Stats(
        dragonConfig.debuff.hp / 100,
        dragonConfig.debuff.atk / 100,
        dragonConfig.debuff.df / 100
      );

      const dragonResults = [];

      for (const accessory of selectedAcc) {
        const accPctBase = {
          hp: accessory.hp / 100,
          atk: accessory.atk / 100,
          df: accessory.df / 100
        };

        // ì ¬ 5ì¹¸ ë¶„ë°° (HP + ATK + DEF = 5)
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(
              gemBase.hp * hpGems,
              gemBase.atk * atkGems,
              gemBase.df * defGems
            );

            // ì¸ì²¸íŠ¸ ë°©í–¥ (HP, ATK, DEF ì¤‘ í•˜ë‚˜)
            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(
                accPctBase.hp + enchantBonus.hp,
                accPctBase.atk + enchantBonus.atk,
                accPctBase.df + enchantBonus.df
              );

              // íœë˜íŠ¸ ì¡°í•©
              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                // ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚°
                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                // ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
                const pendantSlotStr = (pendantVer === "v3")
                  ? manualPendantStr
                  : pendant.map(slot =>
                      ["HP","ATK","DEF"]
                        .map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "")
                        .filter(Boolean)
                        .join(" ")
                    ).join(" / ");

                const pendantLabel = (pendantVer === "v3") ? "ìˆ˜ë™ì…ë ¥" : pendantMode;
                const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                dragonResults.push({
                  B: bValue,
                  dragonNumber: dragonConfig.displayNumber,
                  dragonGrade: dragonConfig.grade,
                  dragonType: dragonConfig.type,
                  accessory: `${accessory.name} Lv${accessory.level}`,
                  gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                  gemDetail: { counts: { hp: hpGems, atk: atkGems, df: defGems }, values: { hp: gemBase.hp, atk: gemBase.atk, df: gemBase.df } },
                  pendant: `${pendantLabel} (${pendantSlotStr})`,
                  enchant: `${enchantLabel} +${ENCHANT}%`,
                  finalStats,
                  eValue,
                  spirit: {
                    flat: { hp: dragonConfig.spirit.flat.hp, atk: dragonConfig.spirit.flat.atk, df: dragonConfig.spirit.flat.df },
                    pct: { hp: dragonConfig.spirit.pct.hp, atk: dragonConfig.spirit.pct.atk, df: dragonConfig.spirit.pct.df },
                    extra: { hp: dragonConfig.spirit.extra.hp, atk: dragonConfig.spirit.extra.atk, df: dragonConfig.spirit.extra.df }
                  },
                  spiritSlots: JSON.parse(JSON.stringify(dragonConfig.spiritSlots)),
                  buff: { hp: dragonConfig.buff.hp, atk: dragonConfig.buff.atk, df: dragonConfig.buff.df },
                  debuff: { hp: dragonConfig.debuff.hp, atk: dragonConfig.debuff.atk, df: dragonConfig.debuff.df }
                });
              }
            }
          }
        }
      }

      // ë“œë˜ê³¤ë³„ ìƒìœ„ ê²°ê³¼ ì €ì¥
      dragonResults.sort((a, b) => b.B - a.B);
      allResults.push({
        dragonNumber: dragonConfig.displayNumber,
        dragonGrade: dragonConfig.grade,
        dragonType: dragonConfig.type,
        results: dragonResults.slice(0, topN)
      });
    });

    // 7. ê²°ê³¼ë¥¼ ì „ì—­ì— ì €ì¥ (ìˆ˜ë™ê³„ì‚°ê¸° ì ìš©ìš©)
    window._lastAutoResults = allResults;

    // 8. ê²°ê³¼ ì¶œë ¥ (íƒ­ í˜•ì‹)
    if (!allResults.length || allResults.every(d => d.results.length === 0)) {
      resultBox.innerHTML = '<div style="color:#999;text-align:center;padding:10px;">ê²°ê³¼ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    // ê²°ê³¼ íƒ­ ìƒì„±
    let tabsHtml = '<div class="dragon-tabs" style="margin-bottom:4px;">';
    allResults.forEach((dragonResult, dragonIdx) => {
      tabsHtml += `<button class="dragon-tab ${dragonIdx === 0 ? 'active' : ''}" onclick="switchResultTab(${dragonIdx})" data-result-idx="${dragonIdx}">ë“œë˜ê³¤ ${dragonResult.dragonNumber}</button>`;
    });
    tabsHtml += '</div>';

    // ê²°ê³¼ íŒ¨ë„ ìƒì„±
    let panelsHtml = '';

    allResults.forEach((dragonResult, dragonIdx) => {
      panelsHtml += `<div class="dragon-settings-panel ${dragonIdx === 0 ? 'active' : ''}" id="resultPanel_${dragonIdx}">`;
      panelsHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      panelsHtml += `â˜… ë“œë˜ê³¤ ${dragonResult.dragonNumber} (${dragonResult.dragonGrade} / ${dragonResult.dragonType})`;
      panelsHtml += `</div>`;

      dragonResult.results.forEach((r, i) => {
        const spiritStr = formatSpiritStr(r.spirit, r.spiritSlots);

        // ë²„í”„/ë””ë²„í”„ ë¬¸ìì—´ ìƒì„±
        const buffParts = [];
        if (r.buff?.hp > 0) buffParts.push(`HP${r.buff.hp}%`);
        if (r.buff?.atk > 0) buffParts.push(`ATK${r.buff.atk}%`);
        if (r.buff?.df > 0) buffParts.push(`DEF${r.buff.df}%`);
        const buffStr = buffParts.length > 0 ? buffParts.join(' ') : '-';

        const debuffParts = [];
        if (r.debuff?.hp > 0) debuffParts.push(`HP${r.debuff.hp}%`);
        if (r.debuff?.atk > 0) debuffParts.push(`ATK${r.debuff.atk}%`);
        if (r.debuff?.df > 0) debuffParts.push(`DEF${r.debuff.df}%`);
        const debuffStr = debuffParts.length > 0 ? debuffParts.join(' ') : '-';

        const hasBuffDebuff = buffStr !== '-' || debuffStr !== '-';

        panelsHtml += `
          <div class="result-item" onclick="applyResultToManual(${dragonIdx}, ${i})"
               style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
               onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
            <div style="font-weight:600;color:#1565c0;">[${i + 1}ìœ„] ${r.dragonType} | ${r.accessory}</div>
            <div style="font-size:13px;color:#666;">ì ¬: ${r.gems} | íœë˜íŠ¸: ${r.pendant} | ì¸ì²¸íŠ¸: ${r.enchant}</div>
            <div style="font-size:13px;color:#9c27b0;">ì •ë ¹: ${spiritStr}</div>
            ${hasBuffDebuff ? `<div style="font-size:13px;"><span style="color:#4caf50;">ë²„í”„: ${buffStr}</span> | <span style="color:#f44336;">ë””ë²„í”„: ${debuffStr}</span></div>` : ''}
            <div style="font-size:13px;margin-top:4px;">
              HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
              E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
            </div>
          </div>
        `;
      });

      panelsHtml += `</div>`;
    });

    resultBox.innerHTML = tabsHtml + panelsHtml;
  }

  // ì •ë ¹ ìŠ¬ë¡¯ë³„ ë¬¸ìì—´ í¬ë§· (ì˜ˆ: ATK(24%),DEF(28%),HP(32%),ATK(+120) / ë¶€ê°€ì˜µ: HP+40)
  function formatSpiritStr(spirit, spiritSlots) {
    if (!spiritSlots) return '-';
    const slotParts = [];
    const statNames = { hp: 'HP', atk: 'ATK', df: 'DEF' };

    // ìŠ¬ë¡¯ 1~4 ìˆœì„œëŒ€ë¡œ
    for (let slot = 1; slot <= 4; slot++) {
      const slotData = spiritSlots[`slot${slot}`];
      if (!slotData || slotData.stat === 'none') continue;

      const stat = slotData.stat;
      const type = slotData.type;
      const name = statNames[stat] || stat.toUpperCase();

      if (type === 'flat') {
        const value = SPIRIT_FLAT_TBL[slot][stat];
        slotParts.push(`${name}(+${value})`);
      } else if (type === 'pct') {
        const value = SPIRIT_PCT_TBL[slot][stat];
        slotParts.push(`${name}(${value}%)`);
      }
    }

    // ë¶€ê°€ì˜µ ë¶„ë¦¬
    let result = slotParts.length > 0 ? slotParts.join(',') : '-';
    const subIdx = spiritSlots.sub || 0;
    if (subIdx > 0) {
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      let subStr = '';
      if (sub.hp > 0) subStr = `HP+${sub.hp}`;
      if (sub.atk > 0) subStr = `ATK+${sub.atk}`;
      if (sub.df > 0) subStr = `DEF+${sub.df}`;
      if (subStr) result += ` / ë¶€ê°€ì˜µ: ${subStr}`;
    }

    return result;
  }

  // ê²°ê³¼ íƒ­ ì „í™˜
  function switchResultTab(idx) {
    document.querySelectorAll('#autoResult .dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#autoResult .dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    document.querySelector(`#autoResult .dragon-tab[data-result-idx="${idx}"]`)?.classList.add('active');
    document.getElementById(`resultPanel_${idx}`)?.classList.add('active');
  }

  // ê²°ê³¼ í´ë¦­ ì‹œ ìˆ˜ë™ê³„ì‚°ê¸°ì— ì ìš©
  function applyResultToManual(dragonIdx, resultIdx) {
    if (!window._lastAutoResults || !window._lastAutoResults[dragonIdx]) {
      alert('ê²°ê³¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const dragonResult = window._lastAutoResults[dragonIdx];
    const result = dragonResult.results[resultIdx];
    if (!result) {
      alert('ê²°ê³¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ìˆ˜ë™ê³„ì‚°ê¸°ì˜ í•´ë‹¹ ë“œë˜ê³¤ ì¸ë±ìŠ¤ (1-based)
    const manualIdx = dragonResult.dragonNumber;

    // ìˆ˜ë™ê³„ì‚°ê¸°ì— ë“œë˜ê³¤ì´ ì—†ìœ¼ë©´ ìë™ ì¶”ê°€
    let needsRender = false;
    while (ManualDragonState.dragons.length < manualIdx) {
      if (ManualDragonState.dragons.length >= ManualDragonState.maxDragons) {
        alert(`ìµœëŒ€ ${ManualDragonState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return;
      }
      const newDragon = new ManualDragonConfig(ManualDragonState.nextId++, dragonResult.dragonGrade, dragonResult.dragonType);
      newDragon.displayNumber = ManualDragonState.dragons.length + 1;
      ManualDragonState.dragons.push(newDragon);
      needsRender = true;
    }
    if (needsRender) {
      renderAllManual();
      updateManualDragonCount();
    }

    // ë“±ê¸‰/íƒ€ì… ì ìš©
    const levelEl = document.getElementById(`d${manualIdx}_m_level`);
    const typeEl = document.getElementById(`d${manualIdx}_m_type`);
    if (levelEl) levelEl.value = dragonResult.dragonGrade;
    if (typeEl) typeEl.value = dragonResult.dragonType;

    // ì ¬ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "HP2 ATK0 DEF3")
    const gemMatch = result.gems.match(/HP(\d+)\s+ATK(\d+)\s+DEF(\d+)/);
    if (gemMatch) {
      const hpCount = parseInt(gemMatch[1]);
      const atkCount = parseInt(gemMatch[2]);
      const defCount = parseInt(gemMatch[3]);

      const gemBase = {
        hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 156),
        atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 39),
        df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 39)
      };

      let slotIdx = 1;
      // HP ì ¬
      for (let i = 0; i < hpCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'HP', gemBase.hp);
      }
      // ATK ì ¬
      for (let i = 0; i < atkCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'ATK', gemBase.atk);
      }
      // DEF ì ¬
      for (let i = 0; i < defCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'DEF', gemBase.df);
      }
    }

    // ì¥ì‹ êµ¬ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ë°”ë¿”(ì²´/ë°©) Lv20")
    const accMatch = result.accessory.match(/(.+)\s+Lv(\d+)/);
    if (accMatch) {
      const accName = accMatch[1];
      const accLevel = parseInt(accMatch[2]);

      // ACC_TABLEì—ì„œ í•´ë‹¹ ì¥ì‹ êµ¬ ì°¾ê¸°
      const accIndex = ACC_TABLE.findIndex(acc => acc[0] === accName && acc[1] === accLevel);
      if (accIndex !== -1) {
        const accId = `acc_${accIndex}`;
        const accSelect = document.getElementById(`d${manualIdx}_acc_select`);
        if (accSelect) {
          accSelect.value = accId;
          onManualAccessoryChange(manualIdx, accId);
        }
      }
    }

    // ì¸ì²¸íŠ¸ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ATK +21%")
    const enchMatch = result.enchant.match(/(HP|ATK|DEF)\s+\+(\d+)%/);
    if (enchMatch) {
      const enchStat = enchMatch[1];
      const enchValue = parseInt(enchMatch[2]);

      document.getElementById(`d${manualIdx}_m_ench_hp`).value = enchStat === 'HP' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_atk`).value = enchStat === 'ATK' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_df`).value = enchStat === 'DEF' ? enchValue : 0;
    }

    // íœë˜íŠ¸ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ë‹¬ (HP6 / ATK6)")
    const pendMatch = result.pendant.match(/\(([^)]+)\)/);
    if (pendMatch) {
      const pendParts = pendMatch[1].split('/').map(s => s.trim());
      let pendHp = 0, pendAtk = 0, pendDf = 0;

      pendParts.forEach(part => {
        const m = part.match(/(HP|ATK|DEF)(\d+)/);
        if (m) {
          if (m[1] === 'HP') pendHp += parseInt(m[2]);
          else if (m[1] === 'ATK') pendAtk += parseInt(m[2]);
          else if (m[1] === 'DEF') pendDf += parseInt(m[2]);
        }
      });

      document.getElementById(`d${manualIdx}_m_pend_hp`).value = pendHp;
      document.getElementById(`d${manualIdx}_m_pend_atk`).value = pendAtk;
      document.getElementById(`d${manualIdx}_m_pend_df`).value = pendDf;
    }

    // ê²°ê³¼ ê°ì²´ì—ì„œ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ë³µì‚¬
    if (result.spirit) {
      document.getElementById(`d${manualIdx}_sf_hp`).value = result.spirit.flat.hp;
      document.getElementById(`d${manualIdx}_sf_atk`).value = result.spirit.flat.atk;
      document.getElementById(`d${manualIdx}_sf_df`).value = result.spirit.flat.df;
      document.getElementById(`d${manualIdx}_sp_hp`).value = result.spirit.pct.hp;
      document.getElementById(`d${manualIdx}_sp_atk`).value = result.spirit.pct.atk;
      document.getElementById(`d${manualIdx}_sp_df`).value = result.spirit.pct.df;
      document.getElementById(`d${manualIdx}_se_hp`).value = result.spirit.extra.hp;
      document.getElementById(`d${manualIdx}_se_atk`).value = result.spirit.extra.atk;
      document.getElementById(`d${manualIdx}_se_df`).value = result.spirit.extra.df;
    }

    // ì •ë ¹ ìŠ¬ë¡¯ë„ ë³µì‚¬ (ìŠ¬ë¡¯ ì„ íƒ ëª¨ë“œ UI ì—…ë°ì´íŠ¸)
    if (result.spiritSlots) {
      const dragon = ManualDragonState.dragons.find(d => d.displayNumber === manualIdx);
      if (dragon) {
        dragon.spiritSlots = JSON.parse(JSON.stringify(result.spiritSlots));
      }
      // ìŠ¬ë¡¯ UI ì—…ë°ì´íŠ¸
      for (let slot = 1; slot <= 4; slot++) {
        const slotData = result.spiritSlots[`slot${slot}`];
        const statEl = document.getElementById(`d${manualIdx}_slot${slot}_stat`);
        const typeEl = document.getElementById(`d${manualIdx}_slot${slot}_type`);
        if (statEl) statEl.value = slotData.stat;
        if (typeEl) typeEl.value = slotData.type;
      }
      const subEl = document.getElementById(`d${manualIdx}_sub`);
      if (subEl) subEl.value = result.spiritSlots.sub;

      // ìš”ì•½ ì—…ë°ì´íŠ¸
      calculateManualSpiritFromSlots(manualIdx);
    }

    if (result.buff) {
      document.getElementById(`d${manualIdx}_bf_hp`).value = result.buff.hp;
      document.getElementById(`d${manualIdx}_bf_atk`).value = result.buff.atk;
      document.getElementById(`d${manualIdx}_bf_df`).value = result.buff.df;
    }
    if (result.debuff) {
      document.getElementById(`d${manualIdx}_db_hp`).value = result.debuff.hp;
      document.getElementById(`d${manualIdx}_db_atk`).value = result.debuff.atk;
      document.getElementById(`d${manualIdx}_db_df`).value = result.debuff.df;
    }

    // ì ìš© ì™„ë£Œ í‘œì‹œ (íƒ­ ì´ë™ ì—†ì´)
    const resultItem = event?.target?.closest('.result-item');
    if (resultItem) {
      resultItem.style.background = '#c8e6c9';
      setTimeout(() => { resultItem.style.background = '#f8f9fa'; }, 1000);
    }
  }

  // ì ¬ ìŠ¬ë¡¯ ì ìš© í—¬í¼ í•¨ìˆ˜
  function applyGemSlot(manualIdx, slotIdx, type, value) {
    const typeSelect = document.getElementById(`d${manualIdx}_slot_type_${slotIdx}`);
    const valSelect = document.getElementById(`d${manualIdx}_slot_val_${slotIdx}`);
    if (typeSelect) {
      typeSelect.value = type;
      typeSelect.dispatchEvent(new Event('change'));
      // ìŠ¬ë¡¯ë³„ë¡œ ë”œë ˆì´ë¥¼ ë‹¤ë¥´ê²Œ í•´ì„œ ì¶©ëŒ ë°©ì§€
      setTimeout(() => { if (valSelect) valSelect.value = value; }, 50 * slotIdx);
    }
  }

  // ===== Optimize ëª¨ë“œ ê³„ì‚° =====
  async function calcAutoOptimizeMode(selectedAcc, gemBase, pot, col, ENCHANT, accInventoryMap) {
    const resultBox = document.getElementById("autoResult");

    // tqdm ìŠ¤íƒ€ì¼ ì§„í–‰ë¥  í‘œì‹œ
    function showProgress(percent) {
      const filled = Math.round(percent / 5);
      const empty = 20 - filled;
      const bar = 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty);
      resultBox.innerHTML = `<div style="padding:30px;text-align:center;font-family:monospace;font-size:14px;color:#333;">${bar} ${percent}%</div>`;
    }
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    showProgress(0);
    await delay(20);

    // ëª¨ë“  ë“œë˜ê³¤ì˜ íœë˜íŠ¸/ì •ë ¹/ë²„í”„/ë””ë²„í”„ ê°’ ë™ê¸°í™”
    syncAllDragonValues();
    showProgress(5);
    await delay(20);

    // ê° ë“œë˜ê³¤ì— ëŒ€í•´ ê° ì¥ì‹ êµ¬ì˜ ìµœì  Bê°’ ê³„ì‚°
    const dragonAccScores = [];

    for (let dragonIdx = 0; dragonIdx < AppState.dragons.length; dragonIdx++) {
      const dragonConfig = AppState.dragons[dragonIdx];
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];
      const spiritFlat = new Stats(dragonConfig.spirit.flat.hp, dragonConfig.spirit.flat.atk, dragonConfig.spirit.flat.df);
      const spiritPct = new Stats(dragonConfig.spirit.pct.hp / 100, dragonConfig.spirit.pct.atk / 100, dragonConfig.spirit.pct.df / 100);
      const spiritExtra = new Stats(dragonConfig.spirit.extra.hp, dragonConfig.spirit.extra.atk, dragonConfig.spirit.extra.df);
      const buff = new Stats(dragonConfig.buff.hp / 100, dragonConfig.buff.atk / 100, dragonConfig.buff.df / 100);
      const debuff = new Stats(dragonConfig.debuff.hp / 100, dragonConfig.debuff.atk / 100, dragonConfig.debuff.df / 100);

      // ë“œë˜ê³¤ë³„ íœë˜íŠ¸ ì¡°í•© ìƒì„±
      const pendantData = getDragonPendantCombinations(dragonConfig);
      if (pendantData.error) {
        dragonAccScores.push({ dragonIdx, dragonConfig, accScores: [] });
        continue;
      }
      const pendantCombinations = pendantData.combinations;
      const pendantVer = pendantData.ver;
      const pendantMode = pendantData.mode;
      const manualPendantStr = pendantData.manualStr;

      const accScores = [];

      selectedAcc.forEach((accessory, accIdx) => {
        let bestResult = null;
        let bestB = -Infinity;

        const accPctBase = { hp: accessory.hp / 100, atk: accessory.atk / 100, df: accessory.df / 100 };

        // ëª¨ë“  ì¡°í•© ì¤‘ ìµœê³  Bê°’ ì°¾ê¸°
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(gemBase.hp * hpGems, gemBase.atk * atkGems, gemBase.df * defGems);

            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(accPctBase.hp + enchantBonus.hp, accPctBase.atk + enchantBonus.atk, accPctBase.df + enchantBonus.df);

              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                if (bValue > bestB) {
                  bestB = bValue;
                  const pendantSlotStr = (pendantVer === "v3") ? manualPendantStr : pendant.map(slot =>
                    ["HP","ATK","DEF"].map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "").filter(Boolean).join(" ")
                  ).join(" / ");
                  const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                  bestResult = {
                    B: bValue,
                    dragonNumber: dragonConfig.displayNumber,
                    dragonGrade: dragonConfig.grade,
                    dragonType: dragonConfig.type,
                    accessory: `${accessory.name} Lv${accessory.level}`,
                    accIdx: accIdx,
                    accIndex: accessory.index,
                    gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                    gemDetail: { counts: { hp: hpGems, atk: atkGems, df: defGems }, values: { hp: gemBase.hp, atk: gemBase.atk, df: gemBase.df } },
                    pendant: `${pendantVer === "v3" ? "ìˆ˜ë™ì…ë ¥" : pendantMode} (${pendantSlotStr})`,
                    enchant: `${enchantLabel} +${ENCHANT}%`,
                    finalStats,
                    eValue,
                    spirit: {
                      flat: { hp: dragonConfig.spirit.flat.hp, atk: dragonConfig.spirit.flat.atk, df: dragonConfig.spirit.flat.df },
                      pct: { hp: dragonConfig.spirit.pct.hp, atk: dragonConfig.spirit.pct.atk, df: dragonConfig.spirit.pct.df },
                      extra: { hp: dragonConfig.spirit.extra.hp, atk: dragonConfig.spirit.extra.atk, df: dragonConfig.spirit.extra.df }
                    },
                    spiritSlots: JSON.parse(JSON.stringify(dragonConfig.spiritSlots)),
                    buff: { hp: dragonConfig.buff.hp, atk: dragonConfig.buff.atk, df: dragonConfig.buff.df },
                    debuff: { hp: dragonConfig.debuff.hp, atk: dragonConfig.debuff.atk, df: dragonConfig.debuff.df }
                  };
                }
              }
            }
          }
        }

        accScores.push({ accIdx, bestB, bestResult });
      });

      dragonAccScores.push({ dragonIdx, dragonConfig, accScores });
      const progressPct = Math.round(10 + (dragonIdx + 1) / AppState.dragons.length * 60);
      showProgress(progressPct);
      await delay(10);
    }

    showProgress(75);
    await delay(20);

    // Hungarian ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœì  ë¶„ë°° (ì „ì—­ ìµœì í•´ ë³´ì¥)
    // ì¥ì‹ êµ¬ ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ ìƒì„± (ë³´ìœ  ê°œìˆ˜ë§Œí¼ ê°€ìƒ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±)
    const accInstances = [];
    selectedAcc.forEach((accData, accIdx) => {
      const accIndex = accData.index;
      const inventory = accInventoryMap.get(accIndex) || 1;
      for (let i = 0; i < inventory; i++) {
        accInstances.push({ accIdx, accIndex, instanceNum: i });
      }
    });

    const numDragons = AppState.dragons.length;
    const numInstances = accInstances.length;

    // Bê°’ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±: matrix[dragonIdx][instanceIdx] = bestB
    // ë™ì‹œì— ê²°ê³¼ ë§¤íŠ¸ë¦­ìŠ¤ë„ ì €ì¥
    const bMatrix = [];
    const resultMatrix = [];
    let maxB = 0;

    for (let d = 0; d < numDragons; d++) {
      bMatrix[d] = [];
      resultMatrix[d] = [];
      const dragonData = dragonAccScores[d];
      for (let i = 0; i < numInstances; i++) {
        const instance = accInstances[i];
        const accScore = dragonData.accScores.find(s => s.accIdx === instance.accIdx);
        if (accScore && accScore.bestResult) {
          bMatrix[d][i] = accScore.bestB;
          resultMatrix[d][i] = accScore.bestResult;
          if (accScore.bestB > maxB) maxB = accScore.bestB;
        } else {
          bMatrix[d][i] = 0;
          resultMatrix[d][i] = null;
        }
      }
    }

    // Hungarian ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„ (Kuhn-Munkres)
    // ìµœëŒ€í™” ë¬¸ì œë¥¼ ìµœì†Œí™”ë¡œ ë³€í™˜: cost = maxB - bValue
    function hungarianAlgorithm(profitMatrix, n, m) {
      // n = ë“œë˜ê³¤ ìˆ˜, m = ì¥ì‹ êµ¬ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜
      // íŒ¨ë”©í•˜ì—¬ ì •ì‚¬ê° í–‰ë ¬ë¡œ ë§Œë“¦
      const size = Math.max(n, m);
      const cost = [];
      for (let i = 0; i < size; i++) {
        cost[i] = [];
        for (let j = 0; j < size; j++) {
          if (i < n && j < m) {
            cost[i][j] = maxB - profitMatrix[i][j];
          } else {
            cost[i][j] = maxB; // ë”ë¯¸ ì…€ì€ ë†’ì€ ë¹„ìš©
          }
        }
      }

      const u = new Array(size + 1).fill(0);
      const v = new Array(size + 1).fill(0);
      const p = new Array(size + 1).fill(0);
      const way = new Array(size + 1).fill(0);
      const INF = 1e18;

      for (let i = 1; i <= n; i++) {
        p[0] = i;
        let j0 = 0;
        const minv = new Array(size + 1).fill(INF);
        const used = new Array(size + 1).fill(false);

        do {
          used[j0] = true;
          const i0 = p[j0];
          let delta = INF;
          let j1 = 0;

          for (let j = 1; j <= size; j++) {
            if (!used[j]) {
              const cur = cost[i0 - 1][j - 1] - u[i0] - v[j];
              if (cur < minv[j]) {
                minv[j] = cur;
                way[j] = j0;
              }
              if (minv[j] < delta) {
                delta = minv[j];
                j1 = j;
              }
            }
          }

          for (let j = 0; j <= size; j++) {
            if (used[j]) {
              u[p[j]] += delta;
              v[j] -= delta;
            } else {
              minv[j] -= delta;
            }
          }

          j0 = j1;
        } while (p[j0] !== 0);

        do {
          const j1 = way[j0];
          p[j0] = p[j1];
          j0 = j1;
        } while (j0);
      }

      // ê²°ê³¼ ì¶”ì¶œ: assignment[dragonIdx] = instanceIdx
      const assignment = new Array(n).fill(-1);
      for (let j = 1; j <= size; j++) {
        if (p[j] > 0 && p[j] <= n && j <= m) {
          assignment[p[j] - 1] = j - 1;
        }
      }
      return assignment;
    }

    const optimalAssignment = hungarianAlgorithm(bMatrix, numDragons, numInstances);
    showProgress(90);
    await delay(20);

    // ê²°ê³¼ ì¡°ë¦½
    const assignments = [];
    for (let d = 0; d < numDragons; d++) {
      const instIdx = optimalAssignment[d];
      if (instIdx >= 0 && resultMatrix[d][instIdx]) {
        assignments.push({
          dragonIdx: d,
          accIdx: accInstances[instIdx].accIdx,
          accIndex: accInstances[instIdx].accIndex,
          bestB: bMatrix[d][instIdx],
          bestResult: resultMatrix[d][instIdx]
        });
      }
    }

    // ê²°ê³¼ë¥¼ ë“œë˜ê³¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    assignments.sort((a, b) => a.dragonIdx - b.dragonIdx);
    showProgress(100);
    await delay(30);

    // ì „ì—­ì— ì €ì¥
    const allResults = assignments.map(a => ({
      dragonNumber: a.bestResult.dragonNumber,
      dragonGrade: a.bestResult.dragonGrade,
      dragonType: a.bestResult.dragonType,
      results: [a.bestResult]
    }));
    window._lastAutoResults = allResults;

    // ê²°ê³¼ ì¶œë ¥
    let outputHtml = '';
    let totalB = 0;

    assignments.forEach((assign, idx) => {
      const r = assign.bestResult;
      totalB += r.B;
      const spiritStr = formatSpiritStr(r.spirit, r.spiritSlots);

      // ë²„í”„/ë””ë²„í”„ ë¬¸ìì—´ ìƒì„±
      const buffParts = [];
      if (r.buff?.hp > 0) buffParts.push(`HP${r.buff.hp}%`);
      if (r.buff?.atk > 0) buffParts.push(`ATK${r.buff.atk}%`);
      if (r.buff?.df > 0) buffParts.push(`DEF${r.buff.df}%`);
      const buffStr = buffParts.length > 0 ? buffParts.join(' ') : '-';

      const debuffParts = [];
      if (r.debuff?.hp > 0) debuffParts.push(`HP${r.debuff.hp}%`);
      if (r.debuff?.atk > 0) debuffParts.push(`ATK${r.debuff.atk}%`);
      if (r.debuff?.df > 0) debuffParts.push(`DEF${r.debuff.df}%`);
      const debuffStr = debuffParts.length > 0 ? debuffParts.join(' ') : '-';

      const hasBuffDebuff = buffStr !== '-' || debuffStr !== '-';

      outputHtml += `<div style="margin-bottom:15px;">`;
      outputHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      outputHtml += `â˜… ë“œë˜ê³¤ ${r.dragonNumber} (${r.dragonGrade} / ${r.dragonType})`;
      outputHtml += `</div>`;
      outputHtml += `
        <div class="result-item" onclick="applyResultToManual(${idx}, 0)"
             style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
             onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
          <div style="font-weight:600;color:#1565c0;">[ìµœì ] ${r.dragonType} | ${r.accessory}</div>
          <div style="font-size:13px;color:#666;">ì ¬: ${r.gems} | íœë˜íŠ¸: ${r.pendant} | ì¸ì²¸íŠ¸: ${r.enchant}</div>
          <div style="font-size:13px;color:#9c27b0;">ì •ë ¹: ${spiritStr}</div>
          ${hasBuffDebuff ? `<div style="font-size:13px;"><span style="color:#4caf50;">ë²„í”„: ${buffStr}</span> | <span style="color:#f44336;">ë””ë²„í”„: ${debuffStr}</span></div>` : ''}
          <div style="font-size:13px;margin-top:4px;">
            HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
            E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
          </div>
        </div>
      </div>`;
    });

    outputHtml += `<div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-top:10px;text-align:center;">
      <strong style="color:#2e7d32;font-size:18px;">ì´ B-Value í•©ê³„: ${(totalB/1e6).toFixed(3)}</strong>
    </div>`;

    resultBox.innerHTML = outputHtml;
  }

  // ===== ê²°ê³¼ ê´€ë¦¬ =====
  function clearAllResults() {
    if (confirm('ê³„ì‚° ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      window._lastAutoResults = null;
      document.getElementById("autoResult").innerHTML = '';
      alert("ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }

  function downloadTxt(){
    // ê³„ì‚° ê²°ê³¼ í™•ì¸
    if (!window._lastAutoResults || window._lastAutoResults.length === 0) {
      alert("ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
      return;
    }

    // Excel ì›Œí¬ë¶ ìƒì„±
    const wb = XLSX.utils.book_new();

    // ê° ë“œë˜ê³¤ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
    window._lastAutoResults.forEach((dragonResult) => {
      // ì‹œíŠ¸ ë°ì´í„° ì¤€ë¹„
      const sheetData = [];

      // í—¤ë” í–‰
      sheetData.push(['ìˆœìœ„', 'íƒ€ì…', 'ì¥ì‹ êµ¬', 'ì ¬', 'íœë˜íŠ¸', 'ì¸ì²¸íŠ¸', 'ì •ë ¹', 'ë²„í”„', 'ë””ë²„í”„', 'HP', 'ATK', 'DEF', 'E', 'B']);

      // ë“œë˜ê³¤ ì •ë³´ í–‰
      sheetData.push([`${dragonResult.dragonGrade} / ${dragonResult.dragonType}`, '', '', '', '', '', '', '', '', '', '', '', '', '']);

      // ê²°ê³¼ ë°ì´í„° í–‰
      dragonResult.results.forEach((r, i) => {
        // ì ¬ ìƒì„¸ í˜•ì‹ ë³€í™˜ (ì‚¬ìš©í•œ ì ¬ë§Œ: HP 148 148 148 DEF 37 37)
        let gemStr = r.gems;
        if (r.gemDetail) {
          const { counts, values } = r.gemDetail;
          const parts = [];
          // HP (ì‚¬ìš©í•œ ê²½ìš°ë§Œ)
          if (counts.hp > 0) {
            parts.push('HP ' + Array(counts.hp).fill(values.hp).join(' '));
          }
          // ATK (ì‚¬ìš©í•œ ê²½ìš°ë§Œ)
          if (counts.atk > 0) {
            parts.push('ATK ' + Array(counts.atk).fill(values.atk).join(' '));
          }
          // DEF (ì‚¬ìš©í•œ ê²½ìš°ë§Œ)
          if (counts.df > 0) {
            parts.push('DEF ' + Array(counts.df).fill(values.df).join(' '));
          }
          gemStr = parts.length > 0 ? parts.join(' ') : '-';
        }

        // ë²„í”„/ë””ë²„í”„ ë¬¸ìì—´ ìƒì„±
        const buffParts = [];
        if (r.buff?.hp > 0) buffParts.push(`HP${r.buff.hp}%`);
        if (r.buff?.atk > 0) buffParts.push(`ATK${r.buff.atk}%`);
        if (r.buff?.df > 0) buffParts.push(`DEF${r.buff.df}%`);
        const buffStr = buffParts.length > 0 ? buffParts.join(' ') : '-';

        const debuffParts = [];
        if (r.debuff?.hp > 0) debuffParts.push(`HP${r.debuff.hp}%`);
        if (r.debuff?.atk > 0) debuffParts.push(`ATK${r.debuff.atk}%`);
        if (r.debuff?.df > 0) debuffParts.push(`DEF${r.debuff.df}%`);
        const debuffStr = debuffParts.length > 0 ? debuffParts.join(' ') : '-';

        sheetData.push([
          i + 1,
          r.dragonType,
          r.accessory,
          gemStr,
          r.pendant,
          r.enchant,
          formatSpiritStr(r.spirit, r.spiritSlots),
          buffStr,
          debuffStr,
          r.finalStats.hp,
          r.finalStats.atk,
          r.finalStats.df,
          Math.round(r.eValue),
          (r.B / 1e6).toFixed(3)
        ]);
      });

      // ì‹œíŠ¸ ìƒì„± ë° ì›Œí¬ë¶ì— ì¶”ê°€
      const ws = XLSX.utils.aoa_to_sheet(sheetData);

      // ì—´ ë„ˆë¹„ ì„¤ì •
      ws['!cols'] = [
        { wch: 6 },   // ìˆœìœ„
        { wch: 10 },  // íƒ€ì…
        { wch: 18 },  // ì¥ì‹ êµ¬
        { wch: 35 },  // ì ¬
        { wch: 20 },  // íœë˜íŠ¸
        { wch: 12 },  // ì¸ì²¸íŠ¸
        { wch: 35 },  // ì •ë ¹
        { wch: 18 },  // ë²„í”„
        { wch: 18 },  // ë””ë²„í”„
        { wch: 8 },   // HP
        { wch: 8 },   // ATK
        { wch: 8 },   // DEF
        { wch: 8 },   // E
        { wch: 10 }   // B
      ];

      // ì‹œíŠ¸ ì´ë¦„ (ë“œë˜ê³¤ ë²ˆí˜¸)
      const sheetName = `ë“œë˜ê³¤${dragonResult.dragonNumber}`;
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    // Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    XLSX.writeFile(wb, 'dragon_result.xlsx');
  }

  const gemOptions = {
    HP: [160, 156, 152, 148],
    ATK: [40, 39, 38, 37],
    DEF: [40, 39, 38, 37]
  };

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ìƒíƒœ
  const ManualDragonState = {
    dragons: [],
    maxDragons: 9,
    nextId: 1,
    selectedForResult: new Set()  // ê²°ê³¼ì— í‘œì‹œí•  ë“œë˜ê³¤ ì„ íƒ
  };

  class ManualDragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;
      this.type = type;
      this.accessoryId = null;
      this.spiritSlots = {
        slot1: { stat: 'none', type: 'pct' },
        slot2: { stat: 'none', type: 'pct' },
        slot3: { stat: 'none', type: 'pct' },
        slot4: { stat: 'none', type: 'pct' },
        sub: 0
      };
      // ì €ì¥ëœ UI ê°’ë“¤
      this.savedValues = null;
    }
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ëª¨ë“  ë“œë˜ê³¤ì˜ í˜„ì¬ UI ê°’ ì €ì¥
  function saveAllManualValues() {
    ManualDragonState.dragons.forEach(dragon => {
      const idx = dragon.displayNumber;
      // íŒ¨ë„ì´ ì•„ì§ DOMì— ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
      if (!document.getElementById(`manualPanel_${idx}`)) return;
      const getVal = (id) => document.getElementById(id)?.value ?? '';

      dragon.savedValues = {
        level: getVal(`d${idx}_m_level`),
        type: getVal(`d${idx}_m_type`),
        accSelect: getVal(`d${idx}_acc_select`),
        accHp: getVal(`d${idx}_m_acc_hp`),
        accAtk: getVal(`d${idx}_m_acc_atk`),
        accDf: getVal(`d${idx}_m_acc_df`),
        enchHp: getVal(`d${idx}_m_ench_hp`),
        enchAtk: getVal(`d${idx}_m_ench_atk`),
        enchDf: getVal(`d${idx}_m_ench_df`),
        pendHp: getVal(`d${idx}_m_pend_hp`),
        pendAtk: getVal(`d${idx}_m_pend_atk`),
        pendDf: getVal(`d${idx}_m_pend_df`),
        sfHp: getVal(`d${idx}_sf_hp`),
        sfAtk: getVal(`d${idx}_sf_atk`),
        sfDf: getVal(`d${idx}_sf_df`),
        spHp: getVal(`d${idx}_sp_hp`),
        spAtk: getVal(`d${idx}_sp_atk`),
        spDf: getVal(`d${idx}_sp_df`),
        seHp: getVal(`d${idx}_se_hp`),
        seAtk: getVal(`d${idx}_se_atk`),
        seDf: getVal(`d${idx}_se_df`),
        bfHp: getVal(`d${idx}_bf_hp`),
        bfAtk: getVal(`d${idx}_bf_atk`),
        bfDf: getVal(`d${idx}_bf_df`),
        dbHp: getVal(`d${idx}_db_hp`),
        dbAtk: getVal(`d${idx}_db_atk`),
        dbDf: getVal(`d${idx}_db_df`),
        gems: [],
        // ì •ë ¹ ì…ë ¥ ëª¨ë“œ
        spiritMode: document.querySelector(`input[name="d${idx}_spirit_mode"]:checked`)?.value || 'slot'
      };

      // ì ¬ ìŠ¬ë¡¯ ì €ì¥
      for (let i = 1; i <= 5; i++) {
        dragon.savedValues.gems.push({
          type: getVal(`d${idx}_slot_type_${i}`),
          val: getVal(`d${idx}_slot_val_${i}`)
        });
      }

      // ì •ë ¹ ìŠ¬ë¡¯ ì €ì¥ (spiritSlots ê°ì²´ì— ì €ì¥)
      for (let slot = 1; slot <= 4; slot++) {
        dragon.spiritSlots[`slot${slot}`] = {
          stat: getVal(`d${idx}_slot${slot}_stat`),
          type: getVal(`d${idx}_slot${slot}_type`)
        };
      }
      dragon.spiritSlots.sub = parseInt(getVal(`d${idx}_sub`) || '0');
    });
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ì €ì¥ëœ UI ê°’ ë³µì›
  function restoreAllManualValues() {
    ManualDragonState.dragons.forEach(dragon => {
      if (!dragon.savedValues) return;

      const idx = dragon.displayNumber;
      const v = dragon.savedValues;
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = val;
      };

      setVal(`d${idx}_m_level`, v.level);
      setVal(`d${idx}_m_type`, v.type);
      setVal(`d${idx}_acc_select`, v.accSelect);
      setVal(`d${idx}_m_acc_hp`, v.accHp);
      setVal(`d${idx}_m_acc_atk`, v.accAtk);
      setVal(`d${idx}_m_acc_df`, v.accDf);
      setVal(`d${idx}_m_ench_hp`, v.enchHp);
      setVal(`d${idx}_m_ench_atk`, v.enchAtk);
      setVal(`d${idx}_m_ench_df`, v.enchDf);
      setVal(`d${idx}_m_pend_hp`, v.pendHp);
      setVal(`d${idx}_m_pend_atk`, v.pendAtk);
      setVal(`d${idx}_m_pend_df`, v.pendDf);
      setVal(`d${idx}_sf_hp`, v.sfHp);
      setVal(`d${idx}_sf_atk`, v.sfAtk);
      setVal(`d${idx}_sf_df`, v.sfDf);
      setVal(`d${idx}_sp_hp`, v.spHp);
      setVal(`d${idx}_sp_atk`, v.spAtk);
      setVal(`d${idx}_sp_df`, v.spDf);
      setVal(`d${idx}_se_hp`, v.seHp);
      setVal(`d${idx}_se_atk`, v.seAtk);
      setVal(`d${idx}_se_df`, v.seDf);
      setVal(`d${idx}_bf_hp`, v.bfHp);
      setVal(`d${idx}_bf_atk`, v.bfAtk);
      setVal(`d${idx}_bf_df`, v.bfDf);
      setVal(`d${idx}_db_hp`, v.dbHp);
      setVal(`d${idx}_db_atk`, v.dbAtk);
      setVal(`d${idx}_db_df`, v.dbDf);

      // ì ¬ ìŠ¬ë¡¯ ë³µì› (íƒ€ì… ì„¤ì • í›„ change ì´ë²¤íŠ¸ ë°œìƒì‹œì¼œ ì˜µì…˜ ìƒì„±)
      v.gems.forEach((gem, i) => {
        const typeEl = document.getElementById(`d${idx}_slot_type_${i+1}`);
        const valEl = document.getElementById(`d${idx}_slot_val_${i+1}`);
        if (typeEl) {
          typeEl.value = gem.type;
          typeEl.dispatchEvent(new Event('change'));
        }
        // ì˜µì…˜ ìƒì„± í›„ ê°’ ì„¤ì •
        setTimeout(() => {
          if (valEl) valEl.value = gem.val;
        }, 10 * (i + 1));
      });

      // spiritSlots UI ë³µì›
      for (let slot = 1; slot <= 4; slot++) {
        const slotData = dragon.spiritSlots[`slot${slot}`];
        setVal(`d${idx}_slot${slot}_stat`, slotData.stat);
        setVal(`d${idx}_slot${slot}_type`, slotData.type);
      }
      setVal(`d${idx}_sub`, dragon.spiritSlots.sub);

      // ì •ë ¹ ì…ë ¥ ëª¨ë“œ ë³µì›
      if (v.spiritMode) {
        const modeRadio = document.querySelector(`input[name="d${idx}_spirit_mode"][value="${v.spiritMode}"]`);
        if (modeRadio) modeRadio.checked = true;

        // ëª¨ë“œì— ë”°ë¥¸ UI í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        const slotDiv = document.getElementById(`d${idx}_spirit_slot_mode`);
        const manualDiv = document.getElementById(`d${idx}_spirit_manual_mode`);
        if (v.spiritMode === 'slot') {
          if (slotDiv) slotDiv.style.display = 'block';
          if (manualDiv) manualDiv.style.display = 'none';
          // ìŠ¬ë¡¯ ëª¨ë“œì¼ ë•Œë§Œ summary ì—…ë°ì´íŠ¸
          calculateManualSpiritFromSlots(idx);
        } else {
          if (slotDiv) slotDiv.style.display = 'none';
          if (manualDiv) manualDiv.style.display = 'block';
        }
      } else {
        // ê¸°ë³¸ ìŠ¬ë¡¯ ëª¨ë“œ - summary ì—…ë°ì´íŠ¸
        calculateManualSpiritFromSlots(idx);
      }
    });
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ì •ë ¹ ìŠ¬ë¡¯ ì˜µì…˜ ìƒì„± í•¨ìˆ˜
  function genManualStatOptions(selected) {
    return `
      <option value="none" ${selected === 'none' ? 'selected' : ''}>-</option>
      <option value="hp" ${selected === 'hp' ? 'selected' : ''}>HP</option>
      <option value="atk" ${selected === 'atk' ? 'selected' : ''}>ATK</option>
      <option value="df" ${selected === 'df' ? 'selected' : ''}>DEF</option>
    `;
  }

  function genManualTypeOptions(selected) {
    return `
      <option value="flat" ${selected === 'flat' ? 'selected' : ''}>+</option>
      <option value="pct" ${selected === 'pct' ? 'selected' : ''}>%</option>
    `;
  }

  function genManualSubOptions(selected) {
    return SPIRIT_SUB_OPTIONS.map((opt, i) =>
      `<option value="${i}" ${selected === i ? 'selected' : ''}>${opt.label}</option>`
    ).join('');
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ì •ë ¹ ì…ë ¥ ëª¨ë“œ í† ê¸€
  function toggleManualSpiritMode(idx) {
    const mode = document.querySelector(`input[name="d${idx}_spirit_mode"]:checked`)?.value || 'slot';
    const slotDiv = document.getElementById(`d${idx}_spirit_slot_mode`);
    const manualDiv = document.getElementById(`d${idx}_spirit_manual_mode`);

    if (mode === 'slot') {
      slotDiv.style.display = 'block';
      manualDiv.style.display = 'none';
      // ìŠ¬ë¡¯ ëª¨ë“œë¡œ ì „í™˜ ì‹œ ê°’ ì¬ê³„ì‚°
      calculateManualSpiritFromSlots(idx);
    } else {
      slotDiv.style.display = 'none';
      manualDiv.style.display = 'block';
    }
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ì •ë ¹ ìŠ¬ë¡¯ì—ì„œ ê°’ ê³„ì‚°
  function calculateManualSpiritFromSlots(idx) {
    const dragon = ManualDragonState.dragons.find(d => d.displayNumber === idx);
    if (!dragon) return;

    const flatTotal = { hp: 0, atk: 0, df: 0 };
    const pctTotal = { hp: 0, atk: 0, df: 0 };
    const extraTotal = { hp: 0, atk: 0, df: 0 };

    // ìŠ¬ë¡¯ 1~4 ê³„ì‚°
    for (let slot = 1; slot <= 4; slot++) {
      const stat = document.getElementById(`d${idx}_slot${slot}_stat`)?.value || 'none';
      const type = document.getElementById(`d${idx}_slot${slot}_type`)?.value || 'pct';

      // spiritSlots ì €ì¥
      dragon.spiritSlots[`slot${slot}`] = { stat, type };

      if (stat === 'none') continue;

      if (type === 'flat') {
        flatTotal[stat] += SPIRIT_FLAT_TBL[slot][stat];
      } else if (type === 'pct') {
        pctTotal[stat] += SPIRIT_PCT_TBL[slot][stat];
      }
    }

    // ë¶€ê°€ì˜µ ê³„ì‚°
    const subIdx = parseInt(document.getElementById(`d${idx}_sub`)?.value || '0');
    dragon.spiritSlots.sub = subIdx;

    if (subIdx > 0) {
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      extraTotal.hp = sub.hp;
      extraTotal.atk = sub.atk;
      extraTotal.df = sub.df;
    }

    // ì§ì ‘ ì…ë ¥ í•„ë“œì— ê°’ ë°˜ì˜
    document.getElementById(`d${idx}_sf_hp`).value = flatTotal.hp;
    document.getElementById(`d${idx}_sf_atk`).value = flatTotal.atk;
    document.getElementById(`d${idx}_sf_df`).value = flatTotal.df;
    document.getElementById(`d${idx}_sp_hp`).value = pctTotal.hp;
    document.getElementById(`d${idx}_sp_atk`).value = pctTotal.atk;
    document.getElementById(`d${idx}_sp_df`).value = pctTotal.df;
    document.getElementById(`d${idx}_se_hp`).value = extraTotal.hp;
    document.getElementById(`d${idx}_se_atk`).value = extraTotal.atk;
    document.getElementById(`d${idx}_se_df`).value = extraTotal.df;

    // ìš”ì•½ í‘œì‹œ
    const summaryDiv = document.getElementById(`d${idx}_spirit_summary`);
    if (summaryDiv) {
      const parts = [];
      if (flatTotal.hp > 0 || flatTotal.atk > 0 || flatTotal.df > 0) {
        parts.push(`í”Œì˜µ: HP+${flatTotal.hp} ATK+${flatTotal.atk} DEF+${flatTotal.df}`);
      }
      if (pctTotal.hp > 0 || pctTotal.atk > 0 || pctTotal.df > 0) {
        parts.push(`í¼ì˜µ: HP${pctTotal.hp}% ATK${pctTotal.atk}% DEF${pctTotal.df}%`);
      }
      if (extraTotal.hp > 0 || extraTotal.atk > 0 || extraTotal.df > 0) {
        parts.push(`ë¶€ê°€ì˜µ: HP+${extraTotal.hp} ATK+${extraTotal.atk} DEF+${extraTotal.df}`);
      }
      summaryDiv.textContent = parts.length > 0 ? parts.join(' | ') : 'ì •ë ¹ ë¯¸ì„ íƒ';
    }
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ì¶”ê°€
  function addManualDragon() {
    if (ManualDragonState.dragons.length >= ManualDragonState.maxDragons) {
      alert(`ìµœëŒ€ ${ManualDragonState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    const grade = '9.0';
    const type = 'ê³µê²©í˜•';

    const newDragon = new ManualDragonConfig(ManualDragonState.nextId++, grade, type);
    newDragon.displayNumber = ManualDragonState.dragons.length + 1;
    ManualDragonState.dragons.push(newDragon);

    renderAllManual();
    updateManualDragonCount();
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ì‚­ì œ
  function removeManualDragon(dragonId) {
    const index = ManualDragonState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    const dragon = ManualDragonState.dragons[index];
    const oldDisplayNumber = dragon.displayNumber;

    ManualDragonState.dragons.splice(index, 1);

    // ë¦¬ë„˜ë²„ë§ ë° selectedForResult ì—…ë°ì´íŠ¸
    const wasSelected = ManualDragonState.selectedForResult.has(oldDisplayNumber);
    ManualDragonState.selectedForResult.clear();
    ManualDragonState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });
    // ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒ 3ê°œ ì„ íƒ (ë˜ëŠ” ëª¨ë“  ë“œë˜ê³¤ ì„ íƒ)
    const selectCount = Math.min(3, ManualDragonState.dragons.length);
    for (let i = 0; i < selectCount; i++) {
      ManualDragonState.selectedForResult.add(ManualDragonState.dragons[i].displayNumber);
    }

    renderAllManual();
    updateManualDragonCount();
  }

  function updateManualDragonCount() {
    const countEl = document.getElementById('manualDragonCount');
    if (countEl) {
      countEl.textContent = `(í˜„ì¬: ${ManualDragonState.dragons.length}ë§ˆë¦¬)`;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ 3ë§ˆë¦¬ ë“œë˜ê³¤ ìë™ ìƒì„±
  window.addEventListener('DOMContentLoaded', () => {
    // ê¸°ë³¸ 3ë§ˆë¦¬ ìƒì„±
    for (let i = 0; i < 3; i++) {
      const dragon = new ManualDragonConfig(ManualDragonState.nextId++, '9.0', 'ê³µê²©í˜•');
      dragon.displayNumber = i + 1;
      ManualDragonState.dragons.push(dragon);
    }
    renderAllManual();
    updateManualDragonCount();
  });

  function renderAllManual() {
    const tabsContainer = document.getElementById('manualDragonTabs');
    const inputsWrap = document.getElementById('inputsWrap');
    const allResults = document.getElementById('allResults');

    if (!tabsContainer || !inputsWrap) return;

    // ë Œë”ë§ ì „ í˜„ì¬ ê°’ ì €ì¥
    saveAllManualValues();

    tabsContainer.innerHTML = '';
    inputsWrap.innerHTML = '';
    allResults.innerHTML = '';

    if (ManualDragonState.dragons.length === 0) {
      inputsWrap.innerHTML = '<p style="color:#999;text-align:center;padding:10px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      updateDragonSelectionPanel();
      return;
    }

    // íƒ­ ìƒì„±
    ManualDragonState.dragons.forEach((dragon, index) => {
      const tab = document.createElement('button');
      tab.className = `dragon-tab ${index === 0 ? 'active' : ''}`;
      tab.textContent = `ë“œë˜ê³¤ ${dragon.displayNumber}`;
      tab.dataset.dragonIdx = dragon.displayNumber;
      tab.onclick = () => switchManualDragonTab(dragon.displayNumber);
      tabsContainer.appendChild(tab);
    });

    // íŒ¨ë„ ìƒì„±
    ManualDragonState.dragons.forEach((dragon, index) => {
      renderOneInputAsPanel(dragon.displayNumber, dragon, index === 0);
    });

    // ì €ì¥ëœ ê°’ ë³µì›
    restoreAllManualValues();

    // ì„ íƒ íŒ¨ë„ ì—…ë°ì´íŠ¸ ë° ê²°ê³¼ ì‹œíŠ¸ ìƒì„±
    updateDragonSelectionPanel();
    renderSelectedResults();
  }

  // ë“œë˜ê³¤ ì„ íƒ íŒ¨ë„ ì—…ë°ì´íŠ¸
  function updateDragonSelectionPanel() {
    const panel = document.getElementById('dragonSelectPanel');
    const checkboxes = document.getElementById('dragonSelectCheckboxes');

    if (!panel || !checkboxes) return;

    // 4ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ
    if (ManualDragonState.dragons.length < 4) {
      panel.style.display = 'none';
      // 3ë§ˆë¦¬ ì´í•˜ë©´ ëª¨ë‘ ì„ íƒ
      ManualDragonState.selectedForResult.clear();
      ManualDragonState.dragons.forEach(d => ManualDragonState.selectedForResult.add(d.displayNumber));
      return;
    }

    panel.style.display = 'block';

    // ê¸°ë³¸ ì„ íƒ: ì²˜ìŒ 3ê°œ (ì•„ì§ ì„ íƒëœ ê²Œ ì—†ìœ¼ë©´)
    if (ManualDragonState.selectedForResult.size === 0) {
      ManualDragonState.dragons.slice(0, 3).forEach(d => ManualDragonState.selectedForResult.add(d.displayNumber));
    }

    // ì²´í¬ë°•ìŠ¤ ìƒì„±
    checkboxes.innerHTML = ManualDragonState.dragons.map(dragon => {
      const isChecked = ManualDragonState.selectedForResult.has(dragon.displayNumber);
      const isDisabled = !isChecked && ManualDragonState.selectedForResult.size >= 3;
      return `
        <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${isChecked ? '#e8f5e9' : '#fff'};border:1px solid ${isChecked ? '#4caf50' : '#ddd'};border-radius:6px;cursor:${isDisabled ? 'not-allowed' : 'pointer'};">
          <input type="checkbox"
                 ${isChecked ? 'checked' : ''}
                 ${isDisabled ? 'disabled' : ''}
                 onchange="toggleDragonSelection(${dragon.displayNumber}, this.checked)">
          ë“œë˜ê³¤ ${dragon.displayNumber}
        </label>
      `;
    }).join('');
  }

  // ë“œë˜ê³¤ ì„ íƒ í† ê¸€
  function toggleDragonSelection(displayNumber, isSelected) {
    if (isSelected) {
      if (ManualDragonState.selectedForResult.size < 3) {
        ManualDragonState.selectedForResult.add(displayNumber);
      }
    } else {
      // ìµœì†Œ 1ê°œëŠ” ì„ íƒë˜ì–´ì•¼ í•¨
      if (ManualDragonState.selectedForResult.size <= 1) {
        alert('ìµœì†Œ 1ê°œì˜ ë“œë˜ê³¤ì€ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
        updateDragonSelectionPanel(); // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
        return;
      }
      ManualDragonState.selectedForResult.delete(displayNumber);
    }
    updateDragonSelectionPanel();
    renderSelectedResults();
  }

  // ì„ íƒëœ ë“œë˜ê³¤ë§Œ ê²°ê³¼ ì‹œíŠ¸ ìƒì„±
  function renderSelectedResults() {
    const allResults = document.getElementById('allResults');
    if (!allResults) return;

    allResults.innerHTML = '';

    // ì„ íƒëœ ë“œë˜ê³¤ë“¤ì˜ ê²°ê³¼ ì‹œíŠ¸ ìƒì„± (ìˆœì„œ ìœ ì§€)
    ManualDragonState.dragons
      .filter(d => ManualDragonState.selectedForResult.has(d.displayNumber))
      .forEach(dragon => {
        renderOneResult(dragon.displayNumber);
      });
  }

  function renderOneInputAsPanel(idx, dragonConfig, isActive) {
    const inputsWrap = document.getElementById('inputsWrap');
    const panel = document.createElement('div');
    panel.className = `dragon-settings-panel ${isActive ? 'active' : ''}`;
    panel.id = `manualPanel_${idx}`;

    // ë“œë˜ê³¤ ID ì°¾ê¸° (ì‚­ì œìš©)
    const dragonId = dragonConfig ? dragonConfig.id : null;
    const showDelete = ManualDragonState.dragons.length > 1;

    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <strong style="font-size:13px;color:var(--accent);">ë“œë˜ê³¤ ${idx}</strong>
        ${showDelete && dragonId ? `<button class="btn-remove" onclick="removeManualDragon(${dragonId})">ì‚­ì œ</button>` : ''}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <fieldset>
          <legend>ë“±ê¸‰ / íƒ€ì…</legend>
          <div class="row">
            <label>ë“±ê¸‰
              <select id="d${idx}_m_level">
                <option value="7.0" ${dragonConfig?.grade === '7.0' ? 'selected' : ''}>7.0</option>
                <option value="8.0" ${dragonConfig?.grade === '8.0' ? 'selected' : ''}>8.0</option>
                <option value="9.0" ${!dragonConfig || dragonConfig?.grade === '9.0' ? 'selected' : ''}>9.0</option>
              </select>
            </label>
            <label>íƒ€ì…
              <select id="d${idx}_m_type">
                <option ${dragonConfig?.type === 'ê³µê²©í˜•' ? 'selected' : ''}>ê³µê²©í˜•</option>
                <option ${dragonConfig?.type === 'ë°©ì–´í˜•' ? 'selected' : ''}>ë°©ì–´í˜•</option>
                <option ${dragonConfig?.type === 'ì²´ë ¥í˜•' ? 'selected' : ''}>ì²´ë ¥í˜•</option>
                <option ${dragonConfig?.type === 'ê³µë°©í˜•' ? 'selected' : ''}>ê³µë°©í˜•</option>
                <option ${dragonConfig?.type === 'ì²´ê³µí˜•' ? 'selected' : ''}>ì²´ê³µí˜•</option>
                <option ${dragonConfig?.type === 'ì²´ë°©í˜•' ? 'selected' : ''}>ì²´ë°©í˜•</option>
              </select>
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>ì¥ì‹ êµ¬ ì„ íƒ</legend>
          <div class="row">
            <select id="d${idx}_acc_select" onchange="onManualAccessoryChange(${idx}, this.value)" style="width:100%;">
              <option value="">-- ì¥ì‹ êµ¬ ì„ íƒ --</option>
              ${renderAccessoryOptions(dragonConfig?.accessoryId)}
            </select>
          </div>
          <div class="row" style="margin-top:3px;">
            <span class="small">ë˜ëŠ” ì§ì ‘ ì…ë ¥:</span>
          </div>
          <div class="row">
            HP <input id="d${idx}_m_acc_hp" type="number" value="" placeholder="-" style="width:55px">%
            ATK <input id="d${idx}_m_acc_atk" type="number" value="" placeholder="-" style="width:55px">%
            DEF <input id="d${idx}_m_acc_df" type="number" value="" placeholder="-" style="width:55px">%
          </div>
        </fieldset>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:3px;">
        <fieldset>
          <legend>ì ¬ ìŠ¬ë¡¯ (5ê°œ)</legend>
          <div id="d${idx}_gem_slots"></div>
        </fieldset>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <fieldset>
            <legend>ì¸ì±ˆíŠ¸</legend>
            <div class="row">
              HP <select id="d${idx}_m_ench_hp"><option value="0" selected>-</option><option value="21">21</option></select>
              ATK <select id="d${idx}_m_ench_atk"><option value="0" selected>-</option><option value="21">21</option></select>
              DEF <select id="d${idx}_m_ench_df"><option value="0" selected>-</option><option value="21">21</option></select>
            </div>
          </fieldset>

          <fieldset>
            <legend>íœë˜íŠ¸ (%)</legend>
            <div class="row">
              HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:50px">%
              ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:50px">%
              DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:50px">%
            </div>
          </fieldset>
        </div>
      </div>

      <fieldset style="margin-top:3px;">
        <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„</legend>

        <!-- ì…ë ¥ ëª¨ë“œ ì„ íƒ -->
        <div class="row" style="margin-bottom:4px;">
          <label><input type="radio" name="d${idx}_spirit_mode" value="slot" checked onchange="toggleManualSpiritMode(${idx})">ìŠ¬ë¡¯ ì„ íƒ</label>
          <label><input type="radio" name="d${idx}_spirit_mode" value="manual" onchange="toggleManualSpiritMode(${idx})">ì§ì ‘ ì…ë ¥</label>
        </div>

        <!-- ìŠ¬ë¡¯ ì„ íƒ ëª¨ë“œ (2x2 ì‚¬ë¶„ë©´ ë°°ì¹˜) -->
        <div id="d${idx}_spirit_slot_mode">
          <div style="font-size:12px;margin-bottom:4px;color:#666;">ì •ë ¹ ìŠ¬ë¡¯:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;">
            <!-- 2ì‚¬ë¶„ë©´(ì¢Œìƒ)=ìŠ¬ë¡¯1, 1ì‚¬ë¶„ë©´(ìš°ìƒ)=ìŠ¬ë¡¯2 -->
            <div style="display:flex;gap:4px;">
              <select id="d${idx}_slot1_stat" onchange="calculateManualSpiritFromSlots(${idx})" style="flex:1;">${genManualStatOptions(dragonConfig?.spiritSlots?.slot1?.stat || 'none')}</select>
              <select id="d${idx}_slot1_type" onchange="calculateManualSpiritFromSlots(${idx})" style="width:45px;">${genManualTypeOptions(dragonConfig?.spiritSlots?.slot1?.type || 'pct')}</select>
            </div>
            <div style="display:flex;gap:4px;">
              <select id="d${idx}_slot2_stat" onchange="calculateManualSpiritFromSlots(${idx})" style="flex:1;">${genManualStatOptions(dragonConfig?.spiritSlots?.slot2?.stat || 'none')}</select>
              <select id="d${idx}_slot2_type" onchange="calculateManualSpiritFromSlots(${idx})" style="width:45px;">${genManualTypeOptions(dragonConfig?.spiritSlots?.slot2?.type || 'pct')}</select>
            </div>
            <!-- 3ì‚¬ë¶„ë©´(ì¢Œí•˜)=ìŠ¬ë¡¯3, 4ì‚¬ë¶„ë©´(ìš°í•˜)=ìŠ¬ë¡¯4 -->
            <div style="display:flex;gap:4px;">
              <select id="d${idx}_slot3_stat" onchange="calculateManualSpiritFromSlots(${idx})" style="flex:1;">${genManualStatOptions(dragonConfig?.spiritSlots?.slot3?.stat || 'none')}</select>
              <select id="d${idx}_slot3_type" onchange="calculateManualSpiritFromSlots(${idx})" style="width:45px;">${genManualTypeOptions(dragonConfig?.spiritSlots?.slot3?.type || 'pct')}</select>
            </div>
            <div style="display:flex;gap:4px;">
              <select id="d${idx}_slot4_stat" onchange="calculateManualSpiritFromSlots(${idx})" style="flex:1;">${genManualStatOptions(dragonConfig?.spiritSlots?.slot4?.stat || 'none')}</select>
              <select id="d${idx}_slot4_type" onchange="calculateManualSpiritFromSlots(${idx})" style="width:45px;">${genManualTypeOptions(dragonConfig?.spiritSlots?.slot4?.type || 'pct')}</select>
            </div>
          </div>
          <div style="margin-bottom:4px;">
            <span style="font-size:12px;color:#666;">ë¶€ê°€ì˜µ:</span>
            <select id="d${idx}_sub" onchange="calculateManualSpiritFromSlots(${idx})" style="margin-left:6px;">${genManualSubOptions(dragonConfig?.spiritSlots?.sub || 0)}</select>
          </div>
          <div id="d${idx}_spirit_summary" style="background:#f0f0f0;padding:4px 6px;border-radius:3px;font-size:11px;color:#666;"></div>
        </div>

        <!-- ì§ì ‘ ì…ë ¥ ëª¨ë“œ -->
        <div id="d${idx}_spirit_manual_mode" style="display:none;">
          <div style="font-weight:700;margin-bottom:3px;font-size:12px">(HP / ATK / DEF)</div>
          <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
            <input id="d${idx}_sf_hp" type="number" value="" placeholder="-">
            <input id="d${idx}_sf_atk" type="number" value="" placeholder="-">
            <input id="d${idx}_sf_df" type="number" value="" placeholder="-">
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
            <input id="d${idx}_sp_hp" type="number" value="" placeholder="-">
            <input id="d${idx}_sp_atk" type="number" value="" placeholder="-">
            <input id="d${idx}_sp_df" type="number" value="" placeholder="-">
            <span class="small">% ì…ë ¥</span>
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ ë¶€ê°€ì˜µ</strong>
            <input id="d${idx}_se_hp" type="number" value="" placeholder="-">
            <input id="d${idx}_se_atk" type="number" value="" placeholder="-">
            <input id="d${idx}_se_df" type="number" value="" placeholder="-">
          </div>
        </div>

        <!-- ë²„í”„/ë””ë²„í”„ (2x2 í˜•íƒœ) -->
        <div style="margin-top:6px;border-top:1px solid #eee;padding-top:6px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
                <select id="d${idx}_bf_hp"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="d${idx}_bf_atk"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="d${idx}_bf_df"><option value="0" selected>-</option><option value="20">20</option></select>
              </div>
            </div>
            <div>
              <div style="font-size:12px;color:#666;margin-bottom:3px;">ë””ë²„í”„ (HP/ATK/DEF)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">
                <select id="d${idx}_db_hp"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="d${idx}_db_atk"><option value="0" selected>-</option><option value="20">20</option></select>
                <select id="d${idx}_db_df"><option value="0" selected>-</option><option value="20">20</option></select>
              </div>
            </div>
          </div>
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(panel);
    renderGems(idx);
  }

  function switchManualDragonTab(dragonIdx) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('#manualDragonTabs .dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#inputsWrap .dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    document.querySelector(`#manualDragonTabs .dragon-tab[data-dragon-idx="${dragonIdx}"]`)?.classList.add('active');
    document.getElementById(`manualPanel_${dragonIdx}`)?.classList.add('active');
  }

  // ì¥ì‹ êµ¬ ì˜µì…˜ ë Œë”ë§ (ì¤‘ë³µ ì„ íƒ í—ˆìš© - ì¥ì‹ êµ¬ëŠ” ì—¬ëŸ¬ ë“œë˜ê³¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
  function renderAccessoryOptions(currentAccId = null) {
    return ACC_TABLE.map((acc, index) => {
      const [name, level, hp, atk, df] = acc;
      const accId = `acc_${index}`;

      return `<option value="${accId}" ${currentAccId === accId ? 'selected' : ''}>
        ${name} Lv${level} | HP+${hp}% ATK+${atk}% DEF+${df}%
      </option>`;
    }).join('');
  }

  // ì¥ì‹ êµ¬ ì„ íƒ ë³€ê²½ ì‹œ í˜¸ì¶œ (ì¤‘ë³µ ì„ íƒ í—ˆìš©)
  function onManualAccessoryChange(dragonIdx, accId) {
    const dragon = ManualDragonState.dragons[dragonIdx - 1];
    if (!dragon) return;

    if (accId && accId !== '') {
      dragon.accessoryId = accId;

      // ì¥ì‹ êµ¬ ê°’ ìë™ ì…ë ¥
      const accIndex = parseInt(accId.replace('acc_', ''));
      const accData = ACC_TABLE[accIndex];
      if (accData) {
        document.getElementById(`d${dragonIdx}_m_acc_hp`).value = accData[2];
        document.getElementById(`d${dragonIdx}_m_acc_atk`).value = accData[3];
        document.getElementById(`d${dragonIdx}_m_acc_df`).value = accData[4];
      }
    } else {
      dragon.accessoryId = null;
    }
  }

  // ëª¨ë“  ì¥ì‹ êµ¬ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
  function renderGems(idx){
    const c=document.getElementById(`d${idx}_gem_slots`); c.innerHTML='';
    for(let i=1;i<=5;i++){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `
        <strong style="width:64px;display:inline-block">ì ¬${i}</strong>
        <select id="d${idx}_slot_type_${i}">
          <option value="">--ì¢…ë¥˜--</option>
          <option value="HP">HP</option>
          <option value="ATK">ATK</option>
          <option value="DEF">DEF</option>
        </select>
        <select id="d${idx}_slot_val_${i}">
          <option value="0">--ê°’--</option>
        </select>`;
      c.appendChild(row);

      const typeSel=row.querySelector(`#d${idx}_slot_type_${i}`);
      const valSel=row.querySelector(`#d${idx}_slot_val_${i}`);
      typeSel.addEventListener('change', ()=>{
        valSel.innerHTML = `<option value="0">--ê°’--</option>`;
        const t=typeSel.value;
        if(t && gemOptions[t]){
          gemOptions[t].forEach(v=>{
            const op=document.createElement('option');
            op.value=v; op.textContent=v; valSel.appendChild(op);
          });
        }
      });
    }
  }

function renderOneResult(idx){
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.id = `resultSheet_${idx}`;
  sheet.innerHTML = `
    <div class="name" id="d${idx}_name_display">ë“œë˜ê³¤ ${idx}</div>
    <div class="grid">
      <div class="cell h center">êµ¬ë¶„</div>
      <div class="cell h center">ì²´ë ¥</div>
      <div class="cell h center">ê³µê²©ë ¥</div>
      <div class="cell h center">ë°©ì–´ë ¥</div>

      <div class="cell">ê¸°ë³¸ ìŠ¤íƒ¯</div>
      <div class="cell right" id="d${idx}_c_base_hp">-</div>
      <div class="cell right" id="d${idx}_c_base_atk">-</div>
      <div class="cell right" id="d${idx}_c_base_df">-</div>

      <div class="cell">ì ¬1</div><div class="cell right" id="d${idx}_c_g1_hp">0</div><div class="cell right" id="d${idx}_c_g1_atk">0</div><div class="cell right" id="d${idx}_c_g1_df">0</div>
      <div class="cell">ì ¬2</div><div class="cell right" id="d${idx}_c_g2_hp">0</div><div class="cell right" id="d${idx}_c_g2_atk">0</div><div class="cell right" id="d${idx}_c_g2_df">0</div>
      <div class="cell">ì ¬3</div><div class="cell right" id="d${idx}_c_g3_hp">0</div><div class="cell right" id="d${idx}_c_g3_atk">0</div><div class="cell right" id="d${idx}_c_g3_df">0</div>
      <div class="cell">ì ¬4</div><div class="cell right" id="d${idx}_c_g4_hp">0</div><div class="cell right" id="d${idx}_c_g4_atk">0</div><div class="cell right" id="d${idx}_c_g4_df">0</div>
      <div class="cell">ì ¬5</div><div class="cell right" id="d${idx}_c_g5_hp">0</div><div class="cell right" id="d${idx}_c_g5_atk">0</div><div class="cell right" id="d${idx}_c_g5_df">0</div>

      <div class="cell">ì¥ì‹ êµ¬ %</div><div class="cell right" id="d${idx}_c_acc_hp">0%</div><div class="cell right" id="d${idx}_c_acc_atk">0%</div><div class="cell right" id="d${idx}_c_acc_df">0%</div>
      <div class="cell">ì¸ì²¸íŠ¸ %</div><div class="cell right" id="d${idx}_c_ench_hp">0%</div><div class="cell right" id="d${idx}_c_ench_atk">0%</div><div class="cell right" id="d${idx}_c_ench_df">0%</div>
      <div class="cell">íœë˜íŠ¸ %</div><div class="cell right" id="d${idx}_c_pend_hp">0%</div><div class="cell right" id="d${idx}_c_pend_atk">0%</div><div class="cell right" id="d${idx}_c_pend_df">0%</div>

      <div class="cell">ì •ë ¹ +</div><div class="cell right" id="d${idx}_c_spf_hp">0</div><div class="cell right" id="d${idx}_c_spf_atk">0</div><div class="cell right" id="d${idx}_c_spf_df">0</div>
      <div class="cell">ì •ë ¹ %</div><div class="cell right" id="d${idx}_c_spp_hp">0%</div><div class="cell right" id="d${idx}_c_spp_atk">0%</div><div class="cell right" id="d${idx}_c_spp_df">0%</div>
      <div class="cell">ì •ë ¹ ë¶€ê°€ì˜µ</div><div class="cell right" id="d${idx}_c_spe_hp">0</div><div class="cell right" id="d${idx}_c_spe_atk">0</div><div class="cell right" id="d${idx}_c_spe_df">0</div>
      <div class="cell">ë²„í”„ %</div><div class="cell right" id="d${idx}_c_bf_hp">0%</div><div class="cell right" id="d${idx}_c_bf_atk">0%</div><div class="cell right" id="d${idx}_c_bf_df">0%</div>
      <div class="cell">ë””ë²„í”„ %</div><div class="cell right" id="d${idx}_c_db_hp">0%</div><div class="cell right" id="d${idx}_c_db_atk">0%</div><div class="cell right" id="d${idx}_c_db_df">0%</div>

      <div class="cell section center" style="grid-column:1/5">ìµœì¢… ìŠ¤íƒ¯</div>
      <div class="cell sum">ì²´ë ¥</div><div class="cell big" id="d${idx}_c_fin_hp">-</div>
      <div class="cell sum">ê³µê²©ë ¥</div><div class="cell big" id="d${idx}_c_fin_atk">-</div>
      <div class="cell sum">ë°©ì–´ë ¥</div><div class="cell big" id="d${idx}_c_fin_df">-</div>

      <div class="cell section center" style="grid-column:1/5">ì§€í‘œ</div>
      <div class="cell">E-Value</div><div class="cell big" id="d${idx}_c_eval" style="grid-column:2/5">-</div>
      <div class="cell">B-Value</div><div class="cell big" id="d${idx}_c_bval" style="grid-column:2/5">-</div>
    </div>
  `;
  allResults.appendChild(sheet);
}

  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
  function num(id){ return Number(document.getElementById(id)?.value||0); }

  // ===== ìˆ˜ë™ ê³„ì‚°ê¸° =====
  function manualCalcOne(idx){
    setText(`d${idx}_name_display`, `ë“œë˜ê³¤ ${idx}`);

    const lvl = document.getElementById(`d${idx}_m_level`).value;
    const type = document.getElementById(`d${idx}_m_type`).value;
    const base = dragon[lvl][type];

    // ì ¬ í•©ì‚°
    let g_hp=0, g_atk=0, g_df=0;
    for(let i=1;i<=5;i++){
      const t=document.getElementById(`d${idx}_slot_type_${i}`).value;
      const v=Number(document.getElementById(`d${idx}_slot_val_${i}`).value||0);
      let hp=0, atk=0, df=0;
      if(t==="HP") hp=v; if(t==="ATK") atk=v; if(t==="DEF") df=v;
      g_hp+=hp; g_atk+=atk; g_df+=df;
      setText(`d${idx}_c_g${i}_hp`, hp); setText(`d${idx}_c_g${i}_atk`, atk); setText(`d${idx}_c_g${i}_df`, df);
    }
    const gem = new Stats(g_hp,g_atk,g_df);

    // ì¥ì‹ êµ¬/ì¸ì²¸íŠ¸ (ê³„ì‚°ì€ í•©ì‚°í•´ì„œ, í‘œê¸°ëŠ” ë¶„ë¦¬)
    const accOnly = new Stats(num(`d${idx}_m_acc_hp`)/100, num(`d${idx}_m_acc_atk`)/100, num(`d${idx}_m_acc_df`)/100);
    const enchOnly = new Stats(num(`d${idx}_m_ench_hp`)/100, num(`d${idx}_m_ench_atk`)/100, num(`d${idx}_m_ench_df`)/100);
    const acc = new Stats(accOnly.hp+enchOnly.hp, accOnly.atk+enchOnly.atk, accOnly.df+enchOnly.df);

    const pend = new Stats(num(`d${idx}_m_pend_hp`)/100, num(`d${idx}_m_pend_atk`)/100, num(`d${idx}_m_pend_df`)/100);

    // ì •ë ¹/ë²„í”„/ë””ë²„í”„
    const spf = new Stats(num(`d${idx}_sf_hp`), num(`d${idx}_sf_atk`), num(`d${idx}_sf_df`));
    const spp = new Stats(num(`d${idx}_sp_hp`)/100, num(`d${idx}_sp_atk`)/100, num(`d${idx}_sp_df`)/100);
    const spe = new Stats(num(`d${idx}_se_hp`), num(`d${idx}_se_atk`), num(`d${idx}_se_df`));
    const bf  = new Stats(num(`d${idx}_bf_hp`)/100, num(`d${idx}_bf_atk`)/100, num(`d${idx}_bf_df`)/100);
    const db  = new Stats(num(`d${idx}_db_hp`)/100, num(`d${idx}_db_atk`)/100, num(`d${idx}_db_df`)/100);

    // ìƒìˆ˜
    const pot = new Stats(24,6,6);
    const col = new Stats(240,60,60);

    const [fin, E, B] = calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);

    // ê²°ê³¼ ì‹œíŠ¸
    setText(`d${idx}_c_base_hp`, base.hp);
    setText(`d${idx}_c_base_atk`, base.atk);
    setText(`d${idx}_c_base_df`, base.df);

    // í¼ì„¼íŠ¸ í‘œê¸°(ë¶„ë¦¬)
    setText(`d${idx}_c_acc_hp`, (accOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_atk`, (accOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_df`, (accOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_ench_hp`, (enchOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_atk`, (enchOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_df`, (enchOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_pend_hp`, document.getElementById(`d${idx}_m_pend_hp`).value + '%');
    setText(`d${idx}_c_pend_atk`, document.getElementById(`d${idx}_m_pend_atk`).value + '%');
    setText(`d${idx}_c_pend_df`, document.getElementById(`d${idx}_m_pend_df`).value + '%');

    setText(`d${idx}_c_spf_hp`, spf.hp); setText(`d${idx}_c_spf_atk`, spf.atk); setText(`d${idx}_c_spf_df`, spf.df);
    setText(`d${idx}_c_spp_hp`, (spp.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_atk`, (spp.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_df`, (spp.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_spe_hp`, spe.hp); setText(`d${idx}_c_spe_atk`, spe.atk); setText(`d${idx}_c_spe_df`, spe.df);
    setText(`d${idx}_c_bf_hp`, (bf.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_atk`, (bf.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_df`, (bf.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_db_hp`, (db.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_db_atk`, (db.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_db_df`, (db.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_fin_hp`, fin.hp);
    setText(`d${idx}_c_fin_atk`, fin.atk);
    setText(`d${idx}_c_fin_df`, fin.df);
    setText(`d${idx}_c_eval`, Math.round(E).toString());
    setText(`d${idx}_c_bval`, (B/1e6).toFixed(3));  // ë‹¨ìœ„ â€˜Mâ€™ í‘œì‹œ ì—†ìŒ
  }

  function manualCalcAll(){
    ManualDragonState.dragons.forEach(dragon => {
      manualCalcOne(dragon.displayNumber);
    });
  }

  function savePngAll(){
    const node = document.getElementById('allResults');
    manualCalcAll(); // ìµœì‹  ê°’ ë³´ì¥
    const w = node.scrollWidth;
    const h = node.scrollHeight;

    html2canvas(node, {
      backgroundColor: null,
      scale: 2,
      width:  w,
      height: h,
      windowWidth:  w,
      windowHeight: h
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='dragon_calculate.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  const autoDiv=document.getElementById('autoCalc');
  const manualDiv=document.getElementById('manualCalc');
  const spiritDiv=document.getElementById('spiritCalc');
  const btnAuto=document.getElementById('btnAuto');
  const btnManual=document.getElementById('btnManual');
  const btnSpirit=document.getElementById('btnSpirit');

  // ê° ëª¨ë“œì˜ ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
  let autoScrollPos = 0;
  let manualScrollPos = 0;
  let spiritScrollPos = 0;

  const allDivs = [autoDiv, manualDiv, spiritDiv];
  const allBtns = [btnAuto, btnManual, btnSpirit];

  // ===== UI ëª¨ë“œ ì „í™˜ =====
  function switchMode(mode){
    // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
    const currentScroll = window.scrollY;

    allDivs.forEach(d => d.classList.remove('active'));
    allBtns.forEach(b => b.classList.remove('active'));

    if(mode==='auto'){
      autoDiv.classList.add('active');
      btnAuto.classList.add('active');
      window.scrollTo(0, autoScrollPos);
      autoScrollPos = 0;
    }else if(mode==='manual'){
      manualDiv.classList.add('active');
      btnManual.classList.add('active');
      window.scrollTo(0, manualScrollPos);
      manualScrollPos = 0;
    }else if(mode==='spirit'){
      spiritDiv.classList.add('active');
      btnSpirit.classList.add('active');
      window.scrollTo(0, spiritScrollPos);
      spiritScrollPos = 0;
      initSpiritPredAccessories();
    }
  }
  btnAuto.onclick=()=>switchMode('auto');
  btnManual.onclick=()=>switchMode('manual');
  btnSpirit.onclick=()=>switchMode('spirit');

  // ===== ì •ë ¹ ì˜ˆì¸¡ê¸° =====
  function initSpiritPredAccessories() {
    const sel = document.getElementById('sp_acc_select');
    if (!sel || sel.options.length > 1) return;
    ACC_TABLE.forEach((a, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${a[0]} Lv${a[1]} (HP+${a[2]}% ATK+${a[3]}% DEF+${a[4]}%)`;
      sel.appendChild(opt);
    });
  }

  function onSpiritPredAccChange(val) {
    if (val === '') return;
    const a = ACC_TABLE[Number(val)];
    document.getElementById('sp_acc_hp').value = a[2];
    document.getElementById('sp_acc_atk').value = a[3];
    document.getElementById('sp_acc_df').value = a[4];
  }

  function toggleSpiritPredMode() {
    const mode = document.querySelector('input[name="sp_spirit_mode"]:checked')?.value;
    document.getElementById('sp_spirit_slot_mode').style.display = mode === 'slot' ? 'block' : 'none';
    document.getElementById('sp_spirit_manual_mode').style.display = mode === 'manual' ? 'block' : 'none';
  }

  function getSpiritPredValues() {
    const mode = document.querySelector('input[name="sp_spirit_mode"]:checked')?.value;
    let flat = { hp: 0, atk: 0, df: 0 };
    let pct = { hp: 0, atk: 0, df: 0 };
    let extra = { hp: 0, atk: 0, df: 0 };

    if (mode === 'slot') {
      for (let slot = 1; slot <= 4; slot++) {
        const stat = document.getElementById(`sp_slot${slot}_stat`)?.value;
        const type = document.getElementById(`sp_slot${slot}_type`)?.value;
        if (!stat || stat === 'none') continue;
        if (type === 'flat') flat[stat] += SPIRIT_FLAT_TBL[slot][stat];
        else if (type === 'pct') pct[stat] += SPIRIT_PCT_TBL[slot][stat];
      }
      const subIdx = parseInt(document.getElementById('sp_sub')?.value || 0);
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      extra = { hp: sub.hp, atk: sub.atk, df: sub.df };
    } else {
      flat = { hp: Number(document.getElementById('sp_sf_hp')?.value||0), atk: Number(document.getElementById('sp_sf_atk')?.value||0), df: Number(document.getElementById('sp_sf_df')?.value||0) };
      pct = { hp: Number(document.getElementById('sp_sp_hp')?.value||0), atk: Number(document.getElementById('sp_sp_atk')?.value||0), df: Number(document.getElementById('sp_sp_df')?.value||0) };
      extra = { hp: Number(document.getElementById('sp_se_hp')?.value||0), atk: Number(document.getElementById('sp_se_atk')?.value||0), df: Number(document.getElementById('sp_se_df')?.value||0) };
    }
    return { flat, pct, extra };
  }

  function runSpiritPredictor() {
    const resultDiv = document.getElementById('spiritPredResult');

    // 1. ë“±ê¸‰
    const grade = document.querySelector('input[name="sp_grade"]:checked')?.value || '9.0';

    // 2. ì¥ì‹ êµ¬ + ì¸ì±ˆíŠ¸ â†’ accTotal
    const accHp = Number(document.getElementById('sp_acc_hp')?.value || 0);
    const accAtk = Number(document.getElementById('sp_acc_atk')?.value || 0);
    const accDf = Number(document.getElementById('sp_acc_df')?.value || 0);
    const enchHp = Number(document.getElementById('sp_ench_hp')?.value || 0);
    const enchAtk = Number(document.getElementById('sp_ench_atk')?.value || 0);
    const enchDf = Number(document.getElementById('sp_ench_df')?.value || 0);
    const accTotal = new Stats((accHp + enchHp) / 100, (accAtk + enchAtk) / 100, (accDf + enchDf) / 100);

    // 3. ì ¬
    const gemBase = {
      hp: Number(document.querySelector('input[name="sp_gem_hp"]:checked')?.value || 156),
      atk: Number(document.querySelector('input[name="sp_gem_atk"]:checked')?.value || 39),
      df: Number(document.querySelector('input[name="sp_gem_df"]:checked')?.value || 39)
    };

    // 4. íœë˜íŠ¸
    const pendHp = Number(document.getElementById('sp_pend_hp')?.value || 0);
    const pendAtk = Number(document.getElementById('sp_pend_atk')?.value || 0);
    const pendDf = Number(document.getElementById('sp_pend_df')?.value || 0);
    const pendStats = new Stats(pendHp / 100, pendAtk / 100, pendDf / 100);

    // 5. ì •ë ¹
    const spirit = getSpiritPredValues();
    const spiritFlat = new Stats(spirit.flat.hp, spirit.flat.atk, spirit.flat.df);
    const spiritPct = new Stats(spirit.pct.hp / 100, spirit.pct.atk / 100, spirit.pct.df / 100);
    const spiritExtra = new Stats(spirit.extra.hp, spirit.extra.atk, spirit.extra.df);

    // 6. ë²„í”„/ë””ë²„í”„
    const buff = new Stats(
      Number(document.getElementById('sp_bf_hp')?.value || 0) / 100,
      Number(document.getElementById('sp_bf_atk')?.value || 0) / 100,
      Number(document.getElementById('sp_bf_df')?.value || 0) / 100
    );
    const debuff = new Stats(
      Number(document.getElementById('sp_db_hp')?.value || 0) / 100,
      Number(document.getElementById('sp_db_atk')?.value || 0) / 100,
      Number(document.getElementById('sp_db_df')?.value || 0) / 100
    );

    // ê³ ì •ê°’
    const pot = new Stats(24, 6, 6);
    const col = new Stats(240, 60, 60);
    const types = ['ê³µê²©í˜•', 'ë°©ì–´í˜•', 'ì²´ë ¥í˜•', 'ê³µë°©í˜•', 'ì²´ê³µí˜•', 'ì²´ë°©í˜•'];

    // 7. ê° íƒ€ì…ë³„ë¡œ ìµœì  ì ¬ ë¶„ë°°ë¥¼ ì°¾ì•„ ìµœê³  B-value ê³„ì‚°
    const typeResults = [];

    types.forEach(type => {
      const baseStats = dragon[grade][type];
      let bestB = -Infinity;
      let bestResult = null;

      // ì ¬ 5ì¹¸ ë¶„ë°°
      for (let hpG = 0; hpG <= 5; hpG++) {
        for (let atkG = 0; atkG <= 5 - hpG; atkG++) {
          const dfG = 5 - hpG - atkG;
          const gemTotal = new Stats(gemBase.hp * hpG, gemBase.atk * atkG, gemBase.df * dfG);

          const [finalStats, ev, bv] = calcPredict(
            baseStats, gemTotal, pot, accTotal, pendStats,
            spiritFlat, spiritPct, spiritExtra, col, buff, debuff
          );

          if (bv > bestB) {
            bestB = bv;
            bestResult = {
              type, finalStats, eValue: ev, bValue: bv,
              gems: `HP${hpG} ATK${atkG} DEF${dfG}`
            };
          }
        }
      }
      if (bestResult) typeResults.push(bestResult);
    });

    // 8. B-value ì •ë ¬
    typeResults.sort((a, b) => b.bValue - a.bValue);

    // 9. ê²°ê³¼ ë Œë”ë§
    const best = typeResults[0];
    let html = `
      <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:10px 14px;border-radius:6px;margin-bottom:10px;text-align:center;">
        <div style="font-size:11px;opacity:0.8;margin-bottom:2px;">ìµœì  ë“œë˜ê³¤ íƒ€ì…</div>
        <div style="font-size:22px;font-weight:800;letter-spacing:1px;">${best.type}</div>
        <div style="font-size:13px;margin-top:4px;">B-Value: <b>${best.bValue.toLocaleString()}</b> &nbsp;|&nbsp; E-Value: <b>${best.eValue.toLocaleString()}</b></div>
        <div style="font-size:11px;opacity:0.8;margin-top:2px;">ìµœì  ì ¬: ${best.gems} &nbsp;|&nbsp; HP ${best.finalStats.hp.toLocaleString()} / ATK ${best.finalStats.atk.toLocaleString()} / DEF ${best.finalStats.df.toLocaleString()}</div>
      </div>
    `;

    // ë¹„êµí‘œ
    html += `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:#f1f5f9;">
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:center;">ìˆœìœ„</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:center;">íƒ€ì…</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:center;">ìµœì ì ¬</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:right;">HP</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:right;">ATK</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:right;">DEF</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:right;">E-Value</th>
          <th style="padding:6px 8px;border:1px solid var(--border);text-align:right;">B-Value</th>
        </tr>
      </thead><tbody>`;

    typeResults.forEach((r, i) => {
      const isBest = i === 0;
      const bg = isBest ? 'background:#eff6ff;font-weight:700;' : '';
      const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}`;
      html += `<tr style="${bg}">
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:center;">${medal}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:center;font-weight:600;">${r.type}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:center;font-size:11px;">${r.gems}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:right;">${r.finalStats.hp.toLocaleString()}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:right;">${r.finalStats.atk.toLocaleString()}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:right;">${r.finalStats.df.toLocaleString()}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:right;">${r.eValue.toLocaleString()}</td>
        <td style="padding:5px 8px;border:1px solid var(--border);text-align:right;color:${isBest?'var(--accent)':'inherit'};">${r.bValue.toLocaleString()}</td>
      </tr>`;
    });

    html += '</tbody></table></div>';

    // 1ìœ„ ëŒ€ë¹„ ì°¨ì´ ë¹„êµ ë°”
    const maxB = typeResults[0].bValue;
    html += '<div style="margin-top:10px;">';
    html += '<div style="font-size:12px;font-weight:600;margin-bottom:6px;color:#475569;">íƒ€ì…ë³„ B-Value ë¹„êµ</div>';
    typeResults.forEach((r, i) => {
      const pct = maxB > 0 ? (r.bValue / maxB * 100) : 0;
      const barColor = i === 0 ? 'var(--accent)' : i === 1 ? '#60a5fa' : i === 2 ? '#93c5fd' : '#cbd5e1';
      html += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
        <span style="width:50px;font-size:11px;font-weight:600;text-align:right;">${r.type}</span>
        <div style="flex:1;background:#f1f5f9;border-radius:3px;height:18px;overflow:hidden;">
          <div style="width:${pct.toFixed(1)}%;height:100%;background:${barColor};border-radius:3px;transition:width 0.3s;"></div>
        </div>
        <span style="width:50px;font-size:10px;color:#666;">${pct.toFixed(1)}%</span>
      </div>`;
    });
    html += '</div>';

    resultDiv.innerHTML = html;
  }

  // ===== ì‚¬ìš©ë²• íŒì—… =====
  function openHelpModal() {
    const modalHtml = `
      <div id="helpModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;position:relative;">
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:16px 20px;border-radius:12px 12px 0 0;position:sticky;top:0;z-index:1;">
            <h2 style="margin:0;font-size:20px;">ğŸ“– ë“œë˜ê³¤ ê³„ì‚°ê¸° ì‚¬ìš©ë²•</h2>
            <button onclick="closeHelpModal()" style="position:absolute;top:12px;right:15px;background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:22px;cursor:pointer;width:32px;height:32px;border-radius:50%;">Ã—</button>
          </div>

          <div style="padding:20px;">

            <!-- ìë™ ê³„ì‚°ê¸° -->
            <div style="margin-bottom:20px;">
              <h3 style="color:#667eea;border-bottom:2px solid #667eea;padding-bottom:6px;margin-bottom:12px;font-size:16px;">ğŸ”„ ìë™ ê³„ì‚°ê¸°</h3>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">1. ê³„ì‚° ëª¨ë“œ ì„ íƒ</h4>
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li><b>Normal:</b> ì„ íƒí•œ ì¥ì‹ êµ¬ë“¤ë¡œ ê° ë“œë˜ê³¤ë³„ ê°œë³„ ê³„ì‚°</li>
                  <li><b>Optimize:</b> ì¥ì‹ êµ¬ ë³´ìœ  ê°œìˆ˜ë¥¼ ê³ ë ¤í•œ ë“œë˜ê³¤ë³„ ìµœì  ì¥ì‹ êµ¬ ìë™ ë¶„ë°°</li>
                </ul>
              </div>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">2. ë“œë˜ê³¤ ì¶”ê°€</h4>
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li>ë“±ê¸‰(7.0/8.0/9.0)ê³¼ íƒ€ì… ì„ íƒ í›„ <b>"ì¶”ê°€"</b> í´ë¦­</li>
                  <li>ìµœëŒ€ 9ë§ˆë¦¬ê¹Œì§€ ì¶”ê°€ ê°€ëŠ¥, ì‚­ì œ ë²„íŠ¼ìœ¼ë¡œ ì œê±°</li>
                </ul>
              </div>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">3. ì„¤ì •ê°’ ì…ë ¥</h4>
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li><b>ì ¬:</b> HP/ATK/DEF ì ¬ ìˆ˜ì¹˜ ì„ íƒ (ì™¼ìª½ ì»¬ëŸ¼)</li>
                  <li><b>ì¥ì‹ êµ¬:</b> ì ¬ ì•„ë˜ ëª©ë¡ì—ì„œ ê³„ì‚°ì— í¬í•¨í•  ì¥ì‹ êµ¬ ì²´í¬</li>
                  <li><b>íœë˜íŠ¸:</b> ê°€ìš´ë° ì»¬ëŸ¼ ë“œë˜ê³¤ë³„ íƒ­ì—ì„œ ìë™/ì§€ì •/ìˆ˜ë™ ëª¨ë“œ ì„ íƒ</li>
                  <li><b>ì •ë ¹:</b> ìŠ¬ë¡¯ë³„ ì˜µì…˜ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥</li>
                  <li><b>ë²„í”„/ë””ë²„í”„:</b> - ë˜ëŠ” 20 ì„ íƒ</li>
                </ul>
              </div>
              <div style="background:#e3f2fd;padding:10px 12px;border-radius:6px;">
                <h4 style="margin:0 0 6px;color:#1565c0;font-size:13px;">ğŸ’¡ íŒ: ê²°ê³¼ í´ë¦­</h4>
                <p style="margin:0;color:#555;font-size:13px;">ê³„ì‚° ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì„¤ì •ì´ <b>ìˆ˜ë™ ê³„ì‚°ê¸°</b>ì— ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤!</p>
              </div>
            </div>

            <!-- ìˆ˜ë™ ê³„ì‚°ê¸° -->
            <div style="margin-bottom:20px;">
              <h3 style="color:#667eea;border-bottom:2px solid #667eea;padding-bottom:6px;margin-bottom:12px;font-size:16px;">âœï¸ ìˆ˜ë™ ê³„ì‚°ê¸°</h3>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;">
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li>ëª¨ë“  ê°’ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì„¸ë°€í•˜ê²Œ ê³„ì‚°</li>
                  <li>ìë™ ê³„ì‚°ê¸° ê²°ê³¼ í´ë¦­ìœ¼ë¡œ ê°’ ìë™ ê°€ì ¸ì˜¤ê¸° ê°€ëŠ¥</li>
                  <li>4ë§ˆë¦¬ ì´ìƒì¼ ê²½ìš° ê²°ê³¼ì— í‘œì‹œí•  ë“œë˜ê³¤ ì„ íƒ (ìµœëŒ€ 3ë§ˆë¦¬)</li>
                  <li><b>ì´ë¯¸ì§€ ì €ì¥:</b> ê³„ì‚° ê²°ê³¼ë¥¼ PNG ì´ë¯¸ì§€ë¡œ ì €ì¥</li>
                </ul>
              </div>
            </div>

            <!-- ì •ë ¹ ì˜ˆì¸¡ê¸° -->
            <div style="margin-bottom:20px;">
              <h3 style="color:#667eea;border-bottom:2px solid #667eea;padding-bottom:6px;margin-bottom:12px;font-size:16px;">ğŸ”® ì •ë ¹ ì˜ˆì¸¡ê¸°</h3>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">ê¸°ëŠ¥ ì„¤ëª…</h4>
                <p style="margin:0 0 8px;color:#555;font-size:13px;">
                  íšë“í•œ ì •ë ¹ì„ ì–´ë–¤ ìš©ì— ì¥ì°©í•˜ë©´ ê°€ì¥ íš¨ìœ¨ì ì¸ì§€ ë¶„ì„í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.<br>
                  ë™ì¼í•œ ì¡°ê±´ì—ì„œ 6ê°œ íƒ€ì…(ê³µê²©/ë°©ì–´/ì²´ë ¥/ê³µë°©/ì²´ê³µ/ì²´ë°©) ëª¨ë‘ì— ì •ë ¹ì„ ì ìš©í•œ ê²°ê³¼ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
                </p>
              </div>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">ì…ë ¥ í•­ëª©</h4>
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li><b>ë“œë˜ê³¤ ë“±ê¸‰:</b> 7.0 / 8.0 / 9.0</li>
                  <li><b>ì¥ì‹ êµ¬:</b> ë“œë¡­ë‹¤ìš´ ì„ íƒ ë˜ëŠ” HP/ATK/DEF % ì§ì ‘ ì…ë ¥</li>
                  <li><b>ì ¬:</b> HP/ATK/DEF ì ¬ ìˆ˜ì¹˜ ì„ íƒ</li>
                  <li><b>ì¸ì±ˆíŠ¸:</b> HP/ATK/DEF ê°ê° - ë˜ëŠ” 21 ì„ íƒ</li>
                  <li><b>íœë˜íŠ¸:</b> HP/ATK/DEF % ì§ì ‘ ì…ë ¥</li>
                  <li><b>ì •ë ¹:</b> ìŠ¬ë¡¯ ì„ íƒ ëª¨ë“œ(4ìŠ¬ë¡¯ + ë¶€ê°€ì˜µ) ë˜ëŠ” ì§ì ‘ ì…ë ¥</li>
                  <li><b>ë²„í”„/ë””ë²„í”„:</b> - ë˜ëŠ” 20 ì„ íƒ</li>
                </ul>
              </div>
              <div style="background:#f8f9fa;padding:12px;border-radius:6px;">
                <h4 style="margin:0 0 6px;color:#333;font-size:14px;">ê²°ê³¼ í™•ì¸</h4>
                <ul style="margin:0;padding-left:18px;color:#555;line-height:1.7;font-size:13px;">
                  <li>ìµœì  ë“œë˜ê³¤ íƒ€ì…ì´ ìƒë‹¨ì— í¬ê²Œ í‘œì‹œë©ë‹ˆë‹¤</li>
                  <li>6ê°œ íƒ€ì… ìˆœìœ„í‘œì—ì„œ HP/ATK/DEF/E-Value/B-Value ë¹„êµ</li>
                  <li>ê° íƒ€ì…ë³„ ìµœì  ì ¬ ë¶„ë°°(5ì¹¸)ë„ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</li>
                  <li>í•˜ë‹¨ ë¹„êµ ë°” ì°¨íŠ¸ì—ì„œ B-Value ë¹„ìœ¨ì„ í•œëˆˆì— í™•ì¸</li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }

  function closeHelpModal() {
    const modal = document.getElementById('helpModal');
    if (modal) modal.remove();
  }
  </script>
</body>
</html>
