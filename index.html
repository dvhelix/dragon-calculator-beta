<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>드래곤 비벨/이벨 통합 계산기</title>
<style>
  :root{
    --bg:#f7f7f9; --ink:#111;
    --line:#cfcfd6; --accent:#2d6cdf;
    --black:#000; --grid:#b5b5bd;
  }
  body{font-family:Consolas,"Noto Sans KR",sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
  h2{margin:0 0 8px}
  .hint{color:#666;margin-bottom:14px}
  .small{color:#888;font-size:12px}

  .header-fixed{position:sticky;top:0;background:var(--bg);z-index:100;padding:12px 0;border-bottom:2px solid var(--line);margin-bottom:16px}
  .modebar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .btn{padding:8px 14px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:6px}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn:hover{background:#f0f0f0}

  .calc-container{display:none;overflow-y:auto;height:100%}
  .calc-container.active{display:block}

  fieldset{background:#fff;border:1px solid #ccc;padding:12px;margin-bottom:14px;border-radius:8px}
  legend{font-weight:700}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px}
  label{display:inline-flex;gap:6px;align-items:center}
  input[type="number"],select{height:28px;border:1px solid #aaa;border-radius:4px;text-align:center;background:#fff}
  input[type="text"]{height:28px;border:1px solid #aaa;border-radius:4px;background:#fff;padding:0 8px}

  .acc-list{max-height:220px;overflow:auto;border:1px solid #ddd;padding:8px;background:#fcfcfc;border-radius:6px}
  .toolbar{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}

  /* 정령/버프/디버프 */
  .row-spirit{
    display:grid;
    grid-template-columns: 150px 90px 90px 90px auto;
    align-items:center;
    column-gap:8px;
    margin-bottom:6px
  }
  .row-spirit strong{text-align:right;padding-right:4px;font-weight:700}

  /* 수동결과 시트 */
  .results-wrap{margin-top:14px}
  .results-row{display:inline-flex;gap:12px;align-items:flex-start;flex-wrap:nowrap}
  .sheet{
    background:#111; color:#e5e5e5;
    padding:12px; border-radius:10px;
    display:inline-block; min-width:530px;
  }
  .sheet .name{
    font-weight:900; font-size:18px; letter-spacing:.5px; margin-bottom:6px; text-align:center;
  }
  .grid{
    display:grid;
    grid-template-columns: 150px 120px 120px 120px;
    border:2px solid var(--black);
    background:#222;
  }
  .cell{
    border:1px solid var(--grid);
    padding:6px 8px; line-height:1.15;
    font-size:13px; background:#1a1a1a;
  }
  .cell.h{background:#303030;font-weight:700}
  .cell.section{background:#2b2b2b;color:#ffe4b5;font-weight:700;text-align:center}
  .cell.sum{background:#000;border-color:#444;color:#fff;font-size:15px}
  .cell.big{font-size:22px;font-weight:900;letter-spacing:1px;text-align:center;background:#000}
  .center{text-align:center}
  .right{text-align:right}
  pre.result{
    white-space:pre; background:#111; color:#e5e5e5;
    padding:12px; border-radius:8px; min-height:220px;
  }

  /* 모바일 반응형 */
  @media (max-width: 768px) {
    body{margin:12px;}
    .header-fixed{padding:8px 0;}
    h2{font-size:18px;}
    .hint{font-size:11px;}

    .modebar{gap:6px;}
    .btn{padding:6px 10px;font-size:13px;}

    .row{flex-direction:column;align-items:flex-start;gap:6px;}
    .row label{width:100%;}

    .row-spirit{
      grid-template-columns:1fr;
      gap:6px;
    }
    .row-spirit strong{text-align:left;padding-right:0;margin-bottom:4px;}
    .row-spirit input{width:100%;}

    input[type="number"],select,input[type="text"]{width:100% !important;box-sizing:border-box;}

    .toolbar{gap:6px;}
    .toolbar .btn{font-size:11px;padding:6px 8px;}

    .acc-list{max-height:180px;font-size:13px;}

    fieldset{padding:10px;}
    legend{font-size:14px;}

    .sheet{
      min-width:unset;
      width:100%;
      padding:10px;
      overflow-x:auto;
    }
    .sheet .name{font-size:16px;}

    .grid{
      grid-template-columns:80px repeat(3, 1fr);
      font-size:10px;
      min-width:320px;
    }
    .cell{padding:4px 5px;font-size:10px;}
    .cell.h{font-size:9px;padding:3px 4px;}
    .cell.big{font-size:14px;}
    .cell.sum{font-size:11px;}
    .cell.section{grid-column:1/5 !important;}

    .results-row{flex-direction:column;gap:12px;}

    #pendant_auto_row{flex-direction:column;align-items:flex-start;}
    #pendant_stats_row{flex-direction:column;align-items:flex-start;}
    #pendant_manual{flex-direction:column;align-items:flex-start;gap:8px;}

    pre.result{font-size:11px;padding:10px;min-height:150px;overflow-x:auto;}
  }

  /* 모바일에서 세로로 쌓기 */
  @media (max-width: 768px) {
    #viewSlotContent div[style*="grid-template-columns:1fr 1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
</head>

<body>
  <div class="header-fixed">
    <h2>드래곤 비벨/이벨 통합 계산기</h2>
    <div class="modebar">
      <button class="btn primary" id="btnAuto">자동 계산기</button>
      <button class="btn" id="btnResult">예측기 결과</button>
      <button class="btn" id="btnManual">수동 계산기</button>
      <button class="btn" id="btnServer">저장 서버</button>
    </div>
    <div class="hint small">모든 입력은 <b>HP / ATK / DEF</b> 순서입니다. · made by 헬릭스</div>
  </div>

  <div id="autoCalc" class="calc-container active">
    <!-- 등급/타입 -->
    <fieldset>
      <legend>등급 / 타입 선택</legend>
      <div class="row">
        <label><input type="radio" name="level" value="7.0">7.0</label>
        <label><input type="radio" name="level" value="8.0">8.0</label>
        <label><input type="radio" name="level" value="9.0" checked>9.0</label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input type="checkbox" class="dtype" value="공격형" checked>공격형</label>
        <label><input type="checkbox" class="dtype" value="방어형" checked>방어형</label>
        <label><input type="checkbox" class="dtype" value="체력형" checked>체력형</label>
        <label><input type="checkbox" class="dtype" value="공방형" checked>공방형</label>
        <label><input type="checkbox" class="dtype" value="체공형" checked>체공형</label>
        <label><input type="checkbox" class="dtype" value="체방형" checked>체방형</label>
      </div>
    </fieldset>

    <!-- 젬(자동 분배용 기본값만 필요: 실제 분배는 루프에서 순회) -->
    <fieldset>
      <legend>젬 선택 (※ 복수 선택 불가, 자동 분배에서 사용)</legend>
      <div class="row">
        <strong>HP</strong>
        <label><input type="radio" name="gem_hp" value="160">160</label>
        <label><input type="radio" name="gem_hp" value="156" checked>156</label>
        <label><input type="radio" name="gem_hp" value="152">152</label>
        <label><input type="radio" name="gem_hp" value="148">148</label>
      </div>
      <div class="row">
        <strong>ATK</strong>
        <label><input type="radio" name="gem_atk" value="40">40</label>
        <label><input type="radio" name="gem_atk" value="39" checked>39</label>
        <label><input type="radio" name="gem_atk" value="38">38</label>
        <label><input type="radio" name="gem_atk" value="37">37</label>
      </div>
      <div class="row">
        <strong>DEF</strong>
        <label><input type="radio" name="gem_df" value="40">40</label>
        <label><input type="radio" name="gem_df" value="39" checked>39</label>
        <label><input type="radio" name="gem_df" value="38">38</label>
        <label><input type="radio" name="gem_df" value="37">37</label>
      </div>
    </fieldset>

    <!-- 장신구 -->
    <fieldset>
      <legend>장신구 선택 (복수 선택 가능)</legend>
      <div class="toolbar">
        <button class="btn" type="button" id="btnToggleFavorites" onclick="toggleFavoritesFilter()">즐겨찾기만 보기</button>
        <button class="btn" type="button" onclick="toggleLevel(20)">Lv20 전체 선택/해제</button>
        <button class="btn" type="button" onclick="toggleLevel(19)">Lv19 전체 선택/해제</button>
        <button class="btn" type="button" onclick="toggleLevel(18)">Lv18 전체 선택/해제</button>
        <button class="btn" type="button" onclick="toggleLevel(17)">Lv17 전체 선택/해제</button>
        <button class="btn" type="button" onclick="selectNone()">전체 해제</button>
      </div>
      <div id="accList" class="acc-list"></div>
    </fieldset>

    <!-- 펜던트 -->
    <fieldset>
      <legend>펜던트</legend>

      <!-- 버전 선택 -->
      <div class="row" style="margin-bottom:8px;">
        <strong>버전 선택:</strong>
        <label><input type="radio" name="pendant_ver" value="v1" checked>Ver1 (자동 분배)</label>
        <label><input type="radio" name="pendant_ver" value="v2">Ver2 (지정 분배)</label>
        <label><input type="radio" name="pendant_ver" value="v3">Ver3 (수동 입력)</label>
      </div>

      <!-- 자동 분배용 (Ver1, Ver2 공용) -->
      <div class="row" id="pendant_auto_row">
        <strong>종류 / 값 입력:</strong>
        <label><input type="radio" name="pendant_mode" value="별">별</label>
        <label><input type="radio" name="pendant_mode" value="달" checked>달</label>
        <label><input type="radio" name="pendant_mode" value="태양">태양</label>
        <input id="pendant_value" type="number" value="12" style="width:90px;"> %
        <span class="small" id="pendantHint">별 ≤ 6, 달 ≤ 12, 태양 ≤ 18</span>
      </div>

      <!-- Ver2 전용 -->
      <div class="row" id="pendant_stats_row" style="margin-top:8px; display:none;">
        <strong>Ver2 스탯 선택:</strong>
        <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
        <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
        <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
      </div>

      <!-- Ver3 전용 -->
      <div id="pendant_manual" style="margin-top:8px; display:none; align-items:center; gap:4px;">
        <strong>수동 입력:</strong>
        HP <input id="pend_manual_hp" type="number" value="0" style="width:55px;">%
        ATK <input id="pend_manual_atk" type="number" value="0" style="width:55px;">%
        DEF <input id="pend_manual_df" type="number" value="0" style="width:55px;">%
      </div>
    </fieldset>

    <!-- 정령/버프/디버프 -->
    <fieldset>
      <legend>정령 / 버프 / 디버프 <button class="btn" type="button" onclick="resetSpiritBuffs()" style="margin-left:8px;font-size:12px;padding:4px 10px;">전체 초기화</button></legend>
      <div style="font-weight:bold; color:black; margin-bottom:6px;">(HP / ATK / DEF)</div>

      <div class="row-spirit"><strong>정령 + (플옵)</strong><input id="sf_hp" type="number" value="0"><input id="sf_atk" type="number" value="0"><input id="sf_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>정령 % (퍼옵)</strong><input id="sp_hp" type="number" value="0"><input id="sp_atk" type="number" value="0"><input id="sp_df" type="number" value="0"><span class="small">(% 입력)</span></div>
      <div class="row-spirit"><strong>정령 옵</strong><input id="se_hp" type="number" value="0"><input id="se_atk" type="number" value="0"><input id="se_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>버프 (%)</strong><input id="bf_hp" type="number" value="0"><input id="bf_atk" type="number" value="0"><input id="bf_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>디버프 (%)</strong><input id="db_hp" type="number" value="0"><input id="db_atk" type="number" value="0"><input id="db_df" type="number" value="0"></div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <span style="font-weight:700;">→ 수동계산기에 적용:</span>
        <button class="btn" type="button" onclick="copyToManualDragon(1)">드래곤1</button>
        <button class="btn" type="button" onclick="copyToManualDragon(2)">드래곤2</button>
        <button class="btn" type="button" onclick="copyToManualDragon(3)">드래곤3</button>
      </div>
    </fieldset>

    <!-- 기타 -->
    <fieldset>
      <legend>기타</legend>
      <div class="row">Top N <input id="top_n" type="number" value="5" style="width:80px"></div>
    </fieldset>

    <div class="toolbar">
      <button class="btn primary" type="button" onclick="calcAuto()">계산하기</button>
      <button class="btn" type="button" onclick="downloadTxt()">저장하기 (.txt)</button>
      <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff9800;color:#fff;border-color:#ff9800;">예측기 결과 초기화</button>
      <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">즐겨찾기 초기화</button>
    </div>

    <h3>결과</h3>
    <pre id="autoResult" class="result"></pre>
  </div>

  <div id="resultCalc" class="calc-container">
    <h3 style="margin:0 0 16px">예측기 결과 (누적)</h3>

    <div class="toolbar" style="margin-bottom:16px">
      <button class="btn" type="button" onclick="downloadAllResults()">전체 저장 (.txt)</button>
      <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">전체 삭제</button>
    </div>

    <pre id="resultStorage" class="result" style="min-height:400px"></pre>
  </div>

  <div id="manualCalc" class="calc-container">
    <h3 style="margin:0 0 16px">수동 계산기 (3마리 비교)</h3>

    <!-- 드래곤별 입력폼 (세로 정렬) -->
    <div id="inputsWrap" style="display:flex;flex-direction:column;gap:16px"></div>

    <!-- 계산/저장 버튼 -->
    <div style="margin:20px 0;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn primary" onclick="manualCalcAll()">수동 계산</button>
      <button class="btn" onclick="savePngAll()">결과를 PNG로 저장</button>
      <button class="btn" onclick="saveToServer()" style="background:#00aa88;color:#fff;border-color:#00aa88">서버에 저장</button>
      <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">즐겨찾기 초기화</button>
    </div>

    <!-- 결과 시트 (가로 비교) -->
    <div class="results-wrap">
      <div id="allResults" class="results-row"></div>
    </div>
  </div>

  <div id="serverCalc" class="calc-container">
    <h3 style="margin:0 0 16px">저장 서버</h3>

    <!-- 저장 슬롯 만들기 -->
    <fieldset>
      <legend>저장 슬롯 만들기</legend>
      <div class="row">
        <label>슬롯 이름
          <input id="newSlotName" type="text" placeholder="" style="width:200px">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="slotType" value="public" checked>공유 (누구나 접근 가능)</label>
        <label><input type="radio" name="slotType" value="private">잠금 (비밀번호 필요)</label>
      </div>
      <div class="row" id="slotPasswordRow" style="margin-top:8px;display:none">
        <label>비밀번호
          <input id="slotPassword" type="password" placeholder="비밀번호 입력" style="width:150px">
        </label>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="createSlot()">슬롯 만들기</button>
      </div>
    </fieldset>

    <!-- 저장된 슬롯 목록 -->
    <fieldset>
      <legend>저장된 슬롯 목록</legend>
      <div id="slotList" style="min-height:200px">
        <p style="color:#999;text-align:center;padding:40px 0">슬롯을 생성하거나 불러오는 중...</p>
      </div>
    </fieldset>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB90WAYMh6G8aWS3gzKw2wmT9X3O0zGoGw",
      authDomain: "dragon-calculator-8733b.firebaseapp.com",
      databaseURL: "https://dragon-calculator-8733b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dragon-calculator-8733b",
      storageBucket: "dragon-calculator-8733b.firebasestorage.app",
      messagingSenderId: "707550978178",
      appId: "1:707550978178:web:09607e55f05337c154949b"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // 전역으로 노출
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
  </script>

  <script>
  // ===== 데이터 구조 정의 =====
  class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}

  // 드래곤 기본 스탯 (등급별/타입별)
  const dragon={
   "7.0":{공격형:new Stats(876,285,161),방어형:new Stats(788,185,283),체력형:new Stats(1252,176,176),공방형:new Stats(720,242,243),체공형:new Stats(1080,262,133),체방형:new Stats(1080,133,262)},
   "8.0":{공격형:new Stats(876,305,161),방어형:new Stats(788,185,303),체력형:new Stats(1332,176,176),공방형:new Stats(720,252,253),체공형:new Stats(1120,272,133),체방형:new Stats(1120,133,272)},
   "9.0":{공격형:new Stats(876,325,161),방어형:new Stats(788,185,323),체력형:new Stats(1412,176,176),공방형:new Stats(720,262,263),체공형:new Stats(1160,282,133),체방형:new Stats(1160,133,282)}
  };

  // ===== 핵심 계산 함수 =====
  function eVal(s){return s.hp+4*s.atk+4*s.df;}
  function bVal(s){return s.hp*s.atk*s.df;}

  // 최종 스탯 계산 (모든 보너스 적용)
  function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
    const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
    const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
    const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                       Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                       Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
    const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
    const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
    const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
    const f = new Stats(
      s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
      s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
      s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
    );
    return [f, eVal(f), bVal(f)];
  }

  // ===== 유틸리티 함수 =====
  // 입력값 가져오기
  function val(id){ return Number(document.getElementById(id)?.value||0); }

  // 정령/버프/디버프 초기화
  function resetSpiritBuffs(){
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value=0;
    });
  }

  function copyToManualDragon(dragonIdx){
    // 자동계산기의 정령/버프/디버프 값을 수동계산기로 복사
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(field => {
      const value = val(field);
      const el = document.getElementById(`d${dragonIdx}_${field}`);
      if(el) el.value = value;
    });
    alert(`드래곤 ${dragonIdx}에 정령/버프/디버프 값이 적용되었습니다.`);
  }

  // ===== 장신구 즐겨찾기 관리 =====
  function resetFavorites() {
    const confirmed = confirm(
      '장신구 즐겨찾기를 초기화하시겠습니까?\n\n' +
      '※ 이 작업은 되돌릴 수 없습니다.'
    );

    if (confirmed) {
      try {
        localStorage.removeItem('accFavorites');
        alert('즐겨찾기가 초기화되었습니다.\n페이지를 새로고침합니다.');
        location.reload();
      } catch (e) {
        console.error('즐겨찾기 초기화 실패:', e);
        alert('초기화 중 오류가 발생했습니다.');
      }
    }
  }

  // ===== 장신구 데이터 테이블 =====
  // 형식: [이름, 레벨, HP%, ATK%, DEF%]
  const ACC_TABLE = [ ["악보(체)",20,20,0,0], ["여보(방)",20,0,0,20], ["황보(공)",20,0,20,0], ["바뿔(공/방)",20,0,10,10], ["바뿔(체/방)",20,10,0,10], ["바뿔(체/공)",20,10,10,0],
    ["바뿔(공/방)",19,0,10,9],["바뿔(체/방)",19,10,0,9],["바뿔(공/체)",19,9,10,0],
    ["불뿔(공/체)",19,6,13,0],["불뿔(공/방)",19,0,13,6],
    ["물뿔(체/방)",19,13,0,6],["물뿔(체/공)",19,13,6,0],
    ["대뿔(방/공)",19,0,6,13],["대뿔(방/체)",19,6,0,13],
    ["여보",19,0,0,19],["황보",19,0,19,0],["악보",19,19,0,0],
    ["바뿔(공/방)",18,0,9,9],["바뿔(체/방)",18,9,0,9],["바뿔(공/체)",18,9,9,0],
    ["불뿔(공/체)",18,6,12,0],["불뿔(공/방)",18,0,12,6],
    ["물뿔(체/방)",18,12,0,6],["물뿔(체/공)",18,12,6,0],
    ["대뿔(방/공)",18,0,6,12],["대뿔(방/체)",18,6,0,12],
    ["여보",18,0,0,18],["황보",18,0,18,0],["악보",18,18,0,0],
    ["바뿔(공/방)",17,0,9,8],["바뿔(체/방)",17,9,0,8],["바뿔(공/체)",17,9,8,0],
    ["불뿔(공/체)",17,6,11,0],["불뿔(공/방)",17,0,11,6],
    ["물뿔(체/방)",17,11,0,6],["물뿔(체/공)",17,11,6,0],
    ["대뿔(방/공)",17,0,6,11],["대뿔(방/체)",17,6,0,11],
    ["여보",17,0,0,17],["황보",17,0,17,0],["악보",17,17,0,0],
  ];

  // 전역 변수
  let accCheckboxes = [];
  let accFavorites = new Set();
  let showOnlyFavorites = false;

  // 즐겨찾기 불러오기
  function loadFavorites() {
    try {
      const saved = localStorage.getItem('accFavorites');
      if (saved) {
        accFavorites = new Set(JSON.parse(saved));
      }
    } catch (e) {
      console.error('즐겨찾기 불러오기 실패:', e);
    }
  }

  // 즐겨찾기 저장
  function saveFavorites() {
    try {
      localStorage.setItem('accFavorites', JSON.stringify([...accFavorites]));
    } catch (e) {
      console.error('즐겨찾기 저장 실패:', e);
    }
  }

  // 즐겨찾기 토글
  function toggleFavorite(accId) {
    if (accFavorites.has(accId)) {
      accFavorites.delete(accId);
    } else {
      accFavorites.add(accId);
    }
    saveFavorites();
    renderAccessories();
  }

  function renderAccessories() {
    const accListEl = document.getElementById('accList');
    accListEl.innerHTML = '';
    accCheckboxes = [];

    // 즐겨찾기 정렬: 즐겨찾기가 위로
    const sortedTable = [...ACC_TABLE].map((r, i) => ({ data: r, index: i }))
      .sort((a, b) => {
        const aFav = accFavorites.has('acc_' + a.index);
        const bFav = accFavorites.has('acc_' + b.index);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return 0;
      });

    sortedTable.forEach(({ data: r, index: i }) => {
      const [n, l, h, a, d] = r;
      const id = 'acc_' + i;
      const isFavorite = accFavorites.has(id);

      // 즐겨찾기 필터 적용
      if (showOnlyFavorites && !isFavorite) return;

      const line = document.createElement('div');
      line.style.cssText = 'display:flex;align-items:center;gap:6px;padding:2px 0;';

      const starBtn = document.createElement('button');
      starBtn.textContent = isFavorite ? '⭐' : '☆';
      starBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:2px 6px;';
      starBtn.title = isFavorite ? '즐겨찾기 해제' : '즐겨찾기 추가';
      starBtn.onclick = (e) => {
        e.preventDefault();
        toggleFavorite(id);
      };

      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%`;
      label.style.flex = '1';

      line.appendChild(starBtn);
      line.appendChild(label);
      accListEl.appendChild(line);
      accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d });
    });
  }

  // 즐겨찾기 필터 토글
  function toggleFavoritesFilter() {
    showOnlyFavorites = !showOnlyFavorites;
    const btn = document.getElementById('btnToggleFavorites');
    if (btn) {
      btn.textContent = showOnlyFavorites ? '전체 보기' : '즐겨찾기만 보기';
      btn.classList.toggle('primary', showOnlyFavorites);
    }
    renderAccessories();
  }

  loadFavorites();
  renderAccessories();

  function selectNone(){
    accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
  }

  function toggleLevel(level){
    const filtered = accCheckboxes.filter(o => o.level === level);
    const allChecked = filtered.every(o => document.getElementById(o.id).checked);
    filtered.forEach(o => document.getElementById(o.id).checked = !allChecked);
  }

  document.querySelectorAll('input[name="pendant_ver"]').forEach(r => {
    r.addEventListener('change', () => {
      const ver = document.querySelector('input[name="pendant_ver"]:checked').value;
      document.getElementById("pendant_auto_row").style.display = (ver === "v3") ? "none" : "flex";
      document.getElementById("pendant_stats_row").style.display = (ver === "v2") ? "flex" : "none";
      document.getElementById("pendant_manual").style.display = (ver === "v3") ? "flex" : "none";
    });
  });
  window.addEventListener("DOMContentLoaded", () => {
    // 펜던트 버전 UI 초기화
    document.querySelector('input[name="pendant_ver"]:checked')?.dispatchEvent(new Event('change'));
  });

  // ===== 펜던트 조합 생성 =====
  function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
    const MAX = 6;
    const combos = [];

    if (total <= 0) return [[[0,0,0]]];

    // 선택된 스탯의 인덱스 배열 생성 (HP:0, ATK:1, DEF:2)
    const statIdx = [];
    if (selectedStats.includes("HP"))  statIdx.push(0);
    if (selectedStats.includes("ATK")) statIdx.push(1);
    if (selectedStats.includes("DEF")) statIdx.push(2);

    // 별 펜던트: 1슬롯
    if (mode === "별") {
      const value = Math.min(total, MAX);
      return statIdx.map(i => {
        const slot = [0,0,0];
        slot[i] = value;
        return [slot];
      });
    }

    // 달 펜던트: 2슬롯
    if (mode === "달") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          if (x+y === total)
            for (let i of statIdx)
              for (let j of statIdx) {
                const slot1=[0,0,0], slot2=[0,0,0];
                slot1[i]=x; slot2[j]=y;
                combos.push([slot1, slot2]);
              }
      return combos;
    }

    // 태양 펜던트: 3슬롯
    if (mode === "태양") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          for (let z=1; z<=MAX; z++)
            if (x+y+z === total)
              for (let i of statIdx)
                for (let j of statIdx)
                  for (let k of statIdx) {
                    const slot1=[0,0,0], slot2=[0,0,0], slot3=[0,0,0];
                    slot1[i]=x; slot2[j]=y; slot3[k]=z;
                    combos.push([slot1, slot2, slot3]);
                  }
      return combos;
    }

    return [[[0,0,0]]];
  }

  // ===== 자동 계산기 =====
  function calcAuto(){
    const resultBox = document.getElementById("autoResult");
    resultBox.innerHTML = '<div style="text-align:center;padding:40px;color:#666;"><div style="font-weight:700;margin-bottom:10px;">계산 중입니다...</div><small style="color:#999;">조합이 많을 경우 시간이 걸릴 수 있습니다.</small></div>';

    // UI 업데이트를 위한 짧은 딜레이
    setTimeout(() => {
      calcAutoCore();
    }, 50);
  }

  function calcAutoCore(){
    const resultBox = document.getElementById("autoResult");

    // 1. 사용자 입력값 수집
    const level = document.querySelector('input[name="level"]:checked')?.value || '9.0';

    const dragonTypes = {};
    document.querySelectorAll(".dtype").forEach(cb => dragonTypes[cb.value] = cb.checked);
    const selectedTypes = Object.keys(dragonTypes).filter(k => dragonTypes[k]);
    if (!selectedTypes.length) {
      resultBox.textContent = "드래곤 타입이 선택되지 않았습니다.";
      return;
    }

    const gemBase = {
      hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 160),
      atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 40),
      df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 40)
    };

    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id).checked);
    if (!selectedAcc.length) {
      resultBox.textContent = "장신구가 선택되지 않았습니다.";
      return;
    }

    // 펜던트 설정
    const pendantMode = document.querySelector('input[name="pendant_mode"]:checked')?.value || "달";
    const pendantValue = Number(document.getElementById("pendant_value")?.value || 12);
    const pendantVer = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
    const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // 상수 및 기타
    const topN = Number(document.getElementById("top_n").value || 5);
    const ENCHANT = 21;  // 인첸트 % (HP/ATK/DEF 각 방향)
    const pot = new Stats(24, 6, 6);    // 포텐셜 (고정)
    const col = new Stats(240, 60, 60); // 수집 효과 (고정)

    // 정령/버프/디버프
    const spiritFlat = new Stats(val('sf_hp'), val('sf_atk'), val('sf_df'));
    const spiritPct = new Stats(val('sp_hp')/100, val('sp_atk')/100, val('sp_df')/100);
    const spiritExtra = new Stats(val('se_hp'), val('se_atk'), val('se_df'));
    const buff = new Stats(val('bf_hp')/100, val('bf_atk')/100, val('bf_df')/100);
    const debuff = new Stats(val('db_hp')/100, val('db_atk')/100, val('db_df')/100);

    // 2. 펜던트 조합 생성
    let pendantCombinations = [];
    let manualPendantStr = "";

    if (pendantVer === "v3") {
      // Ver3: 수동 입력
      const ph = Number(document.getElementById("pend_manual_hp")?.value || 0) / 100;
      const pa = Number(document.getElementById("pend_manual_atk")?.value || 0) / 100;
      const pd = Number(document.getElementById("pend_manual_df")?.value || 0) / 100;
      pendantCombinations = [[[ph, pa, pd]]];
      const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
      manualPendantStr = `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`;
    } else {
      // Ver1/Ver2: 자동 조합 생성
      const maxValues = {별:6, 달:12, 태양:18};
      const limit = maxValues[pendantMode] || 0;
      if (pendantValue > limit || pendantValue <= 0) {
        resultBox.textContent = "펜던트 값을 다시 확인해주세요.";
        return;
      }
      const stats = (pendantVer === "v2") ? selectedStats : ["HP", "ATK", "DEF"];
      pendantCombinations = genPend(pendantValue, pendantMode, stats);
      if (!pendantCombinations.length) {
        resultBox.textContent = "펜던트 조합 생성 오류";
        return;
      }
    }

    // 3. 모든 조합에 대해 계산 수행
    const results = [];

    for (const accessory of selectedAcc) {
      const accPctBase = {
        hp: accessory.hp / 100,
        atk: accessory.atk / 100,
        df: accessory.df / 100
      };

      for (const type of selectedTypes) {
        const baseStats = dragon[level][type];

        // 젬 5칸 분배 (HP + ATK + DEF = 5)
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(
              gemBase.hp * hpGems,
              gemBase.atk * atkGems,
              gemBase.df * defGems
            );

            // 인첸트 방향 (HP, ATK, DEF 중 하나)
            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(
                accPctBase.hp + enchantBonus.hp,
                accPctBase.atk + enchantBonus.atk,
                accPctBase.df + enchantBonus.df
              );

              // 펜던트 조합
              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                // 최종 스탯 계산
                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                // 결과 문자열 생성
                const pendantSlotStr = (pendantVer === "v3")
                  ? manualPendantStr
                  : pendant.map(slot =>
                      ["HP","ATK","DEF"]
                        .map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "")
                        .filter(Boolean)
                        .join(" ")
                    ).join(" / ");

                const pendantLabel = (pendantVer === "v3") ? "수동입력" : pendantMode;
                const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                const line1 = `${type} | ${accessory.name} Lv${accessory.level} | 젬: HP${hpGems} ATK${atkGems} DEF${defGems} | 펜던트: ${pendantLabel} (${pendantSlotStr}) | 인첸트: ${enchantLabel} +${ENCHANT}%\n`;
                const line2 = `HP=${finalStats.hp} | ATK=${finalStats.atk} | DEF=${finalStats.df} | E=${eValue.toFixed(0)} | B=${(bValue/1e6).toFixed(3)}\n`;

                results.push({ B: bValue, display_line1: line1, display_line2: line2 });
              }
            }
          }
        }
      }
    }

    // 4. 결과 출력
    if (!results.length) {
      resultBox.textContent = "결과가 생성되지 않았습니다.";
      return;
    }

    results.sort((a, b) => b.B - a.B);
    const topResults = results.slice(0, topN)
      .map((r, i) => `[${i + 1}위] ${r.display_line1}${r.display_line2}`)
      .join("\n");

    // 자동 계산기 결과 출력
    resultBox.textContent = topResults;

    // 예측기 결과 탭에 자동 저장
    const resultStorage = document.getElementById("resultStorage");
    const timestamp = new Date().toLocaleString('ko-KR', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });

    const separator = resultStorage.textContent.trim() ?
      `\n\n${'='.repeat(80)}\n[${timestamp}] 새로운 계산 결과\n${'='.repeat(80)}\n\n` :
      `[${timestamp}] 계산 결과\n${'='.repeat(80)}\n\n`;

    resultStorage.textContent = resultStorage.textContent + separator + topResults;
  }

  // ===== 예측기 결과 관리 =====
  function clearAllResults() {
    if (confirm('예측기 결과 탭의 모든 결과를 삭제하시겠습니까?')) {
      document.getElementById("resultStorage").textContent = "";
      alert("전체 결과가 삭제되었습니다.");
    }
  }

  function downloadAllResults() {
    const text = document.getElementById("resultStorage").textContent || "";
    if (!text.trim()) {
      alert("저장할 결과가 없습니다.");
      return;
    }
    const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dragon_results_all.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function downloadTxt(){
    const text=document.getElementById("autoResult").textContent||"";
    if(!text.trim()) return;
    const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="dragon_result.txt";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  const gemOptions = {
    HP: [160, 156, 152, 148],
    ATK: [40, 39, 38, 37],
    DEF: [40, 39, 38, 37]
  };

  // 페이지 로드 시 3마리 드래곤 자동 생성
  window.addEventListener('DOMContentLoaded', () => {
    renderAll(3);
  });

  function renderAll(count){
    const inputsWrap = document.getElementById('inputsWrap');
    const allResults = document.getElementById('allResults');

    inputsWrap.innerHTML = '';
    allResults.innerHTML = '';

    for(let i=1; i<=count; i++){
      renderOneInput(i);
      renderOneResult(i);
    }
  }

  function renderOneInput(idx){
    const box = document.createElement('div');
    box.className = 'dragon-input';
    box.style.cssText = 'border:1px solid var(--line);background:#fff;border-radius:8px;padding:12px';
    box.innerHTML = `
      <div class="row">
        <strong style="font-size:16px">드래곤 ${idx}</strong>
        <label>이름 <input id="d${idx}_name" type="text"></label>
      </div>

      <fieldset>
        <legend>등급 / 타입</legend>
        <div class="row">
          <label>등급
            <select id="d${idx}_m_level">
              <option value="7.0">7.0</option>
              <option value="8.0">8.0</option>
              <option value="9.0" selected>9.0</option>
            </select>
          </label>
          <label>타입
            <select id="d${idx}_m_type">
              <option>공격형</option>
              <option>방어형</option>
              <option>체력형</option>
              <option>공방형</option>
              <option>체공형</option>
              <option>체방형</option>
            </select>
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>젬 슬롯 (5개)</legend>
        <div id="d${idx}_gem_slots"></div>
      </fieldset>

      <fieldset>
        <legend>장신구 / 인첸트 (%)</legend>
        <div class="row">
          장신구 HP <input id="d${idx}_m_acc_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_acc_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_acc_df" type="number" value="0" style="width:90px">
        </div>
        <div class="row">
          인첸트 HP <input id="d${idx}_m_ench_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_ench_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_ench_df" type="number" value="0" style="width:90px">
        </div>
      </fieldset>

      <fieldset>
        <legend>펜던트 (%)</legend>
        <div class="row">
          HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:90px">
        </div>
      </fieldset>

      <fieldset>
        <legend>정령 / 버프 / 디버프</legend>
        <div style="font-weight:700;margin-bottom:6px">(HP / ATK / DEF)</div>
        <div class="row-spirit"><strong>정령 + (플옵)</strong>
          <input id="d${idx}_sf_hp" type="number" value="0">
          <input id="d${idx}_sf_atk" type="number" value="0">
          <input id="d${idx}_sf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>정령 % (퍼옵)</strong>
          <input id="d${idx}_sp_hp" type="number" value="0">
          <input id="d${idx}_sp_atk" type="number" value="0">
          <input id="d${idx}_sp_df" type="number" value="0">
          <span class="small">% 입력</span>
        </div>
        <div class="row-spirit"><strong>정령 부가옵</strong>
          <input id="d${idx}_se_hp" type="number" value="0">
          <input id="d${idx}_se_atk" type="number" value="0">
          <input id="d${idx}_se_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>버프 (%)</strong>
          <input id="d${idx}_bf_hp" type="number" value="0">
          <input id="d${idx}_bf_atk" type="number" value="0">
          <input id="d${idx}_bf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>디버프 (%)</strong>
          <input id="d${idx}_db_hp" type="number" value="0">
          <input id="d${idx}_db_atk" type="number" value="0">
          <input id="d${idx}_db_df" type="number" value="0">
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(box);
    renderGems(idx);
  }

  function renderGems(idx){
    const c=document.getElementById(`d${idx}_gem_slots`); c.innerHTML='';
    for(let i=1;i<=5;i++){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `
        <strong style="width:64px;display:inline-block">젬${i}</strong>
        <select id="d${idx}_slot_type_${i}">
          <option value="">--종류--</option>
          <option value="HP">HP</option>
          <option value="ATK">ATK</option>
          <option value="DEF">DEF</option>
        </select>
        <select id="d${idx}_slot_val_${i}">
          <option value="0">--값--</option>
        </select>`;
      c.appendChild(row);

      const typeSel=row.querySelector(`#d${idx}_slot_type_${i}`);
      const valSel=row.querySelector(`#d${idx}_slot_val_${i}`);
      typeSel.addEventListener('change', ()=>{
        valSel.innerHTML = `<option value="0">--값--</option>`;
        const t=typeSel.value;
        if(t && gemOptions[t]){
          gemOptions[t].forEach(v=>{
            const op=document.createElement('option');
            op.value=v; op.textContent=v; valSel.appendChild(op);
          });
        }
      });
    }
  }

function renderOneResult(idx){
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.id = `resultSheet_${idx}`;
  sheet.innerHTML = `
    <div class="name" id="d${idx}_name_display">드래곤 ${idx}</div>
    <div class="grid">
      <div class="cell h center">구분</div>
      <div class="cell h center">체력</div>
      <div class="cell h center">공격력</div>
      <div class="cell h center">방어력</div>

      <div class="cell">기본 스탯</div>
      <div class="cell right" id="d${idx}_c_base_hp">-</div>
      <div class="cell right" id="d${idx}_c_base_atk">-</div>
      <div class="cell right" id="d${idx}_c_base_df">-</div>

      <div class="cell">젬1</div><div class="cell right" id="d${idx}_c_g1_hp">0</div><div class="cell right" id="d${idx}_c_g1_atk">0</div><div class="cell right" id="d${idx}_c_g1_df">0</div>
      <div class="cell">젬2</div><div class="cell right" id="d${idx}_c_g2_hp">0</div><div class="cell right" id="d${idx}_c_g2_atk">0</div><div class="cell right" id="d${idx}_c_g2_df">0</div>
      <div class="cell">젬3</div><div class="cell right" id="d${idx}_c_g3_hp">0</div><div class="cell right" id="d${idx}_c_g3_atk">0</div><div class="cell right" id="d${idx}_c_g3_df">0</div>
      <div class="cell">젬4</div><div class="cell right" id="d${idx}_c_g4_hp">0</div><div class="cell right" id="d${idx}_c_g4_atk">0</div><div class="cell right" id="d${idx}_c_g4_df">0</div>
      <div class="cell">젬5</div><div class="cell right" id="d${idx}_c_g5_hp">0</div><div class="cell right" id="d${idx}_c_g5_atk">0</div><div class="cell right" id="d${idx}_c_g5_df">0</div>

      <div class="cell">장신구 %</div><div class="cell right" id="d${idx}_c_acc_hp">0%</div><div class="cell right" id="d${idx}_c_acc_atk">0%</div><div class="cell right" id="d${idx}_c_acc_df">0%</div>
      <div class="cell">인첸트 %</div><div class="cell right" id="d${idx}_c_ench_hp">0%</div><div class="cell right" id="d${idx}_c_ench_atk">0%</div><div class="cell right" id="d${idx}_c_ench_df">0%</div>
      <div class="cell">펜던트 %</div><div class="cell right" id="d${idx}_c_pend_hp">0%</div><div class="cell right" id="d${idx}_c_pend_atk">0%</div><div class="cell right" id="d${idx}_c_pend_df">0%</div>

      <div class="cell">정령 +</div><div class="cell right" id="d${idx}_c_spf_hp">0</div><div class="cell right" id="d${idx}_c_spf_atk">0</div><div class="cell right" id="d${idx}_c_spf_df">0</div>
      <div class="cell">정령 %</div><div class="cell right" id="d${idx}_c_spp_hp">0%</div><div class="cell right" id="d${idx}_c_spp_atk">0%</div><div class="cell right" id="d${idx}_c_spp_df">0%</div>
      <div class="cell">정령 부가옵</div><div class="cell right" id="d${idx}_c_spe_hp">0</div><div class="cell right" id="d${idx}_c_spe_atk">0</div><div class="cell right" id="d${idx}_c_spe_df">0</div>
      <div class="cell">버프 %</div><div class="cell right" id="d${idx}_c_bf_hp">0%</div><div class="cell right" id="d${idx}_c_bf_atk">0%</div><div class="cell right" id="d${idx}_c_bf_df">0%</div>
      <div class="cell">디버프 %</div><div class="cell right" id="d${idx}_c_db_hp">0%</div><div class="cell right" id="d${idx}_c_db_atk">0%</div><div class="cell right" id="d${idx}_c_db_df">0%</div>

      <div class="cell section center" style="grid-column:1/5">최종 스탯</div>
      <div class="cell sum">체력</div><div class="cell big" id="d${idx}_c_fin_hp">-</div>
      <div class="cell sum">공격력</div><div class="cell big" id="d${idx}_c_fin_atk">-</div>
      <div class="cell sum">방어력</div><div class="cell big" id="d${idx}_c_fin_df">-</div>

      <div class="cell section center" style="grid-column:1/5">지표</div>
      <div class="cell">E-Value</div><div class="cell big" id="d${idx}_c_eval" style="grid-column:2/5">-</div>
      <div class="cell">B-Value</div><div class="cell big" id="d${idx}_c_bval" style="grid-column:2/5">-</div>
    </div>
  `;
  allResults.appendChild(sheet);
}

  const num = val;  // 별칭 (자동 계산기와 수동 계산기 모두 사용)
  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

  // ===== 수동 계산기 =====
  function manualCalcOne(idx){
    const nm = (document.getElementById(`d${idx}_name`).value||'').trim();
    setText(`d${idx}_name_display`, nm ? nm : `드래곤 ${idx}`);

    const lvl = document.getElementById(`d${idx}_m_level`).value;
    const type = document.getElementById(`d${idx}_m_type`).value;
    const base = dragon[lvl][type];

    // 젬 합산
    let g_hp=0, g_atk=0, g_df=0;
    for(let i=1;i<=5;i++){
      const t=document.getElementById(`d${idx}_slot_type_${i}`).value;
      const v=Number(document.getElementById(`d${idx}_slot_val_${i}`).value||0);
      let hp=0, atk=0, df=0;
      if(t==="HP") hp=v; if(t==="ATK") atk=v; if(t==="DEF") df=v;
      g_hp+=hp; g_atk+=atk; g_df+=df;
      setText(`d${idx}_c_g${i}_hp`, hp); setText(`d${idx}_c_g${i}_atk`, atk); setText(`d${idx}_c_g${i}_df`, df);
    }
    const gem = new Stats(g_hp,g_atk,g_df);

    // 장신구/인첸트 (계산은 합산해서, 표기는 분리)
    const accOnly = new Stats(num(`d${idx}_m_acc_hp`)/100, num(`d${idx}_m_acc_atk`)/100, num(`d${idx}_m_acc_df`)/100);
    const enchOnly = new Stats(num(`d${idx}_m_ench_hp`)/100, num(`d${idx}_m_ench_atk`)/100, num(`d${idx}_m_ench_df`)/100);
    const acc = new Stats(accOnly.hp+enchOnly.hp, accOnly.atk+enchOnly.atk, accOnly.df+enchOnly.df);

    const pend = new Stats(num(`d${idx}_m_pend_hp`)/100, num(`d${idx}_m_pend_atk`)/100, num(`d${idx}_m_pend_df`)/100);

    // 정령/버프/디버프
    const spf = new Stats(num(`d${idx}_sf_hp`), num(`d${idx}_sf_atk`), num(`d${idx}_sf_df`));
    const spp = new Stats(num(`d${idx}_sp_hp`)/100, num(`d${idx}_sp_atk`)/100, num(`d${idx}_sp_df`)/100);
    const spe = new Stats(num(`d${idx}_se_hp`), num(`d${idx}_se_atk`), num(`d${idx}_se_df`));
    const bf  = new Stats(num(`d${idx}_bf_hp`)/100, num(`d${idx}_bf_atk`)/100, num(`d${idx}_bf_df`)/100);
    const db  = new Stats(num(`d${idx}_db_hp`)/100, num(`d${idx}_db_atk`)/100, num(`d${idx}_db_df`)/100);

    // 상수
    const pot = new Stats(24,6,6);
    const col = new Stats(240,60,60);

    const [fin, E, B] = calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);

    // 결과 시트
    setText(`d${idx}_c_base_hp`, base.hp);
    setText(`d${idx}_c_base_atk`, base.atk);
    setText(`d${idx}_c_base_df`, base.df);

    // 퍼센트 표기(분리)
    setText(`d${idx}_c_acc_hp`, (accOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_atk`, (accOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_df`, (accOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_ench_hp`, (enchOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_atk`, (enchOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_df`, (enchOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_pend_hp`, document.getElementById(`d${idx}_m_pend_hp`).value + '%');
    setText(`d${idx}_c_pend_atk`, document.getElementById(`d${idx}_m_pend_atk`).value + '%');
    setText(`d${idx}_c_pend_df`, document.getElementById(`d${idx}_m_pend_df`).value + '%');

    setText(`d${idx}_c_spf_hp`, spf.hp); setText(`d${idx}_c_spf_atk`, spf.atk); setText(`d${idx}_c_spf_df`, spf.df);
    setText(`d${idx}_c_spp_hp`, (spp.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_atk`, (spp.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_df`, (spp.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_spe_hp`, spe.hp); setText(`d${idx}_c_spe_atk`, spe.atk); setText(`d${idx}_c_spe_df`, spe.df);
    setText(`d${idx}_c_bf_hp`, (bf.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_atk`, (bf.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_df`, (bf.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_db_hp`, (db.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_db_atk`, (db.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_db_df`, (db.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_fin_hp`, fin.hp);
    setText(`d${idx}_c_fin_atk`, fin.atk);
    setText(`d${idx}_c_fin_df`, fin.df);
    setText(`d${idx}_c_eval`, Math.round(E).toString());
    setText(`d${idx}_c_bval`, (B/1e6).toFixed(3));  // 단위 ‘M’ 표시 없음
  }

  function manualCalcAll(){
    for(let i=1;i<=3;i++) manualCalcOne(i);
  }

  function savePngAll(){
    const node = document.getElementById('allResults');
    manualCalcAll(); // 최신 값 보장
    const w = node.scrollWidth;
    const h = node.scrollHeight;

    html2canvas(node, {
      backgroundColor: null,
      scale: 2,
      width:  w,
      height: h,
      windowWidth:  w,
      windowHeight: h
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='dragon_calculate.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  const autoDiv=document.getElementById('autoCalc');
  const resultDiv=document.getElementById('resultCalc');
  const manualDiv=document.getElementById('manualCalc');
  const serverDiv=document.getElementById('serverCalc');
  const btnAuto=document.getElementById('btnAuto');
  const btnResult=document.getElementById('btnResult');
  const btnManual=document.getElementById('btnManual');
  const btnServer=document.getElementById('btnServer');

  // 각 모드의 독립적인 스크롤 위치 저장
  let autoScrollPos = 0;
  let resultScrollPos = 0;
  let manualScrollPos = 0;
  let serverScrollPos = 0;

  // ===== UI 모드 전환 =====
  function switchMode(mode){
    if(mode==='auto'){
      resultScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      autoDiv.classList.add('active');
      resultDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnAuto.classList.add('primary');
      btnResult.classList.remove('primary');
      btnManual.classList.remove('primary');
      btnServer.classList.remove('primary');

      window.scrollTo(0, autoScrollPos);
    }else if(mode==='result'){
      autoScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      resultDiv.classList.add('active');
      autoDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnResult.classList.add('primary');
      btnAuto.classList.remove('primary');
      btnManual.classList.remove('primary');
      btnServer.classList.remove('primary');

      window.scrollTo(0, resultScrollPos);
    }else if(mode==='manual'){
      autoScrollPos = window.scrollY;
      resultScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      manualDiv.classList.add('active');
      autoDiv.classList.remove('active');
      resultDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnManual.classList.add('primary');
      btnAuto.classList.remove('primary');
      btnResult.classList.remove('primary');
      btnServer.classList.remove('primary');

      window.scrollTo(0, manualScrollPos);
    }else if(mode==='server'){
      autoScrollPos = window.scrollY;
      resultScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;

      serverDiv.classList.add('active');
      autoDiv.classList.remove('active');
      resultDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      btnServer.classList.add('primary');
      btnAuto.classList.remove('primary');
      btnResult.classList.remove('primary');
      btnManual.classList.remove('primary');

      window.scrollTo(0, serverScrollPos);
      loadSlotList(); // 슬롯 목록 로드
    }
  }
  btnAuto.onclick=()=>switchMode('auto');
  btnResult.onclick=()=>switchMode('result');
  btnManual.onclick=()=>switchMode('manual');
  btnServer.onclick=()=>switchMode('server');

  // 잠금/공유 선택 시 비밀번호 입력란 표시
  document.querySelectorAll('input[name="slotType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const isPrivate = document.querySelector('input[name="slotType"]:checked').value === 'private';
      document.getElementById('slotPasswordRow').style.display = isPrivate ? 'flex' : 'none';
    });
  });

  // ===== Firebase 서버 관리 =====
  // 비밀번호 해싱 (SHA-256)
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  // 슬롯 만들기
  async function createSlot() {
    const name = document.getElementById('newSlotName').value.trim();
    if (!name) {
      alert('슬롯 이름을 입력해주세요.');
      return;
    }

    const type = document.querySelector('input[name="slotType"]:checked').value;
    const isPrivate = type === 'private';

    let passwordHash = null;
    if (isPrivate) {
      const password = document.getElementById('slotPassword').value;
      if (!password) {
        alert('비밀번호를 입력해주세요.');
        return;
      }
      passwordHash = await hashPassword(password);
    }

    const slotData = {
      name: name,
      type: type,
      passwordHash: passwordHash,
      createdAt: Date.now(),
      data: []
    };

    try {
      const newSlotRef = window.firebasePush(window.firebaseRef(window.firebaseDB, 'slots'));
      await window.firebaseSet(newSlotRef, slotData);

      alert(`슬롯 "${name}"이(가) 생성되었습니다!`);
      document.getElementById('newSlotName').value = '';
      document.getElementById('slotPassword').value = '';
      loadSlotList();
    } catch (error) {
      console.error('슬롯 생성 오류:', error);
      alert('슬롯 생성 중 오류가 발생했습니다.');
    }
  }

  // 슬롯 목록 로드
  function loadSlotList() {
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    window.firebaseOnValue(slotsRef, (snapshot) => {
      const slotListEl = document.getElementById('slotList');
      slotListEl.innerHTML = '';

      if (!snapshot.exists()) {
        slotListEl.innerHTML = '<p style="color:#999;text-align:center;padding:40px 0">저장된 슬롯이 없습니다.</p>';
        return;
      }

      const slots = snapshot.val();
      Object.keys(slots).forEach(slotId => {
        const slot = slots[slotId];
        const slotBox = document.createElement('div');
        slotBox.style.cssText = 'border:1px solid var(--line);background:#fff;border-radius:8px;padding:12px;margin-bottom:10px';

        const lockIcon = slot.type === 'private' ? '🔒 ' : '';
        const dataCount = slot.data ? slot.data.length : 0;
        const createdDate = new Date(slot.createdAt).toLocaleString('ko-KR');

        slotBox.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <strong style="font-size:16px">${lockIcon} ${slot.name}</strong>
              <div style="color:#666;font-size:12px;margin-top:4px">
                생성일: ${createdDate} | 저장된 데이터: ${dataCount}개
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" onclick="viewSlot('${slotId}')" style="background:#4CAF50;color:#fff;border-color:#4CAF50;">열람하기</button>
              <button class="btn" onclick="clearSlotData('${slotId}')" style="background:#ff9800;color:#fff;border-color:#ff9800;">데이터 비우기</button>
              <button class="btn" onclick="deleteSlot('${slotId}')" style="background:#f44336;color:#fff;border-color:#f44336;">슬롯 삭제</button>
            </div>
          </div>
        `;
        slotListEl.appendChild(slotBox);
      });
    });
  }

  // 슬롯 열람
  async function viewSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    // 데이터 표시 - 모달로 개선
    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('저장된 데이터가 없습니다.');
      return;
    }

    // 모달 생성
    let modalContent = `
      <div id="viewSlotModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ddd;padding-bottom:12px;">
            <h3 style="margin:0;color:#111;">📁 ${slot.name}</h3>
            <button class="btn" onclick="closeViewSlotModal()" style="padding:6px 12px;">닫기</button>
          </div>

          <!-- 상단 탭 및 검색/다운로드 -->
          <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="btnDetailView" onclick="switchViewMode('detail')" style="padding:8px 16px;">상세 보기</button>
              <button class="btn" id="btnSummaryView" onclick="switchViewMode('summary')" style="padding:8px 16px;">요약 통계</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="userSearchInput" type="text" placeholder="유저 검색..." style="padding:6px 12px;border:1px solid #aaa;border-radius:4px;width:150px;">
              <button class="btn" onclick="filterByUser()" style="padding:6px 12px;">🔍 검색</button>
              <button class="btn" id="btnExportStats" onclick="exportToExcel()" style="padding:6px 12px;background:#28a745;color:#fff;border-color:#28a745;display:none;">📊 통계 저장</button>
            </div>
          </div>

          <div id="viewSlotContent"></div>
          <div id="viewSlotSummary" style="display:none;"></div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // 데이터를 전역에 저장 (필터링 및 통계용)
    window._currentSlotData = dataList;

    // 상세 보기 초기 렌더링 (함수 정의 전이므로 setTimeout 사용)
    setTimeout(() => window.renderDetailView(dataList), 0);
  }

  // 열람 모달 닫기
  window.closeViewSlotModal = function() {
    const modal = document.getElementById('viewSlotModal');
    if (modal) modal.remove();
    delete window._currentSlotData;
    delete window._currentFilteredData;
  }

  // 뷰 모드 전환 (상세 보기 / 요약 통계)
  window.switchViewMode = function(mode) {
    const detailBtn = document.getElementById('btnDetailView');
    const summaryBtn = document.getElementById('btnSummaryView');
    const exportBtn = document.getElementById('btnExportStats');
    const contentDiv = document.getElementById('viewSlotContent');
    const summaryDiv = document.getElementById('viewSlotSummary');

    if (mode === 'detail') {
      detailBtn.classList.add('primary');
      summaryBtn.classList.remove('primary');
      contentDiv.style.display = 'block';
      summaryDiv.style.display = 'none';
      exportBtn.style.display = 'none';
    } else if (mode === 'summary') {
      detailBtn.classList.remove('primary');
      summaryBtn.classList.add('primary');
      contentDiv.style.display = 'none';
      summaryDiv.style.display = 'block';
      exportBtn.style.display = 'inline-block';
      renderSummaryStats();
    }
  }

  // 요약 통계 렌더링
  window.renderSummaryStats = function() {
    const summaryDiv = document.getElementById('viewSlotSummary');
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      summaryDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px 0;">표시할 데이터가 없습니다.</p>';
      return;
    }

    let summaryHtml = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#2d6cdf;color:#fff;">
              <th style="padding:12px;text-align:left;border:1px solid #ddd;">유저이름</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">드래곤1 (비벨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">드래곤2 (비벨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">드래곤3 (비벨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">합계</th>
            </tr>
          </thead>
          <tbody>
    `;

    dataList.forEach((entry, index) => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });

      const total = bValues.reduce((sum, val) => sum + val, 0);
      const rowBg = index % 2 === 0 ? '#f9f9f9' : '#fff';

      summaryHtml += `
        <tr style="background:${rowBg};">
          <td style="padding:10px;border:1px solid #ddd;font-weight:600;">${entry.userName}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[0].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[1].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[2].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;font-weight:700;background:#e3f2fd;">${total.toFixed(3)}</td>
        </tr>
      `;
    });

    summaryHtml += `
          </tbody>
        </table>
      </div>
    `;

    summaryDiv.innerHTML = summaryHtml;
  }

  // 유저 검색 필터
  window.filterByUser = function() {
    const searchInput = document.getElementById('userSearchInput');
    const searchTerm = searchInput.value.trim().toLowerCase();

    if (!searchTerm) {
      // 검색어가 없으면 전체 데이터 표시
      window._currentFilteredData = null;
      renderDetailView(window._currentSlotData);
      renderSummaryStats();
      return;
    }

    // 검색어로 필터링
    const filtered = window._currentSlotData.filter(entry =>
      entry.userName.toLowerCase().includes(searchTerm)
    );

    if (filtered.length === 0) {
      alert(`"${searchInput.value}" 유저를 찾을 수 없습니다.`);
      return;
    }

    window._currentFilteredData = filtered;
    renderDetailView(filtered);
    renderSummaryStats();
  }

  // 상세 보기 재렌더링
  window.renderDetailView = function(dataList) {
    const contentDiv = document.getElementById('viewSlotContent');
    contentDiv.innerHTML = '';

    dataList.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.style.cssText = 'border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9f9f9;';

      let entryHtml = `
        <div style="background:#2d6cdf;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
          <strong style="font-size:16px;">[${index + 1}] ${entry.userName}</strong>
          <span style="font-size:12px;opacity:0.9;">${new Date(entry.timestamp).toLocaleString('ko-KR')}</span>
        </div>
      `;

      entry.dragons.forEach((dragon, dragonIdx) => {
        const dragonName = dragon.name || `드래곤 ${dragonIdx + 1}`;

        // 저장된 결과값 사용
        const finalStats = dragon.finalStats || { hp: 0, atk: 0, df: 0 };
        const eValue = dragon.eValue || 0;
        const bValue = dragon.bValue || 0;

        entryHtml += `
          <div style="border:1px solid #ccc;border-radius:6px;padding:12px;margin-bottom:10px;background:#fff;">
            <h4 style="margin:0 0 10px;color:#2d6cdf;border-bottom:1px solid #eee;padding-bottom:6px;">${dragonName}</h4>

            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:12px;border-radius:6px;margin-bottom:12px;">
              <div style="font-size:14px;font-weight:700;margin-bottom:8px;">📊 최종 계산 결과</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;font-size:13px;">
                <div><strong>HP:</strong> ${finalStats.hp.toLocaleString()}</div>
                <div><strong>ATK:</strong> ${finalStats.atk.toLocaleString()}</div>
                <div><strong>DEF:</strong> ${finalStats.df.toLocaleString()}</div>
              </div>
              <div style="border-top:1px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">E-Value (이벨)</div>
                  <div style="font-size:18px;font-weight:900;">${eValue.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">B-Value (비벨)</div>
                  <div style="font-size:18px;font-weight:900;">${bValue.toFixed(3)}</div>
                </div>
              </div>
            </div>

            <!-- 기본 정보만 표시 -->
            <div style="display:grid !important;grid-template-columns:1fr 1fr !important;gap:15px;font-size:13px;">

              <!-- 기본 정보 -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>등급/타입:</strong><br>${dragon.level} / ${dragon.type}</div>
              </div>

            </div>
          </div>
        `;
      });

      entryDiv.innerHTML = entryHtml;
      contentDiv.appendChild(entryDiv);
    });
  }

  // 엑셀 다운로드 (CSV 형식)
  window.exportToExcel = function() {
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      alert('내보낼 데이터가 없습니다.');
      return;
    }

    // CSV 헤더
    let csv = '유저이름,드래곤1,드래곤2,드래곤3,합계\n';

    // CSV 데이터
    dataList.forEach(entry => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });
      const total = bValues.reduce((sum, val) => sum + val, 0);
      csv += `${entry.userName},${bValues[0].toFixed(3)},${bValues[1].toFixed(3)},${bValues[2].toFixed(3)},${total.toFixed(3)}\n`;
    });

    // BOM 추가 (한글 깨짐 방지)
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `dragon_stats_${new Date().getTime()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  // 슬롯의 데이터만 비우기 (슬롯은 유지) - 선택 삭제 방식
  async function clearSlotData(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('삭제할 데이터가 없습니다.');
      return;
    }

    // 삭제할 데이터 선택 모달 표시
    showDeleteSelectionModal(slotId, slot.name, dataList);
  }

  // 데이터 선택 삭제 모달
  function showDeleteSelectionModal(slotId, slotName, dataList) {
    const modalId = 'deleteSelectionModal';

    // 기존 모달이 있으면 제거
    const existingModal = document.getElementById(modalId);
    if (existingModal) existingModal.remove();

    const modalContent = `
      <div id="${modalId}" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999;padding:20px;box-sizing:border-box;">
        <div style="background:#fff;border-radius:12px;max-width:800px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3);">

          <!-- 헤더 -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;font-size:20px;">🗑️ "${slotName}" 데이터 선택 삭제</h2>
            <button onclick="document.getElementById('${modalId}').remove()" style="background:none;border:none;color:#fff;font-size:28px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;line-height:1;">&times;</button>
          </div>

          <!-- 안내 메시지 -->
          <div style="padding:15px 20px;background:#fff3cd;border-bottom:1px solid #ffc107;color:#856404;">
            <strong>⚠️ 주의:</strong> 선택한 데이터는 영구적으로 삭제됩니다. (총 ${dataList.length}개)
          </div>

          <!-- 전체 선택 컨트롤 -->
          <div style="padding:15px 20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:bold;">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="width:18px;height:18px;cursor:pointer;">
              <span>전체 선택</span>
            </label>
            <span id="selectedCount" style="color:#666;font-size:14px;">선택: 0개</span>
          </div>

          <!-- 데이터 목록 -->
          <div id="deleteDataList" style="flex:1;overflow-y:auto;padding:15px 20px;">
            ${dataList.map((entry, index) => {
              const timestamp = new Date(entry.timestamp).toLocaleString('ko-KR');
              const dragonCount = entry.dragons ? entry.dragons.length : 0;

              return `
                <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:10px;background:#f9f9f9;display:flex;align-items:center;gap:12px;">
                  <input type="checkbox" class="data-checkbox" data-index="${index}" onchange="updateSelectedCount()" style="width:18px;height:18px;cursor:pointer;flex-shrink:0;">
                  <div style="flex:1;">
                    <div style="font-weight:bold;color:#2d6cdf;margin-bottom:4px;">[${index + 1}] ${entry.userName}</div>
                    <div style="font-size:13px;color:#666;">
                      <span>📅 ${timestamp}</span>
                      <span style="margin-left:12px;">🐉 드래곤 ${dragonCount}마리</span>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- 하단 버튼 -->
          <div style="padding:15px 20px;background:#f8f9fa;border-top:1px solid #dee2e6;display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="document.getElementById('${modalId}').remove()" style="padding:10px 20px;background:#6c757d;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;">취소</button>
            <button onclick="executeDeleteSelected('${slotId}')" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">선택 항목 삭제</button>
          </div>

        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // 전체 선택/해제 함수
    window.toggleSelectAll = function() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.data-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
      updateSelectedCount();
    };

    // 선택 개수 업데이트 함수
    window.updateSelectedCount = function() {
      const checkboxes = document.querySelectorAll('.data-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      document.getElementById('selectedCount').textContent = `선택: ${checkedCount}개`;

      // 전체 선택 체크박스 상태 업데이트
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      selectAllCheckbox.checked = checkedCount === checkboxes.length && checkedCount > 0;
    };

    // 선택 항목 삭제 실행 함수
    window.executeDeleteSelected = async function(slotId) {
      const checkboxes = document.querySelectorAll('.data-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
      }

      const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

      if (!confirm(`선택한 ${selectedIndices.length}개의 데이터를 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
        return;
      }

      try {
        // 슬롯 데이터 다시 가져오기
        const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
        const snapshot = await window.firebaseGet(slotRef);

        if (!snapshot.exists()) {
          alert('슬롯을 찾을 수 없습니다.');
          return;
        }

        const slot = snapshot.val();
        const currentData = slot.data || [];

        // 선택되지 않은 항목만 남기기 (인덱스 역순으로 정렬하여 안전하게 삭제)
        const newData = currentData.filter((_, index) => !selectedIndices.includes(index));

        // Firebase 업데이트
        const dataRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}/data`);
        await window.firebaseSet(dataRef, newData);

        alert(`${selectedIndices.length}개의 데이터가 삭제되었습니다.`);

        // 모달 닫기
        document.getElementById('deleteSelectionModal').remove();

        // 슬롯 목록 새로고침
        loadSlotList();
      } catch (error) {
        console.error('데이터 삭제 오류:', error);
        alert('데이터 삭제 중 오류가 발생했습니다.');
      }
    };
  }

  // 슬롯 완전 삭제
  async function deleteSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    if (!confirm(`"${slot.name}" 슬롯을 완전히 삭제하시겠습니까?\n\n⚠️ 슬롯과 모든 데이터가 영구적으로 삭제됩니다.\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
      return;
    }

    // 한 번 더 확인
    const confirmText = prompt('정말로 삭제하시려면 "삭제"를 입력하세요:');
    if (confirmText !== '삭제') {
      alert('삭제가 취소되었습니다.');
      return;
    }

    try {
      await window.firebaseSet(slotRef, null);
      alert(`"${slot.name}" 슬롯이 삭제되었습니다.`);
      loadSlotList();
    } catch (error) {
      console.error('슬롯 삭제 오류:', error);
      alert('슬롯 삭제 중 오류가 발생했습니다.');
    }
  }

  // 전역 함수로 노출
  window.clearSlotData = clearSlotData;
  window.deleteSlot = deleteSlot;

  // 페이지 로드 시 슬롯 목록 자동 로드 (Firebase 초기화 후)
  setTimeout(() => {
    if (window.firebaseDB) {
      loadSlotList();
    }
  }, 1000);

  // 수동계산기 데이터를 서버에 저장
  async function saveToServer() {
    // 슬롯 목록 먼저 가져오기
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    const snapshot = await window.firebaseGet(slotsRef);

    if (!snapshot.exists()) {
      alert('저장 가능한 슬롯이 없습니다.\n\n저장 서버 탭에서 슬롯을 먼저 생성해주세요.');
      return;
    }

    const slots = snapshot.val();
    const slotList = Object.keys(slots).map(id => ({id, ...slots[id]}));

    // 2. 슬롯 선택 모달 생성
    const modalHtml = `
      <div id="slotSelectModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:24px;">
          <h3 style="margin:0 0 16px;color:#111;">슬롯 선택</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">유저 이름</label>
            <input id="saveUserName" type="text" placeholder="이름을 입력하세요" style="width:100%;height:36px;border:1px solid #aaa;border-radius:6px;padding:0 12px;box-sizing:border-box;">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">저장할 슬롯</label>
            <div id="slotSelectList" style="border:1px solid #ddd;border-radius:6px;max-height:300px;overflow-y:auto;"></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="closeSlotModal()" style="padding:10px 20px;">취소</button>
            <button class="btn primary" onclick="confirmSlotSelection()" style="padding:10px 20px;">저장</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 3. 슬롯 목록 렌더링
    const slotSelectList = document.getElementById('slotSelectList');
    slotList.forEach((slot, index) => {
      const lockIcon = slot.type === 'private' ? '🔒 ' : '';
      const dataCount = slot.data ? slot.data.length : 0;

      const slotItem = document.createElement('div');
      slotItem.style.cssText = 'padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;';
      slotItem.innerHTML = `
        <input type="radio" name="selectedSlot" value="${index}" id="slot_${index}" style="margin-right:8px;">
        <label for="slot_${index}" style="cursor:pointer;display:inline;">
          <strong>${lockIcon} ${slot.name}</strong>
          <span style="color:#666;font-size:12px;margin-left:8px;">(${dataCount}개 저장됨)</span>
        </label>
      `;
      slotItem.addEventListener('mouseover', () => slotItem.style.background = '#f5f5f5');
      slotItem.addEventListener('mouseout', () => slotItem.style.background = '');
      slotItem.addEventListener('click', (e) => {
        if(e.target.tagName !== 'INPUT') {
          document.getElementById(`slot_${index}`).checked = true;
        }
      });
      slotSelectList.appendChild(slotItem);
    });

    // 슬롯 리스트를 전역에 저장
    window._slotList = slotList;
  }

  // 모달 닫기
  window.closeSlotModal = function() {
    const modal = document.getElementById('slotSelectModal');
    if (modal) modal.remove();
    delete window._slotList;
  }

  // 슬롯 선택 확정 및 저장
  window.confirmSlotSelection = async function() {
    const userName = document.getElementById('saveUserName')?.value?.trim();
    if (!userName) {
      alert('유저 이름을 입력해주세요.');
      return;
    }

    const selectedRadio = document.querySelector('input[name="selectedSlot"]:checked');
    if (!selectedRadio) {
      alert('저장할 슬롯을 선택해주세요.');
      return;
    }

    const selectedIndex = parseInt(selectedRadio.value);
    const selectedSlot = window._slotList[selectedIndex];

    // 잠금 슬롯이면 비밀번호 확인
    if (selectedSlot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== selectedSlot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    // Helper 함수: 텍스트 값 가져오기
    const getText = (id) => {
      const el = document.getElementById(id);
      return el ? el.textContent.trim() : '';
    };

    // Helper 함수: 숫자 값 가져오기
    const getNum = (id) => {
      const el = document.getElementById(id);
      const text = el ? el.textContent.trim() : '0';
      return Number(text.replace(/,/g, '')) || 0;
    };

    // 드래곤 3마리 계산된 결과값 수집
    const dragons = [];
    for (let i = 1; i <= 3; i++) {
      const dragonData = {
        name: document.getElementById(`d${i}_name`)?.value || '',
        level: document.getElementById(`d${i}_m_level`)?.value || '9.0',
        type: document.getElementById(`d${i}_m_type`)?.value || '공격형',
        // 계산된 최종 결과값
        finalStats: {
          hp: getNum(`d${i}_c_fin_hp`),
          atk: getNum(`d${i}_c_fin_atk`),
          df: getNum(`d${i}_c_fin_df`)
        },
        eValue: getNum(`d${i}_c_eval`),
        bValue: parseFloat(getText(`d${i}_c_bval`))
      };

      dragons.push(dragonData);
    }

    // Firebase에 저장
    const saveData = {
      userName: userName,
      timestamp: Date.now(),
      dragons: dragons
    };

    try {
      const currentData = selectedSlot.data || [];
      currentData.push(saveData);

      const slotRef = window.firebaseRef(window.firebaseDB, `slots/${selectedSlot.id}/data`);
      await window.firebaseSet(slotRef, currentData);

      closeSlotModal();
      alert(`"${selectedSlot.name}" 슬롯에 저장되었습니다!`);
    } catch (error) {
      console.error('저장 오류:', error);
      alert('저장 중 오류가 발생했습니다.');
    }
  }
  </script>
</body>
</html>
