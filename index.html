<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</title>
<style>
  :root{
    --bg:#f7f7f9; --ink:#111;
    --line:#cfcfd6; --accent:#2d6cdf;
    --black:#000; --grid:#b5b5bd;
  }
  body{font-family:Consolas,"Noto Sans KR",sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
  h2{margin:0 0 8px}
  .hint{color:#666;margin-bottom:14px}
  .small{color:#888;font-size:12px}

  .header-fixed{position:sticky;top:0;background:var(--bg);z-index:100;padding:12px 0;border-bottom:2px solid var(--line);margin-bottom:16px}
  .modebar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .btn{padding:8px 14px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:6px}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn:hover{background:#f0f0f0}

  .calc-container{display:none;overflow-y:auto;height:100%}
  .calc-container.active{display:block}

  fieldset{background:#fff;border:1px solid #ccc;padding:12px;margin-bottom:14px;border-radius:8px}
  legend{font-weight:700}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px}
  label{display:inline-flex;gap:6px;align-items:center}
  input[type="number"],select{height:28px;border:1px solid #aaa;border-radius:4px;text-align:center;background:#fff}
  input[type="text"]{height:28px;border:1px solid #aaa;border-radius:4px;background:#fff;padding:0 8px}

  .acc-list{max-height:220px;overflow:auto;border:1px solid #ddd;padding:8px;background:#fcfcfc;border-radius:6px}
  .toolbar{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}

  /* ì •ë ¹/ë²„í”„/ë””ë²„í”„ */
  .row-spirit{
    display:grid;
    grid-template-columns: 150px 90px 90px 90px auto;
    align-items:center;
    column-gap:8px;
    margin-bottom:6px
  }
  .row-spirit strong{text-align:right;padding-right:4px;font-weight:700}

  /* ìˆ˜ë™ê²°ê³¼ ì‹œíŠ¸ */
  .results-wrap{margin-top:14px}
  .results-row{display:inline-flex;gap:12px;align-items:flex-start;flex-wrap:nowrap}
  .sheet{
    background:#111; color:#e5e5e5;
    padding:12px; border-radius:10px;
    display:inline-block; min-width:530px;
  }
  .sheet .name{
    font-weight:900; font-size:18px; letter-spacing:.5px; margin-bottom:6px; text-align:center;
  }
  .grid{
    display:grid;
    grid-template-columns: 150px 120px 120px 120px;
    border:2px solid var(--black);
    background:#222;
  }
  .cell{
    border:1px solid var(--grid);
    padding:6px 8px; line-height:1.15;
    font-size:13px; background:#1a1a1a;
  }
  .cell.h{background:#303030;font-weight:700}
  .cell.section{background:#2b2b2b;color:#ffe4b5;font-weight:700;text-align:center}
  .cell.sum{background:#000;border-color:#444;color:#fff;font-size:15px}
  .cell.big{font-size:22px;font-weight:900;letter-spacing:1px;text-align:center;background:#000}
  .center{text-align:center}
  .right{text-align:right}
  pre.result{
    white-space:pre; background:#111; color:#e5e5e5;
    padding:12px; border-radius:8px; min-height:220px;
  }

  /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    body{margin:12px;}
    .header-fixed{padding:8px 0;}
    h2{font-size:18px;}
    .hint{font-size:11px;}

    .modebar{gap:6px;}
    .btn{padding:6px 10px;font-size:13px;}

    .row{flex-direction:column;align-items:flex-start;gap:6px;}
    .row label{width:100%;}

    .row-spirit{
      grid-template-columns:1fr;
      gap:6px;
    }
    .row-spirit strong{text-align:left;padding-right:0;margin-bottom:4px;}
    .row-spirit input{width:100%;}

    input[type="number"],select,input[type="text"]{width:100% !important;box-sizing:border-box;}

    .toolbar{gap:6px;}
    .toolbar .btn{font-size:11px;padding:6px 8px;}

    .acc-list{max-height:180px;font-size:13px;}

    fieldset{padding:10px;}
    legend{font-size:14px;}

    .sheet{
      min-width:unset;
      width:100%;
      padding:10px;
      overflow-x:auto;
    }
    .sheet .name{font-size:16px;}

    .grid{
      grid-template-columns:80px repeat(3, 1fr);
      font-size:10px;
      min-width:320px;
    }
    .cell{padding:4px 5px;font-size:10px;}
    .cell.h{font-size:9px;padding:3px 4px;}
    .cell.big{font-size:14px;}
    .cell.sum{font-size:11px;}
    .cell.section{grid-column:1/5 !important;}

    .results-row{flex-direction:column;gap:12px;}

    #pendant_auto_row{flex-direction:column;align-items:flex-start;}
    #pendant_stats_row{flex-direction:column;align-items:flex-start;}
    #pendant_manual{flex-direction:column;align-items:flex-start;gap:8px;}

    pre.result{font-size:11px;padding:10px;min-height:150px;overflow-x:auto;}
  }

  /* ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œë¡œ ìŒ“ê¸° */
  @media (max-width: 768px) {
    #viewSlotContent div[style*="grid-template-columns:1fr 1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
</head>

<body>
  <div class="header-fixed">
    <h2>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</h2>
    <div class="modebar">
      <button class="btn primary" id="btnAuto">ìë™ ê³„ì‚°ê¸°</button>
      <button class="btn" id="btnManual">ìˆ˜ë™ ê³„ì‚°ê¸°</button>
      <button class="btn" id="btnServer">ì €ì¥ ì„œë²„</button>
    </div>
    <div class="hint small">ëª¨ë“  ì…ë ¥ì€ <b>HP / ATK / DEF</b> ìˆœì„œì…ë‹ˆë‹¤. Â· made by í—¬ë¦­ìŠ¤</div>
  </div>

  <div id="autoCalc" class="calc-container active">
    <!-- ë“±ê¸‰/íƒ€ì… -->
    <fieldset>
      <legend>ë“±ê¸‰ / íƒ€ì… ì„ íƒ</legend>
      <div class="row">
        <label><input type="radio" name="level" value="7.0" checked>7.0</label>
        <label><input type="radio" name="level" value="8.0">8.0</label>
        <label><input type="radio" name="level" value="9.0">9.0</label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input type="checkbox" class="dtype" value="ê³µê²©í˜•" checked>ê³µê²©í˜•</label>
        <label><input type="checkbox" class="dtype" value="ë°©ì–´í˜•" checked>ë°©ì–´í˜•</label>
        <label><input type="checkbox" class="dtype" value="ì²´ë ¥í˜•" checked>ì²´ë ¥í˜•</label>
        <label><input type="checkbox" class="dtype" value="ê³µë°©í˜•" checked>ê³µë°©í˜•</label>
        <label><input type="checkbox" class="dtype" value="ì²´ê³µí˜•" checked>ì²´ê³µí˜•</label>
        <label><input type="checkbox" class="dtype" value="ì²´ë°©í˜•" checked>ì²´ë°©í˜•</label>
      </div>
    </fieldset>

    <!-- ì ¬(ìë™ ë¶„ë°°ìš© ê¸°ë³¸ê°’ë§Œ í•„ìš”: ì‹¤ì œ ë¶„ë°°ëŠ” ë£¨í”„ì—ì„œ ìˆœíšŒ) -->
    <fieldset>
      <legend>ì ¬ ì„ íƒ (â€» ë³µìˆ˜ ì„ íƒ ë¶ˆê°€, ìë™ ë¶„ë°°ì—ì„œ ì‚¬ìš©)</legend>
      <div class="row">
        <strong>HP</strong>
        <label><input type="radio" name="gem_hp" value="160">160</label>
        <label><input type="radio" name="gem_hp" value="156" checked>156</label>
        <label><input type="radio" name="gem_hp" value="152">152</label>
        <label><input type="radio" name="gem_hp" value="148">148</label>
      </div>
      <div class="row">
        <strong>ATK</strong>
        <label><input type="radio" name="gem_atk" value="40">40</label>
        <label><input type="radio" name="gem_atk" value="39" checked>39</label>
        <label><input type="radio" name="gem_atk" value="38">38</label>
        <label><input type="radio" name="gem_atk" value="37">37</label>
      </div>
      <div class="row">
        <strong>DEF</strong>
        <label><input type="radio" name="gem_df" value="40">40</label>
        <label><input type="radio" name="gem_df" value="39" checked>39</label>
        <label><input type="radio" name="gem_df" value="38">38</label>
        <label><input type="radio" name="gem_df" value="37">37</label>
      </div>
    </fieldset>

    <!-- ì¥ì‹ êµ¬ -->
    <fieldset>
      <legend>ì¥ì‹ êµ¬ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</legend>
      <div class="toolbar">
        <button class="btn" type="button" onclick="toggleLevel(19)">Lv19 ì „ì²´ ì„ íƒ/í•´ì œ</button>
        <button class="btn" type="button" onclick="toggleLevel(18)">Lv18 ì „ì²´ ì„ íƒ/í•´ì œ</button>
        <button class="btn" type="button" onclick="toggleLevel(17)">Lv17 ì „ì²´ ì„ íƒ/í•´ì œ</button>
        <button class="btn" type="button" onclick="selectNone()">ì „ì²´ í•´ì œ</button>
      </div>
      <div id="accList" class="acc-list"></div>
    </fieldset>

    <!-- íœë˜íŠ¸ -->
    <fieldset>
      <legend>íœë˜íŠ¸</legend>

      <!-- ë²„ì „ ì„ íƒ -->
      <div class="row" style="margin-bottom:8px;">
        <strong>ë²„ì „ ì„ íƒ:</strong>
        <label><input type="radio" name="pendant_ver" value="v1" checked>Ver1 (ìë™ ë¶„ë°°)</label>
        <label><input type="radio" name="pendant_ver" value="v2">Ver2 (ì§€ì • ë¶„ë°°)</label>
        <label><input type="radio" name="pendant_ver" value="v3">Ver3 (ìˆ˜ë™ ì…ë ¥)</label>
      </div>

      <!-- ìë™ ë¶„ë°°ìš© (Ver1, Ver2 ê³µìš©) -->
      <div class="row" id="pendant_auto_row">
        <strong>ì¢…ë¥˜ / ê°’ ì…ë ¥:</strong>
        <label><input type="radio" name="pendant_mode" value="ë³„" checked>ë³„</label>
        <label><input type="radio" name="pendant_mode" value="ë‹¬">ë‹¬</label>
        <label><input type="radio" name="pendant_mode" value="íƒœì–‘">íƒœì–‘</label>
        <input id="pendant_value" type="number" value="12" style="width:90px;"> %
        <span class="small" id="pendantHint">ë³„ â‰¤ 6, ë‹¬ â‰¤ 12, íƒœì–‘ â‰¤ 18</span>
      </div>

      <!-- Ver2 ì „ìš© -->
      <div class="row" id="pendant_stats_row" style="margin-top:8px; display:none;">
        <strong>Ver2 ìŠ¤íƒ¯ ì„ íƒ:</strong>
        <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
        <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
        <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
      </div>

      <!-- Ver3 ì „ìš© -->
      <div id="pendant_manual" style="margin-top:8px; display:none; align-items:center; gap:4px;">
        <strong>ìˆ˜ë™ ì…ë ¥:</strong>
        HP <input id="pend_manual_hp" type="number" value="0" style="width:55px;">%
        ATK <input id="pend_manual_atk" type="number" value="0" style="width:55px;">%
        DEF <input id="pend_manual_df" type="number" value="0" style="width:55px;">%
      </div>
    </fieldset>

    <!-- ì •ë ¹/ë²„í”„/ë””ë²„í”„ -->
    <fieldset>
      <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„ <button class="btn" type="button" onclick="resetSpiritBuffs()" style="margin-left:8px;font-size:12px;padding:4px 10px;">ì „ì²´ ì´ˆê¸°í™”</button></legend>
      <div style="font-weight:bold; color:black; margin-bottom:6px;">(HP / ATK / DEF)</div>

      <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong><input id="sf_hp" type="number" value="0"><input id="sf_atk" type="number" value="0"><input id="sf_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong><input id="sp_hp" type="number" value="0"><input id="sp_atk" type="number" value="0"><input id="sp_df" type="number" value="0"><span class="small">(% ì…ë ¥)</span></div>
      <div class="row-spirit"><strong>ì •ë ¹ ì˜µ</strong><input id="se_hp" type="number" value="0"><input id="se_atk" type="number" value="0"><input id="se_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>ë²„í”„ (%)</strong><input id="bf_hp" type="number" value="0"><input id="bf_atk" type="number" value="0"><input id="bf_df" type="number" value="0"></div>
      <div class="row-spirit"><strong>ë””ë²„í”„ (%)</strong><input id="db_hp" type="number" value="0"><input id="db_atk" type="number" value="0"><input id="db_df" type="number" value="0"></div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <span style="font-weight:700;">â†’ ìˆ˜ë™ê³„ì‚°ê¸°ì— ì ìš©:</span>
        <button class="btn" type="button" onclick="copyToManualDragon(1)">ë“œë˜ê³¤1</button>
        <button class="btn" type="button" onclick="copyToManualDragon(2)">ë“œë˜ê³¤2</button>
        <button class="btn" type="button" onclick="copyToManualDragon(3)">ë“œë˜ê³¤3</button>
      </div>
    </fieldset>

    <!-- ê¸°íƒ€ -->
    <fieldset>
      <legend>ê¸°íƒ€</legend>
      <div class="row">Top N <input id="top_n" type="number" value="5" style="width:80px"></div>
    </fieldset>

    <div class="toolbar">
      <button class="btn primary" type="button" onclick="calcAuto()">ê³„ì‚°í•˜ê¸°</button>
      <button class="btn" type="button" onclick="downloadTxt()">ì €ì¥í•˜ê¸° (.txt)</button>
    </div>

    <h3>ê²°ê³¼</h3>
    <pre id="autoResult" class="result"></pre>
  </div>

  <div id="manualCalc" class="calc-container">
    <h3 style="margin:0 0 16px">ìˆ˜ë™ ê³„ì‚°ê¸° (3ë§ˆë¦¬ ë¹„êµ)</h3>

    <!-- ë“œë˜ê³¤ë³„ ì…ë ¥í¼ (ì„¸ë¡œ ì •ë ¬) -->
    <div id="inputsWrap" style="display:flex;flex-direction:column;gap:16px"></div>

    <!-- ê³„ì‚°/ì €ì¥ ë²„íŠ¼ -->
    <div style="margin:20px 0;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn primary" onclick="manualCalcAll()">ìˆ˜ë™ ê³„ì‚°</button>
      <button class="btn" onclick="savePngAll()">ê²°ê³¼ë¥¼ PNGë¡œ ì €ì¥</button>
      <button class="btn" onclick="saveToServer()" style="background:#00aa88;color:#fff;border-color:#00aa88">ì„œë²„ì— ì €ì¥</button>
    </div>

    <!-- ê²°ê³¼ ì‹œíŠ¸ (ê°€ë¡œ ë¹„êµ) -->
    <div class="results-wrap">
      <div id="allResults" class="results-row"></div>
    </div>
  </div>

  <div id="serverCalc" class="calc-container">
    <h3 style="margin:0 0 16px">ì €ì¥ ì„œë²„</h3>

    <!-- ì €ì¥ ìŠ¬ë¡¯ ë§Œë“¤ê¸° -->
    <fieldset>
      <legend>ì €ì¥ ìŠ¬ë¡¯ ë§Œë“¤ê¸°</legend>
      <div class="row">
        <label>ìŠ¬ë¡¯ ì´ë¦„
          <input id="newSlotName" type="text" placeholder="" style="width:200px">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="slotType" value="public" checked>ê³µìœ  (ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥)</label>
        <label><input type="radio" name="slotType" value="private">ì ê¸ˆ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)</label>
      </div>
      <div class="row" id="slotPasswordRow" style="margin-top:8px;display:none">
        <label>ë¹„ë°€ë²ˆí˜¸
          <input id="slotPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:150px">
        </label>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="createSlot()">ìŠ¬ë¡¯ ë§Œë“¤ê¸°</button>
      </div>
    </fieldset>

    <!-- ì €ì¥ëœ ìŠ¬ë¡¯ ëª©ë¡ -->
    <fieldset>
      <legend>ì €ì¥ëœ ìŠ¬ë¡¯ ëª©ë¡</legend>
      <div id="slotList" style="min-height:200px">
        <p style="color:#999;text-align:center;padding:40px 0">ìŠ¬ë¡¯ì„ ìƒì„±í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </fieldset>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB90WAYMh6G8aWS3gzKw2wmT9X3O0zGoGw",
      authDomain: "dragon-calculator-8733b.firebaseapp.com",
      databaseURL: "https://dragon-calculator-8733b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dragon-calculator-8733b",
      storageBucket: "dragon-calculator-8733b.firebasestorage.app",
      messagingSenderId: "707550978178",
      appId: "1:707550978178:web:09607e55f05337c154949b"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
  </script>

  <script>
  class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}
  const dragon={
   "7.0":{ê³µê²©í˜•:new Stats(876,285,161),ë°©ì–´í˜•:new Stats(788,185,283),ì²´ë ¥í˜•:new Stats(1252,176,176),ê³µë°©í˜•:new Stats(720,242,243),ì²´ê³µí˜•:new Stats(1080,262,133),ì²´ë°©í˜•:new Stats(1080,133,262)},
   "8.0":{ê³µê²©í˜•:new Stats(876,305,161),ë°©ì–´í˜•:new Stats(788,185,303),ì²´ë ¥í˜•:new Stats(1332,176,176),ê³µë°©í˜•:new Stats(720,252,253),ì²´ê³µí˜•:new Stats(1120,272,133),ì²´ë°©í˜•:new Stats(1120,133,272)},
   "9.0":{ê³µê²©í˜•:new Stats(876,325,161),ë°©ì–´í˜•:new Stats(788,185,323),ì²´ë ¥í˜•:new Stats(1412,176,176),ê³µë°©í˜•:new Stats(720,262,263),ì²´ê³µí˜•:new Stats(1160,282,133),ì²´ë°©í˜•:new Stats(1160,133,282)}
  };
  function eVal(s){return s.hp+4*s.atk+4*s.df;}
  function bVal(s){return s.hp*s.atk*s.df;}
  function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
    const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
    const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
    const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                       Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                       Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
    const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
    const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
    const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
    const f = new Stats(
      s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
      s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
      s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
    );
    return [f, eVal(f), bVal(f)];
  }
  // í—¬í¼ í•¨ìˆ˜: ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
  function val(id){ return Number(document.getElementById(id)?.value||0); }

  function resetSpiritBuffs(){
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value=0;
    });
  }

  function copyToManualDragon(dragonIdx){
    // ìë™ê³„ì‚°ê¸°ì˜ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ê°’ì„ ìˆ˜ë™ê³„ì‚°ê¸°ë¡œ ë³µì‚¬
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(field => {
      const value = val(field);
      const el = document.getElementById(`d${dragonIdx}_${field}`);
      if(el) el.value = value;
    });
    alert(`ë“œë˜ê³¤ ${dragonIdx}ì— ì •ë ¹/ë²„í”„/ë””ë²„í”„ ê°’ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  const ACC_TABLE = [
    ["ë°”ë¿”(ê³µ/ë°©)",19,0,10,9],["ë°”ë¿”(ì²´/ë°©)",19,10,0,9],["ë°”ë¿”(ê³µ/ì²´)",19,9,10,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",19,6,13,0],["ë¶ˆë¿”(ê³µ/ë°©)",19,0,13,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",19,13,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",19,13,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",19,0,6,13],["ëŒ€ë¿”(ë°©/ì²´)",19,6,0,13],
    ["ì—¬ë³´",19,0,0,19],["í™©ë³´",19,0,19,0],["ì•…ë³´",19,19,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",18,0,9,9],["ë°”ë¿”(ì²´/ë°©)",18,9,0,9],["ë°”ë¿”(ê³µ/ì²´)",18,9,9,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",18,6,12,0],["ë¶ˆë¿”(ê³µ/ë°©)",18,0,12,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",18,12,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",18,12,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",18,0,6,12],["ëŒ€ë¿”(ë°©/ì²´)",18,6,0,12],
    ["ì—¬ë³´",18,0,0,18],["í™©ë³´",18,0,18,0],["ì•…ë³´",18,18,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",17,0,9,8],["ë°”ë¿”(ì²´/ë°©)",17,9,0,8],["ë°”ë¿”(ê³µ/ì²´)",17,9,8,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",17,6,11,0],["ë¶ˆë¿”(ê³µ/ë°©)",17,0,11,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",17,11,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",17,11,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",17,0,6,11],["ëŒ€ë¿”(ë°©/ì²´)",17,6,0,11],
    ["ì—¬ë³´",17,0,0,17],["í™©ë³´",17,0,17,0],["ì•…ë³´",17,17,0,0],
  ];
  let accCheckboxes = [];

  function renderAccessories() {
    const accListEl = document.getElementById('accList');
    accListEl.innerHTML = '';
    accCheckboxes = [];
    ACC_TABLE.forEach((r, i) => {
      const [n, l, h, a, d] = r;
      const id = 'acc_' + i;
      const line = document.createElement('div');
      line.innerHTML = `<label><input type="checkbox" id="${id}"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%</label>`;
      accListEl.appendChild(line);
      accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d });
    });
  }
  renderAccessories();

  function selectNone(){
    accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
  }

  function toggleLevel(level){
    const filtered = accCheckboxes.filter(o => o.level === level);
    const allChecked = filtered.every(o => document.getElementById(o.id).checked);
    filtered.forEach(o => document.getElementById(o.id).checked = !allChecked);
  }

  document.querySelectorAll('input[name="pendant_ver"]').forEach(r => {
    r.addEventListener('change', () => {
      const ver = document.querySelector('input[name="pendant_ver"]:checked').value;
      document.getElementById("pendant_auto_row").style.display = (ver === "v3") ? "none" : "flex";
      document.getElementById("pendant_stats_row").style.display = (ver === "v2") ? "flex" : "none";
      document.getElementById("pendant_manual").style.display = (ver === "v3") ? "flex" : "none";
    });
  });
  window.addEventListener("DOMContentLoaded", () => {
    document.querySelector('input[name="pendant_ver"]:checked')?.dispatchEvent(new Event('change'));
  });

  function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
    const MAX = 6;
    const combos = [];

    if (total <= 0) return [[[0,0,0]]];

    // ì„ íƒëœ ìŠ¤íƒ¯ì˜ ì¸ë±ìŠ¤ ë°°ì—´ ìƒì„± (HP:0, ATK:1, DEF:2)
    const statIdx = [];
    if (selectedStats.includes("HP"))  statIdx.push(0);
    if (selectedStats.includes("ATK")) statIdx.push(1);
    if (selectedStats.includes("DEF")) statIdx.push(2);

    // ë³„ íœë˜íŠ¸: 1ìŠ¬ë¡¯
    if (mode === "ë³„") {
      const value = Math.min(total, MAX);
      return statIdx.map(i => {
        const slot = [0,0,0];
        slot[i] = value;
        return [slot];
      });
    }

    // ë‹¬ íœë˜íŠ¸: 2ìŠ¬ë¡¯
    if (mode === "ë‹¬") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          if (x+y === total)
            for (let i of statIdx)
              for (let j of statIdx) {
                const slot1=[0,0,0], slot2=[0,0,0];
                slot1[i]=x; slot2[j]=y;
                combos.push([slot1, slot2]);
              }
      return combos;
    }

    // íƒœì–‘ íœë˜íŠ¸: 3ìŠ¬ë¡¯
    if (mode === "íƒœì–‘") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          for (let z=1; z<=MAX; z++)
            if (x+y+z === total)
              for (let i of statIdx)
                for (let j of statIdx)
                  for (let k of statIdx) {
                    const slot1=[0,0,0], slot2=[0,0,0], slot3=[0,0,0];
                    slot1[i]=x; slot2[j]=y; slot3[k]=z;
                    combos.push([slot1, slot2, slot3]);
                  }
      return combos;
    }

    return [[[0,0,0]]];
  }

  function calcAuto(){
    const resultBox = document.getElementById("autoResult");
    resultBox.textContent = "";

    // 1. ì‚¬ìš©ì ì…ë ¥ê°’ ìˆ˜ì§‘
    const level = document.querySelector('input[name="level"]:checked').value;

    const dragonTypes = {};
    document.querySelectorAll(".dtype").forEach(cb => dragonTypes[cb.value] = cb.checked);
    const selectedTypes = Object.keys(dragonTypes).filter(k => dragonTypes[k]);
    if (!selectedTypes.length) {
      resultBox.textContent = "ë“œë˜ê³¤ íƒ€ì…ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      return;
    }

    const gemBase = {
      hp: Number(document.querySelector('input[name="gem_hp"]:checked').value),
      atk: Number(document.querySelector('input[name="gem_atk"]:checked').value),
      df: Number(document.querySelector('input[name="gem_df"]:checked').value)
    };

    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id).checked);
    if (!selectedAcc.length) {
      resultBox.textContent = "ì¥ì‹ êµ¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      return;
    }

    // íœë˜íŠ¸ ì„¤ì •
    const pendantMode = document.querySelector('input[name="pendant_mode"]:checked')?.value || "ë³„";
    const pendantValue = Number(document.getElementById("pendant_value").value || 0);
    const pendantVer = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
    const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // ìƒìˆ˜ ë° ê¸°íƒ€
    const topN = Number(document.getElementById("top_n").value || 5);
    const ENCHANT = 21;  // ì¸ì²¸íŠ¸ % (HP/ATK/DEF ê° ë°©í–¥)
    const pot = new Stats(24, 6, 6);    // í¬í…ì…œ (ê³ ì •)
    const col = new Stats(240, 60, 60); // ìˆ˜ì§‘ íš¨ê³¼ (ê³ ì •)

    // ì •ë ¹/ë²„í”„/ë””ë²„í”„
    const spiritFlat = new Stats(val('sf_hp'), val('sf_atk'), val('sf_df'));
    const spiritPct = new Stats(val('sp_hp')/100, val('sp_atk')/100, val('sp_df')/100);
    const spiritExtra = new Stats(val('se_hp'), val('se_atk'), val('se_df'));
    const buff = new Stats(val('bf_hp')/100, val('bf_atk')/100, val('bf_df')/100);
    const debuff = new Stats(val('db_hp')/100, val('db_atk')/100, val('db_df')/100);

    // 2. íœë˜íŠ¸ ì¡°í•© ìƒì„±
    let pendantCombinations = [];
    let manualPendantStr = "";

    if (pendantVer === "v3") {
      // Ver3: ìˆ˜ë™ ì…ë ¥
      const ph = Number(document.getElementById("pend_manual_hp")?.value || 0) / 100;
      const pa = Number(document.getElementById("pend_manual_atk")?.value || 0) / 100;
      const pd = Number(document.getElementById("pend_manual_df")?.value || 0) / 100;
      pendantCombinations = [[[ph, pa, pd]]];
      const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
      manualPendantStr = `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`;
    } else {
      // Ver1/Ver2: ìë™ ì¡°í•© ìƒì„±
      const maxValues = {ë³„:6, ë‹¬:12, íƒœì–‘:18};
      const limit = maxValues[pendantMode] || 0;
      if (pendantValue > limit || pendantValue <= 0) {
        resultBox.textContent = "íœë˜íŠ¸ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
        return;
      }
      const stats = (pendantVer === "v2") ? selectedStats : ["HP", "ATK", "DEF"];
      pendantCombinations = genPend(pendantValue, pendantMode, stats);
      if (!pendantCombinations.length) {
        resultBox.textContent = "íœë˜íŠ¸ ì¡°í•© ìƒì„± ì˜¤ë¥˜";
        return;
      }
    }

    // 3. ëª¨ë“  ì¡°í•©ì— ëŒ€í•´ ê³„ì‚° ìˆ˜í–‰
    const results = [];

    for (const accessory of selectedAcc) {
      const accPctBase = {
        hp: accessory.hp / 100,
        atk: accessory.atk / 100,
        df: accessory.df / 100
      };

      for (const type of selectedTypes) {
        const baseStats = dragon[level][type];

        // ì ¬ 5ì¹¸ ë¶„ë°° (HP + ATK + DEF = 5)
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(
              gemBase.hp * hpGems,
              gemBase.atk * atkGems,
              gemBase.df * defGems
            );

            // ì¸ì²¸íŠ¸ ë°©í–¥ (HP, ATK, DEF ì¤‘ í•˜ë‚˜)
            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(
                accPctBase.hp + enchantBonus.hp,
                accPctBase.atk + enchantBonus.atk,
                accPctBase.df + enchantBonus.df
              );

              // íœë˜íŠ¸ ì¡°í•©
              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                // ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚°
                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                // ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
                const pendantSlotStr = (pendantVer === "v3")
                  ? manualPendantStr
                  : pendant.map(slot =>
                      ["HP","ATK","DEF"]
                        .map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "")
                        .filter(Boolean)
                        .join(" ")
                    ).join(" / ");

                const pendantLabel = (pendantVer === "v3") ? "ìˆ˜ë™ì…ë ¥" : pendantMode;
                const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                const line1 = `${type} | ${accessory.name} Lv${accessory.level} | ì ¬: HP${hpGems} ATK${atkGems} DEF${defGems} | íœë˜íŠ¸: ${pendantLabel} (${pendantSlotStr}) | ì¸ì²¸íŠ¸: ${enchantLabel} +${ENCHANT}%\n`;
                const line2 = `HP=${finalStats.hp} | ATK=${finalStats.atk} | DEF=${finalStats.df} | E=${eValue.toFixed(0)} | B=${(bValue/1e6).toFixed(3)}\n`;

                results.push({ B: bValue, display_line1: line1, display_line2: line2 });
              }
            }
          }
        }
      }
    }

    // 4. ê²°ê³¼ ì¶œë ¥
    if (!results.length) {
      resultBox.textContent = "ê²°ê³¼ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      return;
    }

    results.sort((a, b) => b.B - a.B);
    const topResults = results.slice(0, topN)
      .map((r, i) => `[${i + 1}ìœ„] ${r.display_line1}${r.display_line2}`)
      .join("\n");
    resultBox.textContent = topResults;
  }

  function downloadTxt(){
    const text=document.getElementById("autoResult").textContent||"";
    if(!text.trim()) return;
    const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="dragon_result.txt";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  const gemOptions = {
    HP: [160, 156, 152, 148],
    ATK: [40, 39, 38, 37],
    DEF: [40, 39, 38, 37]
  };

  // í˜ì´ì§€ ë¡œë“œ ì‹œ 3ë§ˆë¦¬ ë“œë˜ê³¤ ìë™ ìƒì„±
  window.addEventListener('DOMContentLoaded', () => {
    renderAll(3);
  });

  function renderAll(count){
    const inputsWrap = document.getElementById('inputsWrap');
    const allResults = document.getElementById('allResults');

    inputsWrap.innerHTML = '';
    allResults.innerHTML = '';

    for(let i=1; i<=count; i++){
      renderOneInput(i);
      renderOneResult(i);
    }
  }

  function renderOneInput(idx){
    const box = document.createElement('div');
    box.className = 'dragon-input';
    box.style.cssText = 'border:1px solid var(--line);background:#fff;border-radius:8px;padding:12px';
    box.innerHTML = `
      <div class="row">
        <strong style="font-size:16px">ë“œë˜ê³¤ ${idx}</strong>
        <label>ì´ë¦„ <input id="d${idx}_name" type="text"></label>
      </div>

      <fieldset>
        <legend>ë“±ê¸‰ / íƒ€ì…</legend>
        <div class="row">
          <label>ë“±ê¸‰
            <select id="d${idx}_m_level">
              <option value="7.0">7.0</option>
              <option value="8.0">8.0</option>
              <option value="9.0" selected>9.0</option>
            </select>
          </label>
          <label>íƒ€ì…
            <select id="d${idx}_m_type">
              <option>ê³µê²©í˜•</option>
              <option>ë°©ì–´í˜•</option>
              <option>ì²´ë ¥í˜•</option>
              <option>ê³µë°©í˜•</option>
              <option>ì²´ê³µí˜•</option>
              <option>ì²´ë°©í˜•</option>
            </select>
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>ì ¬ ìŠ¬ë¡¯ (5ê°œ)</legend>
        <div id="d${idx}_gem_slots"></div>
      </fieldset>

      <fieldset>
        <legend>ì¥ì‹ êµ¬ / ì¸ì²¸íŠ¸ (%)</legend>
        <div class="row">
          ì¥ì‹ êµ¬ HP <input id="d${idx}_m_acc_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_acc_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_acc_df" type="number" value="0" style="width:90px">
        </div>
        <div class="row">
          ì¸ì²¸íŠ¸ HP <input id="d${idx}_m_ench_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_ench_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_ench_df" type="number" value="0" style="width:90px">
        </div>
      </fieldset>

      <fieldset>
        <legend>íœë˜íŠ¸ (%)</legend>
        <div class="row">
          HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:90px">
          ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:90px">
          DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:90px">
        </div>
      </fieldset>

      <fieldset>
        <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„</legend>
        <div style="font-weight:700;margin-bottom:6px">(HP / ATK / DEF)</div>
        <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
          <input id="d${idx}_sf_hp" type="number" value="0">
          <input id="d${idx}_sf_atk" type="number" value="0">
          <input id="d${idx}_sf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
          <input id="d${idx}_sp_hp" type="number" value="0">
          <input id="d${idx}_sp_atk" type="number" value="0">
          <input id="d${idx}_sp_df" type="number" value="0">
          <span class="small">% ì…ë ¥</span>
        </div>
        <div class="row-spirit"><strong>ì •ë ¹ ë¶€ê°€ì˜µ</strong>
          <input id="d${idx}_se_hp" type="number" value="0">
          <input id="d${idx}_se_atk" type="number" value="0">
          <input id="d${idx}_se_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ë²„í”„ (%)</strong>
          <input id="d${idx}_bf_hp" type="number" value="0">
          <input id="d${idx}_bf_atk" type="number" value="0">
          <input id="d${idx}_bf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ë””ë²„í”„ (%)</strong>
          <input id="d${idx}_db_hp" type="number" value="0">
          <input id="d${idx}_db_atk" type="number" value="0">
          <input id="d${idx}_db_df" type="number" value="0">
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(box);
    renderGems(idx);
  }

  function renderGems(idx){
    const c=document.getElementById(`d${idx}_gem_slots`); c.innerHTML='';
    for(let i=1;i<=5;i++){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `
        <strong style="width:64px;display:inline-block">ì ¬${i}</strong>
        <select id="d${idx}_slot_type_${i}">
          <option value="">--ì¢…ë¥˜--</option>
          <option value="HP">HP</option>
          <option value="ATK">ATK</option>
          <option value="DEF">DEF</option>
        </select>
        <select id="d${idx}_slot_val_${i}">
          <option value="0">--ê°’--</option>
        </select>`;
      c.appendChild(row);

      const typeSel=row.querySelector(`#d${idx}_slot_type_${i}`);
      const valSel=row.querySelector(`#d${idx}_slot_val_${i}`);
      typeSel.addEventListener('change', ()=>{
        valSel.innerHTML = `<option value="0">--ê°’--</option>`;
        const t=typeSel.value;
        if(t && gemOptions[t]){
          gemOptions[t].forEach(v=>{
            const op=document.createElement('option');
            op.value=v; op.textContent=v; valSel.appendChild(op);
          });
        }
      });
    }
  }

function renderOneResult(idx){
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.id = `resultSheet_${idx}`;
  sheet.innerHTML = `
    <div class="name" id="d${idx}_name_display">ë“œë˜ê³¤ ${idx}</div>
    <div class="grid">
      <div class="cell h center">êµ¬ë¶„</div>
      <div class="cell h center">ì²´ë ¥</div>
      <div class="cell h center">ê³µê²©ë ¥</div>
      <div class="cell h center">ë°©ì–´ë ¥</div>

      <div class="cell">ê¸°ë³¸ ìŠ¤íƒ¯</div>
      <div class="cell right" id="d${idx}_c_base_hp">-</div>
      <div class="cell right" id="d${idx}_c_base_atk">-</div>
      <div class="cell right" id="d${idx}_c_base_df">-</div>

      <div class="cell">ì ¬1</div><div class="cell right" id="d${idx}_c_g1_hp">0</div><div class="cell right" id="d${idx}_c_g1_atk">0</div><div class="cell right" id="d${idx}_c_g1_df">0</div>
      <div class="cell">ì ¬2</div><div class="cell right" id="d${idx}_c_g2_hp">0</div><div class="cell right" id="d${idx}_c_g2_atk">0</div><div class="cell right" id="d${idx}_c_g2_df">0</div>
      <div class="cell">ì ¬3</div><div class="cell right" id="d${idx}_c_g3_hp">0</div><div class="cell right" id="d${idx}_c_g3_atk">0</div><div class="cell right" id="d${idx}_c_g3_df">0</div>
      <div class="cell">ì ¬4</div><div class="cell right" id="d${idx}_c_g4_hp">0</div><div class="cell right" id="d${idx}_c_g4_atk">0</div><div class="cell right" id="d${idx}_c_g4_df">0</div>
      <div class="cell">ì ¬5</div><div class="cell right" id="d${idx}_c_g5_hp">0</div><div class="cell right" id="d${idx}_c_g5_atk">0</div><div class="cell right" id="d${idx}_c_g5_df">0</div>

      <div class="cell">ì¥ì‹ êµ¬ %</div><div class="cell right" id="d${idx}_c_acc_hp">0%</div><div class="cell right" id="d${idx}_c_acc_atk">0%</div><div class="cell right" id="d${idx}_c_acc_df">0%</div>
      <div class="cell">ì¸ì²¸íŠ¸ %</div><div class="cell right" id="d${idx}_c_ench_hp">0%</div><div class="cell right" id="d${idx}_c_ench_atk">0%</div><div class="cell right" id="d${idx}_c_ench_df">0%</div>
      <div class="cell">íœë˜íŠ¸ %</div><div class="cell right" id="d${idx}_c_pend_hp">0%</div><div class="cell right" id="d${idx}_c_pend_atk">0%</div><div class="cell right" id="d${idx}_c_pend_df">0%</div>

      <div class="cell">ì •ë ¹ +</div><div class="cell right" id="d${idx}_c_spf_hp">0</div><div class="cell right" id="d${idx}_c_spf_atk">0</div><div class="cell right" id="d${idx}_c_spf_df">0</div>
      <div class="cell">ì •ë ¹ %</div><div class="cell right" id="d${idx}_c_spp_hp">0%</div><div class="cell right" id="d${idx}_c_spp_atk">0%</div><div class="cell right" id="d${idx}_c_spp_df">0%</div>
      <div class="cell">ì •ë ¹ ë¶€ê°€ì˜µ</div><div class="cell right" id="d${idx}_c_spe_hp">0</div><div class="cell right" id="d${idx}_c_spe_atk">0</div><div class="cell right" id="d${idx}_c_spe_df">0</div>
      <div class="cell">ë²„í”„ %</div><div class="cell right" id="d${idx}_c_bf_hp">0%</div><div class="cell right" id="d${idx}_c_bf_atk">0%</div><div class="cell right" id="d${idx}_c_bf_df">0%</div>
      <div class="cell">ë””ë²„í”„ %</div><div class="cell right" id="d${idx}_c_db_hp">0%</div><div class="cell right" id="d${idx}_c_db_atk">0%</div><div class="cell right" id="d${idx}_c_db_df">0%</div>

      <div class="cell section center" style="grid-column:1/5">ìµœì¢… ìŠ¤íƒ¯</div>
      <div class="cell sum">ì²´ë ¥</div><div class="cell big" id="d${idx}_c_fin_hp">-</div>
      <div class="cell sum">ê³µê²©ë ¥</div><div class="cell big" id="d${idx}_c_fin_atk">-</div>
      <div class="cell sum">ë°©ì–´ë ¥</div><div class="cell big" id="d${idx}_c_fin_df">-</div>

      <div class="cell section center" style="grid-column:1/5">ì§€í‘œ</div>
      <div class="cell">E-Value</div><div class="cell big" id="d${idx}_c_eval" style="grid-column:2/5">-</div>
      <div class="cell">B-Value</div><div class="cell big" id="d${idx}_c_bval" style="grid-column:2/5">-</div>
    </div>
  `;
  allResults.appendChild(sheet);
}

  const num = val;  // ë³„ì¹­ (ìë™ ê³„ì‚°ê¸°ì™€ ìˆ˜ë™ ê³„ì‚°ê¸° ëª¨ë‘ ì‚¬ìš©)
  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

  function manualCalcOne(idx){
    const nm = (document.getElementById(`d${idx}_name`).value||'').trim();
    setText(`d${idx}_name_display`, nm ? nm : `ë“œë˜ê³¤ ${idx}`);

    const lvl = document.getElementById(`d${idx}_m_level`).value;
    const type = document.getElementById(`d${idx}_m_type`).value;
    const base = dragon[lvl][type];

    // ì ¬ í•©ì‚°
    let g_hp=0, g_atk=0, g_df=0;
    for(let i=1;i<=5;i++){
      const t=document.getElementById(`d${idx}_slot_type_${i}`).value;
      const v=Number(document.getElementById(`d${idx}_slot_val_${i}`).value||0);
      let hp=0, atk=0, df=0;
      if(t==="HP") hp=v; if(t==="ATK") atk=v; if(t==="DEF") df=v;
      g_hp+=hp; g_atk+=atk; g_df+=df;
      setText(`d${idx}_c_g${i}_hp`, hp); setText(`d${idx}_c_g${i}_atk`, atk); setText(`d${idx}_c_g${i}_df`, df);
    }
    const gem = new Stats(g_hp,g_atk,g_df);

    // ì¥ì‹ êµ¬/ì¸ì²¸íŠ¸ (ê³„ì‚°ì€ í•©ì‚°í•´ì„œ, í‘œê¸°ëŠ” ë¶„ë¦¬)
    const accOnly = new Stats(num(`d${idx}_m_acc_hp`)/100, num(`d${idx}_m_acc_atk`)/100, num(`d${idx}_m_acc_df`)/100);
    const enchOnly = new Stats(num(`d${idx}_m_ench_hp`)/100, num(`d${idx}_m_ench_atk`)/100, num(`d${idx}_m_ench_df`)/100);
    const acc = new Stats(accOnly.hp+enchOnly.hp, accOnly.atk+enchOnly.atk, accOnly.df+enchOnly.df);

    const pend = new Stats(num(`d${idx}_m_pend_hp`)/100, num(`d${idx}_m_pend_atk`)/100, num(`d${idx}_m_pend_df`)/100);

    // ì •ë ¹/ë²„í”„/ë””ë²„í”„
    const spf = new Stats(num(`d${idx}_sf_hp`), num(`d${idx}_sf_atk`), num(`d${idx}_sf_df`));
    const spp = new Stats(num(`d${idx}_sp_hp`)/100, num(`d${idx}_sp_atk`)/100, num(`d${idx}_sp_df`)/100);
    const spe = new Stats(num(`d${idx}_se_hp`), num(`d${idx}_se_atk`), num(`d${idx}_se_df`));
    const bf  = new Stats(num(`d${idx}_bf_hp`)/100, num(`d${idx}_bf_atk`)/100, num(`d${idx}_bf_df`)/100);
    const db  = new Stats(num(`d${idx}_db_hp`)/100, num(`d${idx}_db_atk`)/100, num(`d${idx}_db_df`)/100);

    // ìƒìˆ˜
    const pot = new Stats(24,6,6);
    const col = new Stats(240,60,60);

    const [fin, E, B] = calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);

    // ê²°ê³¼ ì‹œíŠ¸
    setText(`d${idx}_c_base_hp`, base.hp);
    setText(`d${idx}_c_base_atk`, base.atk);
    setText(`d${idx}_c_base_df`, base.df);

    // í¼ì„¼íŠ¸ í‘œê¸°(ë¶„ë¦¬)
    setText(`d${idx}_c_acc_hp`, (accOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_atk`, (accOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_df`, (accOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_ench_hp`, (enchOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_atk`, (enchOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_df`, (enchOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_pend_hp`, document.getElementById(`d${idx}_m_pend_hp`).value + '%');
    setText(`d${idx}_c_pend_atk`, document.getElementById(`d${idx}_m_pend_atk`).value + '%');
    setText(`d${idx}_c_pend_df`, document.getElementById(`d${idx}_m_pend_df`).value + '%');

    setText(`d${idx}_c_spf_hp`, spf.hp); setText(`d${idx}_c_spf_atk`, spf.atk); setText(`d${idx}_c_spf_df`, spf.df);
    setText(`d${idx}_c_spp_hp`, (spp.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_atk`, (spp.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_df`, (spp.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_spe_hp`, spe.hp); setText(`d${idx}_c_spe_atk`, spe.atk); setText(`d${idx}_c_spe_df`, spe.df);
    setText(`d${idx}_c_bf_hp`, (bf.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_atk`, (bf.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_df`, (bf.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_db_hp`, (db.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_db_atk`, (db.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_db_df`, (db.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_fin_hp`, fin.hp);
    setText(`d${idx}_c_fin_atk`, fin.atk);
    setText(`d${idx}_c_fin_df`, fin.df);
    setText(`d${idx}_c_eval`, Math.round(E).toString());
    setText(`d${idx}_c_bval`, (B/1e6).toFixed(3));  // ë‹¨ìœ„ â€˜Mâ€™ í‘œì‹œ ì—†ìŒ
  }

  function manualCalcAll(){
    for(let i=1;i<=3;i++) manualCalcOne(i);
  }

  function savePngAll(){
    const node = document.getElementById('allResults');
    manualCalcAll(); // ìµœì‹  ê°’ ë³´ì¥
    const w = node.scrollWidth;
    const h = node.scrollHeight;

    html2canvas(node, {
      backgroundColor: null,
      scale: 2,
      width:  w,
      height: h,
      windowWidth:  w,
      windowHeight: h
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='dragon_calculate.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  const autoDiv=document.getElementById('autoCalc');
  const manualDiv=document.getElementById('manualCalc');
  const serverDiv=document.getElementById('serverCalc');
  const btnAuto=document.getElementById('btnAuto');
  const btnManual=document.getElementById('btnManual');
  const btnServer=document.getElementById('btnServer');

  // ê° ëª¨ë“œì˜ ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
  let autoScrollPos = 0;
  let manualScrollPos = 0;
  let serverScrollPos = 0;

  function switchMode(mode){
    if(mode==='auto'){
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      autoDiv.classList.add('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnAuto.classList.add('primary');
      btnManual.classList.remove('primary');
      btnServer.classList.remove('primary');

      window.scrollTo(0, autoScrollPos);
    }else if(mode==='manual'){
      autoScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      manualDiv.classList.add('active');
      autoDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnManual.classList.add('primary');
      btnAuto.classList.remove('primary');
      btnServer.classList.remove('primary');

      window.scrollTo(0, manualScrollPos);
    }else if(mode==='server'){
      autoScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;

      serverDiv.classList.add('active');
      autoDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      btnServer.classList.add('primary');
      btnAuto.classList.remove('primary');
      btnManual.classList.remove('primary');

      window.scrollTo(0, serverScrollPos);
      loadSlotList(); // ìŠ¬ë¡¯ ëª©ë¡ ë¡œë“œ
    }
  }
  btnAuto.onclick=()=>switchMode('auto');
  btnManual.onclick=()=>switchMode('manual');
  btnServer.onclick=()=>switchMode('server');

  // ì ê¸ˆ/ê³µìœ  ì„ íƒ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ í‘œì‹œ
  document.querySelectorAll('input[name="slotType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const isPrivate = document.querySelector('input[name="slotType"]:checked').value === 'private';
      document.getElementById('slotPasswordRow').style.display = isPrivate ? 'flex' : 'none';
    });
  });

  // ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (SHA-256)
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  // ìŠ¬ë¡¯ ë§Œë“¤ê¸°
  async function createSlot() {
    const name = document.getElementById('newSlotName').value.trim();
    if (!name) {
      alert('ìŠ¬ë¡¯ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const type = document.querySelector('input[name="slotType"]:checked').value;
    const isPrivate = type === 'private';

    let passwordHash = null;
    if (isPrivate) {
      const password = document.getElementById('slotPassword').value;
      if (!password) {
        alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      passwordHash = await hashPassword(password);
    }

    const slotData = {
      name: name,
      type: type,
      passwordHash: passwordHash,
      createdAt: Date.now(),
      data: []
    };

    try {
      const newSlotRef = window.firebasePush(window.firebaseRef(window.firebaseDB, 'slots'));
      await window.firebaseSet(newSlotRef, slotData);

      alert(`ìŠ¬ë¡¯ "${name}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
      document.getElementById('newSlotName').value = '';
      document.getElementById('slotPassword').value = '';
      loadSlotList();
    } catch (error) {
      console.error('ìŠ¬ë¡¯ ìƒì„± ì˜¤ë¥˜:', error);
      alert('ìŠ¬ë¡¯ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ìŠ¬ë¡¯ ëª©ë¡ ë¡œë“œ
  function loadSlotList() {
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    window.firebaseOnValue(slotsRef, (snapshot) => {
      const slotListEl = document.getElementById('slotList');
      slotListEl.innerHTML = '';

      if (!snapshot.exists()) {
        slotListEl.innerHTML = '<p style="color:#999;text-align:center;padding:40px 0">ì €ì¥ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const slots = snapshot.val();
      Object.keys(slots).forEach(slotId => {
        const slot = slots[slotId];
        const slotBox = document.createElement('div');
        slotBox.style.cssText = 'border:1px solid var(--line);background:#fff;border-radius:8px;padding:12px;margin-bottom:10px';

        const lockIcon = slot.type === 'private' ? 'ğŸ”’ ' : '';
        const dataCount = slot.data ? slot.data.length : 0;
        const createdDate = new Date(slot.createdAt).toLocaleString('ko-KR');

        slotBox.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <strong style="font-size:16px">${lockIcon} ${slot.name}</strong>
              <div style="color:#666;font-size:12px;margin-top:4px">
                ìƒì„±ì¼: ${createdDate} | ì €ì¥ëœ ë°ì´í„°: ${dataCount}ê°œ
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" onclick="viewSlot('${slotId}')" style="background:#4CAF50;color:#fff;border-color:#4CAF50;">ì—´ëŒí•˜ê¸°</button>
              <button class="btn" onclick="clearSlotData('${slotId}')" style="background:#ff9800;color:#fff;border-color:#ff9800;">ë°ì´í„° ë¹„ìš°ê¸°</button>
              <button class="btn" onclick="deleteSlot('${slotId}')" style="background:#f44336;color:#fff;border-color:#f44336;">ìŠ¬ë¡¯ ì‚­ì œ</button>
            </div>
          </div>
        `;
        slotListEl.appendChild(slotBox);
      });
    });
  }

  // ìŠ¬ë¡¯ ì—´ëŒ
  async function viewSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    // ë°ì´í„° í‘œì‹œ - ëª¨ë‹¬ë¡œ ê°œì„ 
    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ëª¨ë‹¬ ìƒì„±
    let modalContent = `
      <div id="viewSlotModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ddd;padding-bottom:12px;">
            <h3 style="margin:0;color:#111;">ğŸ“ ${slot.name}</h3>
            <button class="btn" onclick="closeViewSlotModal()" style="padding:6px 12px;">ë‹«ê¸°</button>
          </div>

          <!-- ìƒë‹¨ íƒ­ ë° ê²€ìƒ‰/ë‹¤ìš´ë¡œë“œ -->
          <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="btnDetailView" onclick="switchViewMode('detail')" style="padding:8px 16px;">ìƒì„¸ ë³´ê¸°</button>
              <button class="btn" id="btnSummaryView" onclick="switchViewMode('summary')" style="padding:8px 16px;">ìš”ì•½ í†µê³„</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="userSearchInput" type="text" placeholder="ìœ ì € ê²€ìƒ‰..." style="padding:6px 12px;border:1px solid #aaa;border-radius:4px;width:150px;">
              <button class="btn" onclick="filterByUser()" style="padding:6px 12px;">ğŸ” ê²€ìƒ‰</button>
              <button class="btn" id="btnExportStats" onclick="exportToExcel()" style="padding:6px 12px;background:#28a745;color:#fff;border-color:#28a745;display:none;">ğŸ“Š í†µê³„ ì €ì¥</button>
            </div>
          </div>

          <div id="viewSlotContent"></div>
          <div id="viewSlotSummary" style="display:none;"></div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // ë°ì´í„°ë¥¼ ì „ì—­ì— ì €ì¥ (í•„í„°ë§ ë° í†µê³„ìš©)
    window._currentSlotData = dataList;

    // ìƒì„¸ ë³´ê¸° ì´ˆê¸° ë Œë”ë§ (í•¨ìˆ˜ ì •ì˜ ì „ì´ë¯€ë¡œ setTimeout ì‚¬ìš©)
    setTimeout(() => window.renderDetailView(dataList), 0);
  }

  // ë“œë˜ê³¤ ìŠ¤íƒ¯ ê³„ì‚° (ì¤‘ë³µ ì œê±°ìš© í—¬í¼ í•¨ìˆ˜)
  window.calculateDragonStats = function(dragon) {
    let gemTotal = {hp: 0, atk: 0, df: 0};
    dragon.gems.forEach(gem => {
      if (gem.type === 'HP') gemTotal.hp += gem.value;
      if (gem.type === 'ATK') gemTotal.atk += gem.value;
      if (gem.type === 'DEF') gemTotal.df += gem.value;
    });

    const pot = new Stats(24, 6, 6);
    const col = new Stats(240, 60, 60);
    const gem = new Stats(gemTotal.hp, gemTotal.atk, gemTotal.df);
    const acc = new Stats(
      (dragon.accessory.hp + dragon.enchant.hp) / 100,
      (dragon.accessory.atk + dragon.enchant.atk) / 100,
      (dragon.accessory.df + dragon.enchant.df) / 100
    );
    const pend = new Stats(dragon.pendant.hp / 100, dragon.pendant.atk / 100, dragon.pendant.df / 100);
    const spf = new Stats(dragon.spirit.flatHp, dragon.spirit.flatAtk, dragon.spirit.flatDf);
    const spp = new Stats(dragon.spirit.pctHp / 100, dragon.spirit.pctAtk / 100, dragon.spirit.pctDf / 100);
    const spe = new Stats(dragon.spirit.extraHp, dragon.spirit.extraAtk, dragon.spirit.extraDf);
    const bf = new Stats(dragon.buff.hp / 100, dragon.buff.atk / 100, dragon.buff.df / 100);
    const db = new Stats(dragon.debuff.hp / 100, dragon.debuff.atk / 100, dragon.debuff.df / 100);

    const base = window.dragon && window.dragon[dragon.level] && window.dragon[dragon.level][dragon.type]
      ? window.dragon[dragon.level][dragon.type]
      : new Stats(1160, 282, 133);

    return calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);
  }

  // ì—´ëŒ ëª¨ë‹¬ ë‹«ê¸°
  window.closeViewSlotModal = function() {
    const modal = document.getElementById('viewSlotModal');
    if (modal) modal.remove();
    delete window._currentSlotData;
    delete window._currentFilteredData;
  }

  // ë·° ëª¨ë“œ ì „í™˜ (ìƒì„¸ ë³´ê¸° / ìš”ì•½ í†µê³„)
  window.switchViewMode = function(mode) {
    const detailBtn = document.getElementById('btnDetailView');
    const summaryBtn = document.getElementById('btnSummaryView');
    const exportBtn = document.getElementById('btnExportStats');
    const contentDiv = document.getElementById('viewSlotContent');
    const summaryDiv = document.getElementById('viewSlotSummary');

    if (mode === 'detail') {
      detailBtn.classList.add('primary');
      summaryBtn.classList.remove('primary');
      contentDiv.style.display = 'block';
      summaryDiv.style.display = 'none';
      exportBtn.style.display = 'none';
    } else if (mode === 'summary') {
      detailBtn.classList.remove('primary');
      summaryBtn.classList.add('primary');
      contentDiv.style.display = 'none';
      summaryDiv.style.display = 'block';
      exportBtn.style.display = 'inline-block';
      renderSummaryStats();
    }
  }

  // ìš”ì•½ í†µê³„ ë Œë”ë§
  window.renderSummaryStats = function() {
    const summaryDiv = document.getElementById('viewSlotSummary');
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      summaryDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px 0;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    let summaryHtml = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#2d6cdf;color:#fff;">
              <th style="padding:12px;text-align:left;border:1px solid #ddd;">ìœ ì €ì´ë¦„</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">ë“œë˜ê³¤1 (ë¹„ë²¨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">ë“œë˜ê³¤2 (ë¹„ë²¨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">ë“œë˜ê³¤3 (ë¹„ë²¨)</th>
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">í•©ê³„</th>
            </tr>
          </thead>
          <tbody>
    `;

    dataList.forEach((entry, index) => {
      const bValues = entry.dragons.map(dragon => {
        const [, , bValue] = window.calculateDragonStats(dragon);
        return bValue / 1e6;
      });

      const total = bValues.reduce((sum, val) => sum + val, 0);
      const rowBg = index % 2 === 0 ? '#f9f9f9' : '#fff';

      summaryHtml += `
        <tr style="background:${rowBg};">
          <td style="padding:10px;border:1px solid #ddd;font-weight:600;">${entry.userName}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[0].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[1].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;">${bValues[2].toFixed(3)}</td>
          <td style="padding:10px;border:1px solid #ddd;text-align:center;font-weight:700;background:#e3f2fd;">${total.toFixed(3)}</td>
        </tr>
      `;
    });

    summaryHtml += `
          </tbody>
        </table>
      </div>
    `;

    summaryDiv.innerHTML = summaryHtml;
  }

  // ìœ ì € ê²€ìƒ‰ í•„í„°
  window.filterByUser = function() {
    const searchInput = document.getElementById('userSearchInput');
    const searchTerm = searchInput.value.trim().toLowerCase();

    if (!searchTerm) {
      // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„° í‘œì‹œ
      window._currentFilteredData = null;
      renderDetailView(window._currentSlotData);
      renderSummaryStats();
      return;
    }

    // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
    const filtered = window._currentSlotData.filter(entry =>
      entry.userName.toLowerCase().includes(searchTerm)
    );

    if (filtered.length === 0) {
      alert(`"${searchInput.value}" ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }

    window._currentFilteredData = filtered;
    renderDetailView(filtered);
    renderSummaryStats();
  }

  // ìƒì„¸ ë³´ê¸° ì¬ë Œë”ë§
  window.renderDetailView = function(dataList) {
    const contentDiv = document.getElementById('viewSlotContent');
    contentDiv.innerHTML = '';

    dataList.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.style.cssText = 'border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9f9f9;';

      let entryHtml = `
        <div style="background:#2d6cdf;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
          <strong style="font-size:16px;">[${index + 1}] ${entry.userName}</strong>
          <span style="font-size:12px;opacity:0.9;">${new Date(entry.timestamp).toLocaleString('ko-KR')}</span>
        </div>
      `;

      entry.dragons.forEach((dragon, dragonIdx) => {
        const dragonName = dragon.name || `ë“œë˜ê³¤ ${dragonIdx + 1}`;
        const [finalStats, eValue, bValue] = window.calculateDragonStats(dragon);

        entryHtml += `
          <div style="border:1px solid #ccc;border-radius:6px;padding:12px;margin-bottom:10px;background:#fff;">
            <h4 style="margin:0 0 10px;color:#2d6cdf;border-bottom:1px solid #eee;padding-bottom:6px;">${dragonName}</h4>

            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:12px;border-radius:6px;margin-bottom:12px;">
              <div style="font-size:14px;font-weight:700;margin-bottom:8px;">ğŸ“Š ìµœì¢… ê³„ì‚° ê²°ê³¼</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;font-size:13px;">
                <div><strong>HP:</strong> ${finalStats.hp.toLocaleString()}</div>
                <div><strong>ATK:</strong> ${finalStats.atk.toLocaleString()}</div>
                <div><strong>DEF:</strong> ${finalStats.df.toLocaleString()}</div>
              </div>
              <div style="border-top:1px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">E-Value (ì´ë²¨)</div>
                  <div style="font-size:18px;font-weight:900;">${eValue.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">B-Value (ë¹„ë²¨)</div>
                  <div style="font-size:18px;font-weight:900;">${(bValue/1e6).toFixed(3)}</div>
                </div>
              </div>
            </div>

            <!-- ì…ë ¥ ìŠ¤íƒ¯ ìƒì„¸ (4ê°œ ì»¬ëŸ¼ìœ¼ë¡œ ê·¸ë£¹í™”) -->
            <div style="display:grid !important;grid-template-columns:1fr 1fr 1fr 1fr !important;gap:15px;font-size:13px;">

              <!-- 1ê·¸ë£¹: ê¸°ë³¸ ì •ë³´ -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>ë“±ê¸‰/íƒ€ì…:</strong><br>${dragon.level} / ${dragon.type}</div>
                <div><strong>ì ¬ êµ¬ì„±:</strong><br>${dragon.gems.map((gem, i) => gem.type ? `ì ¬${i+1}: ${gem.type} ${gem.value}` : `ì ¬${i+1}: ì—†ìŒ`).join('<br>')}</div>
              </div>

              <!-- 2ê·¸ë£¹: ì¥ë¹„ ì˜µì…˜ -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>ì¥ì‹ êµ¬ (%):</strong><br>HP ${dragon.accessory.hp}% / ATK ${dragon.accessory.atk}% / DEF ${dragon.accessory.df}%</div>
                <div><strong>ì¸ì±ˆíŠ¸ (%):</strong><br>HP ${dragon.enchant.hp}% / ATK ${dragon.enchant.atk}% / DEF ${dragon.enchant.df}%</div>
                <div><strong>íœë˜íŠ¸ (%):</strong><br>HP ${dragon.pendant.hp}% / ATK ${dragon.pendant.atk}% / DEF ${dragon.pendant.df}%</div>
              </div>

              <!-- 3ê·¸ë£¹: ì •ë ¹ ì˜µì…˜ -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>ì •ë ¹ í”Œì˜µ:</strong><br>HP ${dragon.spirit.flatHp} / ATK ${dragon.spirit.flatAtk} / DEF ${dragon.spirit.flatDf}</div>
                <div><strong>ì •ë ¹ í¼ì˜µ (%):</strong><br>HP ${dragon.spirit.pctHp}% / ATK ${dragon.spirit.pctAtk}% / DEF ${dragon.spirit.pctDf}%</div>
                <div><strong>ì •ë ¹ ë¶€ê°€ì˜µ:</strong><br>HP ${dragon.spirit.extraHp} / ATK ${dragon.spirit.extraAtk} / DEF ${dragon.spirit.extraDf}</div>
              </div>

              <!-- 4ê·¸ë£¹: ë²„í”„/ë””ë²„í”„ -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>ë²„í”„ (%):</strong><br>HP ${dragon.buff.hp}% / ATK ${dragon.buff.atk}% / DEF ${dragon.buff.df}%</div>
                <div><strong>ë””ë²„í”„ (%):</strong><br>HP ${dragon.debuff.hp}% / ATK ${dragon.debuff.atk}% / DEF ${dragon.debuff.df}%</div>
              </div>

            </div>
          </div>
        `;
      });

      entryDiv.innerHTML = entryHtml;
      contentDiv.appendChild(entryDiv);
    });
  }

  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (CSV í˜•ì‹)
  window.exportToExcel = function() {
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // CSV í—¤ë”
    let csv = 'ìœ ì €ì´ë¦„,ë“œë˜ê³¤1,ë“œë˜ê³¤2,ë“œë˜ê³¤3,í•©ê³„\n';

    // CSV ë°ì´í„°
    dataList.forEach(entry => {
      const bValues = entry.dragons.map(dragon => {
        const [, , bValue] = window.calculateDragonStats(dragon);
        return bValue / 1e6;
      });
      const total = bValues.reduce((sum, val) => sum + val, 0);
      csv += `${entry.userName},${bValues[0].toFixed(3)},${bValues[1].toFixed(3)},${bValues[2].toFixed(3)},${total.toFixed(3)}\n`;
    });

    // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `dragon_stats_${new Date().getTime()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  // ìŠ¬ë¡¯ì˜ ë°ì´í„°ë§Œ ë¹„ìš°ê¸° (ìŠ¬ë¡¯ì€ ìœ ì§€)
  async function clearSlotData(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    const dataCount = slot.data ? slot.data.length : 0;
    if (dataCount === 0) {
      alert('ë¹„ìš¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    if (!confirm(`"${slot.name}" ìŠ¬ë¡¯ì˜ ëª¨ë“  ë°ì´í„°(${dataCount}ê°œ)ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
      return;
    }

    try {
      const dataRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}/data`);
      await window.firebaseSet(dataRef, []);
      alert('ìŠ¬ë¡¯ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      loadSlotList();
    } catch (error) {
      console.error('ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
      alert('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ìŠ¬ë¡¯ ì™„ì „ ì‚­ì œ
  async function deleteSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    if (!confirm(`"${slot.name}" ìŠ¬ë¡¯ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ìŠ¬ë¡¯ê³¼ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
      return;
    }

    // í•œ ë²ˆ ë” í™•ì¸
    const confirmText = prompt('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (confirmText !== 'ì‚­ì œ') {
      alert('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      await window.firebaseSet(slotRef, null);
      alert(`"${slot.name}" ìŠ¬ë¡¯ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadSlotList();
    } catch (error) {
      console.error('ìŠ¬ë¡¯ ì‚­ì œ ì˜¤ë¥˜:', error);
      alert('ìŠ¬ë¡¯ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.clearSlotData = clearSlotData;
  window.deleteSlot = deleteSlot;

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¬ë¡¯ ëª©ë¡ ìë™ ë¡œë“œ (Firebase ì´ˆê¸°í™” í›„)
  setTimeout(() => {
    if (window.firebaseDB) {
      loadSlotList();
    }
  }, 1000);

  // ìˆ˜ë™ê³„ì‚°ê¸° ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥
  async function saveToServer() {
    // 1. ìŠ¬ë¡¯ ëª©ë¡ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    const snapshot = await window.firebaseGet(slotsRef);

    if (!snapshot.exists()) {
      alert('ì €ì¥ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì €ì¥ ì„œë²„ íƒ­ì—ì„œ ìŠ¬ë¡¯ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    const slots = snapshot.val();
    const slotList = Object.keys(slots).map(id => ({id, ...slots[id]}));

    // 2. ìŠ¬ë¡¯ ì„ íƒ ëª¨ë‹¬ ìƒì„±
    const modalHtml = `
      <div id="slotSelectModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:24px;">
          <h3 style="margin:0 0 16px;color:#111;">ìŠ¬ë¡¯ ì„ íƒ</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">ìœ ì € ì´ë¦„</label>
            <input id="saveUserName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;height:36px;border:1px solid #aaa;border-radius:6px;padding:0 12px;box-sizing:border-box;">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">ì €ì¥í•  ìŠ¬ë¡¯</label>
            <div id="slotSelectList" style="border:1px solid #ddd;border-radius:6px;max-height:300px;overflow-y:auto;"></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="closeSlotModal()" style="padding:10px 20px;">ì·¨ì†Œ</button>
            <button class="btn primary" onclick="confirmSlotSelection()" style="padding:10px 20px;">ì €ì¥</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 3. ìŠ¬ë¡¯ ëª©ë¡ ë Œë”ë§
    const slotSelectList = document.getElementById('slotSelectList');
    slotList.forEach((slot, index) => {
      const lockIcon = slot.type === 'private' ? 'ğŸ”’' : 'ğŸ”“';
      const dataCount = slot.data ? slot.data.length : 0;

      const slotItem = document.createElement('div');
      slotItem.style.cssText = 'padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;';
      slotItem.innerHTML = `
        <input type="radio" name="selectedSlot" value="${index}" id="slot_${index}" style="margin-right:8px;">
        <label for="slot_${index}" style="cursor:pointer;display:inline;">
          <strong>${lockIcon} ${slot.name}</strong>
          <span style="color:#666;font-size:12px;margin-left:8px;">(${dataCount}ê°œ ì €ì¥ë¨)</span>
        </label>
      `;
      slotItem.addEventListener('mouseover', () => slotItem.style.background = '#f5f5f5');
      slotItem.addEventListener('mouseout', () => slotItem.style.background = '');
      slotItem.addEventListener('click', (e) => {
        if(e.target.tagName !== 'INPUT') {
          document.getElementById(`slot_${index}`).checked = true;
        }
      });
      slotSelectList.appendChild(slotItem);
    });

    // ìŠ¬ë¡¯ ë¦¬ìŠ¤íŠ¸ë¥¼ ì „ì—­ì— ì €ì¥
    window._slotList = slotList;
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  window.closeSlotModal = function() {
    const modal = document.getElementById('slotSelectModal');
    if (modal) modal.remove();
    delete window._slotList;
  }

  // ìŠ¬ë¡¯ ì„ íƒ í™•ì • ë° ì €ì¥
  window.confirmSlotSelection = async function() {
    const userName = document.getElementById('saveUserName')?.value?.trim();
    if (!userName) {
      alert('ìœ ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const selectedRadio = document.querySelector('input[name="selectedSlot"]:checked');
    if (!selectedRadio) {
      alert('ì €ì¥í•  ìŠ¬ë¡¯ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const selectedIndex = parseInt(selectedRadio.value);
    const selectedSlot = window._slotList[selectedIndex];

    // ì ê¸ˆ ìŠ¬ë¡¯ì´ë©´ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (selectedSlot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== selectedSlot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    // ë“œë˜ê³¤ 3ë§ˆë¦¬ ë°ì´í„° ìˆ˜ì§‘
    const dragons = [];
    for (let i = 1; i <= 3; i++) {
      const dragonData = {
        name: document.getElementById(`d${i}_name`)?.value || '',
        level: document.getElementById(`d${i}_m_level`)?.value || '9.0',
        type: document.getElementById(`d${i}_m_type`)?.value || 'ê³µê²©í˜•',
        gems: [],
        accessory: {
          hp: num(`d${i}_m_acc_hp`),
          atk: num(`d${i}_m_acc_atk`),
          df: num(`d${i}_m_acc_df`)
        },
        enchant: {
          hp: num(`d${i}_m_ench_hp`),
          atk: num(`d${i}_m_ench_atk`),
          df: num(`d${i}_m_ench_df`)
        },
        pendant: {
          hp: num(`d${i}_m_pend_hp`),
          atk: num(`d${i}_m_pend_atk`),
          df: num(`d${i}_m_pend_df`)
        },
        spirit: {
          flatHp: num(`d${i}_sf_hp`),
          flatAtk: num(`d${i}_sf_atk`),
          flatDf: num(`d${i}_sf_df`),
          pctHp: num(`d${i}_sp_hp`),
          pctAtk: num(`d${i}_sp_atk`),
          pctDf: num(`d${i}_sp_df`),
          extraHp: num(`d${i}_se_hp`),
          extraAtk: num(`d${i}_se_atk`),
          extraDf: num(`d${i}_se_df`)
        },
        buff: {
          hp: num(`d${i}_bf_hp`),
          atk: num(`d${i}_bf_atk`),
          df: num(`d${i}_bf_df`)
        },
        debuff: {
          hp: num(`d${i}_db_hp`),
          atk: num(`d${i}_db_atk`),
          df: num(`d${i}_db_df`)
        }
      };

      // ì ¬ ë°ì´í„° ìˆ˜ì§‘
      for (let j = 1; j <= 5; j++) {
        const type = document.getElementById(`d${i}_slot_type_${j}`)?.value || '';
        const value = document.getElementById(`d${i}_slot_val_${j}`)?.value || '0';
        dragonData.gems.push({type, value: parseInt(value)});
      }

      dragons.push(dragonData);
    }

    // Firebaseì— ì €ì¥
    const saveData = {
      userName: userName,
      timestamp: Date.now(),
      dragons: dragons
    };

    try {
      const currentData = selectedSlot.data || [];
      currentData.push(saveData);

      const slotRef = window.firebaseRef(window.firebaseDB, `slots/${selectedSlot.id}/data`);
      await window.firebaseSet(slotRef, currentData);

      closeSlotModal();
      alert(`"${selectedSlot.name}" ìŠ¬ë¡¯ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
  </script>
</body>
</html>
