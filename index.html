<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>드래곤 비벨/이벨 통합 계산기</title>
<style>
  :root{
    --bg:#ffffff; --ink:#1a1a1a;
    --card-bg:#f8f9fa; --border:#e5e7eb;
    --accent:#3b82f6; --accent-hover:#2563eb;
    --radius:12px; --radius-sm:8px;
    --shadow:0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-md:0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
  }
  body{font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;margin:24px;background:var(--bg);color:var(--ink);line-height:1.5}
  h2{margin:0 0 8px;font-weight:700;color:var(--ink)}
  .hint{color:#6b7280;margin-bottom:14px}
  .small{color:#9ca3af;font-size:12px}

  .header-fixed{position:sticky;top:0;background:var(--bg);z-index:100;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:20px}
  .modebar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab-btn{padding:10px 20px;border:none;background:transparent;cursor:pointer;border-radius:0;font-size:14px;font-weight:500;color:#6b7280;position:relative;transition:color 0.2s}
  .tab-btn:hover{color:var(--accent);background:#f3f4f6}
  .tab-btn.active{color:var(--accent);font-weight:600}
  .tab-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent);border-radius:1px}
  .btn{padding:10px 18px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:var(--radius-sm);font-size:14px;font-weight:500;transition:all 0.2s;box-shadow:var(--shadow)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:var(--shadow-md)}
  .btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
  .btn:hover{background:#f9fafb;border-color:#d1d5db}

  .calc-container{display:none;overflow-y:auto;height:100%}
  .calc-container.active{display:block}

  fieldset{background:var(--card-bg);border:none;padding:20px;margin-bottom:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
  legend{font-weight:700;font-size:15px;color:var(--ink);padding:0 4px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:8px}
  label{display:inline-flex;gap:6px;align-items:center;cursor:pointer;font-size:14px}
  input[type="number"],select{height:36px;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:center;background:#fff;font-size:14px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="number"]:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
  input[type="text"]{height:36px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;padding:0 12px;font-size:14px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
  input[type="checkbox"],input[type="radio"]{width:18px;height:18px;accent-color:var(--accent)}

  .acc-list{max-height:220px;overflow:auto;border:1px solid var(--border);padding:12px;background:#fff;border-radius:var(--radius-sm)}
  .toolbar{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}

  /* 정령/버프/디버프 */
  .row-spirit{
    display:grid;
    grid-template-columns: 150px 90px 90px 90px auto;
    align-items:center;
    column-gap:8px;
    margin-bottom:6px
  }
  .row-spirit strong{text-align:right;padding-right:4px;font-weight:700}

  /* 수동결과 시트 - 밝은 테마 */
  .results-wrap{margin-top:16px}
  .results-row{display:inline-flex;gap:16px;align-items:flex-start;flex-wrap:nowrap}
  .sheet{
    background:#fff; color:var(--ink);
    padding:16px; border-radius:var(--radius);
    display:inline-block; min-width:530px;
    box-shadow:var(--shadow-md);
    border:1px solid var(--border);
  }
  .sheet .name{
    font-weight:700; font-size:18px; letter-spacing:.3px; margin-bottom:10px; text-align:center;
    color:var(--accent);
  }
  .grid{
    display:grid;
    grid-template-columns: 150px 120px 120px 120px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:var(--radius-sm);
    overflow:hidden;
  }
  .cell{
    border:1px solid var(--border);
    padding:8px 10px; line-height:1.3;
    font-size:13px; background:#fff;
    color:var(--ink);
  }
  .cell.h{background:#f1f5f9;font-weight:600;color:#475569}
  .cell.section{background:#e0f2fe;color:#0369a1;font-weight:700;text-align:center}
  .cell.sum{background:#f8fafc;border-color:var(--border);color:var(--ink);font-size:15px;font-weight:600}
  .cell.big{font-size:22px;font-weight:700;letter-spacing:1px;text-align:center;background:#eff6ff;color:var(--accent)}
  .center{text-align:center}
  .right{text-align:right}
  pre.result{
    white-space:pre; background:#f8fafc; color:var(--ink);
    padding:16px; border-radius:var(--radius-sm); min-height:220px;
    border:1px solid var(--border);
    font-family:'Consolas',monospace;
    font-size:13px;
    line-height:1.5;
  }

  /* 모바일 반응형 */
  @media (max-width: 768px) {
    body{margin:12px;}
    .header-fixed{padding:12px 0;}
    h2{font-size:18px;}
    .hint{font-size:12px;}

    .modebar{gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .tab-btn{padding:8px 14px;font-size:13px;white-space:nowrap;}
    .btn{padding:8px 12px;font-size:13px;}

    .row{flex-direction:column;align-items:flex-start;gap:8px;}
    .row label{width:100%;}

    .row-spirit{
      grid-template-columns:1fr;
      gap:8px;
    }
    .row-spirit strong{text-align:left;padding-right:0;margin-bottom:4px;}
    .row-spirit input{width:100%;}

    input[type="number"],select,input[type="text"]{width:100% !important;box-sizing:border-box;height:40px;}

    .toolbar{gap:8px;}
    .toolbar .btn{font-size:12px;padding:8px 10px;}

    .acc-list{max-height:180px;font-size:13px;}

    fieldset{padding:14px;border-radius:var(--radius-sm);}
    legend{font-size:14px;}

    .sheet{
      min-width:unset;
      width:100%;
      padding:12px;
      overflow-x:auto;
    }
    .sheet .name{font-size:16px;}

    .grid{
      grid-template-columns:80px repeat(3, 1fr);
      font-size:11px;
      min-width:320px;
    }
    .cell{padding:6px 5px;font-size:11px;}
    .cell.h{font-size:10px;padding:5px 4px;}
    .cell.big{font-size:16px;}
    .cell.sum{font-size:12px;}
    .cell.section{grid-column:1/5 !important;}

    .results-row{flex-direction:column;gap:14px;}

    #pendant_auto_row{flex-direction:column;align-items:flex-start;}
    #pendant_stats_row{flex-direction:column;align-items:flex-start;}
    #pendant_manual{flex-direction:column;align-items:flex-start;gap:8px;}

    pre.result{font-size:12px;padding:12px;min-height:150px;overflow-x:auto;}
  }

  /* 모바일에서 세로로 쌓기 */
  @media (max-width: 768px) {
    #viewSlotContent div[style*="grid-template-columns:1fr 1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }

  /* ===== 3단 레이아웃 ===== */
  .calc-layout {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    align-items: start;
  }
  .calc-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  @media (max-width: 1024px) {
    .calc-layout {
      grid-template-columns: 1fr;
    }
  }

  /* 드래곤 카드 스타일 */
  .dragon-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }
  .dragon-card .info {
    flex: 1;
    font-size: 14px;
  }
  .dragon-card .info strong {
    color: var(--accent);
    font-size: 15px;
  }
  .dragon-card .btn-remove {
    background: #ff6b6b;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
  }
  .dragon-card .btn-remove:hover {
    background: #ee5a5a;
  }

  /* 드래곤 리스트 */
  .dragon-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    padding: 8px 0;
  }

  /* 드래곤별 설정 탭 */
  .dragon-tabs {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 8px;
  }
  .dragon-tab {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
  }
  .dragon-tab:hover {
    background: #f3f4f6;
  }
  .dragon-tab.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }

  /* 드래곤별 설정 패널 */
  .dragon-settings-panel {
    display: none;
  }
  .dragon-settings-panel.active {
    display: block;
  }
</style>
</head>

<body>
  <div class="header-fixed">
    <h2>드래곤 비벨/이벨 통합 계산기</h2>
    <div class="modebar">
      <button class="tab-btn active" id="btnAuto">자동 계산기</button>
      <button class="tab-btn" id="btnResult">예측기 결과</button>
      <button class="tab-btn" id="btnManual">수동 계산기</button>
      <button class="tab-btn" id="btnServer">저장 서버</button>
    </div>
    <div class="hint small">모든 입력은 <b>HP / ATK / DEF</b> 순서입니다. · made by 헬릭스</div>
  </div>

  <div id="autoCalc" class="calc-container active">
    <div class="calc-layout">
      <!-- ===== 왼쪽 컬럼: 드래곤 추가, 젬, 장신구 ===== -->
      <div class="calc-column">
        <!-- 드래곤 추가 패널 -->
        <fieldset>
          <legend>드래곤 추가 (최대 9마리)</legend>
          <div class="row">
            <label>등급
              <select id="add_dragon_grade">
                <option value="7.0">7.0</option>
                <option value="8.0">8.0</option>
                <option value="9.0" selected>9.0</option>
              </select>
            </label>
            <label>타입
              <select id="add_dragon_type">
                <option value="공격형">공격형</option>
                <option value="방어형">방어형</option>
                <option value="체력형">체력형</option>
                <option value="공방형">공방형</option>
                <option value="체공형">체공형</option>
                <option value="체방형">체방형</option>
              </select>
            </label>
            <button class="btn primary" type="button" onclick="addDragon()">드래곤 추가</button>
          </div>
          <div id="dragonListDisplay" class="dragon-list">
            <p style="color:#999;text-align:center;padding:20px 0;">드래곤을 추가해주세요</p>
          </div>
        </fieldset>

        <!-- 젬 선택 (공통) -->
        <fieldset>
          <legend>젬 선택 (공통)</legend>
          <div class="row">
            <strong>HP</strong>
            <label><input type="radio" name="gem_hp" value="160">160</label>
            <label><input type="radio" name="gem_hp" value="156" checked>156</label>
            <label><input type="radio" name="gem_hp" value="152">152</label>
            <label><input type="radio" name="gem_hp" value="148">148</label>
          </div>
          <div class="row">
            <strong>ATK</strong>
            <label><input type="radio" name="gem_atk" value="40">40</label>
            <label><input type="radio" name="gem_atk" value="39" checked>39</label>
            <label><input type="radio" name="gem_atk" value="38">38</label>
            <label><input type="radio" name="gem_atk" value="37">37</label>
          </div>
          <div class="row">
            <strong>DEF</strong>
            <label><input type="radio" name="gem_df" value="40">40</label>
            <label><input type="radio" name="gem_df" value="39" checked>39</label>
            <label><input type="radio" name="gem_df" value="38">38</label>
            <label><input type="radio" name="gem_df" value="37">37</label>
          </div>
        </fieldset>

        <!-- 장신구 선택 -->
        <fieldset>
          <legend>장신구 선택 (복수 선택 가능)</legend>
          <div class="toolbar">
            <button class="btn" type="button" id="btnToggleFavorites" onclick="toggleFavoritesFilter()">즐겨찾기만 보기</button>
            <button class="btn" type="button" onclick="toggleLevel(20)">Lv20</button>
            <button class="btn" type="button" onclick="toggleLevel(19)">Lv19</button>
            <button class="btn" type="button" onclick="toggleLevel(18)">Lv18</button>
            <button class="btn" type="button" onclick="toggleLevel(17)">Lv17</button>
            <button class="btn" type="button" onclick="selectNone()">전체 해제</button>
          </div>
          <div id="accList" class="acc-list"></div>
        </fieldset>
      </div>

      <!-- ===== 가운데 컬럼: 펜던트, 정령/버프/디버프 ===== -->
      <div class="calc-column">
        <!-- 펜던트 -->
        <fieldset>
          <legend>펜던트</legend>
          <div class="row" style="margin-bottom:8px;">
            <strong>버전 선택:</strong>
            <label><input type="radio" name="pendant_ver" value="v1" checked>Ver1 (자동)</label>
            <label><input type="radio" name="pendant_ver" value="v2">Ver2 (지정)</label>
            <label><input type="radio" name="pendant_ver" value="v3">Ver3 (수동)</label>
          </div>
          <div class="row" id="pendant_auto_row">
            <strong>종류 / 값:</strong>
            <label><input type="radio" name="pendant_mode" value="별">별</label>
            <label><input type="radio" name="pendant_mode" value="달" checked>달</label>
            <label><input type="radio" name="pendant_mode" value="태양">태양</label>
            <input id="pendant_value" type="number" value="12" style="width:70px;"> %
          </div>
          <div class="row" id="pendant_stats_row" style="margin-top:8px; display:none;">
            <strong>스탯:</strong>
            <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
            <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
            <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
          </div>
          <div id="pendant_manual" style="margin-top:8px; display:none; align-items:center; gap:4px;">
            <strong>수동 입력:</strong>
            HP <input id="pend_manual_hp" type="number" value="0" style="width:55px;">%
            ATK <input id="pend_manual_atk" type="number" value="0" style="width:55px;">%
            DEF <input id="pend_manual_df" type="number" value="0" style="width:55px;">%
          </div>
          <div class="small" style="margin-top:6px;">별 ≤ 6, 달 ≤ 12, 태양 ≤ 18</div>
        </fieldset>

        <!-- 드래곤별 정령/버프/디버프 -->
        <fieldset>
          <legend>정령 / 버프 / 디버프 (드래곤별)
            <button class="btn" type="button" onclick="resetAllDragonSpiritBuffs()" style="margin-left:8px;font-size:12px;padding:4px 10px;">전체 초기화</button>
          </legend>
          <div id="dragonSpiritBuffContainer">
            <p style="color:#999;text-align:center;padding:20px 0;">드래곤을 먼저 추가해주세요</p>
          </div>
        </fieldset>

        <!-- 수동계산기에 적용 버튼 -->
        <fieldset>
          <legend>수동계산기에 적용</legend>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" type="button" onclick="copyToManualFromAppState(1)">드래곤1</button>
            <button class="btn" type="button" onclick="copyToManualFromAppState(2)">드래곤2</button>
            <button class="btn" type="button" onclick="copyToManualFromAppState(3)">드래곤3</button>
          </div>
        </fieldset>
      </div>

      <!-- ===== 오른쪽 컬럼: TopN, 계산 버튼, 결과 ===== -->
      <div class="calc-column">
        <!-- 기타 설정 -->
        <fieldset>
          <legend>기타 설정</legend>
          <div class="row">Top N <input id="top_n" type="number" value="5" style="width:80px"></div>
          <div class="row" style="margin-top:10px;">
            <strong>장신구 모드:</strong>
          </div>
          <div class="row">
            <label><input type="radio" name="acc_mode" value="share" checked>공유 (모든 드래곤 동일 적용)</label>
          </div>
          <div class="row">
            <label><input type="radio" name="acc_mode" value="distribute">비공유 (드래곤별 최적 배분)</label>
          </div>
          <div class="small" style="margin-top:4px;color:#666;">
            비공유 모드: 장신구를 드래곤들에게 분배하여 최적 조합 계산
          </div>
        </fieldset>

        <!-- 계산 버튼 -->
        <div class="toolbar" style="flex-direction:column;">
          <button class="btn primary" type="button" onclick="calcAuto()" style="width:100%;">계산하기</button>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn" type="button" onclick="downloadTxt()">저장 (.txt)</button>
            <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff9800;color:#fff;border-color:#ff9800;">결과 초기화</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">즐겨찾기 초기화</button>
          </div>
        </div>

        <!-- 결과 -->
        <fieldset>
          <legend>계산 결과</legend>
          <pre id="autoResult" class="result"></pre>
        </fieldset>
      </div>
    </div>
  </div>

  <div id="resultCalc" class="calc-container">
    <h3 style="margin:0 0 16px">예측기 결과 (누적)</h3>

    <div class="toolbar" style="margin-bottom:16px">
      <button class="btn" type="button" onclick="downloadAllResults()">전체 저장 (.txt)</button>
      <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">전체 삭제</button>
    </div>

    <pre id="resultStorage" class="result" style="min-height:400px"></pre>
  </div>

  <div id="manualCalc" class="calc-container">
    <h3 style="margin:0 0 16px">수동 계산기 (최대 9마리 비교)</h3>

    <div class="calc-layout">
      <!-- ===== 왼쪽 컬럼: 드래곤 추가 및 탭 ===== -->
      <div class="calc-column" style="grid-column: 1 / 3;">
        <!-- 드래곤 추가 패널 -->
        <fieldset>
          <legend>드래곤 추가 (수동계산기)</legend>
          <div class="row">
            <label>등급
              <select id="add_manual_dragon_grade">
                <option value="7.0">7.0</option>
                <option value="8.0">8.0</option>
                <option value="9.0" selected>9.0</option>
              </select>
            </label>
            <label>타입
              <select id="add_manual_dragon_type">
                <option value="공격형">공격형</option>
                <option value="방어형">방어형</option>
                <option value="체력형">체력형</option>
                <option value="공방형">공방형</option>
                <option value="체공형">체공형</option>
                <option value="체방형">체방형</option>
              </select>
            </label>
            <button class="btn primary" type="button" onclick="addManualDragon()">드래곤 추가</button>
            <span class="small" id="manualDragonCount">(현재: 3마리)</span>
          </div>
        </fieldset>

        <!-- 드래곤 탭 -->
        <fieldset>
          <legend>드래곤 설정</legend>
          <div id="manualDragonTabs" class="dragon-tabs"></div>
          <div id="inputsWrap"></div>
        </fieldset>
      </div>

      <!-- ===== 오른쪽 컬럼: 계산버튼 ===== -->
      <div class="calc-column">
        <fieldset>
          <legend>계산 및 저장</legend>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn primary" onclick="manualCalcAll()" style="width:100%;">수동 계산</button>
            <button class="btn" onclick="savePngAll()" style="width:100%;">결과를 PNG로 저장</button>
            <button class="btn" onclick="saveToServer()" style="background:#00aa88;color:#fff;border-color:#00aa88;width:100%;">서버에 저장</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;width:100%;">즐겨찾기 초기화</button>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- 결과 시트 (가로 비교) -->
    <div class="results-wrap" style="margin-top:20px;">
      <div id="allResults" class="results-row"></div>
    </div>
  </div>

  <div id="serverCalc" class="calc-container">
    <h3 style="margin:0 0 16px">저장 서버</h3>

    <!-- 저장 슬롯 만들기 -->
    <fieldset>
      <legend>저장 슬롯 만들기</legend>
      <div class="row">
        <label>슬롯 이름
          <input id="newSlotName" type="text" placeholder="" style="width:200px">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="slotType" value="public" checked>공유 (누구나 접근 가능)</label>
        <label><input type="radio" name="slotType" value="private">잠금 (비밀번호 필요)</label>
      </div>
      <div class="row" id="slotPasswordRow" style="margin-top:8px;display:none">
        <label>비밀번호
          <input id="slotPassword" type="password" placeholder="비밀번호 입력" style="width:150px">
        </label>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="createSlot()">슬롯 만들기</button>
      </div>
    </fieldset>

    <!-- 저장된 슬롯 목록 -->
    <fieldset>
      <legend>저장된 슬롯 목록</legend>
      <div id="slotList" style="min-height:200px">
        <p style="color:#999;text-align:center;padding:40px 0">슬롯을 생성하거나 불러오는 중...</p>
      </div>
    </fieldset>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB90WAYMh6G8aWS3gzKw2wmT9X3O0zGoGw",
      authDomain: "dragon-calculator-8733b.firebaseapp.com",
      databaseURL: "https://dragon-calculator-8733b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dragon-calculator-8733b",
      storageBucket: "dragon-calculator-8733b.firebasestorage.app",
      messagingSenderId: "707550978178",
      appId: "1:707550978178:web:09607e55f05337c154949b"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // 전역으로 노출
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
  </script>

  <script>
  // ===== 데이터 구조 정의 =====
  class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}

  // ===== 새로운 상태 관리 구조 =====
  class DragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;      // "7.0" | "8.0" | "9.0"
      this.type = type;        // "공격형" | "방어형" | etc.
      this.accessoryId = null;
      this.pendant = { hp: 0, atk: 0, df: 0 };
      this.spirit = {
        flat: { hp: 0, atk: 0, df: 0 },
        pct: { hp: 0, atk: 0, df: 0 },
        extra: { hp: 0, atk: 0, df: 0 }
      };
      this.buff = { hp: 0, atk: 0, df: 0 };
      this.debuff = { hp: 0, atk: 0, df: 0 };
    }
  }

  const AppState = {
    dragons: [],
    maxDragons: 9,
    gems: { hp: 156, atk: 39, df: 39 },
    accessoryAllocation: new Map(),
    nextDragonId: 1
  };

  // ===== 드래곤 추가/제거 함수 =====
  function addDragon() {
    if (AppState.dragons.length >= AppState.maxDragons) {
      alert(`최대 ${AppState.maxDragons}마리까지만 추가할 수 있습니다.`);
      return;
    }

    const gradeSelect = document.getElementById('add_dragon_grade');
    const typeSelect = document.getElementById('add_dragon_type');
    const grade = gradeSelect ? gradeSelect.value : '9.0';
    const type = typeSelect ? typeSelect.value : '공격형';

    const newDragon = new DragonConfig(AppState.nextDragonId++, grade, type);
    newDragon.displayNumber = AppState.dragons.length + 1;
    AppState.dragons.push(newDragon);

    renderDragonList();
    renderSpiritBuffSections();
  }

  function removeDragon(dragonId) {
    const index = AppState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    const dragon = AppState.dragons[index];

    // 장신구 해제
    if (dragon.accessoryId) {
      AppState.accessoryAllocation.delete(dragon.accessoryId);
    }

    // 드래곤 제거
    AppState.dragons.splice(index, 1);

    // 리넘버링
    AppState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });

    renderDragonList();
    renderSpiritBuffSections();
  }

  function renderDragonList() {
    const container = document.getElementById('dragonListDisplay');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">드래곤을 추가해주세요</p>';
      return;
    }

    container.innerHTML = AppState.dragons.map(d => `
      <div class="dragon-card">
        <div class="info">
          <strong>드래곤 ${d.displayNumber}</strong>
          <span style="margin-left:8px;color:#666;">${d.grade} / ${d.type}</span>
        </div>
        <button class="btn-remove" onclick="removeDragon(${d.id})">삭제</button>
      </div>
    `).join('');
  }

  function renderSpiritBuffSections() {
    const container = document.getElementById('dragonSpiritBuffContainer');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">드래곤을 먼저 추가해주세요</p>';
      return;
    }

    // 탭 생성
    const tabsHtml = AppState.dragons.map((d, i) => `
      <button class="dragon-tab ${i === 0 ? 'active' : ''}" onclick="switchDragonTab(${d.id})" data-dragon-id="${d.id}">
        드래곤 ${d.displayNumber}
      </button>
    `).join('');

    // 정령 슬롯 옵션 생성 함수
    const slotStatOptions = `
      <option value="none">-</option>
      <option value="hp">HP</option>
      <option value="atk">ATK</option>
      <option value="df">DEF</option>
    `;
    const slotTypeOptions = `
      <option value="flat">+</option>
      <option value="pct">%</option>
    `;
    const subOptions = SPIRIT_SUB_OPTIONS.map((opt, i) => `<option value="${i}">${opt.label}</option>`).join('');

    // 각 드래곤별 설정 패널
    const panelsHtml = AppState.dragons.map((d, i) => `
      <div class="dragon-settings-panel ${i === 0 ? 'active' : ''}" id="dragonPanel_${d.id}">
        <div style="background:#e3f2fd;padding:8px 12px;border-radius:6px;margin-bottom:12px;">
          <strong style="color:#1565c0;">드래곤 ${d.displayNumber}</strong>
          <span style="margin-left:8px;color:#666;">(${d.grade} / ${d.type})</span>
        </div>

        <!-- 입력 모드 선택 -->
        <div class="row" style="margin-bottom:10px;">
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="slot" checked onchange="toggleSpiritInputMode(${d.id})">슬롯 선택</label>
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="manual" onchange="toggleSpiritInputMode(${d.id})">직접 입력</label>
        </div>

        <!-- 슬롯 선택 모드 -->
        <div id="dragon_${d.id}_slot_mode">
          <div style="font-size:13px;margin-bottom:8px;color:#666;">정령 슬롯 1~4 선택:</div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>슬롯 1</strong>
            <select id="dragon_${d.id}_slot1_stat" onchange="calculateSpiritFromSlots(${d.id})">${slotStatOptions}</select>
            <select id="dragon_${d.id}_slot1_type" onchange="calculateSpiritFromSlots(${d.id})">${slotTypeOptions}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>슬롯 2</strong>
            <select id="dragon_${d.id}_slot2_stat" onchange="calculateSpiritFromSlots(${d.id})">${slotStatOptions}</select>
            <select id="dragon_${d.id}_slot2_type" onchange="calculateSpiritFromSlots(${d.id})">${slotTypeOptions}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>슬롯 3</strong>
            <select id="dragon_${d.id}_slot3_stat" onchange="calculateSpiritFromSlots(${d.id})">${slotStatOptions}</select>
            <select id="dragon_${d.id}_slot3_type" onchange="calculateSpiritFromSlots(${d.id})">${slotTypeOptions}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:8px;">
            <strong>슬롯 4</strong>
            <select id="dragon_${d.id}_slot4_stat" onchange="calculateSpiritFromSlots(${d.id})">${slotStatOptions}</select>
            <select id="dragon_${d.id}_slot4_type" onchange="calculateSpiritFromSlots(${d.id})">${slotTypeOptions}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 140px;gap:6px;align-items:center;margin-bottom:8px;">
            <strong>부가옵</strong>
            <select id="dragon_${d.id}_sub" onchange="calculateSpiritFromSlots(${d.id})">${subOptions}</select>
          </div>
          <div id="dragon_${d.id}_spirit_summary"></div>
        </div>

        <!-- 직접 입력 모드 -->
        <div id="dragon_${d.id}_manual_mode" style="display:none;">
          <div style="font-weight:bold;color:black;margin-bottom:6px;">(HP / ATK / DEF)</div>
          <div class="row-spirit"><strong>정령 + (플옵)</strong>
            <input id="dragon_${d.id}_sf_hp" type="number" value="${d.spirit.flat.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_atk" type="number" value="${d.spirit.flat.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_df" type="number" value="${d.spirit.flat.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
          <div class="row-spirit"><strong>정령 % (퍼옵)</strong>
            <input id="dragon_${d.id}_sp_hp" type="number" value="${d.spirit.pct.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_atk" type="number" value="${d.spirit.pct.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_df" type="number" value="${d.spirit.pct.df}" onchange="updateDragonSpirit(${d.id})">
            <span class="small">(% 입력)</span>
          </div>
          <div class="row-spirit"><strong>정령 옵</strong>
            <input id="dragon_${d.id}_se_hp" type="number" value="${d.spirit.extra.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_atk" type="number" value="${d.spirit.extra.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_df" type="number" value="${d.spirit.extra.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
        </div>

        <!-- 버프/디버프 (공통) -->
        <div style="border-top:1px solid #ddd;margin-top:12px;padding-top:12px;">
          <div style="font-weight:bold;color:black;margin-bottom:6px;">버프 / 디버프 (%)</div>
          <div class="row-spirit"><strong>버프 (%)</strong>
            <input id="dragon_${d.id}_bf_hp" type="number" value="${d.buff.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_bf_atk" type="number" value="${d.buff.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_bf_df" type="number" value="${d.buff.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
          <div class="row-spirit"><strong>디버프 (%)</strong>
            <input id="dragon_${d.id}_db_hp" type="number" value="${d.debuff.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_db_atk" type="number" value="${d.debuff.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_db_df" type="number" value="${d.debuff.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
        </div>
      </div>
    `).join('');

    container.innerHTML = `
      <div class="dragon-tabs">${tabsHtml}</div>
      ${panelsHtml}
    `;
  }

  function toggleSpiritInputMode(dragonId) {
    const mode = document.querySelector(`input[name="dragon_${dragonId}_input_mode"]:checked`)?.value;
    const slotMode = document.getElementById(`dragon_${dragonId}_slot_mode`);
    const manualMode = document.getElementById(`dragon_${dragonId}_manual_mode`);

    if (mode === 'slot') {
      slotMode.style.display = 'block';
      manualMode.style.display = 'none';
    } else {
      slotMode.style.display = 'none';
      manualMode.style.display = 'block';
    }
  }

  function switchDragonTab(dragonId) {
    // 모든 탭 비활성화
    document.querySelectorAll('.dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // 선택된 탭 활성화
    document.querySelector(`.dragon-tab[data-dragon-id="${dragonId}"]`)?.classList.add('active');
    document.getElementById(`dragonPanel_${dragonId}`)?.classList.add('active');
  }

  function updateDragonSpirit(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    dragon.spirit.flat.hp = Number(document.getElementById(`dragon_${dragonId}_sf_hp`)?.value || 0);
    dragon.spirit.flat.atk = Number(document.getElementById(`dragon_${dragonId}_sf_atk`)?.value || 0);
    dragon.spirit.flat.df = Number(document.getElementById(`dragon_${dragonId}_sf_df`)?.value || 0);
    dragon.spirit.pct.hp = Number(document.getElementById(`dragon_${dragonId}_sp_hp`)?.value || 0);
    dragon.spirit.pct.atk = Number(document.getElementById(`dragon_${dragonId}_sp_atk`)?.value || 0);
    dragon.spirit.pct.df = Number(document.getElementById(`dragon_${dragonId}_sp_df`)?.value || 0);
    dragon.spirit.extra.hp = Number(document.getElementById(`dragon_${dragonId}_se_hp`)?.value || 0);
    dragon.spirit.extra.atk = Number(document.getElementById(`dragon_${dragonId}_se_atk`)?.value || 0);
    dragon.spirit.extra.df = Number(document.getElementById(`dragon_${dragonId}_se_df`)?.value || 0);
    dragon.buff.hp = Number(document.getElementById(`dragon_${dragonId}_bf_hp`)?.value || 0);
    dragon.buff.atk = Number(document.getElementById(`dragon_${dragonId}_bf_atk`)?.value || 0);
    dragon.buff.df = Number(document.getElementById(`dragon_${dragonId}_bf_df`)?.value || 0);
    dragon.debuff.hp = Number(document.getElementById(`dragon_${dragonId}_db_hp`)?.value || 0);
    dragon.debuff.atk = Number(document.getElementById(`dragon_${dragonId}_db_atk`)?.value || 0);
    dragon.debuff.df = Number(document.getElementById(`dragon_${dragonId}_db_df`)?.value || 0);
  }

  // ===== 정령 슬롯별 수치 테이블 =====
  const SPIRIT_FLAT_TBL = {
    1: { hp: 216, atk: 54, df: 54 },
    2: { hp: 240, atk: 60, df: 60 },
    3: { hp: 264, atk: 66, df: 66 },
    4: { hp: 480, atk: 120, df: 120 }
  };
  const SPIRIT_PCT_TBL = {
    1: { hp: 24, atk: 24, df: 24 },
    2: { hp: 28, atk: 28, df: 28 },
    3: { hp: 32, atk: 32, df: 32 },
    4: { hp: 40, atk: 40, df: 40 }
  };
  const SPIRIT_SUB_OPTIONS = [
    { label: '없음', hp: 0, atk: 0, df: 0 },
    { label: '체력40', hp: 40, atk: 0, df: 0 },
    { label: '공격력10', hp: 0, atk: 10, df: 0 },
    { label: '방어력10', hp: 0, atk: 0, df: 10 }
  ];

  // 정령 슬롯 선택에서 값 계산
  function calculateSpiritFromSlots(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    let flatTotal = { hp: 0, atk: 0, df: 0 };
    let pctTotal = { hp: 0, atk: 0, df: 0 };
    let extraTotal = { hp: 0, atk: 0, df: 0 };

    // 슬롯 1~4 계산
    for (let slot = 1; slot <= 4; slot++) {
      const statEl = document.getElementById(`dragon_${dragonId}_slot${slot}_stat`);
      const typeEl = document.getElementById(`dragon_${dragonId}_slot${slot}_type`);
      if (!statEl || !typeEl) continue;

      const stat = statEl.value; // hp, atk, df
      const type = typeEl.value; // flat, pct

      if (stat && stat !== 'none') {
        if (type === 'flat') {
          flatTotal[stat] += SPIRIT_FLAT_TBL[slot][stat];
        } else if (type === 'pct') {
          pctTotal[stat] += SPIRIT_PCT_TBL[slot][stat];
        }
      }
    }

    // 부가옵 계산
    const subEl = document.getElementById(`dragon_${dragonId}_sub`);
    if (subEl) {
      const subIdx = parseInt(subEl.value) || 0;
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      extraTotal.hp = sub.hp;
      extraTotal.atk = sub.atk;
      extraTotal.df = sub.df;
    }

    // DragonConfig 업데이트
    dragon.spirit.flat = flatTotal;
    dragon.spirit.pct = pctTotal;
    dragon.spirit.extra = extraTotal;

    // 합계 표시 업데이트
    updateSpiritSummary(dragonId, flatTotal, pctTotal, extraTotal);
  }

  function updateSpiritSummary(dragonId, flat, pct, extra) {
    const summaryEl = document.getElementById(`dragon_${dragonId}_spirit_summary`);
    if (summaryEl) {
      summaryEl.innerHTML = `
        <div style="background:#e8f5e9;padding:8px;border-radius:4px;font-size:12px;">
          <strong>계산된 정령 값:</strong><br>
          플옵: HP+${flat.hp} ATK+${flat.atk} DEF+${flat.df}<br>
          퍼옵: HP+${pct.hp}% ATK+${pct.atk}% DEF+${pct.df}%<br>
          부가옵: HP+${extra.hp} ATK+${extra.atk} DEF+${extra.df}
        </div>
      `;
    }
  }

  // ===== 장신구 중복 방지 =====
  function allocateAccessory(dragonId, accId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return false;

    // 이전 장착 해제
    if (dragon.accessoryId) {
      AppState.accessoryAllocation.delete(dragon.accessoryId);
    }

    // 빈 값이면 해제만
    if (!accId || accId === '') {
      dragon.accessoryId = null;
      return true;
    }

    // 중복 체크
    if (AppState.accessoryAllocation.has(accId)) {
      const allocatedDragonId = AppState.accessoryAllocation.get(accId);
      if (allocatedDragonId !== dragonId) {
        const allocatedDragon = AppState.dragons.find(d => d.id === allocatedDragonId);
        alert(`드래곤 ${allocatedDragon?.displayNumber || '?'}에 이미 장착됨`);
        return false;
      }
    }

    // 할당
    AppState.accessoryAllocation.set(accId, dragonId);
    dragon.accessoryId = accId;
    return true;
  }

  // 드래곤 기본 스탯 (등급별/타입별)
  const dragon={
   "7.0":{공격형:new Stats(876,285,161),방어형:new Stats(788,185,283),체력형:new Stats(1252,176,176),공방형:new Stats(720,242,243),체공형:new Stats(1080,262,133),체방형:new Stats(1080,133,262)},
   "8.0":{공격형:new Stats(876,305,161),방어형:new Stats(788,185,303),체력형:new Stats(1332,176,176),공방형:new Stats(720,252,253),체공형:new Stats(1120,272,133),체방형:new Stats(1120,133,272)},
   "9.0":{공격형:new Stats(876,325,161),방어형:new Stats(788,185,323),체력형:new Stats(1412,176,176),공방형:new Stats(720,262,263),체공형:new Stats(1160,282,133),체방형:new Stats(1160,133,282)}
  };

  // ===== 핵심 계산 함수 =====
  function eVal(s){return s.hp+4*s.atk+4*s.df;}
  function bVal(s){return s.hp*s.atk*s.df;}

  // 최종 스탯 계산 (모든 보너스 적용)
  function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
    const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
    const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
    const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                       Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                       Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
    const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
    const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
    const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
    const f = new Stats(
      s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
      s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
      s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
    );
    return [f, eVal(f), bVal(f)];
  }

  // ===== 유틸리티 함수 =====
  // 입력값 가져오기
  function val(id){ return Number(document.getElementById(id)?.value||0); }

  // 정령/버프/디버프 초기화 (기존 호환성)
  function resetSpiritBuffs(){
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value=0;
    });
  }

  // 모든 드래곤의 정령/버프/디버프 초기화
  function resetAllDragonSpiritBuffs() {
    AppState.dragons.forEach(dragon => {
      dragon.spirit.flat = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.pct = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.extra = { hp: 0, atk: 0, df: 0 };
      dragon.buff = { hp: 0, atk: 0, df: 0 };
      dragon.debuff = { hp: 0, atk: 0, df: 0 };
    });
    renderSpiritBuffSections();
  }

  // AppState에서 수동계산기로 복사
  function copyToManualFromAppState(manualIdx) {
    if (AppState.dragons.length < manualIdx) {
      alert(`드래곤 ${manualIdx}이(가) 추가되지 않았습니다.`);
      return;
    }

    const dragon = AppState.dragons[manualIdx - 1];
    if (!dragon) return;

    // 정령/버프/디버프 값 복사
    const setValue = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value;
    };

    setValue(`d${manualIdx}_sf_hp`, dragon.spirit.flat.hp);
    setValue(`d${manualIdx}_sf_atk`, dragon.spirit.flat.atk);
    setValue(`d${manualIdx}_sf_df`, dragon.spirit.flat.df);
    setValue(`d${manualIdx}_sp_hp`, dragon.spirit.pct.hp);
    setValue(`d${manualIdx}_sp_atk`, dragon.spirit.pct.atk);
    setValue(`d${manualIdx}_sp_df`, dragon.spirit.pct.df);
    setValue(`d${manualIdx}_se_hp`, dragon.spirit.extra.hp);
    setValue(`d${manualIdx}_se_atk`, dragon.spirit.extra.atk);
    setValue(`d${manualIdx}_se_df`, dragon.spirit.extra.df);
    setValue(`d${manualIdx}_bf_hp`, dragon.buff.hp);
    setValue(`d${manualIdx}_bf_atk`, dragon.buff.atk);
    setValue(`d${manualIdx}_bf_df`, dragon.buff.df);
    setValue(`d${manualIdx}_db_hp`, dragon.debuff.hp);
    setValue(`d${manualIdx}_db_atk`, dragon.debuff.atk);
    setValue(`d${manualIdx}_db_df`, dragon.debuff.df);

    // 등급/타입도 복사
    setValue(`d${manualIdx}_m_level`, dragon.grade);
    setValue(`d${manualIdx}_m_type`, dragon.type);

    alert(`드래곤 ${manualIdx}에 정령/버프/디버프 값이 적용되었습니다.`);
  }

  function copyToManualDragon(dragonIdx){
    // 기존 호환성 - 자동계산기의 정령/버프/디버프 값을 수동계산기로 복사
    ['sf_hp','sf_atk','sf_df','sp_hp','sp_atk','sp_df','se_hp','se_atk','se_df','bf_hp','bf_atk','bf_df','db_hp','db_atk','db_df'].forEach(field => {
      const value = val(field);
      const el = document.getElementById(`d${dragonIdx}_${field}`);
      if(el) el.value = value;
    });
    alert(`드래곤 ${dragonIdx}에 정령/버프/디버프 값이 적용되었습니다.`);
  }

  // ===== 장신구 즐겨찾기 관리 =====
  function resetFavorites() {
    const confirmed = confirm(
      '장신구 즐겨찾기를 초기화하시겠습니까?\n\n' +
      '※ 이 작업은 되돌릴 수 없습니다.'
    );

    if (confirmed) {
      try {
        localStorage.removeItem('accFavorites');
        alert('즐겨찾기가 초기화되었습니다.\n페이지를 새로고침합니다.');
        location.reload();
      } catch (e) {
        console.error('즐겨찾기 초기화 실패:', e);
        alert('초기화 중 오류가 발생했습니다.');
      }
    }
  }

  // ===== 장신구 데이터 테이블 =====
  // 형식: [이름, 레벨, HP%, ATK%, DEF%]
  const ACC_TABLE = [ ["악보(체)",20,20,0,0], ["여보(방)",20,0,0,20], ["황보(공)",20,0,20,0], ["바뿔(공/방)",20,0,10,10], ["바뿔(체/방)",20,10,0,10], ["바뿔(체/공)",20,10,10,0],
    ["바뿔(공/방)",19,0,10,9],["바뿔(체/방)",19,10,0,9],["바뿔(공/체)",19,9,10,0],
    ["불뿔(공/체)",19,6,13,0],["불뿔(공/방)",19,0,13,6],
    ["물뿔(체/방)",19,13,0,6],["물뿔(체/공)",19,13,6,0],
    ["대뿔(방/공)",19,0,6,13],["대뿔(방/체)",19,6,0,13],
    ["여보",19,0,0,19],["황보",19,0,19,0],["악보",19,19,0,0],
    ["바뿔(공/방)",18,0,9,9],["바뿔(체/방)",18,9,0,9],["바뿔(공/체)",18,9,9,0],
    ["불뿔(공/체)",18,6,12,0],["불뿔(공/방)",18,0,12,6],
    ["물뿔(체/방)",18,12,0,6],["물뿔(체/공)",18,12,6,0],
    ["대뿔(방/공)",18,0,6,12],["대뿔(방/체)",18,6,0,12],
    ["여보",18,0,0,18],["황보",18,0,18,0],["악보",18,18,0,0],
    ["바뿔(공/방)",17,0,9,8],["바뿔(체/방)",17,9,0,8],["바뿔(공/체)",17,9,8,0],
    ["불뿔(공/체)",17,6,11,0],["불뿔(공/방)",17,0,11,6],
    ["물뿔(체/방)",17,11,0,6],["물뿔(체/공)",17,11,6,0],
    ["대뿔(방/공)",17,0,6,11],["대뿔(방/체)",17,6,0,11],
    ["여보",17,0,0,17],["황보",17,0,17,0],["악보",17,17,0,0],
  ];

  // 전역 변수
  let accCheckboxes = [];
  let accFavorites = new Set();
  let showOnlyFavorites = false;

  // 즐겨찾기 불러오기
  function loadFavorites() {
    try {
      const saved = localStorage.getItem('accFavorites');
      if (saved) {
        accFavorites = new Set(JSON.parse(saved));
      }
    } catch (e) {
      console.error('즐겨찾기 불러오기 실패:', e);
    }
  }

  // 즐겨찾기 저장
  function saveFavorites() {
    try {
      localStorage.setItem('accFavorites', JSON.stringify([...accFavorites]));
    } catch (e) {
      console.error('즐겨찾기 저장 실패:', e);
    }
  }

  // 즐겨찾기 토글
  function toggleFavorite(accId) {
    if (accFavorites.has(accId)) {
      accFavorites.delete(accId);
    } else {
      accFavorites.add(accId);
    }
    saveFavorites();
    renderAccessories();
  }

  function renderAccessories() {
    const accListEl = document.getElementById('accList');
    accListEl.innerHTML = '';
    accCheckboxes = [];

    // 즐겨찾기 정렬: 즐겨찾기가 위로
    const sortedTable = [...ACC_TABLE].map((r, i) => ({ data: r, index: i }))
      .sort((a, b) => {
        const aFav = accFavorites.has('acc_' + a.index);
        const bFav = accFavorites.has('acc_' + b.index);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return 0;
      });

    sortedTable.forEach(({ data: r, index: i }) => {
      const [n, l, h, a, d] = r;
      const id = 'acc_' + i;
      const isFavorite = accFavorites.has(id);

      // 즐겨찾기 필터 적용
      if (showOnlyFavorites && !isFavorite) return;

      const line = document.createElement('div');
      line.style.cssText = 'display:flex;align-items:center;gap:6px;padding:2px 0;';

      const starBtn = document.createElement('button');
      starBtn.textContent = isFavorite ? '⭐' : '☆';
      starBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:2px 6px;';
      starBtn.title = isFavorite ? '즐겨찾기 해제' : '즐겨찾기 추가';
      starBtn.onclick = (e) => {
        e.preventDefault();
        toggleFavorite(id);
      };

      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%`;
      label.style.flex = '1';

      line.appendChild(starBtn);
      line.appendChild(label);
      accListEl.appendChild(line);
      accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d });
    });
  }

  // 즐겨찾기 필터 토글
  function toggleFavoritesFilter() {
    showOnlyFavorites = !showOnlyFavorites;
    const btn = document.getElementById('btnToggleFavorites');
    if (btn) {
      btn.textContent = showOnlyFavorites ? '전체 보기' : '즐겨찾기만 보기';
      btn.classList.toggle('primary', showOnlyFavorites);
    }
    renderAccessories();
  }

  loadFavorites();
  renderAccessories();

  function selectNone(){
    accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
  }

  function toggleLevel(level){
    const filtered = accCheckboxes.filter(o => o.level === level);
    const allChecked = filtered.every(o => document.getElementById(o.id).checked);
    filtered.forEach(o => document.getElementById(o.id).checked = !allChecked);
  }

  document.querySelectorAll('input[name="pendant_ver"]').forEach(r => {
    r.addEventListener('change', () => {
      const ver = document.querySelector('input[name="pendant_ver"]:checked').value;
      document.getElementById("pendant_auto_row").style.display = (ver === "v3") ? "none" : "flex";
      document.getElementById("pendant_stats_row").style.display = (ver === "v2") ? "flex" : "none";
      document.getElementById("pendant_manual").style.display = (ver === "v3") ? "flex" : "none";
    });
  });
  window.addEventListener("DOMContentLoaded", () => {
    // 펜던트 버전 UI 초기화
    document.querySelector('input[name="pendant_ver"]:checked')?.dispatchEvent(new Event('change'));
  });

  // ===== 펜던트 조합 생성 =====
  function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
    const MAX = 6;
    const combos = [];

    if (total <= 0) return [[[0,0,0]]];

    // 선택된 스탯의 인덱스 배열 생성 (HP:0, ATK:1, DEF:2)
    const statIdx = [];
    if (selectedStats.includes("HP"))  statIdx.push(0);
    if (selectedStats.includes("ATK")) statIdx.push(1);
    if (selectedStats.includes("DEF")) statIdx.push(2);

    // 별 펜던트: 1슬롯
    if (mode === "별") {
      const value = Math.min(total, MAX);
      return statIdx.map(i => {
        const slot = [0,0,0];
        slot[i] = value;
        return [slot];
      });
    }

    // 달 펜던트: 2슬롯
    if (mode === "달") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          if (x+y === total)
            for (let i of statIdx)
              for (let j of statIdx) {
                const slot1=[0,0,0], slot2=[0,0,0];
                slot1[i]=x; slot2[j]=y;
                combos.push([slot1, slot2]);
              }
      return combos;
    }

    // 태양 펜던트: 3슬롯
    if (mode === "태양") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          for (let z=1; z<=MAX; z++)
            if (x+y+z === total)
              for (let i of statIdx)
                for (let j of statIdx)
                  for (let k of statIdx) {
                    const slot1=[0,0,0], slot2=[0,0,0], slot3=[0,0,0];
                    slot1[i]=x; slot2[j]=y; slot3[k]=z;
                    combos.push([slot1, slot2, slot3]);
                  }
      return combos;
    }

    return [[[0,0,0]]];
  }

  // ===== 자동 계산기 =====
  function calcAuto(){
    const resultBox = document.getElementById("autoResult");
    resultBox.innerHTML = '<div style="text-align:center;padding:40px;color:#666;"><div style="font-weight:700;margin-bottom:10px;">계산 중입니다...</div><small style="color:#999;">조합이 많을 경우 시간이 걸릴 수 있습니다.</small></div>';

    // UI 업데이트를 위한 짧은 딜레이
    setTimeout(() => {
      calcAutoCore();
    }, 50);
  }

  function calcAutoCore(){
    const resultBox = document.getElementById("autoResult");

    // 1. 드래곤이 추가되었는지 확인
    if (AppState.dragons.length === 0) {
      resultBox.textContent = "드래곤이 추가되지 않았습니다. 먼저 드래곤을 추가해주세요.";
      return;
    }

    // 2. 젬 기본값
    const gemBase = {
      hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 160),
      atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 40),
      df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 40)
    };

    // 3. 장신구 선택 확인
    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id).checked);
    if (!selectedAcc.length) {
      resultBox.textContent = "장신구가 선택되지 않았습니다.";
      return;
    }

    // 4. 펜던트 설정
    const pendantMode = document.querySelector('input[name="pendant_mode"]:checked')?.value || "달";
    const pendantValue = Number(document.getElementById("pendant_value")?.value || 12);
    const pendantVer = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
    const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // 상수 및 기타
    const topN = Number(document.getElementById("top_n").value || 5);
    const ENCHANT = 21;  // 인첸트 % (HP/ATK/DEF 각 방향)
    const pot = new Stats(24, 6, 6);    // 포텐셜 (고정)
    const col = new Stats(240, 60, 60); // 수집 효과 (고정)

    // 5. 펜던트 조합 생성
    let pendantCombinations = [];
    let manualPendantStr = "";

    if (pendantVer === "v3") {
      const ph = Number(document.getElementById("pend_manual_hp")?.value || 0) / 100;
      const pa = Number(document.getElementById("pend_manual_atk")?.value || 0) / 100;
      const pd = Number(document.getElementById("pend_manual_df")?.value || 0) / 100;
      pendantCombinations = [[[ph, pa, pd]]];
      const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
      manualPendantStr = `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`;
    } else {
      const maxValues = {별:6, 달:12, 태양:18};
      const limit = maxValues[pendantMode] || 0;
      if (pendantValue > limit || pendantValue <= 0) {
        resultBox.textContent = "펜던트 값을 다시 확인해주세요.";
        return;
      }
      const stats = (pendantVer === "v2") ? selectedStats : ["HP", "ATK", "DEF"];
      pendantCombinations = genPend(pendantValue, pendantMode, stats);
      if (!pendantCombinations.length) {
        resultBox.textContent = "펜던트 조합 생성 오류";
        return;
      }
    }

    // 6. 장신구 모드 확인
    const accMode = document.querySelector('input[name="acc_mode"]:checked')?.value || 'share';

    // 비공유 모드: 드래곤별 최적 장신구 배분 계산
    if (accMode === 'distribute' && AppState.dragons.length > 1 && selectedAcc.length >= AppState.dragons.length) {
      calcAutoDistributeMode(selectedAcc, gemBase, pendantCombinations, pendantVer, pendantMode, manualPendantStr, topN, pot, col, ENCHANT);
      return;
    }

    // 공유 모드: 드래곤별로 모든 장신구 적용
    const allResults = [];

    AppState.dragons.forEach((dragonConfig) => {
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];

      // 드래곤별 정령/버프/디버프
      const spiritFlat = new Stats(
        dragonConfig.spirit.flat.hp,
        dragonConfig.spirit.flat.atk,
        dragonConfig.spirit.flat.df
      );
      const spiritPct = new Stats(
        dragonConfig.spirit.pct.hp / 100,
        dragonConfig.spirit.pct.atk / 100,
        dragonConfig.spirit.pct.df / 100
      );
      const spiritExtra = new Stats(
        dragonConfig.spirit.extra.hp,
        dragonConfig.spirit.extra.atk,
        dragonConfig.spirit.extra.df
      );
      const buff = new Stats(
        dragonConfig.buff.hp / 100,
        dragonConfig.buff.atk / 100,
        dragonConfig.buff.df / 100
      );
      const debuff = new Stats(
        dragonConfig.debuff.hp / 100,
        dragonConfig.debuff.atk / 100,
        dragonConfig.debuff.df / 100
      );

      const dragonResults = [];

      for (const accessory of selectedAcc) {
        const accPctBase = {
          hp: accessory.hp / 100,
          atk: accessory.atk / 100,
          df: accessory.df / 100
        };

        // 젬 5칸 분배 (HP + ATK + DEF = 5)
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(
              gemBase.hp * hpGems,
              gemBase.atk * atkGems,
              gemBase.df * defGems
            );

            // 인첸트 방향 (HP, ATK, DEF 중 하나)
            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(
                accPctBase.hp + enchantBonus.hp,
                accPctBase.atk + enchantBonus.atk,
                accPctBase.df + enchantBonus.df
              );

              // 펜던트 조합
              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                // 최종 스탯 계산
                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                // 결과 문자열 생성
                const pendantSlotStr = (pendantVer === "v3")
                  ? manualPendantStr
                  : pendant.map(slot =>
                      ["HP","ATK","DEF"]
                        .map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "")
                        .filter(Boolean)
                        .join(" ")
                    ).join(" / ");

                const pendantLabel = (pendantVer === "v3") ? "수동입력" : pendantMode;
                const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                dragonResults.push({
                  B: bValue,
                  dragonNumber: dragonConfig.displayNumber,
                  dragonGrade: dragonConfig.grade,
                  dragonType: dragonConfig.type,
                  accessory: `${accessory.name} Lv${accessory.level}`,
                  gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                  pendant: `${pendantLabel} (${pendantSlotStr})`,
                  enchant: `${enchantLabel} +${ENCHANT}%`,
                  finalStats,
                  eValue
                });
              }
            }
          }
        }
      }

      // 드래곤별 상위 결과 저장
      dragonResults.sort((a, b) => b.B - a.B);
      allResults.push({
        dragonNumber: dragonConfig.displayNumber,
        dragonGrade: dragonConfig.grade,
        dragonType: dragonConfig.type,
        results: dragonResults.slice(0, topN)
      });
    });

    // 7. 결과를 전역에 저장 (수동계산기 적용용)
    window._lastAutoResults = allResults;

    // 8. 결과 출력 (클릭 가능한 HTML)
    if (!allResults.length || allResults.every(d => d.results.length === 0)) {
      resultBox.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">결과가 생성되지 않았습니다.</div>';
      return;
    }

    let outputHtml = '';
    let outputText = '';

    allResults.forEach((dragonResult, dragonIdx) => {
      outputHtml += `<div style="margin-bottom:20px;">`;
      outputHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      outputHtml += `★ 드래곤 ${dragonResult.dragonNumber} (${dragonResult.dragonGrade} / ${dragonResult.dragonType})`;
      outputHtml += `</div>`;

      outputText += `\n${'━'.repeat(60)}\n`;
      outputText += `★ 드래곤 ${dragonResult.dragonNumber} (${dragonResult.dragonGrade} / ${dragonResult.dragonType})\n`;
      outputText += `${'━'.repeat(60)}\n`;

      dragonResult.results.forEach((r, i) => {
        const resultId = `result_${dragonIdx}_${i}`;
        outputHtml += `
          <div id="${resultId}" class="result-item" onclick="applyResultToManual(${dragonIdx}, ${i})"
               style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
               onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
            <div style="font-weight:600;color:#1565c0;">[${i + 1}위] ${r.dragonType} | ${r.accessory}</div>
            <div style="font-size:13px;color:#666;">젬: ${r.gems} | 펜던트: ${r.pendant} | 인첸트: ${r.enchant}</div>
            <div style="font-size:13px;margin-top:4px;">
              HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
              E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
            </div>
            <div style="font-size:11px;color:#999;margin-top:4px;">클릭하여 수동계산기에 적용</div>
          </div>
        `;

        outputText += `[${i + 1}위] ${r.dragonType} | ${r.accessory} | 젬: ${r.gems} | 펜던트: ${r.pendant} | 인첸트: ${r.enchant}\n`;
        outputText += `HP=${r.finalStats.hp} | ATK=${r.finalStats.atk} | DEF=${r.finalStats.df} | E=${r.eValue.toFixed(0)} | B=${(r.B/1e6).toFixed(3)}\n\n`;
      });

      outputHtml += `</div>`;
    });

    resultBox.innerHTML = outputHtml;

    // 예측기 결과 탭에 자동 저장 (텍스트 형식)
    const resultStorage = document.getElementById("resultStorage");
    const timestamp = new Date().toLocaleString('ko-KR', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });

    const separator = resultStorage.textContent.trim() ?
      `\n\n${'='.repeat(80)}\n[${timestamp}] 새로운 계산 결과\n${'='.repeat(80)}\n\n` :
      `[${timestamp}] 계산 결과\n${'='.repeat(80)}\n\n`;

    resultStorage.textContent = resultStorage.textContent + separator + outputText;
  }

  // 결과 클릭 시 수동계산기에 적용
  function applyResultToManual(dragonIdx, resultIdx) {
    if (!window._lastAutoResults || !window._lastAutoResults[dragonIdx]) {
      alert('결과 데이터를 찾을 수 없습니다.');
      return;
    }

    const dragonResult = window._lastAutoResults[dragonIdx];
    const result = dragonResult.results[resultIdx];
    if (!result) {
      alert('결과 데이터를 찾을 수 없습니다.');
      return;
    }

    // 수동계산기의 해당 드래곤 인덱스 (1-based)
    const manualIdx = dragonResult.dragonNumber;

    // 수동계산기에 드래곤이 있는지 확인
    if (ManualDragonState.dragons.length < manualIdx) {
      alert(`수동계산기에 드래곤 ${manualIdx}이(가) 없습니다. 먼저 드래곤을 추가해주세요.`);
      return;
    }

    // 등급/타입 적용
    const levelEl = document.getElementById(`d${manualIdx}_m_level`);
    const typeEl = document.getElementById(`d${manualIdx}_m_type`);
    if (levelEl) levelEl.value = dragonResult.dragonGrade;
    if (typeEl) typeEl.value = dragonResult.dragonType;

    // 젬 파싱 및 적용 (예: "HP2 ATK0 DEF3")
    const gemMatch = result.gems.match(/HP(\d+)\s+ATK(\d+)\s+DEF(\d+)/);
    if (gemMatch) {
      const hpCount = parseInt(gemMatch[1]);
      const atkCount = parseInt(gemMatch[2]);
      const defCount = parseInt(gemMatch[3]);

      // 젬 슬롯 초기화 및 설정
      let slotIdx = 1;
      const gemBase = {
        hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 156),
        atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 39),
        df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 39)
      };

      // HP 젬
      for (let i = 0; i < hpCount && slotIdx <= 5; i++, slotIdx++) {
        const typeSelect = document.getElementById(`d${manualIdx}_slot_type_${slotIdx}`);
        const valSelect = document.getElementById(`d${manualIdx}_slot_val_${slotIdx}`);
        if (typeSelect) {
          typeSelect.value = 'HP';
          typeSelect.dispatchEvent(new Event('change'));
          setTimeout(() => { if (valSelect) valSelect.value = gemBase.hp; }, 50);
        }
      }
      // ATK 젬
      for (let i = 0; i < atkCount && slotIdx <= 5; i++, slotIdx++) {
        const typeSelect = document.getElementById(`d${manualIdx}_slot_type_${slotIdx}`);
        const valSelect = document.getElementById(`d${manualIdx}_slot_val_${slotIdx}`);
        if (typeSelect) {
          typeSelect.value = 'ATK';
          typeSelect.dispatchEvent(new Event('change'));
          setTimeout(() => { if (valSelect) valSelect.value = gemBase.atk; }, 50);
        }
      }
      // DEF 젬
      for (let i = 0; i < defCount && slotIdx <= 5; i++, slotIdx++) {
        const typeSelect = document.getElementById(`d${manualIdx}_slot_type_${slotIdx}`);
        const valSelect = document.getElementById(`d${manualIdx}_slot_val_${slotIdx}`);
        if (typeSelect) {
          typeSelect.value = 'DEF';
          typeSelect.dispatchEvent(new Event('change'));
          setTimeout(() => { if (valSelect) valSelect.value = gemBase.df; }, 50);
        }
      }
    }

    // 장신구 파싱 및 적용 (예: "바뿔(체/방) Lv20")
    const accMatch = result.accessory.match(/(.+)\s+Lv(\d+)/);
    if (accMatch) {
      const accName = accMatch[1];
      const accLevel = parseInt(accMatch[2]);

      // ACC_TABLE에서 해당 장신구 찾기
      const accIndex = ACC_TABLE.findIndex(acc => acc[0] === accName && acc[1] === accLevel);
      if (accIndex !== -1) {
        const accData = ACC_TABLE[accIndex];
        document.getElementById(`d${manualIdx}_m_acc_hp`).value = accData[2];
        document.getElementById(`d${manualIdx}_m_acc_atk`).value = accData[3];
        document.getElementById(`d${manualIdx}_m_acc_df`).value = accData[4];
      }
    }

    // 인첸트 파싱 및 적용 (예: "ATK +21%")
    const enchMatch = result.enchant.match(/(HP|ATK|DEF)\s+\+(\d+)%/);
    if (enchMatch) {
      const enchStat = enchMatch[1];
      const enchValue = parseInt(enchMatch[2]);

      document.getElementById(`d${manualIdx}_m_ench_hp`).value = enchStat === 'HP' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_atk`).value = enchStat === 'ATK' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_df`).value = enchStat === 'DEF' ? enchValue : 0;
    }

    // 펜던트 파싱 및 적용 (예: "달 (HP6 / ATK6)")
    const pendMatch = result.pendant.match(/\(([^)]+)\)/);
    if (pendMatch) {
      const pendParts = pendMatch[1].split('/').map(s => s.trim());
      let pendHp = 0, pendAtk = 0, pendDf = 0;

      pendParts.forEach(part => {
        const match = part.match(/(HP|ATK|DEF)(\d+)/);
        if (match) {
          const stat = match[1];
          const val = parseInt(match[2]);
          if (stat === 'HP') pendHp += val;
          else if (stat === 'ATK') pendAtk += val;
          else if (stat === 'DEF') pendDf += val;
        }
      });

      document.getElementById(`d${manualIdx}_m_pend_hp`).value = pendHp;
      document.getElementById(`d${manualIdx}_m_pend_atk`).value = pendAtk;
      document.getElementById(`d${manualIdx}_m_pend_df`).value = pendDf;
    }

    // AppState에서 정령/버프/디버프 복사
    const appDragon = AppState.dragons[dragonIdx];
    if (appDragon) {
      document.getElementById(`d${manualIdx}_sf_hp`).value = appDragon.spirit.flat.hp;
      document.getElementById(`d${manualIdx}_sf_atk`).value = appDragon.spirit.flat.atk;
      document.getElementById(`d${manualIdx}_sf_df`).value = appDragon.spirit.flat.df;
      document.getElementById(`d${manualIdx}_sp_hp`).value = appDragon.spirit.pct.hp;
      document.getElementById(`d${manualIdx}_sp_atk`).value = appDragon.spirit.pct.atk;
      document.getElementById(`d${manualIdx}_sp_df`).value = appDragon.spirit.pct.df;
      document.getElementById(`d${manualIdx}_se_hp`).value = appDragon.spirit.extra.hp;
      document.getElementById(`d${manualIdx}_se_atk`).value = appDragon.spirit.extra.atk;
      document.getElementById(`d${manualIdx}_se_df`).value = appDragon.spirit.extra.df;
      document.getElementById(`d${manualIdx}_bf_hp`).value = appDragon.buff.hp;
      document.getElementById(`d${manualIdx}_bf_atk`).value = appDragon.buff.atk;
      document.getElementById(`d${manualIdx}_bf_df`).value = appDragon.buff.df;
      document.getElementById(`d${manualIdx}_db_hp`).value = appDragon.debuff.hp;
      document.getElementById(`d${manualIdx}_db_atk`).value = appDragon.debuff.atk;
      document.getElementById(`d${manualIdx}_db_df`).value = appDragon.debuff.df;
    }

    alert(`드래곤 ${manualIdx}에 [${resultIdx + 1}위] 결과가 적용되었습니다.\n수동계산기 탭에서 확인해주세요.`);

    // 수동계산기 탭으로 전환
    switchMode('manual');
  }

  // ===== 장신구 비공유 모드 계산 =====
  function calcAutoDistributeMode(selectedAcc, gemBase, pendantCombinations, pendantVer, pendantMode, manualPendantStr, topN, pot, col, ENCHANT) {
    const resultBox = document.getElementById("autoResult");

    // 각 드래곤에 대해 각 장신구의 최적 B값 계산
    const dragonAccScores = [];

    AppState.dragons.forEach((dragonConfig, dragonIdx) => {
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];
      const spiritFlat = new Stats(dragonConfig.spirit.flat.hp, dragonConfig.spirit.flat.atk, dragonConfig.spirit.flat.df);
      const spiritPct = new Stats(dragonConfig.spirit.pct.hp / 100, dragonConfig.spirit.pct.atk / 100, dragonConfig.spirit.pct.df / 100);
      const spiritExtra = new Stats(dragonConfig.spirit.extra.hp, dragonConfig.spirit.extra.atk, dragonConfig.spirit.extra.df);
      const buff = new Stats(dragonConfig.buff.hp / 100, dragonConfig.buff.atk / 100, dragonConfig.buff.df / 100);
      const debuff = new Stats(dragonConfig.debuff.hp / 100, dragonConfig.debuff.atk / 100, dragonConfig.debuff.df / 100);

      const accScores = [];

      selectedAcc.forEach((accessory, accIdx) => {
        let bestResult = null;
        let bestB = -Infinity;

        const accPctBase = { hp: accessory.hp / 100, atk: accessory.atk / 100, df: accessory.df / 100 };

        // 모든 조합 중 최고 B값 찾기
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(gemBase.hp * hpGems, gemBase.atk * atkGems, gemBase.df * defGems);

            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(accPctBase.hp + enchantBonus.hp, accPctBase.atk + enchantBonus.atk, accPctBase.df + enchantBonus.df);

              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                if (bValue > bestB) {
                  bestB = bValue;
                  const pendantSlotStr = (pendantVer === "v3") ? manualPendantStr : pendant.map(slot =>
                    ["HP","ATK","DEF"].map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "").filter(Boolean).join(" ")
                  ).join(" / ");
                  const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                  bestResult = {
                    B: bValue,
                    dragonNumber: dragonConfig.displayNumber,
                    dragonGrade: dragonConfig.grade,
                    dragonType: dragonConfig.type,
                    accessory: `${accessory.name} Lv${accessory.level}`,
                    accIdx: accIdx,
                    gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                    pendant: `${pendantVer === "v3" ? "수동입력" : pendantMode} (${pendantSlotStr})`,
                    enchant: `${enchantLabel} +${ENCHANT}%`,
                    finalStats,
                    eValue
                  };
                }
              }
            }
          }
        }

        accScores.push({ accIdx, bestB, bestResult });
      });

      dragonAccScores.push({ dragonIdx, dragonConfig, accScores });
    });

    // 헝가리안 알고리즘 대신 그리디 방식으로 최적 배분
    // (드래곤 수가 적으면 충분히 효과적)
    const usedAcc = new Set();
    const assignments = [];

    // 모든 (드래곤, 장신구) 조합을 B값 기준으로 정렬
    const allPairs = [];
    dragonAccScores.forEach(({ dragonIdx, dragonConfig, accScores }) => {
      accScores.forEach(({ accIdx, bestB, bestResult }) => {
        if (bestResult) {
          allPairs.push({ dragonIdx, accIdx, bestB, bestResult });
        }
      });
    });
    allPairs.sort((a, b) => b.bestB - a.bestB);

    // 그리디하게 배분 (각 드래곤에 하나의 장신구)
    const assignedDragons = new Set();
    for (const pair of allPairs) {
      if (!assignedDragons.has(pair.dragonIdx) && !usedAcc.has(pair.accIdx)) {
        assignments.push(pair);
        assignedDragons.add(pair.dragonIdx);
        usedAcc.add(pair.accIdx);
      }
      if (assignedDragons.size >= AppState.dragons.length) break;
    }

    // 결과를 드래곤 순서대로 정렬
    assignments.sort((a, b) => a.dragonIdx - b.dragonIdx);

    // 전역에 저장
    const allResults = assignments.map(a => ({
      dragonNumber: a.bestResult.dragonNumber,
      dragonGrade: a.bestResult.dragonGrade,
      dragonType: a.bestResult.dragonType,
      results: [a.bestResult]
    }));
    window._lastAutoResults = allResults;

    // 결과 출력
    let outputHtml = `<div style="background:#fff3e0;padding:10px;border-radius:8px;margin-bottom:15px;">
      <strong style="color:#e65100;">🔀 장신구 비공유 모드</strong>
      <div style="font-size:13px;color:#666;margin-top:4px;">각 드래곤에 다른 장신구가 배분됩니다.</div>
    </div>`;

    let outputText = '=== 장신구 비공유 모드 ===\n';
    let totalB = 0;

    assignments.forEach((assign, idx) => {
      const r = assign.bestResult;
      totalB += r.B;

      outputHtml += `<div style="margin-bottom:15px;">`;
      outputHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      outputHtml += `★ 드래곤 ${r.dragonNumber} (${r.dragonGrade} / ${r.dragonType})`;
      outputHtml += `</div>`;
      outputHtml += `
        <div class="result-item" onclick="applyResultToManual(${idx}, 0)"
             style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
             onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
          <div style="font-weight:600;color:#1565c0;">[최적] ${r.dragonType} | ${r.accessory}</div>
          <div style="font-size:13px;color:#666;">젬: ${r.gems} | 펜던트: ${r.pendant} | 인첸트: ${r.enchant}</div>
          <div style="font-size:13px;margin-top:4px;">
            HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
            E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
          </div>
          <div style="font-size:11px;color:#999;margin-top:4px;">클릭하여 수동계산기에 적용</div>
        </div>
      </div>`;

      outputText += `\n드래곤 ${r.dragonNumber}: ${r.accessory} → B=${(r.B/1e6).toFixed(3)}\n`;
    });

    outputHtml += `<div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-top:10px;text-align:center;">
      <strong style="color:#2e7d32;font-size:18px;">총 B-Value 합계: ${(totalB/1e6).toFixed(3)}</strong>
    </div>`;

    outputText += `\n총 B-Value 합계: ${(totalB/1e6).toFixed(3)}\n`;

    resultBox.innerHTML = outputHtml;

    // 예측기 결과 탭에 저장
    const resultStorage = document.getElementById("resultStorage");
    const timestamp = new Date().toLocaleString('ko-KR', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const separator = resultStorage.textContent.trim() ?
      `\n\n${'='.repeat(80)}\n[${timestamp}] 새로운 계산 결과 (비공유 모드)\n${'='.repeat(80)}\n\n` :
      `[${timestamp}] 계산 결과 (비공유 모드)\n${'='.repeat(80)}\n\n`;
    resultStorage.textContent = resultStorage.textContent + separator + outputText;
  }

  // ===== 예측기 결과 관리 =====
  function clearAllResults() {
    if (confirm('예측기 결과 탭의 모든 결과를 삭제하시겠습니까?')) {
      document.getElementById("resultStorage").textContent = "";
      alert("전체 결과가 삭제되었습니다.");
    }
  }

  function downloadAllResults() {
    const text = document.getElementById("resultStorage").textContent || "";
    if (!text.trim()) {
      alert("저장할 결과가 없습니다.");
      return;
    }
    const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dragon_results_all.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function downloadTxt(){
    const text=document.getElementById("autoResult").textContent||"";
    if(!text.trim()) return;
    const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="dragon_result.txt";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  const gemOptions = {
    HP: [160, 156, 152, 148],
    ATK: [40, 39, 38, 37],
    DEF: [40, 39, 38, 37]
  };

  // 수동계산기 드래곤 상태
  const ManualDragonState = {
    dragons: [],
    maxDragons: 9,
    nextId: 1,
    accessoryAllocation: new Map()
  };

  class ManualDragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;
      this.type = type;
      this.accessoryId = null;
    }
  }

  // 수동계산기 드래곤 추가
  function addManualDragon() {
    if (ManualDragonState.dragons.length >= ManualDragonState.maxDragons) {
      alert(`최대 ${ManualDragonState.maxDragons}마리까지만 추가할 수 있습니다.`);
      return;
    }

    const gradeSelect = document.getElementById('add_manual_dragon_grade');
    const typeSelect = document.getElementById('add_manual_dragon_type');
    const grade = gradeSelect ? gradeSelect.value : '9.0';
    const type = typeSelect ? typeSelect.value : '공격형';

    const newDragon = new ManualDragonConfig(ManualDragonState.nextId++, grade, type);
    newDragon.displayNumber = ManualDragonState.dragons.length + 1;
    ManualDragonState.dragons.push(newDragon);

    renderAllManual();
    updateManualDragonCount();
  }

  // 수동계산기 드래곤 삭제
  function removeManualDragon(dragonId) {
    const index = ManualDragonState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    const dragon = ManualDragonState.dragons[index];

    // 장신구 해제
    if (dragon.accessoryId) {
      ManualDragonState.accessoryAllocation.delete(dragon.accessoryId);
    }

    ManualDragonState.dragons.splice(index, 1);

    // 리넘버링
    ManualDragonState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });

    renderAllManual();
    updateManualDragonCount();
  }

  function updateManualDragonCount() {
    const countEl = document.getElementById('manualDragonCount');
    if (countEl) {
      countEl.textContent = `(현재: ${ManualDragonState.dragons.length}마리)`;
    }
  }

  // 페이지 로드 시 3마리 드래곤 자동 생성
  window.addEventListener('DOMContentLoaded', () => {
    // 기본 3마리 생성
    for (let i = 0; i < 3; i++) {
      const dragon = new ManualDragonConfig(ManualDragonState.nextId++, '9.0', '공격형');
      dragon.displayNumber = i + 1;
      ManualDragonState.dragons.push(dragon);
    }
    renderAllManual();
    updateManualDragonCount();
  });

  function renderAllManual() {
    const tabsContainer = document.getElementById('manualDragonTabs');
    const inputsWrap = document.getElementById('inputsWrap');
    const allResults = document.getElementById('allResults');

    if (!tabsContainer || !inputsWrap) return;

    tabsContainer.innerHTML = '';
    inputsWrap.innerHTML = '';
    allResults.innerHTML = '';

    if (ManualDragonState.dragons.length === 0) {
      inputsWrap.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">드래곤을 추가해주세요</p>';
      return;
    }

    // 탭 생성
    ManualDragonState.dragons.forEach((dragon, index) => {
      const tab = document.createElement('button');
      tab.className = `dragon-tab ${index === 0 ? 'active' : ''}`;
      tab.textContent = `드래곤 ${dragon.displayNumber}`;
      tab.dataset.dragonIdx = dragon.displayNumber;
      tab.onclick = () => switchManualDragonTab(dragon.displayNumber);
      tabsContainer.appendChild(tab);
    });

    // 패널 및 결과 시트 생성
    ManualDragonState.dragons.forEach((dragon, index) => {
      renderOneInputAsPanel(dragon.displayNumber, dragon, index === 0);
      renderOneResult(dragon.displayNumber);
    });
  }

  function renderOneInputAsPanel(idx, dragonConfig, isActive) {
    const inputsWrap = document.getElementById('inputsWrap');
    const panel = document.createElement('div');
    panel.className = `dragon-settings-panel ${isActive ? 'active' : ''}`;
    panel.id = `manualPanel_${idx}`;

    // 드래곤 ID 찾기 (삭제용)
    const dragonId = dragonConfig ? dragonConfig.id : null;
    const showDelete = ManualDragonState.dragons.length > 1;

    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;margin-bottom:12px;">
        <div style="display:flex;gap:10px;align-items:center;">
          <strong style="font-size:16px;color:var(--accent);">드래곤 ${idx}</strong>
          <label>이름 <input id="d${idx}_name" type="text" style="width:120px;"></label>
        </div>
        ${showDelete && dragonId ? `<button class="btn-remove" onclick="removeManualDragon(${dragonId})">삭제</button>` : ''}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <fieldset>
          <legend>등급 / 타입</legend>
          <div class="row">
            <label>등급
              <select id="d${idx}_m_level">
                <option value="7.0" ${dragonConfig?.grade === '7.0' ? 'selected' : ''}>7.0</option>
                <option value="8.0" ${dragonConfig?.grade === '8.0' ? 'selected' : ''}>8.0</option>
                <option value="9.0" ${!dragonConfig || dragonConfig?.grade === '9.0' ? 'selected' : ''}>9.0</option>
              </select>
            </label>
            <label>타입
              <select id="d${idx}_m_type">
                <option ${dragonConfig?.type === '공격형' ? 'selected' : ''}>공격형</option>
                <option ${dragonConfig?.type === '방어형' ? 'selected' : ''}>방어형</option>
                <option ${dragonConfig?.type === '체력형' ? 'selected' : ''}>체력형</option>
                <option ${dragonConfig?.type === '공방형' ? 'selected' : ''}>공방형</option>
                <option ${dragonConfig?.type === '체공형' ? 'selected' : ''}>체공형</option>
                <option ${dragonConfig?.type === '체방형' ? 'selected' : ''}>체방형</option>
              </select>
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>장신구 선택</legend>
          <div class="row">
            <select id="d${idx}_acc_select" onchange="onManualAccessoryChange(${idx}, this.value)" style="width:100%;">
              <option value="">-- 장신구 선택 --</option>
              ${renderAccessoryOptions(dragonConfig?.accessoryId)}
            </select>
          </div>
          <div class="row" style="margin-top:6px;">
            <span class="small">또는 직접 입력:</span>
          </div>
          <div class="row">
            HP <input id="d${idx}_m_acc_hp" type="number" value="0" style="width:55px">%
            ATK <input id="d${idx}_m_acc_atk" type="number" value="0" style="width:55px">%
            DEF <input id="d${idx}_m_acc_df" type="number" value="0" style="width:55px">%
          </div>
        </fieldset>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <fieldset>
          <legend>젬 슬롯 (5개)</legend>
          <div id="d${idx}_gem_slots"></div>
        </fieldset>

        <fieldset>
          <legend>인첸트 / 펜던트 (%)</legend>
          <div class="row">
            <strong>인첸트</strong>
            HP <input id="d${idx}_m_ench_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_ench_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_ench_df" type="number" value="0" style="width:50px">
          </div>
          <div class="row" style="margin-top:6px;">
            <strong>펜던트</strong>
            HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:50px">
          </div>
        </fieldset>
      </div>

      <fieldset style="margin-top:12px;">
        <legend>정령 / 버프 / 디버프</legend>
        <div style="font-weight:700;margin-bottom:6px">(HP / ATK / DEF)</div>
        <div class="row-spirit"><strong>정령 + (플옵)</strong>
          <input id="d${idx}_sf_hp" type="number" value="0">
          <input id="d${idx}_sf_atk" type="number" value="0">
          <input id="d${idx}_sf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>정령 % (퍼옵)</strong>
          <input id="d${idx}_sp_hp" type="number" value="0">
          <input id="d${idx}_sp_atk" type="number" value="0">
          <input id="d${idx}_sp_df" type="number" value="0">
          <span class="small">% 입력</span>
        </div>
        <div class="row-spirit"><strong>정령 부가옵</strong>
          <input id="d${idx}_se_hp" type="number" value="0">
          <input id="d${idx}_se_atk" type="number" value="0">
          <input id="d${idx}_se_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>버프 (%)</strong>
          <input id="d${idx}_bf_hp" type="number" value="0">
          <input id="d${idx}_bf_atk" type="number" value="0">
          <input id="d${idx}_bf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>디버프 (%)</strong>
          <input id="d${idx}_db_hp" type="number" value="0">
          <input id="d${idx}_db_atk" type="number" value="0">
          <input id="d${idx}_db_df" type="number" value="0">
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(panel);
    renderGems(idx);
  }

  function switchManualDragonTab(dragonIdx) {
    // 모든 탭 비활성화
    document.querySelectorAll('#manualDragonTabs .dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#inputsWrap .dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // 선택된 탭 활성화
    document.querySelector(`#manualDragonTabs .dragon-tab[data-dragon-idx="${dragonIdx}"]`)?.classList.add('active');
    document.getElementById(`manualPanel_${dragonIdx}`)?.classList.add('active');
  }

  // 기존 호환성을 위한 renderAll
  function renderAll(count){
    // 초기화
    ManualDragonState.dragons = [];
    ManualDragonState.nextId = 1;

    for (let i = 0; i < count; i++) {
      const dragon = new ManualDragonConfig(ManualDragonState.nextId++, '9.0', '공격형');
      dragon.displayNumber = i + 1;
      ManualDragonState.dragons.push(dragon);
    }
    renderAllManual();
    updateManualDragonCount();
  }

  function renderOneInput(idx, dragonConfig = null){
    const inputsWrap = document.getElementById('inputsWrap');
    const box = document.createElement('div');
    box.className = 'dragon-input';
    box.id = `dragonInput_${idx}`;
    box.style.cssText = 'border:1px solid var(--border);background:#fff;border-radius:8px;padding:12px';

    // 드래곤 ID 찾기 (삭제용)
    const dragonId = dragonConfig ? dragonConfig.id : null;
    const showDelete = ManualDragonState.dragons.length > 1;

    box.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div style="display:flex;gap:10px;align-items:center;">
          <strong style="font-size:16px;color:var(--accent);">드래곤 ${idx}</strong>
          <label>이름 <input id="d${idx}_name" type="text" style="width:120px;"></label>
        </div>
        ${showDelete && dragonId ? `<button class="btn-remove" onclick="removeManualDragon(${dragonId})">삭제</button>` : ''}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <fieldset>
          <legend>등급 / 타입</legend>
          <div class="row">
            <label>등급
              <select id="d${idx}_m_level">
                <option value="7.0" ${dragonConfig?.grade === '7.0' ? 'selected' : ''}>7.0</option>
                <option value="8.0" ${dragonConfig?.grade === '8.0' ? 'selected' : ''}>8.0</option>
                <option value="9.0" ${!dragonConfig || dragonConfig?.grade === '9.0' ? 'selected' : ''}>9.0</option>
              </select>
            </label>
            <label>타입
              <select id="d${idx}_m_type">
                <option ${dragonConfig?.type === '공격형' ? 'selected' : ''}>공격형</option>
                <option ${dragonConfig?.type === '방어형' ? 'selected' : ''}>방어형</option>
                <option ${dragonConfig?.type === '체력형' ? 'selected' : ''}>체력형</option>
                <option ${dragonConfig?.type === '공방형' ? 'selected' : ''}>공방형</option>
                <option ${dragonConfig?.type === '체공형' ? 'selected' : ''}>체공형</option>
                <option ${dragonConfig?.type === '체방형' ? 'selected' : ''}>체방형</option>
              </select>
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>장신구 선택</legend>
          <div class="row">
            <select id="d${idx}_acc_select" onchange="onManualAccessoryChange(${idx}, this.value)" style="width:100%;">
              <option value="">-- 장신구 선택 --</option>
              ${renderAccessoryOptions(dragonConfig?.accessoryId)}
            </select>
          </div>
          <div class="row" style="margin-top:6px;">
            <span class="small">또는 직접 입력:</span>
          </div>
          <div class="row">
            HP <input id="d${idx}_m_acc_hp" type="number" value="0" style="width:60px">%
            ATK <input id="d${idx}_m_acc_atk" type="number" value="0" style="width:60px">%
            DEF <input id="d${idx}_m_acc_df" type="number" value="0" style="width:60px">%
          </div>
        </fieldset>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <fieldset>
          <legend>젬 슬롯 (5개)</legend>
          <div id="d${idx}_gem_slots"></div>
        </fieldset>

        <fieldset>
          <legend>인첸트 / 펜던트 (%)</legend>
          <div class="row">
            <strong>인첸트</strong>
            HP <input id="d${idx}_m_ench_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_ench_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_ench_df" type="number" value="0" style="width:50px">
          </div>
          <div class="row" style="margin-top:6px;">
            <strong>펜던트</strong>
            HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:50px">
          </div>
        </fieldset>
      </div>

      <fieldset style="margin-top:12px;">
        <legend>정령 / 버프 / 디버프</legend>
        <div style="font-weight:700;margin-bottom:6px">(HP / ATK / DEF)</div>
        <div class="row-spirit"><strong>정령 + (플옵)</strong>
          <input id="d${idx}_sf_hp" type="number" value="0">
          <input id="d${idx}_sf_atk" type="number" value="0">
          <input id="d${idx}_sf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>정령 % (퍼옵)</strong>
          <input id="d${idx}_sp_hp" type="number" value="0">
          <input id="d${idx}_sp_atk" type="number" value="0">
          <input id="d${idx}_sp_df" type="number" value="0">
          <span class="small">% 입력</span>
        </div>
        <div class="row-spirit"><strong>정령 부가옵</strong>
          <input id="d${idx}_se_hp" type="number" value="0">
          <input id="d${idx}_se_atk" type="number" value="0">
          <input id="d${idx}_se_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>버프 (%)</strong>
          <input id="d${idx}_bf_hp" type="number" value="0">
          <input id="d${idx}_bf_atk" type="number" value="0">
          <input id="d${idx}_bf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>디버프 (%)</strong>
          <input id="d${idx}_db_hp" type="number" value="0">
          <input id="d${idx}_db_atk" type="number" value="0">
          <input id="d${idx}_db_df" type="number" value="0">
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(box);
    renderGems(idx);
  }

  // 장신구 옵션 렌더링 (중복 방지 포함)
  function renderAccessoryOptions(currentAccId = null) {
    return ACC_TABLE.map((acc, index) => {
      const [name, level, hp, atk, df] = acc;
      const accId = `acc_${index}`;
      const isUsed = ManualDragonState.accessoryAllocation.has(accId) &&
                     ManualDragonState.accessoryAllocation.get(accId) !== currentAccId;
      const usedBy = isUsed ? ManualDragonState.accessoryAllocation.get(accId) : null;
      const usedLabel = usedBy ? ` (드래곤 ${usedBy} 사용중)` : '';

      return `<option value="${accId}" ${currentAccId === accId ? 'selected' : ''} ${isUsed ? 'disabled' : ''}>
        ${name} Lv${level} | HP+${hp}% ATK+${atk}% DEF+${df}%${usedLabel}
      </option>`;
    }).join('');
  }

  // 장신구 선택 변경 시 호출
  function onManualAccessoryChange(dragonIdx, accId) {
    const dragon = ManualDragonState.dragons[dragonIdx - 1];
    if (!dragon) return;

    // 이전 할당 해제
    if (dragon.accessoryId) {
      ManualDragonState.accessoryAllocation.delete(dragon.accessoryId);
    }

    if (accId && accId !== '') {
      // 중복 체크
      if (ManualDragonState.accessoryAllocation.has(accId)) {
        alert('이미 다른 드래곤에 장착된 장신구입니다.');
        document.getElementById(`d${dragonIdx}_acc_select`).value = dragon.accessoryId || '';
        return;
      }

      // 새로운 할당
      ManualDragonState.accessoryAllocation.set(accId, dragonIdx);
      dragon.accessoryId = accId;

      // 장신구 값 자동 입력
      const accIndex = parseInt(accId.replace('acc_', ''));
      const accData = ACC_TABLE[accIndex];
      if (accData) {
        document.getElementById(`d${dragonIdx}_m_acc_hp`).value = accData[2];
        document.getElementById(`d${dragonIdx}_m_acc_atk`).value = accData[3];
        document.getElementById(`d${dragonIdx}_m_acc_df`).value = accData[4];
      }
    } else {
      dragon.accessoryId = null;
    }

    // 다른 드래곤의 장신구 셀렉트 업데이트
    updateAllAccessorySelects();
  }

  // 모든 장신구 셀렉트 업데이트
  function updateAllAccessorySelects() {
    ManualDragonState.dragons.forEach((dragon, index) => {
      const select = document.getElementById(`d${dragon.displayNumber}_acc_select`);
      if (select) {
        const currentValue = select.value;
        select.innerHTML = `<option value="">-- 장신구 선택 --</option>${renderAccessoryOptions(dragon.accessoryId)}`;
        select.value = currentValue;
      }
    });
  }

  function renderGems(idx){
    const c=document.getElementById(`d${idx}_gem_slots`); c.innerHTML='';
    for(let i=1;i<=5;i++){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `
        <strong style="width:64px;display:inline-block">젬${i}</strong>
        <select id="d${idx}_slot_type_${i}">
          <option value="">--종류--</option>
          <option value="HP">HP</option>
          <option value="ATK">ATK</option>
          <option value="DEF">DEF</option>
        </select>
        <select id="d${idx}_slot_val_${i}">
          <option value="0">--값--</option>
        </select>`;
      c.appendChild(row);

      const typeSel=row.querySelector(`#d${idx}_slot_type_${i}`);
      const valSel=row.querySelector(`#d${idx}_slot_val_${i}`);
      typeSel.addEventListener('change', ()=>{
        valSel.innerHTML = `<option value="0">--값--</option>`;
        const t=typeSel.value;
        if(t && gemOptions[t]){
          gemOptions[t].forEach(v=>{
            const op=document.createElement('option');
            op.value=v; op.textContent=v; valSel.appendChild(op);
          });
        }
      });
    }
  }

function renderOneResult(idx){
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.id = `resultSheet_${idx}`;
  sheet.innerHTML = `
    <div class="name" id="d${idx}_name_display">드래곤 ${idx}</div>
    <div class="grid">
      <div class="cell h center">구분</div>
      <div class="cell h center">체력</div>
      <div class="cell h center">공격력</div>
      <div class="cell h center">방어력</div>

      <div class="cell">기본 스탯</div>
      <div class="cell right" id="d${idx}_c_base_hp">-</div>
      <div class="cell right" id="d${idx}_c_base_atk">-</div>
      <div class="cell right" id="d${idx}_c_base_df">-</div>

      <div class="cell">젬1</div><div class="cell right" id="d${idx}_c_g1_hp">0</div><div class="cell right" id="d${idx}_c_g1_atk">0</div><div class="cell right" id="d${idx}_c_g1_df">0</div>
      <div class="cell">젬2</div><div class="cell right" id="d${idx}_c_g2_hp">0</div><div class="cell right" id="d${idx}_c_g2_atk">0</div><div class="cell right" id="d${idx}_c_g2_df">0</div>
      <div class="cell">젬3</div><div class="cell right" id="d${idx}_c_g3_hp">0</div><div class="cell right" id="d${idx}_c_g3_atk">0</div><div class="cell right" id="d${idx}_c_g3_df">0</div>
      <div class="cell">젬4</div><div class="cell right" id="d${idx}_c_g4_hp">0</div><div class="cell right" id="d${idx}_c_g4_atk">0</div><div class="cell right" id="d${idx}_c_g4_df">0</div>
      <div class="cell">젬5</div><div class="cell right" id="d${idx}_c_g5_hp">0</div><div class="cell right" id="d${idx}_c_g5_atk">0</div><div class="cell right" id="d${idx}_c_g5_df">0</div>

      <div class="cell">장신구 %</div><div class="cell right" id="d${idx}_c_acc_hp">0%</div><div class="cell right" id="d${idx}_c_acc_atk">0%</div><div class="cell right" id="d${idx}_c_acc_df">0%</div>
      <div class="cell">인첸트 %</div><div class="cell right" id="d${idx}_c_ench_hp">0%</div><div class="cell right" id="d${idx}_c_ench_atk">0%</div><div class="cell right" id="d${idx}_c_ench_df">0%</div>
      <div class="cell">펜던트 %</div><div class="cell right" id="d${idx}_c_pend_hp">0%</div><div class="cell right" id="d${idx}_c_pend_atk">0%</div><div class="cell right" id="d${idx}_c_pend_df">0%</div>

      <div class="cell">정령 +</div><div class="cell right" id="d${idx}_c_spf_hp">0</div><div class="cell right" id="d${idx}_c_spf_atk">0</div><div class="cell right" id="d${idx}_c_spf_df">0</div>
      <div class="cell">정령 %</div><div class="cell right" id="d${idx}_c_spp_hp">0%</div><div class="cell right" id="d${idx}_c_spp_atk">0%</div><div class="cell right" id="d${idx}_c_spp_df">0%</div>
      <div class="cell">정령 부가옵</div><div class="cell right" id="d${idx}_c_spe_hp">0</div><div class="cell right" id="d${idx}_c_spe_atk">0</div><div class="cell right" id="d${idx}_c_spe_df">0</div>
      <div class="cell">버프 %</div><div class="cell right" id="d${idx}_c_bf_hp">0%</div><div class="cell right" id="d${idx}_c_bf_atk">0%</div><div class="cell right" id="d${idx}_c_bf_df">0%</div>
      <div class="cell">디버프 %</div><div class="cell right" id="d${idx}_c_db_hp">0%</div><div class="cell right" id="d${idx}_c_db_atk">0%</div><div class="cell right" id="d${idx}_c_db_df">0%</div>

      <div class="cell section center" style="grid-column:1/5">최종 스탯</div>
      <div class="cell sum">체력</div><div class="cell big" id="d${idx}_c_fin_hp">-</div>
      <div class="cell sum">공격력</div><div class="cell big" id="d${idx}_c_fin_atk">-</div>
      <div class="cell sum">방어력</div><div class="cell big" id="d${idx}_c_fin_df">-</div>

      <div class="cell section center" style="grid-column:1/5">지표</div>
      <div class="cell">E-Value</div><div class="cell big" id="d${idx}_c_eval" style="grid-column:2/5">-</div>
      <div class="cell">B-Value</div><div class="cell big" id="d${idx}_c_bval" style="grid-column:2/5">-</div>
    </div>
  `;
  allResults.appendChild(sheet);
}

  const num = val;  // 별칭 (자동 계산기와 수동 계산기 모두 사용)
  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

  // ===== 수동 계산기 =====
  function manualCalcOne(idx){
    const nm = (document.getElementById(`d${idx}_name`).value||'').trim();
    setText(`d${idx}_name_display`, nm ? nm : `드래곤 ${idx}`);

    const lvl = document.getElementById(`d${idx}_m_level`).value;
    const type = document.getElementById(`d${idx}_m_type`).value;
    const base = dragon[lvl][type];

    // 젬 합산
    let g_hp=0, g_atk=0, g_df=0;
    for(let i=1;i<=5;i++){
      const t=document.getElementById(`d${idx}_slot_type_${i}`).value;
      const v=Number(document.getElementById(`d${idx}_slot_val_${i}`).value||0);
      let hp=0, atk=0, df=0;
      if(t==="HP") hp=v; if(t==="ATK") atk=v; if(t==="DEF") df=v;
      g_hp+=hp; g_atk+=atk; g_df+=df;
      setText(`d${idx}_c_g${i}_hp`, hp); setText(`d${idx}_c_g${i}_atk`, atk); setText(`d${idx}_c_g${i}_df`, df);
    }
    const gem = new Stats(g_hp,g_atk,g_df);

    // 장신구/인첸트 (계산은 합산해서, 표기는 분리)
    const accOnly = new Stats(num(`d${idx}_m_acc_hp`)/100, num(`d${idx}_m_acc_atk`)/100, num(`d${idx}_m_acc_df`)/100);
    const enchOnly = new Stats(num(`d${idx}_m_ench_hp`)/100, num(`d${idx}_m_ench_atk`)/100, num(`d${idx}_m_ench_df`)/100);
    const acc = new Stats(accOnly.hp+enchOnly.hp, accOnly.atk+enchOnly.atk, accOnly.df+enchOnly.df);

    const pend = new Stats(num(`d${idx}_m_pend_hp`)/100, num(`d${idx}_m_pend_atk`)/100, num(`d${idx}_m_pend_df`)/100);

    // 정령/버프/디버프
    const spf = new Stats(num(`d${idx}_sf_hp`), num(`d${idx}_sf_atk`), num(`d${idx}_sf_df`));
    const spp = new Stats(num(`d${idx}_sp_hp`)/100, num(`d${idx}_sp_atk`)/100, num(`d${idx}_sp_df`)/100);
    const spe = new Stats(num(`d${idx}_se_hp`), num(`d${idx}_se_atk`), num(`d${idx}_se_df`));
    const bf  = new Stats(num(`d${idx}_bf_hp`)/100, num(`d${idx}_bf_atk`)/100, num(`d${idx}_bf_df`)/100);
    const db  = new Stats(num(`d${idx}_db_hp`)/100, num(`d${idx}_db_atk`)/100, num(`d${idx}_db_df`)/100);

    // 상수
    const pot = new Stats(24,6,6);
    const col = new Stats(240,60,60);

    const [fin, E, B] = calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);

    // 결과 시트
    setText(`d${idx}_c_base_hp`, base.hp);
    setText(`d${idx}_c_base_atk`, base.atk);
    setText(`d${idx}_c_base_df`, base.df);

    // 퍼센트 표기(분리)
    setText(`d${idx}_c_acc_hp`, (accOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_atk`, (accOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_df`, (accOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_ench_hp`, (enchOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_atk`, (enchOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_df`, (enchOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_pend_hp`, document.getElementById(`d${idx}_m_pend_hp`).value + '%');
    setText(`d${idx}_c_pend_atk`, document.getElementById(`d${idx}_m_pend_atk`).value + '%');
    setText(`d${idx}_c_pend_df`, document.getElementById(`d${idx}_m_pend_df`).value + '%');

    setText(`d${idx}_c_spf_hp`, spf.hp); setText(`d${idx}_c_spf_atk`, spf.atk); setText(`d${idx}_c_spf_df`, spf.df);
    setText(`d${idx}_c_spp_hp`, (spp.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_atk`, (spp.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_df`, (spp.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_spe_hp`, spe.hp); setText(`d${idx}_c_spe_atk`, spe.atk); setText(`d${idx}_c_spe_df`, spe.df);
    setText(`d${idx}_c_bf_hp`, (bf.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_atk`, (bf.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_df`, (bf.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_db_hp`, (db.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_db_atk`, (db.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_db_df`, (db.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_fin_hp`, fin.hp);
    setText(`d${idx}_c_fin_atk`, fin.atk);
    setText(`d${idx}_c_fin_df`, fin.df);
    setText(`d${idx}_c_eval`, Math.round(E).toString());
    setText(`d${idx}_c_bval`, (B/1e6).toFixed(3));  // 단위 ‘M’ 표시 없음
  }

  function manualCalcAll(){
    ManualDragonState.dragons.forEach(dragon => {
      manualCalcOne(dragon.displayNumber);
    });
  }

  function savePngAll(){
    const node = document.getElementById('allResults');
    manualCalcAll(); // 최신 값 보장
    const w = node.scrollWidth;
    const h = node.scrollHeight;

    html2canvas(node, {
      backgroundColor: null,
      scale: 2,
      width:  w,
      height: h,
      windowWidth:  w,
      windowHeight: h
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='dragon_calculate.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  const autoDiv=document.getElementById('autoCalc');
  const resultDiv=document.getElementById('resultCalc');
  const manualDiv=document.getElementById('manualCalc');
  const serverDiv=document.getElementById('serverCalc');
  const btnAuto=document.getElementById('btnAuto');
  const btnResult=document.getElementById('btnResult');
  const btnManual=document.getElementById('btnManual');
  const btnServer=document.getElementById('btnServer');

  // 각 모드의 독립적인 스크롤 위치 저장
  let autoScrollPos = 0;
  let resultScrollPos = 0;
  let manualScrollPos = 0;
  let serverScrollPos = 0;

  // ===== UI 모드 전환 =====
  function switchMode(mode){
    if(mode==='auto'){
      resultScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      autoDiv.classList.add('active');
      resultDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnAuto.classList.add('active');
      btnResult.classList.remove('active');
      btnManual.classList.remove('active');
      btnServer.classList.remove('active');

      window.scrollTo(0, autoScrollPos);
    }else if(mode==='result'){
      autoScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      resultDiv.classList.add('active');
      autoDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnResult.classList.add('active');
      btnAuto.classList.remove('active');
      btnManual.classList.remove('active');
      btnServer.classList.remove('active');

      window.scrollTo(0, resultScrollPos);
    }else if(mode==='manual'){
      autoScrollPos = window.scrollY;
      resultScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      manualDiv.classList.add('active');
      autoDiv.classList.remove('active');
      resultDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnManual.classList.add('active');
      btnAuto.classList.remove('active');
      btnResult.classList.remove('active');
      btnServer.classList.remove('active');

      window.scrollTo(0, manualScrollPos);
    }else if(mode==='server'){
      autoScrollPos = window.scrollY;
      resultScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;

      serverDiv.classList.add('active');
      autoDiv.classList.remove('active');
      resultDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      btnServer.classList.add('active');
      btnAuto.classList.remove('active');
      btnResult.classList.remove('active');
      btnManual.classList.remove('active');

      window.scrollTo(0, serverScrollPos);
      loadSlotList(); // 슬롯 목록 로드
    }
  }
  btnAuto.onclick=()=>switchMode('auto');
  btnResult.onclick=()=>switchMode('result');
  btnManual.onclick=()=>switchMode('manual');
  btnServer.onclick=()=>switchMode('server');

  // 잠금/공유 선택 시 비밀번호 입력란 표시
  document.querySelectorAll('input[name="slotType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const isPrivate = document.querySelector('input[name="slotType"]:checked').value === 'private';
      document.getElementById('slotPasswordRow').style.display = isPrivate ? 'flex' : 'none';
    });
  });

  // ===== Firebase 서버 관리 =====
  // 비밀번호 해싱 (SHA-256)
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  // 슬롯 만들기
  async function createSlot() {
    const name = document.getElementById('newSlotName').value.trim();
    if (!name) {
      alert('슬롯 이름을 입력해주세요.');
      return;
    }

    const type = document.querySelector('input[name="slotType"]:checked').value;
    const isPrivate = type === 'private';

    let passwordHash = null;
    if (isPrivate) {
      const password = document.getElementById('slotPassword').value;
      if (!password) {
        alert('비밀번호를 입력해주세요.');
        return;
      }
      passwordHash = await hashPassword(password);
    }

    const slotData = {
      name: name,
      type: type,
      passwordHash: passwordHash,
      createdAt: Date.now(),
      data: []
    };

    try {
      const newSlotRef = window.firebasePush(window.firebaseRef(window.firebaseDB, 'slots'));
      await window.firebaseSet(newSlotRef, slotData);

      alert(`슬롯 "${name}"이(가) 생성되었습니다!`);
      document.getElementById('newSlotName').value = '';
      document.getElementById('slotPassword').value = '';
      loadSlotList();
    } catch (error) {
      console.error('슬롯 생성 오류:', error);
      alert('슬롯 생성 중 오류가 발생했습니다.');
    }
  }

  // 슬롯 목록 로드
  function loadSlotList() {
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    window.firebaseOnValue(slotsRef, (snapshot) => {
      const slotListEl = document.getElementById('slotList');
      slotListEl.innerHTML = '';

      if (!snapshot.exists()) {
        slotListEl.innerHTML = '<p style="color:#999;text-align:center;padding:40px 0">저장된 슬롯이 없습니다.</p>';
        return;
      }

      const slots = snapshot.val();
      Object.keys(slots).forEach(slotId => {
        const slot = slots[slotId];
        const slotBox = document.createElement('div');
        slotBox.style.cssText = 'border:1px solid var(--border);background:#fff;border-radius:8px;padding:12px;margin-bottom:10px';

        const lockIcon = slot.type === 'private' ? '🔒 ' : '';
        const dataCount = slot.data ? slot.data.length : 0;
        const createdDate = new Date(slot.createdAt).toLocaleString('ko-KR');

        slotBox.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <strong style="font-size:16px">${lockIcon} ${slot.name}</strong>
              <div style="color:#666;font-size:12px;margin-top:4px">
                생성일: ${createdDate} | 저장된 데이터: ${dataCount}개
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" onclick="viewSlot('${slotId}')" style="background:#4CAF50;color:#fff;border-color:#4CAF50;">열람하기</button>
              <button class="btn" onclick="clearSlotData('${slotId}')" style="background:#ff9800;color:#fff;border-color:#ff9800;">데이터 비우기</button>
              <button class="btn" onclick="deleteSlot('${slotId}')" style="background:#f44336;color:#fff;border-color:#f44336;">슬롯 삭제</button>
            </div>
          </div>
        `;
        slotListEl.appendChild(slotBox);
      });
    });
  }

  // 슬롯 열람
  async function viewSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    // 데이터 표시 - 모달로 개선
    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('저장된 데이터가 없습니다.');
      return;
    }

    // 모달 생성
    let modalContent = `
      <div id="viewSlotModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ddd;padding-bottom:12px;">
            <h3 style="margin:0;color:#111;">📁 ${slot.name}</h3>
            <button class="btn" onclick="closeViewSlotModal()" style="padding:6px 12px;">닫기</button>
          </div>

          <!-- 상단 탭 및 검색/다운로드 -->
          <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="btnDetailView" onclick="switchViewMode('detail')" style="padding:8px 16px;">상세 보기</button>
              <button class="btn" id="btnSummaryView" onclick="switchViewMode('summary')" style="padding:8px 16px;">요약 통계</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="userSearchInput" type="text" placeholder="유저 검색..." style="padding:6px 12px;border:1px solid #aaa;border-radius:4px;width:150px;">
              <button class="btn" onclick="filterByUser()" style="padding:6px 12px;">🔍 검색</button>
              <button class="btn" id="btnExportStats" onclick="exportToExcel()" style="padding:6px 12px;background:#28a745;color:#fff;border-color:#28a745;display:none;">📊 통계 저장</button>
            </div>
          </div>

          <div id="viewSlotContent"></div>
          <div id="viewSlotSummary" style="display:none;"></div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // 데이터를 전역에 저장 (필터링 및 통계용)
    window._currentSlotData = dataList;

    // 상세 보기 초기 렌더링 (함수 정의 전이므로 setTimeout 사용)
    setTimeout(() => window.renderDetailView(dataList), 0);
  }

  // 열람 모달 닫기
  window.closeViewSlotModal = function() {
    const modal = document.getElementById('viewSlotModal');
    if (modal) modal.remove();
    delete window._currentSlotData;
    delete window._currentFilteredData;
  }

  // 뷰 모드 전환 (상세 보기 / 요약 통계)
  window.switchViewMode = function(mode) {
    const detailBtn = document.getElementById('btnDetailView');
    const summaryBtn = document.getElementById('btnSummaryView');
    const exportBtn = document.getElementById('btnExportStats');
    const contentDiv = document.getElementById('viewSlotContent');
    const summaryDiv = document.getElementById('viewSlotSummary');

    if (mode === 'detail') {
      detailBtn.classList.add('primary');
      summaryBtn.classList.remove('primary');
      contentDiv.style.display = 'block';
      summaryDiv.style.display = 'none';
      exportBtn.style.display = 'none';
    } else if (mode === 'summary') {
      detailBtn.classList.remove('primary');
      summaryBtn.classList.add('primary');
      contentDiv.style.display = 'none';
      summaryDiv.style.display = 'block';
      exportBtn.style.display = 'inline-block';
      renderSummaryStats();
    }
  }

  // 요약 통계 렌더링
  window.renderSummaryStats = function() {
    const summaryDiv = document.getElementById('viewSlotSummary');
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      summaryDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px 0;">표시할 데이터가 없습니다.</p>';
      return;
    }

    // 동적 드래곤 수 계산 (첫 번째 엔트리 기준)
    const maxDragons = Math.max(...dataList.map(entry => entry.dragons?.length || 0), 3);

    let headerCols = '';
    for (let i = 1; i <= maxDragons; i++) {
      headerCols += `<th style="padding:12px;text-align:center;border:1px solid #ddd;">드래곤${i} (비벨)</th>`;
    }

    let summaryHtml = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#2d6cdf;color:#fff;">
              <th style="padding:12px;text-align:left;border:1px solid #ddd;">유저이름</th>
              ${headerCols}
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">합계</th>
            </tr>
          </thead>
          <tbody>
    `;

    dataList.forEach((entry, index) => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });

      const total = bValues.reduce((sum, val) => sum + val, 0);
      const rowBg = index % 2 === 0 ? '#f9f9f9' : '#fff';

      let dataCols = '';
      for (let i = 0; i < maxDragons; i++) {
        const value = bValues[i] !== undefined ? bValues[i].toFixed(3) : '-';
        dataCols += `<td style="padding:10px;border:1px solid #ddd;text-align:center;">${value}</td>`;
      }

      summaryHtml += `
        <tr style="background:${rowBg};">
          <td style="padding:10px;border:1px solid #ddd;font-weight:600;">${entry.userName}</td>
          ${dataCols}
          <td style="padding:10px;border:1px solid #ddd;text-align:center;font-weight:700;background:#e3f2fd;">${total.toFixed(3)}</td>
        </tr>
      `;
    });

    summaryHtml += `
          </tbody>
        </table>
      </div>
    `;

    summaryDiv.innerHTML = summaryHtml;
  }

  // 유저 검색 필터
  window.filterByUser = function() {
    const searchInput = document.getElementById('userSearchInput');
    const searchTerm = searchInput.value.trim().toLowerCase();

    if (!searchTerm) {
      // 검색어가 없으면 전체 데이터 표시
      window._currentFilteredData = null;
      renderDetailView(window._currentSlotData);
      renderSummaryStats();
      return;
    }

    // 검색어로 필터링
    const filtered = window._currentSlotData.filter(entry =>
      entry.userName.toLowerCase().includes(searchTerm)
    );

    if (filtered.length === 0) {
      alert(`"${searchInput.value}" 유저를 찾을 수 없습니다.`);
      return;
    }

    window._currentFilteredData = filtered;
    renderDetailView(filtered);
    renderSummaryStats();
  }

  // 상세 보기 재렌더링
  window.renderDetailView = function(dataList) {
    const contentDiv = document.getElementById('viewSlotContent');
    contentDiv.innerHTML = '';

    dataList.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.style.cssText = 'border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9f9f9;';

      let entryHtml = `
        <div style="background:#2d6cdf;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
          <strong style="font-size:16px;">[${index + 1}] ${entry.userName}</strong>
          <span style="font-size:12px;opacity:0.9;">${new Date(entry.timestamp).toLocaleString('ko-KR')}</span>
        </div>
      `;

      entry.dragons.forEach((dragon, dragonIdx) => {
        const dragonName = dragon.name || `드래곤 ${dragonIdx + 1}`;

        // 저장된 결과값 사용
        const finalStats = dragon.finalStats || { hp: 0, atk: 0, df: 0 };
        const eValue = dragon.eValue || 0;
        const bValue = dragon.bValue || 0;

        entryHtml += `
          <div style="border:1px solid #ccc;border-radius:6px;padding:12px;margin-bottom:10px;background:#fff;">
            <h4 style="margin:0 0 10px;color:#2d6cdf;border-bottom:1px solid #eee;padding-bottom:6px;">${dragonName}</h4>

            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:12px;border-radius:6px;margin-bottom:12px;">
              <div style="font-size:14px;font-weight:700;margin-bottom:8px;">📊 최종 계산 결과</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;font-size:13px;">
                <div><strong>HP:</strong> ${finalStats.hp.toLocaleString()}</div>
                <div><strong>ATK:</strong> ${finalStats.atk.toLocaleString()}</div>
                <div><strong>DEF:</strong> ${finalStats.df.toLocaleString()}</div>
              </div>
              <div style="border-top:1px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">E-Value (이벨)</div>
                  <div style="font-size:18px;font-weight:900;">${eValue.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">B-Value (비벨)</div>
                  <div style="font-size:18px;font-weight:900;">${bValue.toFixed(3)}</div>
                </div>
              </div>
            </div>

            <!-- 기본 정보만 표시 -->
            <div style="display:grid !important;grid-template-columns:1fr 1fr !important;gap:15px;font-size:13px;">

              <!-- 기본 정보 -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>등급/타입:</strong><br>${dragon.level} / ${dragon.type}</div>
              </div>

            </div>
          </div>
        `;
      });

      entryDiv.innerHTML = entryHtml;
      contentDiv.appendChild(entryDiv);
    });
  }

  // 엑셀 다운로드 (CSV 형식)
  window.exportToExcel = function() {
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      alert('내보낼 데이터가 없습니다.');
      return;
    }

    // 동적 드래곤 수 계산
    const maxDragons = Math.max(...dataList.map(entry => entry.dragons?.length || 0), 3);

    // CSV 헤더
    let headerCols = [];
    for (let i = 1; i <= maxDragons; i++) {
      headerCols.push(`드래곤${i}`);
    }
    let csv = `유저이름,${headerCols.join(',')},합계\n`;

    // CSV 데이터
    dataList.forEach(entry => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });
      const total = bValues.reduce((sum, val) => sum + val, 0);

      let dataCols = [];
      for (let i = 0; i < maxDragons; i++) {
        const value = bValues[i] !== undefined ? bValues[i].toFixed(3) : '0.000';
        dataCols.push(value);
      }

      csv += `${entry.userName},${dataCols.join(',')},${total.toFixed(3)}\n`;
    });

    // BOM 추가 (한글 깨짐 방지)
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `dragon_stats_${new Date().getTime()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  // 슬롯의 데이터만 비우기 (슬롯은 유지) - 선택 삭제 방식
  async function clearSlotData(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('삭제할 데이터가 없습니다.');
      return;
    }

    // 삭제할 데이터 선택 모달 표시
    showDeleteSelectionModal(slotId, slot.name, dataList);
  }

  // 데이터 선택 삭제 모달
  function showDeleteSelectionModal(slotId, slotName, dataList) {
    const modalId = 'deleteSelectionModal';

    // 기존 모달이 있으면 제거
    const existingModal = document.getElementById(modalId);
    if (existingModal) existingModal.remove();

    const modalContent = `
      <div id="${modalId}" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999;padding:20px;box-sizing:border-box;">
        <div style="background:#fff;border-radius:12px;max-width:800px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3);">

          <!-- 헤더 -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;font-size:20px;">🗑️ "${slotName}" 데이터 선택 삭제</h2>
            <button onclick="document.getElementById('${modalId}').remove()" style="background:none;border:none;color:#fff;font-size:28px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;line-height:1;">&times;</button>
          </div>

          <!-- 안내 메시지 -->
          <div style="padding:15px 20px;background:#fff3cd;border-bottom:1px solid #ffc107;color:#856404;">
            <strong>⚠️ 주의:</strong> 선택한 데이터는 영구적으로 삭제됩니다. (총 ${dataList.length}개)
          </div>

          <!-- 전체 선택 컨트롤 -->
          <div style="padding:15px 20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:bold;">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="width:18px;height:18px;cursor:pointer;">
              <span>전체 선택</span>
            </label>
            <span id="selectedCount" style="color:#666;font-size:14px;">선택: 0개</span>
          </div>

          <!-- 데이터 목록 -->
          <div id="deleteDataList" style="flex:1;overflow-y:auto;padding:15px 20px;">
            ${dataList.map((entry, index) => {
              const timestamp = new Date(entry.timestamp).toLocaleString('ko-KR');
              const dragonCount = entry.dragons ? entry.dragons.length : 0;

              return `
                <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:10px;background:#f9f9f9;display:flex;align-items:center;gap:12px;">
                  <input type="checkbox" class="data-checkbox" data-index="${index}" onchange="updateSelectedCount()" style="width:18px;height:18px;cursor:pointer;flex-shrink:0;">
                  <div style="flex:1;">
                    <div style="font-weight:bold;color:#2d6cdf;margin-bottom:4px;">[${index + 1}] ${entry.userName}</div>
                    <div style="font-size:13px;color:#666;">
                      <span>📅 ${timestamp}</span>
                      <span style="margin-left:12px;">🐉 드래곤 ${dragonCount}마리</span>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- 하단 버튼 -->
          <div style="padding:15px 20px;background:#f8f9fa;border-top:1px solid #dee2e6;display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="document.getElementById('${modalId}').remove()" style="padding:10px 20px;background:#6c757d;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;">취소</button>
            <button onclick="executeDeleteSelected('${slotId}')" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">선택 항목 삭제</button>
          </div>

        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // 전체 선택/해제 함수
    window.toggleSelectAll = function() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.data-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
      updateSelectedCount();
    };

    // 선택 개수 업데이트 함수
    window.updateSelectedCount = function() {
      const checkboxes = document.querySelectorAll('.data-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      document.getElementById('selectedCount').textContent = `선택: ${checkedCount}개`;

      // 전체 선택 체크박스 상태 업데이트
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      selectAllCheckbox.checked = checkedCount === checkboxes.length && checkedCount > 0;
    };

    // 선택 항목 삭제 실행 함수
    window.executeDeleteSelected = async function(slotId) {
      const checkboxes = document.querySelectorAll('.data-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
      }

      const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

      if (!confirm(`선택한 ${selectedIndices.length}개의 데이터를 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
        return;
      }

      try {
        // 슬롯 데이터 다시 가져오기
        const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
        const snapshot = await window.firebaseGet(slotRef);

        if (!snapshot.exists()) {
          alert('슬롯을 찾을 수 없습니다.');
          return;
        }

        const slot = snapshot.val();
        const currentData = slot.data || [];

        // 선택되지 않은 항목만 남기기 (인덱스 역순으로 정렬하여 안전하게 삭제)
        const newData = currentData.filter((_, index) => !selectedIndices.includes(index));

        // Firebase 업데이트
        const dataRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}/data`);
        await window.firebaseSet(dataRef, newData);

        alert(`${selectedIndices.length}개의 데이터가 삭제되었습니다.`);

        // 모달 닫기
        document.getElementById('deleteSelectionModal').remove();

        // 슬롯 목록 새로고침
        loadSlotList();
      } catch (error) {
        console.error('데이터 삭제 오류:', error);
        alert('데이터 삭제 중 오류가 발생했습니다.');
      }
    };
  }

  // 슬롯 완전 삭제
  async function deleteSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('슬롯을 찾을 수 없습니다.');
      return;
    }

    const slot = snapshot.val();

    // 잠금된 슬롯은 비밀번호 확인
    if (slot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    if (!confirm(`"${slot.name}" 슬롯을 완전히 삭제하시겠습니까?\n\n⚠️ 슬롯과 모든 데이터가 영구적으로 삭제됩니다.\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
      return;
    }

    // 한 번 더 확인
    const confirmText = prompt('정말로 삭제하시려면 "삭제"를 입력하세요:');
    if (confirmText !== '삭제') {
      alert('삭제가 취소되었습니다.');
      return;
    }

    try {
      await window.firebaseSet(slotRef, null);
      alert(`"${slot.name}" 슬롯이 삭제되었습니다.`);
      loadSlotList();
    } catch (error) {
      console.error('슬롯 삭제 오류:', error);
      alert('슬롯 삭제 중 오류가 발생했습니다.');
    }
  }

  // 전역 함수로 노출
  window.clearSlotData = clearSlotData;
  window.deleteSlot = deleteSlot;

  // 페이지 로드 시 슬롯 목록 자동 로드 (Firebase 초기화 후)
  setTimeout(() => {
    if (window.firebaseDB) {
      loadSlotList();
    }
  }, 1000);

  // 수동계산기 데이터를 서버에 저장
  async function saveToServer() {
    // 슬롯 목록 먼저 가져오기
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    const snapshot = await window.firebaseGet(slotsRef);

    if (!snapshot.exists()) {
      alert('저장 가능한 슬롯이 없습니다.\n\n저장 서버 탭에서 슬롯을 먼저 생성해주세요.');
      return;
    }

    const slots = snapshot.val();
    const slotList = Object.keys(slots).map(id => ({id, ...slots[id]}));

    // 2. 슬롯 선택 모달 생성
    const modalHtml = `
      <div id="slotSelectModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:24px;">
          <h3 style="margin:0 0 16px;color:#111;">슬롯 선택</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">유저 이름</label>
            <input id="saveUserName" type="text" placeholder="이름을 입력하세요" style="width:100%;height:36px;border:1px solid #aaa;border-radius:6px;padding:0 12px;box-sizing:border-box;">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">저장할 슬롯</label>
            <div id="slotSelectList" style="border:1px solid #ddd;border-radius:6px;max-height:300px;overflow-y:auto;"></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="closeSlotModal()" style="padding:10px 20px;">취소</button>
            <button class="btn primary" onclick="confirmSlotSelection()" style="padding:10px 20px;">저장</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 3. 슬롯 목록 렌더링
    const slotSelectList = document.getElementById('slotSelectList');
    slotList.forEach((slot, index) => {
      const lockIcon = slot.type === 'private' ? '🔒 ' : '';
      const dataCount = slot.data ? slot.data.length : 0;

      const slotItem = document.createElement('div');
      slotItem.style.cssText = 'padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;';
      slotItem.innerHTML = `
        <input type="radio" name="selectedSlot" value="${index}" id="slot_${index}" style="margin-right:8px;">
        <label for="slot_${index}" style="cursor:pointer;display:inline;">
          <strong>${lockIcon} ${slot.name}</strong>
          <span style="color:#666;font-size:12px;margin-left:8px;">(${dataCount}개 저장됨)</span>
        </label>
      `;
      slotItem.addEventListener('mouseover', () => slotItem.style.background = '#f5f5f5');
      slotItem.addEventListener('mouseout', () => slotItem.style.background = '');
      slotItem.addEventListener('click', (e) => {
        if(e.target.tagName !== 'INPUT') {
          document.getElementById(`slot_${index}`).checked = true;
        }
      });
      slotSelectList.appendChild(slotItem);
    });

    // 슬롯 리스트를 전역에 저장
    window._slotList = slotList;
  }

  // 모달 닫기
  window.closeSlotModal = function() {
    const modal = document.getElementById('slotSelectModal');
    if (modal) modal.remove();
    delete window._slotList;
  }

  // 슬롯 선택 확정 및 저장
  window.confirmSlotSelection = async function() {
    const userName = document.getElementById('saveUserName')?.value?.trim();
    if (!userName) {
      alert('유저 이름을 입력해주세요.');
      return;
    }

    const selectedRadio = document.querySelector('input[name="selectedSlot"]:checked');
    if (!selectedRadio) {
      alert('저장할 슬롯을 선택해주세요.');
      return;
    }

    const selectedIndex = parseInt(selectedRadio.value);
    const selectedSlot = window._slotList[selectedIndex];

    // 잠금 슬롯이면 비밀번호 확인
    if (selectedSlot.type === 'private') {
      const password = prompt('비밀번호를 입력하세요:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== selectedSlot.passwordHash) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }
    }

    // Helper 함수: 텍스트 값 가져오기
    const getText = (id) => {
      const el = document.getElementById(id);
      return el ? el.textContent.trim() : '';
    };

    // Helper 함수: 숫자 값 가져오기
    const getNum = (id) => {
      const el = document.getElementById(id);
      const text = el ? el.textContent.trim() : '0';
      return Number(text.replace(/,/g, '')) || 0;
    };

    // 동적 드래곤 수에 맞게 계산된 결과값 수집
    const dragons = [];
    ManualDragonState.dragons.forEach(dragon => {
      const i = dragon.displayNumber;
      const dragonData = {
        name: document.getElementById(`d${i}_name`)?.value || '',
        level: document.getElementById(`d${i}_m_level`)?.value || '9.0',
        type: document.getElementById(`d${i}_m_type`)?.value || '공격형',
        // 계산된 최종 결과값
        finalStats: {
          hp: getNum(`d${i}_c_fin_hp`),
          atk: getNum(`d${i}_c_fin_atk`),
          df: getNum(`d${i}_c_fin_df`)
        },
        eValue: getNum(`d${i}_c_eval`),
        bValue: parseFloat(getText(`d${i}_c_bval`)) || 0
      };

      dragons.push(dragonData);
    });

    // Firebase에 저장
    const saveData = {
      userName: userName,
      timestamp: Date.now(),
      dragons: dragons
    };

    try {
      const currentData = selectedSlot.data || [];
      currentData.push(saveData);

      const slotRef = window.firebaseRef(window.firebaseDB, `slots/${selectedSlot.id}/data`);
      await window.firebaseSet(slotRef, currentData);

      closeSlotModal();
      alert(`"${selectedSlot.name}" 슬롯에 저장되었습니다!`);
    } catch (error) {
      console.error('저장 오류:', error);
      alert('저장 중 오류가 발생했습니다.');
    }
  }
  </script>
</body>
</html>
