<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</title>
<style>
  :root{
    --bg:#ffffff; --ink:#1a1a1a;
    --card-bg:#f8f9fa; --border:#e5e7eb;
    --accent:#3b82f6; --accent-hover:#2563eb;
    --radius:12px; --radius-sm:8px;
    --shadow:0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-md:0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
  }
  body{font-family:-apple-system,BlinkMacSystemFont,"Malgun Gothic","ë§‘ì€ ê³ ë”•","Noto Sans KR","Apple SD Gothic Neo","Helvetica Neue",sans-serif;margin:24px;background:var(--bg);color:var(--ink);line-height:1.5}
  h2{margin:0 0 8px;font-weight:700;color:var(--ink)}
  .hint{color:#6b7280;margin-bottom:14px}
  .small{color:#9ca3af;font-size:12px}

  .header-fixed{position:sticky;top:0;background:var(--bg);z-index:100;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:20px}
  .modebar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab-btn{padding:10px 20px;border:none;background:transparent;cursor:pointer;border-radius:0;font-size:14px;font-weight:500;color:#6b7280;position:relative;transition:color 0.2s}
  .tab-btn:hover{color:var(--accent);background:#f3f4f6}
  .tab-btn.active{color:var(--accent);font-weight:600}
  .tab-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent);border-radius:1px}
  .btn{padding:10px 18px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:var(--radius-sm);font-size:14px;font-weight:500;transition:all 0.2s;box-shadow:var(--shadow)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:var(--shadow-md)}
  .btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
  .btn:hover{background:#f9fafb;border-color:#d1d5db}

  .calc-container{display:none;overflow-y:auto;height:100%}
  .calc-container.active{display:block}

  fieldset{background:var(--card-bg);border:none;padding:20px;margin-bottom:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
  legend{font-weight:700;font-size:15px;color:var(--ink);padding:0 4px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:8px}
  label{display:inline-flex;gap:6px;align-items:center;cursor:pointer;font-size:14px}
  input[type="number"],select{height:36px;border:1px solid var(--border);border-radius:var(--radius-sm);text-align:center;background:#fff;font-size:14px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="number"]:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
  input[type="text"]{height:36px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;padding:0 12px;font-size:14px;transition:border-color 0.2s,box-shadow 0.2s}
  input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
  input[type="checkbox"],input[type="radio"]{width:18px;height:18px;accent-color:var(--accent)}

  .acc-list{max-height:220px;overflow:auto;border:1px solid var(--border);padding:12px;background:#fff;border-radius:var(--radius-sm)}
  .toolbar{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}

  /* ì •ë ¹/ë²„í”„/ë””ë²„í”„ */
  .row-spirit{
    display:grid;
    grid-template-columns: 150px 90px 90px 90px auto;
    align-items:center;
    column-gap:8px;
    margin-bottom:6px
  }
  .row-spirit strong{text-align:right;padding-right:4px;font-weight:700}

  /* ìˆ˜ë™ê²°ê³¼ ì‹œíŠ¸ - ë°ì€ í…Œë§ˆ */
  .results-wrap{margin-top:16px}
  .results-row{display:inline-flex;gap:16px;align-items:flex-start;flex-wrap:nowrap}
  .sheet{
    background:#fff; color:var(--ink);
    padding:16px; border-radius:var(--radius);
    display:inline-block; min-width:530px;
    box-shadow:var(--shadow-md);
    border:1px solid var(--border);
  }
  .sheet .name{
    font-weight:700; font-size:18px; letter-spacing:.3px; margin-bottom:10px; text-align:center;
    color:var(--accent);
  }
  .grid{
    display:grid;
    grid-template-columns: 150px 120px 120px 120px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:var(--radius-sm);
    overflow:hidden;
  }
  .cell{
    border:1px solid var(--border);
    padding:8px 10px; line-height:1.3;
    font-size:13px; background:#fff;
    color:var(--ink);
  }
  .cell.h{background:#f1f5f9;font-weight:600;color:#475569}
  .cell.section{background:#e0f2fe;color:#0369a1;font-weight:700;text-align:center}
  .cell.sum{background:#f8fafc;border-color:var(--border);color:var(--ink);font-size:15px;font-weight:600}
  .cell.big{font-size:22px;font-weight:700;letter-spacing:1px;text-align:center;background:#eff6ff;color:var(--accent)}
  .center{text-align:center}
  .right{text-align:right}
  pre.result{
    white-space:pre; background:#f8fafc; color:var(--ink);
    padding:16px; border-radius:var(--radius-sm); min-height:220px;
    border:1px solid var(--border);
    font-family:'Consolas',monospace;
    font-size:13px;
    line-height:1.5;
  }

  /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    body{margin:12px;}
    .header-fixed{padding:12px 0;}
    h2{font-size:18px;}
    .hint{font-size:12px;}

    .modebar{gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .tab-btn{padding:8px 14px;font-size:13px;white-space:nowrap;}
    .btn{padding:8px 12px;font-size:13px;}

    .row{flex-direction:column;align-items:flex-start;gap:8px;}
    .row label{width:100%;}

    .row-spirit{
      grid-template-columns:1fr;
      gap:8px;
    }
    .row-spirit strong{text-align:left;padding-right:0;margin-bottom:4px;}
    .row-spirit input{width:100%;}

    input[type="number"],select,input[type="text"]{width:100% !important;box-sizing:border-box;height:40px;}

    .toolbar{gap:8px;}
    .toolbar .btn{font-size:12px;padding:8px 10px;}

    .acc-list{max-height:180px;font-size:13px;}

    fieldset{padding:14px;border-radius:var(--radius-sm);}
    legend{font-size:14px;}

    .sheet{
      min-width:unset;
      width:100%;
      padding:12px;
      overflow-x:auto;
    }
    .sheet .name{font-size:16px;}

    .grid{
      grid-template-columns:80px repeat(3, 1fr);
      font-size:11px;
      min-width:320px;
    }
    .cell{padding:6px 5px;font-size:11px;}
    .cell.h{font-size:10px;padding:5px 4px;}
    .cell.big{font-size:16px;}
    .cell.sum{font-size:12px;}
    .cell.section{grid-column:1/5 !important;}

    .results-row{flex-direction:column;gap:14px;}

    #pendant_auto_row{flex-direction:column;align-items:flex-start;}
    #pendant_stats_row{flex-direction:column;align-items:flex-start;}
    #pendant_manual{flex-direction:column;align-items:flex-start;gap:8px;}

    pre.result{font-size:12px;padding:12px;min-height:150px;overflow-x:auto;}
  }

  /* ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œë¡œ ìŒ“ê¸° */
  @media (max-width: 768px) {
    #viewSlotContent div[style*="grid-template-columns:1fr 1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }

  /* ===== 3ë‹¨ ë ˆì´ì•„ì›ƒ ===== */
  .calc-layout {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    align-items: start;
  }
  .calc-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  @media (max-width: 1024px) {
    .calc-layout {
      grid-template-columns: 1fr;
    }
  }

  /* ë“œë˜ê³¤ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .dragon-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }
  .dragon-card .info {
    flex: 1;
    font-size: 14px;
  }
  .dragon-card .info strong {
    color: var(--accent);
    font-size: 15px;
  }
  .dragon-card .btn-remove {
    background: #ff6b6b;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
  }
  .dragon-card .btn-remove:hover {
    background: #ee5a5a;
  }

  /* ë“œë˜ê³¤ ë¦¬ìŠ¤íŠ¸ */
  .dragon-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    padding: 8px 0;
  }

  /* ë“œë˜ê³¤ë³„ ì„¤ì • íƒ­ */
  .dragon-tabs {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 8px;
  }
  .dragon-tab {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
  }
  .dragon-tab:hover {
    background: #f3f4f6;
  }
  .dragon-tab.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }

  /* ë“œë˜ê³¤ë³„ ì„¤ì • íŒ¨ë„ */
  .dragon-settings-panel {
    display: none;
  }
  .dragon-settings-panel.active {
    display: block;
  }
</style>
</head>

<body>
  <div class="header-fixed">
    <h2>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</h2>
    <div class="modebar">
      <button class="tab-btn active" id="btnAuto">ìë™ ê³„ì‚°ê¸°</button>
      <button class="tab-btn" id="btnManual">ìˆ˜ë™ ê³„ì‚°ê¸°</button>
      <button class="tab-btn" id="btnServer">ì €ì¥ ì„œë²„</button>
    </div>
    <div class="hint small">ëª¨ë“  ì…ë ¥ì€ <b>HP / ATK / DEF</b> ìˆœì„œì…ë‹ˆë‹¤. Â· made by í—¬ë¦­ìŠ¤</div>
  </div>

  <div id="autoCalc" class="calc-container active">
    <div class="calc-layout">
      <!-- ===== ì™¼ìª½ ì»¬ëŸ¼: ê³„ì‚°ëª¨ë“œ, ë“œë˜ê³¤ ì¶”ê°€, ì ¬ ===== -->
      <div class="calc-column">
        <!-- ê³„ì‚° ëª¨ë“œ (ë§¨ ìœ„) -->
        <fieldset>
          <legend>ê³„ì‚° ëª¨ë“œ</legend>
          <div class="row">
            <label><input type="radio" name="calc_mode" value="normal" checked onchange="onCalcModeChange()">Normal (ë“œë˜ê³¤ë³„ ê°œë³„ ê³„ì‚°)</label>
          </div>
          <div class="row">
            <label><input type="radio" name="calc_mode" value="optimize" onchange="onCalcModeChange()">Optimize (ìµœì  ë°°ë¶„)</label>
          </div>
          <div id="topNRow" style="margin-top:8px;">
            <div class="row">Top N <input id="top_n" type="number" value="5" style="width:80px"></div>
          </div>
        </fieldset>

        <!-- ë“œë˜ê³¤ ì¶”ê°€ íŒ¨ë„ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì¶”ê°€ (ìµœëŒ€ 9ë§ˆë¦¬)</legend>
          <div class="row">
            <label>ë“±ê¸‰
              <select id="add_dragon_grade">
                <option value="7.0">7.0</option>
                <option value="8.0">8.0</option>
                <option value="9.0" selected>9.0</option>
              </select>
            </label>
            <label>íƒ€ì…
              <select id="add_dragon_type">
                <option value="ê³µê²©í˜•">ê³µê²©í˜•</option>
                <option value="ë°©ì–´í˜•">ë°©ì–´í˜•</option>
                <option value="ì²´ë ¥í˜•">ì²´ë ¥í˜•</option>
                <option value="ê³µë°©í˜•">ê³µë°©í˜•</option>
                <option value="ì²´ê³µí˜•">ì²´ê³µí˜•</option>
                <option value="ì²´ë°©í˜•">ì²´ë°©í˜•</option>
              </select>
            </label>
            <button class="btn primary" type="button" onclick="addDragon()">ì¶”ê°€</button>
          </div>
          <div id="dragonListDisplay" class="dragon-list">
            <p style="color:#999;text-align:center;padding:20px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
          </div>
        </fieldset>

        <!-- ì ¬ ì„ íƒ (ê³µí†µ) -->
        <fieldset>
          <legend>ì ¬ ì„ íƒ</legend>
          <div class="row">
            <strong>HP</strong>
            <label><input type="radio" name="gem_hp" value="160">160</label>
            <label><input type="radio" name="gem_hp" value="156" checked>156</label>
            <label><input type="radio" name="gem_hp" value="152">152</label>
            <label><input type="radio" name="gem_hp" value="148">148</label>
          </div>
          <div class="row">
            <strong>ATK</strong>
            <label><input type="radio" name="gem_atk" value="40">40</label>
            <label><input type="radio" name="gem_atk" value="39" checked>39</label>
            <label><input type="radio" name="gem_atk" value="38">38</label>
            <label><input type="radio" name="gem_atk" value="37">37</label>
          </div>
          <div class="row">
            <strong>DEF</strong>
            <label><input type="radio" name="gem_df" value="40">40</label>
            <label><input type="radio" name="gem_df" value="39" checked>39</label>
            <label><input type="radio" name="gem_df" value="38">38</label>
            <label><input type="radio" name="gem_df" value="37">37</label>
          </div>
        </fieldset>
      </div>

      <!-- ===== ê°€ìš´ë° ì»¬ëŸ¼: ì¥ì‹ êµ¬, íœë˜íŠ¸ ===== -->
      <div class="calc-column">
        <!-- ì¥ì‹ êµ¬ ì„ íƒ -->
        <fieldset>
          <legend>ì¥ì‹ êµ¬ ì„ íƒ</legend>
          <div class="toolbar">
            <button class="btn" type="button" id="btnToggleFavorites" onclick="toggleFavoritesFilter()">ì¦ê²¨ì°¾ê¸°ë§Œ</button>
            <button class="btn" type="button" onclick="toggleLevel(20)">Lv20</button>
            <button class="btn" type="button" onclick="toggleLevel(19)">Lv19</button>
            <button class="btn" type="button" onclick="toggleLevel(18)">Lv18</button>
            <button class="btn" type="button" onclick="toggleLevel(17)">Lv17</button>
            <button class="btn" type="button" onclick="selectNone()">í•´ì œ</button>
          </div>
          <div id="accList" class="acc-list"></div>

          <!-- ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ (Optimize ëª¨ë“œì—ì„œëŠ” ê°œìˆ˜ ì…ë ¥ í¬í•¨) -->
          <div id="selectedAccDisplay" style="margin-top:10px;padding:10px;background:#e8f5e9;border-radius:6px;display:none;">
            <div style="font-weight:700;color:#2e7d32;margin-bottom:6px;">ì„ íƒëœ ì¥ì‹ êµ¬:</div>
            <div id="selectedAccList" style="font-size:13px;"></div>
          </div>
        </fieldset>

        <!-- íœë˜íŠ¸ -->
        <fieldset>
          <legend>íœë˜íŠ¸</legend>
          <div class="row" style="margin-bottom:8px;">
            <label><input type="radio" name="pendant_ver" value="v1" checked>ìë™</label>
            <label><input type="radio" name="pendant_ver" value="v2">ì§€ì •</label>
            <label><input type="radio" name="pendant_ver" value="v3">ìˆ˜ë™</label>
          </div>
          <div class="row" id="pendant_auto_row">
            <label><input type="radio" name="pendant_mode" value="ë³„">ë³„</label>
            <label><input type="radio" name="pendant_mode" value="ë‹¬" checked>ë‹¬</label>
            <label><input type="radio" name="pendant_mode" value="íƒœì–‘">íƒœì–‘</label>
            <input id="pendant_value" type="number" value="12" style="width:60px;"> %
          </div>
          <div class="row" id="pendant_stats_row" style="margin-top:8px; display:none;">
            <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
            <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
            <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
          </div>
          <div id="pendant_manual" style="margin-top:8px; display:none;">
            HP <input id="pend_manual_hp" type="number" value="0" style="width:50px;">%
            ATK <input id="pend_manual_atk" type="number" value="0" style="width:50px;">%
            DEF <input id="pend_manual_df" type="number" value="0" style="width:50px;">%
          </div>
        </fieldset>

        <!-- ì •ë ¹/ë²„í”„/ë””ë²„í”„ -->
        <fieldset>
          <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„
            <button class="btn" type="button" onclick="resetAllDragonSpiritBuffs()" style="margin-left:8px;font-size:11px;padding:3px 8px;">ì´ˆê¸°í™”</button>
          </legend>
          <div id="dragonSpiritBuffContainer">
            <p style="color:#999;text-align:center;padding:20px 0;">ë“œë˜ê³¤ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
          </div>
        </fieldset>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ê³„ì‚° ë²„íŠ¼, ê²°ê³¼ ===== -->
      <div class="calc-column">
        <!-- ê³„ì‚° ë²„íŠ¼ -->
        <div class="toolbar" style="flex-direction:column;">
          <button class="btn primary" type="button" onclick="calcAuto()" style="width:100%;font-size:16px;padding:12px;">ê³„ì‚°í•˜ê¸°</button>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn" type="button" onclick="downloadTxt()">Excel ì €ì¥</button>
            <button class="btn" type="button" onclick="clearAllResults()" style="background:#ff9800;color:#fff;border-color:#ff9800;">ì´ˆê¸°í™”</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;">ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ê²°ê³¼ -->
        <fieldset>
          <legend>ê³„ì‚° ê²°ê³¼</legend>
          <div style="font-size:12px;color:#666;margin-bottom:8px;">ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ë™ê³„ì‚°ê¸°ë¡œ ê°’ì´ ì „ì†¡ë©ë‹ˆë‹¤.</div>
          <pre id="autoResult" class="result"></pre>
        </fieldset>
      </div>
    </div>
  </div>

  <div id="manualCalc" class="calc-container">
    <h3 style="margin:0 0 16px">ìˆ˜ë™ ê³„ì‚°ê¸° (ìµœëŒ€ 9ë§ˆë¦¬ ë¹„êµ)</h3>

    <div class="calc-layout">
      <!-- ===== ì™¼ìª½ ì»¬ëŸ¼: ë“œë˜ê³¤ ì¶”ê°€ ë° íƒ­ ===== -->
      <div class="calc-column" style="grid-column: 1 / 3;">
        <!-- ë“œë˜ê³¤ ì¶”ê°€ íŒ¨ë„ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì¶”ê°€ (ìˆ˜ë™ê³„ì‚°ê¸°)</legend>
          <div class="row">
            <label>ë“±ê¸‰
              <select id="add_manual_dragon_grade">
                <option value="7.0">7.0</option>
                <option value="8.0">8.0</option>
                <option value="9.0" selected>9.0</option>
              </select>
            </label>
            <label>íƒ€ì…
              <select id="add_manual_dragon_type">
                <option value="ê³µê²©í˜•">ê³µê²©í˜•</option>
                <option value="ë°©ì–´í˜•">ë°©ì–´í˜•</option>
                <option value="ì²´ë ¥í˜•">ì²´ë ¥í˜•</option>
                <option value="ê³µë°©í˜•">ê³µë°©í˜•</option>
                <option value="ì²´ê³µí˜•">ì²´ê³µí˜•</option>
                <option value="ì²´ë°©í˜•">ì²´ë°©í˜•</option>
              </select>
            </label>
            <button class="btn primary" type="button" onclick="addManualDragon()">ë“œë˜ê³¤ ì¶”ê°€</button>
            <span class="small" id="manualDragonCount">(í˜„ì¬: 3ë§ˆë¦¬)</span>
          </div>
        </fieldset>

        <!-- ë“œë˜ê³¤ íƒ­ -->
        <fieldset>
          <legend>ë“œë˜ê³¤ ì„¤ì •</legend>
          <div id="manualDragonTabs" class="dragon-tabs"></div>
          <div id="inputsWrap"></div>
        </fieldset>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ê³„ì‚°ë²„íŠ¼ ===== -->
      <div class="calc-column">
        <fieldset>
          <legend>ê³„ì‚° ë° ì €ì¥</legend>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn primary" onclick="manualCalcAll()" style="width:100%;">ìˆ˜ë™ ê³„ì‚°</button>
            <button class="btn" onclick="savePngAll()" style="width:100%;">ê²°ê³¼ë¥¼ PNGë¡œ ì €ì¥</button>
            <button class="btn" onclick="saveToServer()" style="background:#00aa88;color:#fff;border-color:#00aa88;width:100%;">ì„œë²„ì— ì €ì¥</button>
            <button class="btn" type="button" onclick="resetFavorites()" style="background:#ff6b6b;color:#fff;border-color:#ff6b6b;width:100%;">ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™”</button>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- ê²°ê³¼ ë“œë˜ê³¤ ì„ íƒ (4ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div id="dragonSelectPanel" style="display:none;margin-top:20px;padding:15px;background:#fff3e0;border-radius:8px;border:1px solid #ffcc80;">
      <div style="font-weight:bold;margin-bottom:10px;color:#e65100;">ğŸ“‹ ê²°ê³¼ì— í‘œì‹œí•  ë“œë˜ê³¤ ì„ íƒ (ìµœëŒ€ 3ê°œ)</div>
      <div id="dragonSelectCheckboxes" style="display:flex;gap:12px;flex-wrap:wrap;"></div>
    </div>

    <!-- ê²°ê³¼ ì‹œíŠ¸ (ê°€ë¡œ ë¹„êµ) -->
    <div class="results-wrap" style="margin-top:20px;">
      <div id="allResults" class="results-row"></div>
    </div>
  </div>

  <div id="serverCalc" class="calc-container">
    <h3 style="margin:0 0 16px">ì €ì¥ ì„œë²„</h3>

    <!-- ì €ì¥ ìŠ¬ë¡¯ ë§Œë“¤ê¸° -->
    <fieldset>
      <legend>ì €ì¥ ìŠ¬ë¡¯ ë§Œë“¤ê¸°</legend>
      <div class="row">
        <label>ìŠ¬ë¡¯ ì´ë¦„
          <input id="newSlotName" type="text" placeholder="" style="width:200px">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="slotType" value="public" checked>ê³µìœ  (ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥)</label>
        <label><input type="radio" name="slotType" value="private">ì ê¸ˆ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)</label>
      </div>
      <div class="row" id="slotPasswordRow" style="margin-top:8px;display:none">
        <label>ë¹„ë°€ë²ˆí˜¸
          <input id="slotPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:150px">
        </label>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="createSlot()">ìŠ¬ë¡¯ ë§Œë“¤ê¸°</button>
      </div>
    </fieldset>

    <!-- ì €ì¥ëœ ìŠ¬ë¡¯ ëª©ë¡ -->
    <fieldset>
      <legend>ì €ì¥ëœ ìŠ¬ë¡¯ ëª©ë¡</legend>
      <div id="slotList" style="min-height:200px">
        <p style="color:#999;text-align:center;padding:40px 0">ìŠ¬ë¡¯ì„ ìƒì„±í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </fieldset>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- SheetJS (Excel íŒŒì¼ ìƒì„±) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB90WAYMh6G8aWS3gzKw2wmT9X3O0zGoGw",
      authDomain: "dragon-calculator-8733b.firebaseapp.com",
      databaseURL: "https://dragon-calculator-8733b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dragon-calculator-8733b",
      storageBucket: "dragon-calculator-8733b.firebasestorage.app",
      messagingSenderId: "707550978178",
      appId: "1:707550978178:web:09607e55f05337c154949b"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
  </script>

  <script>
  // ===== ë°ì´í„° êµ¬ì¡° ì •ì˜ =====
  class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}

  // ===== ìƒˆë¡œìš´ ìƒíƒœ ê´€ë¦¬ êµ¬ì¡° =====
  class DragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;      // "7.0" | "8.0" | "9.0"
      this.type = type;        // "ê³µê²©í˜•" | "ë°©ì–´í˜•" | etc.
      this.pendant = { hp: 0, atk: 0, df: 0 };
      this.spirit = {
        flat: { hp: 0, atk: 0, df: 0 },
        pct: { hp: 0, atk: 0, df: 0 },
        extra: { hp: 0, atk: 0, df: 0 }
      };
      this.spiritSlots = {
        slot1: { stat: 'none', type: 'pct' },
        slot2: { stat: 'none', type: 'pct' },
        slot3: { stat: 'none', type: 'pct' },
        slot4: { stat: 'none', type: 'pct' },
        sub: 0
      };
      this.buff = { hp: 0, atk: 0, df: 0 };
      this.debuff = { hp: 0, atk: 0, df: 0 };
    }
  }

  const AppState = {
    dragons: [],
    maxDragons: 9,
    gems: { hp: 156, atk: 39, df: 39 },
    nextDragonId: 1
  };

  // ===== ë“œë˜ê³¤ ì¶”ê°€/ì œê±° í•¨ìˆ˜ =====
  function addDragon() {
    if (AppState.dragons.length >= AppState.maxDragons) {
      alert(`ìµœëŒ€ ${AppState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    const gradeSelect = document.getElementById('add_dragon_grade');
    const typeSelect = document.getElementById('add_dragon_type');
    const grade = gradeSelect ? gradeSelect.value : '9.0';
    const type = typeSelect ? typeSelect.value : 'ê³µê²©í˜•';

    const newDragon = new DragonConfig(AppState.nextDragonId++, grade, type);
    newDragon.displayNumber = AppState.dragons.length + 1;
    AppState.dragons.push(newDragon);

    renderDragonList();
    renderSpiritBuffSections();
  }

  function removeDragon(dragonId) {
    const index = AppState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    // ë“œë˜ê³¤ ì œê±°
    AppState.dragons.splice(index, 1);

    // ë¦¬ë„˜ë²„ë§
    AppState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });

    renderDragonList();
    renderSpiritBuffSections();
  }

  function renderDragonList() {
    const container = document.getElementById('dragonListDisplay');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      return;
    }

    container.innerHTML = AppState.dragons.map(d => `
      <div class="dragon-card">
        <div class="info">
          <strong>ë“œë˜ê³¤ ${d.displayNumber}</strong>
          <span style="margin-left:8px;color:#666;">${d.grade} / ${d.type}</span>
        </div>
        <button class="btn-remove" onclick="removeDragon(${d.id})">ì‚­ì œ</button>
      </div>
    `).join('');
  }

  function renderSpiritBuffSections() {
    const container = document.getElementById('dragonSpiritBuffContainer');
    if (!container) return;

    if (AppState.dragons.length === 0) {
      container.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">ë“œë˜ê³¤ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      return;
    }

    // íƒ­ ìƒì„±
    const tabsHtml = AppState.dragons.map((d, i) => `
      <button class="dragon-tab ${i === 0 ? 'active' : ''}" onclick="switchDragonTab(${d.id})" data-dragon-id="${d.id}">
        ë“œë˜ê³¤ ${d.displayNumber}
      </button>
    `).join('');

    // ì •ë ¹ ìŠ¬ë¡¯ ì˜µì…˜ ìƒì„± í•¨ìˆ˜ (ì €ì¥ëœ ê°’ ë°˜ì˜)
    const genStatOptions = (selected) => `
      <option value="none" ${selected === 'none' ? 'selected' : ''}>-</option>
      <option value="hp" ${selected === 'hp' ? 'selected' : ''}>HP</option>
      <option value="atk" ${selected === 'atk' ? 'selected' : ''}>ATK</option>
      <option value="df" ${selected === 'df' ? 'selected' : ''}>DEF</option>
    `;
    const genTypeOptions = (selected) => `
      <option value="flat" ${selected === 'flat' ? 'selected' : ''}>+</option>
      <option value="pct" ${selected === 'pct' ? 'selected' : ''}>%</option>
    `;
    const genSubOptions = (selected) => SPIRIT_SUB_OPTIONS.map((opt, i) =>
      `<option value="${i}" ${selected === i ? 'selected' : ''}>${opt.label}</option>`
    ).join('');

    // ê° ë“œë˜ê³¤ë³„ ì„¤ì • íŒ¨ë„
    const panelsHtml = AppState.dragons.map((d, i) => {
      const slots = d.spiritSlots || { slot1: {stat:'none',type:'flat'}, slot2: {stat:'none',type:'flat'}, slot3: {stat:'none',type:'flat'}, slot4: {stat:'none',type:'flat'}, sub: 0 };
      return `
      <div class="dragon-settings-panel ${i === 0 ? 'active' : ''}" id="dragonPanel_${d.id}">
        <div style="background:#e3f2fd;padding:8px 12px;border-radius:6px;margin-bottom:12px;">
          <strong style="color:#1565c0;">ë“œë˜ê³¤ ${d.displayNumber}</strong>
          <span style="margin-left:8px;color:#666;">(${d.grade} / ${d.type})</span>
        </div>

        <!-- ì…ë ¥ ëª¨ë“œ ì„ íƒ -->
        <div class="row" style="margin-bottom:10px;">
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="slot" checked onchange="toggleSpiritInputMode(${d.id})">ìŠ¬ë¡¯ ì„ íƒ</label>
          <label><input type="radio" name="dragon_${d.id}_input_mode" value="manual" onchange="toggleSpiritInputMode(${d.id})">ì§ì ‘ ì…ë ¥</label>
        </div>

        <!-- ìŠ¬ë¡¯ ì„ íƒ ëª¨ë“œ -->
        <div id="dragon_${d.id}_slot_mode">
          <div style="font-size:13px;margin-bottom:8px;color:#666;">ì •ë ¹ ìŠ¬ë¡¯ 1~4 ì„ íƒ:</div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>ìŠ¬ë¡¯ 1</strong>
            <select id="dragon_${d.id}_slot1_stat" onchange="calculateSpiritFromSlots(${d.id})">${genStatOptions(slots.slot1.stat)}</select>
            <select id="dragon_${d.id}_slot1_type" onchange="calculateSpiritFromSlots(${d.id})">${genTypeOptions(slots.slot1.type)}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>ìŠ¬ë¡¯ 2</strong>
            <select id="dragon_${d.id}_slot2_stat" onchange="calculateSpiritFromSlots(${d.id})">${genStatOptions(slots.slot2.stat)}</select>
            <select id="dragon_${d.id}_slot2_type" onchange="calculateSpiritFromSlots(${d.id})">${genTypeOptions(slots.slot2.type)}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:4px;">
            <strong>ìŠ¬ë¡¯ 3</strong>
            <select id="dragon_${d.id}_slot3_stat" onchange="calculateSpiritFromSlots(${d.id})">${genStatOptions(slots.slot3.stat)}</select>
            <select id="dragon_${d.id}_slot3_type" onchange="calculateSpiritFromSlots(${d.id})">${genTypeOptions(slots.slot3.type)}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 80px 60px;gap:6px;align-items:center;margin-bottom:8px;">
            <strong>ìŠ¬ë¡¯ 4</strong>
            <select id="dragon_${d.id}_slot4_stat" onchange="calculateSpiritFromSlots(${d.id})">${genStatOptions(slots.slot4.stat)}</select>
            <select id="dragon_${d.id}_slot4_type" onchange="calculateSpiritFromSlots(${d.id})">${genTypeOptions(slots.slot4.type)}</select>
          </div>
          <div style="display:grid;grid-template-columns:60px 140px;gap:6px;align-items:center;margin-bottom:8px;">
            <strong>ë¶€ê°€ì˜µ</strong>
            <select id="dragon_${d.id}_sub" onchange="calculateSpiritFromSlots(${d.id})">${genSubOptions(slots.sub)}</select>
          </div>
          <div id="dragon_${d.id}_spirit_summary"></div>
        </div>

        <!-- ì§ì ‘ ì…ë ¥ ëª¨ë“œ -->
        <div id="dragon_${d.id}_manual_mode" style="display:none;">
          <div style="font-weight:bold;color:black;margin-bottom:6px;">(HP / ATK / DEF)</div>
          <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
            <input id="dragon_${d.id}_sf_hp" type="number" value="${d.spirit.flat.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_atk" type="number" value="${d.spirit.flat.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sf_df" type="number" value="${d.spirit.flat.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
            <input id="dragon_${d.id}_sp_hp" type="number" value="${d.spirit.pct.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_atk" type="number" value="${d.spirit.pct.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_sp_df" type="number" value="${d.spirit.pct.df}" onchange="updateDragonSpirit(${d.id})">
            <span class="small">(% ì…ë ¥)</span>
          </div>
          <div class="row-spirit"><strong>ì •ë ¹ ì˜µ</strong>
            <input id="dragon_${d.id}_se_hp" type="number" value="${d.spirit.extra.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_atk" type="number" value="${d.spirit.extra.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_se_df" type="number" value="${d.spirit.extra.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
        </div>

        <!-- ë²„í”„/ë””ë²„í”„ (ê³µí†µ) -->
        <div style="border-top:1px solid #ddd;margin-top:12px;padding-top:12px;">
          <div style="font-weight:bold;color:black;margin-bottom:6px;">ë²„í”„ / ë””ë²„í”„ (%)</div>
          <div class="row-spirit"><strong>ë²„í”„ (%)</strong>
            <input id="dragon_${d.id}_bf_hp" type="number" value="${d.buff.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_bf_atk" type="number" value="${d.buff.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_bf_df" type="number" value="${d.buff.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
          <div class="row-spirit"><strong>ë””ë²„í”„ (%)</strong>
            <input id="dragon_${d.id}_db_hp" type="number" value="${d.debuff.hp}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_db_atk" type="number" value="${d.debuff.atk}" onchange="updateDragonSpirit(${d.id})">
            <input id="dragon_${d.id}_db_df" type="number" value="${d.debuff.df}" onchange="updateDragonSpirit(${d.id})">
          </div>
        </div>
      </div>
    `; }).join('');

    container.innerHTML = `
      <div class="dragon-tabs">${tabsHtml}</div>
      ${panelsHtml}
    `;

    // ê° ë“œë˜ê³¤ì˜ ì •ë ¹ ê°’ ì´ˆê¸° ê³„ì‚°
    AppState.dragons.forEach(d => {
      calculateSpiritFromSlots(d.id);
    });
  }

  function toggleSpiritInputMode(dragonId) {
    const mode = document.querySelector(`input[name="dragon_${dragonId}_input_mode"]:checked`)?.value;
    const slotMode = document.getElementById(`dragon_${dragonId}_slot_mode`);
    const manualMode = document.getElementById(`dragon_${dragonId}_manual_mode`);

    if (mode === 'slot') {
      slotMode.style.display = 'block';
      manualMode.style.display = 'none';
    } else {
      slotMode.style.display = 'none';
      manualMode.style.display = 'block';
    }
  }

  function switchDragonTab(dragonId) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    document.querySelector(`.dragon-tab[data-dragon-id="${dragonId}"]`)?.classList.add('active');
    document.getElementById(`dragonPanel_${dragonId}`)?.classList.add('active');
  }

  function updateDragonSpirit(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    dragon.spirit.flat.hp = Number(document.getElementById(`dragon_${dragonId}_sf_hp`)?.value || 0);
    dragon.spirit.flat.atk = Number(document.getElementById(`dragon_${dragonId}_sf_atk`)?.value || 0);
    dragon.spirit.flat.df = Number(document.getElementById(`dragon_${dragonId}_sf_df`)?.value || 0);
    dragon.spirit.pct.hp = Number(document.getElementById(`dragon_${dragonId}_sp_hp`)?.value || 0);
    dragon.spirit.pct.atk = Number(document.getElementById(`dragon_${dragonId}_sp_atk`)?.value || 0);
    dragon.spirit.pct.df = Number(document.getElementById(`dragon_${dragonId}_sp_df`)?.value || 0);
    dragon.spirit.extra.hp = Number(document.getElementById(`dragon_${dragonId}_se_hp`)?.value || 0);
    dragon.spirit.extra.atk = Number(document.getElementById(`dragon_${dragonId}_se_atk`)?.value || 0);
    dragon.spirit.extra.df = Number(document.getElementById(`dragon_${dragonId}_se_df`)?.value || 0);
    dragon.buff.hp = Number(document.getElementById(`dragon_${dragonId}_bf_hp`)?.value || 0);
    dragon.buff.atk = Number(document.getElementById(`dragon_${dragonId}_bf_atk`)?.value || 0);
    dragon.buff.df = Number(document.getElementById(`dragon_${dragonId}_bf_df`)?.value || 0);
    dragon.debuff.hp = Number(document.getElementById(`dragon_${dragonId}_db_hp`)?.value || 0);
    dragon.debuff.atk = Number(document.getElementById(`dragon_${dragonId}_db_atk`)?.value || 0);
    dragon.debuff.df = Number(document.getElementById(`dragon_${dragonId}_db_df`)?.value || 0);
  }

  // ===== ì •ë ¹ ìŠ¬ë¡¯ë³„ ìˆ˜ì¹˜ í…Œì´ë¸” =====
  const SPIRIT_FLAT_TBL = {
    1: { hp: 216, atk: 54, df: 54 },
    2: { hp: 240, atk: 60, df: 60 },
    3: { hp: 264, atk: 66, df: 66 },
    4: { hp: 480, atk: 120, df: 120 }
  };
  const SPIRIT_PCT_TBL = {
    1: { hp: 24, atk: 24, df: 24 },
    2: { hp: 28, atk: 28, df: 28 },
    3: { hp: 32, atk: 32, df: 32 },
    4: { hp: 40, atk: 40, df: 40 }
  };
  const SPIRIT_SUB_OPTIONS = [
    { label: 'ì—†ìŒ', hp: 0, atk: 0, df: 0 },
    { label: 'ì²´ë ¥40', hp: 40, atk: 0, df: 0 },
    { label: 'ê³µê²©ë ¥10', hp: 0, atk: 10, df: 0 },
    { label: 'ë°©ì–´ë ¥10', hp: 0, atk: 0, df: 10 }
  ];

  // ì •ë ¹ ìŠ¬ë¡¯ ì„ íƒì—ì„œ ê°’ ê³„ì‚°
  function calculateSpiritFromSlots(dragonId) {
    const dragon = AppState.dragons.find(d => d.id === dragonId);
    if (!dragon) return;

    let flatTotal = { hp: 0, atk: 0, df: 0 };
    let pctTotal = { hp: 0, atk: 0, df: 0 };
    let extraTotal = { hp: 0, atk: 0, df: 0 };

    // ìŠ¬ë¡¯ 1~4 ê³„ì‚° ë° ì €ì¥
    for (let slot = 1; slot <= 4; slot++) {
      const statEl = document.getElementById(`dragon_${dragonId}_slot${slot}_stat`);
      const typeEl = document.getElementById(`dragon_${dragonId}_slot${slot}_type`);
      if (!statEl || !typeEl) continue;

      const stat = statEl.value; // hp, atk, df, none
      const type = typeEl.value; // flat, pct

      // ìŠ¬ë¡¯ ì„ íƒê°’ ì €ì¥
      dragon.spiritSlots[`slot${slot}`] = { stat, type };

      if (stat && stat !== 'none') {
        if (type === 'flat') {
          flatTotal[stat] += SPIRIT_FLAT_TBL[slot][stat];
        } else if (type === 'pct') {
          pctTotal[stat] += SPIRIT_PCT_TBL[slot][stat];
        }
      }
    }

    // ë¶€ê°€ì˜µ ê³„ì‚° ë° ì €ì¥
    const subEl = document.getElementById(`dragon_${dragonId}_sub`);
    if (subEl) {
      const subIdx = parseInt(subEl.value) || 0;
      dragon.spiritSlots.sub = subIdx;
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      extraTotal.hp = sub.hp;
      extraTotal.atk = sub.atk;
      extraTotal.df = sub.df;
    }

    // DragonConfig ì—…ë°ì´íŠ¸
    dragon.spirit.flat = flatTotal;
    dragon.spirit.pct = pctTotal;
    dragon.spirit.extra = extraTotal;

    // í•©ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateSpiritSummary(dragonId, flatTotal, pctTotal, extraTotal);
  }

  function updateSpiritSummary(dragonId, flat, pct, extra) {
    const summaryEl = document.getElementById(`dragon_${dragonId}_spirit_summary`);
    if (summaryEl) {
      summaryEl.innerHTML = `
        <div style="background:#e8f5e9;padding:8px;border-radius:4px;font-size:12px;">
          <strong>ê³„ì‚°ëœ ì •ë ¹ ê°’:</strong><br>
          í”Œì˜µ: HP+${flat.hp} ATK+${flat.atk} DEF+${flat.df}<br>
          í¼ì˜µ: HP+${pct.hp}% ATK+${pct.atk}% DEF+${pct.df}%<br>
          ë¶€ê°€ì˜µ: HP+${extra.hp} ATK+${extra.atk} DEF+${extra.df}
        </div>
      `;
    }
  }

  // ë“œë˜ê³¤ ê¸°ë³¸ ìŠ¤íƒ¯ (ë“±ê¸‰ë³„/íƒ€ì…ë³„)
  const dragon={
   "7.0":{ê³µê²©í˜•:new Stats(876,285,161),ë°©ì–´í˜•:new Stats(788,185,283),ì²´ë ¥í˜•:new Stats(1252,176,176),ê³µë°©í˜•:new Stats(720,242,243),ì²´ê³µí˜•:new Stats(1080,262,133),ì²´ë°©í˜•:new Stats(1080,133,262)},
   "8.0":{ê³µê²©í˜•:new Stats(876,305,161),ë°©ì–´í˜•:new Stats(788,185,303),ì²´ë ¥í˜•:new Stats(1332,176,176),ê³µë°©í˜•:new Stats(720,252,253),ì²´ê³µí˜•:new Stats(1120,272,133),ì²´ë°©í˜•:new Stats(1120,133,272)},
   "9.0":{ê³µê²©í˜•:new Stats(876,325,161),ë°©ì–´í˜•:new Stats(788,185,323),ì²´ë ¥í˜•:new Stats(1412,176,176),ê³µë°©í˜•:new Stats(720,262,263),ì²´ê³µí˜•:new Stats(1160,282,133),ì²´ë°©í˜•:new Stats(1160,133,282)}
  };

  // ===== í•µì‹¬ ê³„ì‚° í•¨ìˆ˜ =====
  function eVal(s){return s.hp+4*s.atk+4*s.df;}
  function bVal(s){return s.hp*s.atk*s.df;}

  // ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚° (ëª¨ë“  ë³´ë„ˆìŠ¤ ì ìš©)
  function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
    const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
    const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
    const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                       Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                       Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
    const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
    const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
    const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
    const f = new Stats(
      s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
      s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
      s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
    );
    return [f, eVal(f), bVal(f)];
  }

  // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
  // ëª¨ë“  ë“œë˜ê³¤ì˜ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ì´ˆê¸°í™”
  function resetAllDragonSpiritBuffs() {
    AppState.dragons.forEach(dragon => {
      dragon.spirit.flat = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.pct = { hp: 0, atk: 0, df: 0 };
      dragon.spirit.extra = { hp: 0, atk: 0, df: 0 };
      dragon.buff = { hp: 0, atk: 0, df: 0 };
      dragon.debuff = { hp: 0, atk: 0, df: 0 };
    });
    renderSpiritBuffSections();
  }

  // ===== ì¥ì‹ êµ¬ ì¦ê²¨ì°¾ê¸° ê´€ë¦¬ =====
  function resetFavorites() {
    const confirmed = confirm(
      'ì¥ì‹ êµ¬ ì¦ê²¨ì°¾ê¸°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
      'â€» ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    );

    if (confirmed) {
      try {
        localStorage.removeItem('accFavorites');
        alert('ì¦ê²¨ì°¾ê¸°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        location.reload();
      } catch (e) {
        console.error('ì¦ê²¨ì°¾ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  }

  // ===== ì¥ì‹ êµ¬ ë°ì´í„° í…Œì´ë¸” =====
  // í˜•ì‹: [ì´ë¦„, ë ˆë²¨, HP%, ATK%, DEF%]
  const ACC_TABLE = [ ["ì•…ë³´(ì²´)",20,20,0,0], ["ì—¬ë³´(ë°©)",20,0,0,20], ["í™©ë³´(ê³µ)",20,0,20,0], ["ë°”ë¿”(ê³µ/ë°©)",20,0,10,10], ["ë°”ë¿”(ì²´/ë°©)",20,10,0,10], ["ë°”ë¿”(ì²´/ê³µ)",20,10,10,0],
    ["ë°”ë¿”(ê³µ/ë°©)",19,0,10,9],["ë°”ë¿”(ì²´/ë°©)",19,10,0,9],["ë°”ë¿”(ê³µ/ì²´)",19,9,10,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",19,6,13,0],["ë¶ˆë¿”(ê³µ/ë°©)",19,0,13,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",19,13,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",19,13,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",19,0,6,13],["ëŒ€ë¿”(ë°©/ì²´)",19,6,0,13],
    ["ì—¬ë³´",19,0,0,19],["í™©ë³´",19,0,19,0],["ì•…ë³´",19,19,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",18,0,9,9],["ë°”ë¿”(ì²´/ë°©)",18,9,0,9],["ë°”ë¿”(ê³µ/ì²´)",18,9,9,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",18,6,12,0],["ë¶ˆë¿”(ê³µ/ë°©)",18,0,12,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",18,12,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",18,12,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",18,0,6,12],["ëŒ€ë¿”(ë°©/ì²´)",18,6,0,12],
    ["ì—¬ë³´",18,0,0,18],["í™©ë³´",18,0,18,0],["ì•…ë³´",18,18,0,0],
    ["ë°”ë¿”(ê³µ/ë°©)",17,0,9,8],["ë°”ë¿”(ì²´/ë°©)",17,9,0,8],["ë°”ë¿”(ê³µ/ì²´)",17,9,8,0],
    ["ë¶ˆë¿”(ê³µ/ì²´)",17,6,11,0],["ë¶ˆë¿”(ê³µ/ë°©)",17,0,11,6],
    ["ë¬¼ë¿”(ì²´/ë°©)",17,11,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",17,11,6,0],
    ["ëŒ€ë¿”(ë°©/ê³µ)",17,0,6,11],["ëŒ€ë¿”(ë°©/ì²´)",17,6,0,11],
    ["ì—¬ë³´",17,0,0,17],["í™©ë³´",17,0,17,0],["ì•…ë³´",17,17,0,0],
  ];

  // ì „ì—­ ë³€ìˆ˜
  let accCheckboxes = [];
  let accFavorites = new Set();
  let showOnlyFavorites = false;

  // ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
  function loadFavorites() {
    try {
      const saved = localStorage.getItem('accFavorites');
      if (saved) {
        accFavorites = new Set(JSON.parse(saved));
      }
    } catch (e) {
      console.error('ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    }
  }

  // ì¦ê²¨ì°¾ê¸° ì €ì¥
  function saveFavorites() {
    try {
      localStorage.setItem('accFavorites', JSON.stringify([...accFavorites]));
    } catch (e) {
      console.error('ì¦ê²¨ì°¾ê¸° ì €ì¥ ì‹¤íŒ¨:', e);
    }
  }

  // ì¦ê²¨ì°¾ê¸° í† ê¸€
  function toggleFavorite(accId) {
    if (accFavorites.has(accId)) {
      accFavorites.delete(accId);
    } else {
      accFavorites.add(accId);
    }
    saveFavorites();
    renderAccessories();
  }

  function renderAccessories() {
    const accListEl = document.getElementById('accList');
    accListEl.innerHTML = '';
    accCheckboxes = [];

    // ì¦ê²¨ì°¾ê¸° ì •ë ¬: ì¦ê²¨ì°¾ê¸°ê°€ ìœ„ë¡œ
    const sortedTable = [...ACC_TABLE].map((r, i) => ({ data: r, index: i }))
      .sort((a, b) => {
        const aFav = accFavorites.has('acc_' + a.index);
        const bFav = accFavorites.has('acc_' + b.index);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return 0;
      });

    sortedTable.forEach(({ data: r, index: i }) => {
      const [n, l, h, a, d] = r;
      const id = 'acc_' + i;
      const isFavorite = accFavorites.has(id);

      // ì¦ê²¨ì°¾ê¸° í•„í„° ì ìš©
      if (showOnlyFavorites && !isFavorite) return;

      const line = document.createElement('div');
      line.style.cssText = 'display:flex;align-items:center;gap:6px;padding:2px 0;';

      const starBtn = document.createElement('button');
      starBtn.textContent = isFavorite ? 'â­' : 'â˜†';
      starBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:2px 6px;';
      starBtn.title = isFavorite ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€';
      starBtn.onclick = (e) => {
        e.preventDefault();
        toggleFavorite(id);
      };

      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}" onchange="onAccCheckboxChange()"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%`;
      label.style.flex = '1';

      line.appendChild(starBtn);
      line.appendChild(label);
      accListEl.appendChild(line);
      accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d, index: i });
    });

    // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateSelectedAccDisplay();
  }

  // ì¦ê²¨ì°¾ê¸° í•„í„° í† ê¸€
  function toggleFavoritesFilter() {
    showOnlyFavorites = !showOnlyFavorites;
    const btn = document.getElementById('btnToggleFavorites');
    if (btn) {
      btn.textContent = showOnlyFavorites ? 'ì „ì²´ ë³´ê¸°' : 'ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°';
      btn.classList.toggle('primary', showOnlyFavorites);
    }
    renderAccessories();
  }

  loadFavorites();
  renderAccessories();

  // ===== ê³„ì‚° ëª¨ë“œ ì „í™˜ =====
  function onCalcModeChange() {
    const mode = document.querySelector('input[name="calc_mode"]:checked')?.value || 'normal';
    const topNRow = document.getElementById('topNRow');

    if (mode === 'normal') {
      topNRow.style.display = 'block';
    } else {
      topNRow.style.display = 'none';
    }

    // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸ (ëª¨ë“œì— ë”°ë¼ UI ë³€ê²½)
    updateSelectedAccDisplay();
  }

  // ì„ íƒëœ ì¥ì‹ êµ¬ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateSelectedAccDisplay() {
    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id)?.checked);
    const display = document.getElementById('selectedAccDisplay');
    const list = document.getElementById('selectedAccList');
    const isOptimize = document.querySelector('input[name="calc_mode"]:checked')?.value === 'optimize';

    if (selectedAcc.length === 0) {
      display.style.display = 'none';
      return;
    }

    display.style.display = 'block';

    if (isOptimize) {
      // Optimize ëª¨ë“œ: ê° ì¥ì‹ êµ¬ë³„ ê°œìˆ˜ ì…ë ¥
      list.innerHTML = selectedAcc.map((acc, idx) => {
        const currentQty = document.getElementById(`acc_qty_${acc.index}`)?.value || 1;
        return `<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">
          <span style="flex:1;">â€¢ ${acc.name} Lv${acc.level}</span>
          <span style="color:#666;font-size:12px;">(${acc.hp}/${acc.atk}/${acc.df})</span>
          <input type="number" id="acc_qty_${acc.index}" value="${currentQty}" min="1" max="9"
                 style="width:40px;height:24px;text-align:center;border:1px solid #ccc;border-radius:4px;">
        </div>`;
      }).join('');
    } else {
      // Normal ëª¨ë“œ: ë‹¨ìˆœ ëª©ë¡
      list.innerHTML = selectedAcc.map(acc =>
        `<div style="padding:2px 0;">â€¢ ${acc.name} Lv${acc.level} (HP+${acc.hp}% ATK+${acc.atk}% DEF+${acc.df}%)</div>`
      ).join('');
    }
  }

  // ì¥ì‹ êµ¬ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ í˜¸ì¶œ
  function onAccCheckboxChange() {
    updateSelectedAccDisplay();
  }

  function selectNone(){
    accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
    updateSelectedAccDisplay();
  }

  function toggleLevel(level){
    const filtered = accCheckboxes.filter(o => o.level === level);
    const allChecked = filtered.every(o => document.getElementById(o.id).checked);
    filtered.forEach(o => document.getElementById(o.id).checked = !allChecked);
    updateSelectedAccDisplay();
  }

  document.querySelectorAll('input[name="pendant_ver"]').forEach(r => {
    r.addEventListener('change', () => {
      const ver = document.querySelector('input[name="pendant_ver"]:checked').value;
      document.getElementById("pendant_auto_row").style.display = (ver === "v3") ? "none" : "flex";
      document.getElementById("pendant_stats_row").style.display = (ver === "v2") ? "flex" : "none";
      document.getElementById("pendant_manual").style.display = (ver === "v3") ? "flex" : "none";
    });
  });
  window.addEventListener("DOMContentLoaded", () => {
    // íœë˜íŠ¸ ë²„ì „ UI ì´ˆê¸°í™”
    document.querySelector('input[name="pendant_ver"]:checked')?.dispatchEvent(new Event('change'));
  });

  // ===== íœë˜íŠ¸ ì¡°í•© ìƒì„± =====
  function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
    const MAX = 6;
    const combos = [];

    if (total <= 0) return [[[0,0,0]]];

    // ì„ íƒëœ ìŠ¤íƒ¯ì˜ ì¸ë±ìŠ¤ ë°°ì—´ ìƒì„± (HP:0, ATK:1, DEF:2)
    const statIdx = [];
    if (selectedStats.includes("HP"))  statIdx.push(0);
    if (selectedStats.includes("ATK")) statIdx.push(1);
    if (selectedStats.includes("DEF")) statIdx.push(2);

    // ë³„ íœë˜íŠ¸: 1ìŠ¬ë¡¯
    if (mode === "ë³„") {
      const value = Math.min(total, MAX);
      return statIdx.map(i => {
        const slot = [0,0,0];
        slot[i] = value;
        return [slot];
      });
    }

    // ë‹¬ íœë˜íŠ¸: 2ìŠ¬ë¡¯
    if (mode === "ë‹¬") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          if (x+y === total)
            for (let i of statIdx)
              for (let j of statIdx) {
                const slot1=[0,0,0], slot2=[0,0,0];
                slot1[i]=x; slot2[j]=y;
                combos.push([slot1, slot2]);
              }
      return combos;
    }

    // íƒœì–‘ íœë˜íŠ¸: 3ìŠ¬ë¡¯
    if (mode === "íƒœì–‘") {
      for (let x=1; x<=MAX; x++)
        for (let y=1; y<=MAX; y++)
          for (let z=1; z<=MAX; z++)
            if (x+y+z === total)
              for (let i of statIdx)
                for (let j of statIdx)
                  for (let k of statIdx) {
                    const slot1=[0,0,0], slot2=[0,0,0], slot3=[0,0,0];
                    slot1[i]=x; slot2[j]=y; slot3[k]=z;
                    combos.push([slot1, slot2, slot3]);
                  }
      return combos;
    }

    return [[[0,0,0]]];
  }

  // ===== ìë™ ê³„ì‚°ê¸° =====
  function calcAuto(){
    const resultBox = document.getElementById("autoResult");
    resultBox.innerHTML = '<div style="text-align:center;padding:40px;color:#666;"><div style="font-weight:700;margin-bottom:10px;">ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</div><small style="color:#999;">ì¡°í•©ì´ ë§ì„ ê²½ìš° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small></div>';

    // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§§ì€ ë”œë ˆì´
    setTimeout(() => {
      calcAutoCore();
    }, 50);
  }

  function calcAutoCore(){
    const resultBox = document.getElementById("autoResult");

    // 1. ë“œë˜ê³¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (AppState.dragons.length === 0) {
      resultBox.textContent = "ë“œë˜ê³¤ì´ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
      return;
    }

    // 2. ì ¬ ê¸°ë³¸ê°’
    const gemBase = {
      hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 160),
      atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 40),
      df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 40)
    };

    // 3. ì¥ì‹ êµ¬ ì„ íƒ í™•ì¸
    const selectedAcc = accCheckboxes.filter(o => document.getElementById(o.id).checked);
    if (!selectedAcc.length) {
      resultBox.textContent = "ì¥ì‹ êµ¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      return;
    }

    // 4. íœë˜íŠ¸ ì„¤ì •
    const pendantMode = document.querySelector('input[name="pendant_mode"]:checked')?.value || "ë‹¬";
    const pendantValue = Number(document.getElementById("pendant_value")?.value || 12);
    const pendantVer = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
    const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // ìƒìˆ˜ ë° ê¸°íƒ€
    const topN = Number(document.getElementById("top_n").value || 5);
    const ENCHANT = 21;  // ì¸ì²¸íŠ¸ % (HP/ATK/DEF ê° ë°©í–¥)
    const pot = new Stats(24, 6, 6);    // í¬í…ì…œ (ê³ ì •)
    const col = new Stats(240, 60, 60); // ìˆ˜ì§‘ íš¨ê³¼ (ê³ ì •)

    // 5. íœë˜íŠ¸ ì¡°í•© ìƒì„±
    let pendantCombinations = [];
    let manualPendantStr = "";

    if (pendantVer === "v3") {
      const ph = Number(document.getElementById("pend_manual_hp")?.value || 0) / 100;
      const pa = Number(document.getElementById("pend_manual_atk")?.value || 0) / 100;
      const pd = Number(document.getElementById("pend_manual_df")?.value || 0) / 100;
      pendantCombinations = [[[ph, pa, pd]]];
      const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
      manualPendantStr = `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`;
    } else {
      const maxValues = {ë³„:6, ë‹¬:12, íƒœì–‘:18};
      const limit = maxValues[pendantMode] || 0;
      if (pendantValue > limit || pendantValue <= 0) {
        resultBox.textContent = "íœë˜íŠ¸ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
        return;
      }
      const stats = (pendantVer === "v2") ? selectedStats : ["HP", "ATK", "DEF"];
      pendantCombinations = genPend(pendantValue, pendantMode, stats);
      if (!pendantCombinations.length) {
        resultBox.textContent = "íœë˜íŠ¸ ì¡°í•© ìƒì„± ì˜¤ë¥˜";
        return;
      }
    }

    // 6. ê³„ì‚° ëª¨ë“œ í™•ì¸
    const calcMode = document.querySelector('input[name="calc_mode"]:checked')?.value || 'normal';

    // Optimize ëª¨ë“œ: ë“œë˜ê³¤ë³„ ìµœì  ì¥ì‹ êµ¬ ë°°ë¶„ ê³„ì‚°
    if (calcMode === 'optimize') {
      // ê° ì¥ì‹ êµ¬ë³„ ë³´ìœ  ê°œìˆ˜ ìˆ˜ì§‘
      const accInventoryMap = new Map();
      selectedAcc.forEach(acc => {
        const qty = Number(document.getElementById(`acc_qty_${acc.index}`)?.value || 1);
        accInventoryMap.set(acc.index, qty);
      });
      calcAutoOptimizeMode(selectedAcc, gemBase, pendantCombinations, pendantVer, pendantMode, manualPendantStr, pot, col, ENCHANT, accInventoryMap);
      return;
    }

    // Normal ëª¨ë“œ: ë“œë˜ê³¤ë³„ë¡œ ëª¨ë“  ì¥ì‹ êµ¬ ì ìš©
    const allResults = [];

    AppState.dragons.forEach((dragonConfig) => {
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];

      // ë“œë˜ê³¤ë³„ ì •ë ¹/ë²„í”„/ë””ë²„í”„
      const spiritFlat = new Stats(
        dragonConfig.spirit.flat.hp,
        dragonConfig.spirit.flat.atk,
        dragonConfig.spirit.flat.df
      );
      const spiritPct = new Stats(
        dragonConfig.spirit.pct.hp / 100,
        dragonConfig.spirit.pct.atk / 100,
        dragonConfig.spirit.pct.df / 100
      );
      const spiritExtra = new Stats(
        dragonConfig.spirit.extra.hp,
        dragonConfig.spirit.extra.atk,
        dragonConfig.spirit.extra.df
      );
      const buff = new Stats(
        dragonConfig.buff.hp / 100,
        dragonConfig.buff.atk / 100,
        dragonConfig.buff.df / 100
      );
      const debuff = new Stats(
        dragonConfig.debuff.hp / 100,
        dragonConfig.debuff.atk / 100,
        dragonConfig.debuff.df / 100
      );

      const dragonResults = [];

      for (const accessory of selectedAcc) {
        const accPctBase = {
          hp: accessory.hp / 100,
          atk: accessory.atk / 100,
          df: accessory.df / 100
        };

        // ì ¬ 5ì¹¸ ë¶„ë°° (HP + ATK + DEF = 5)
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(
              gemBase.hp * hpGems,
              gemBase.atk * atkGems,
              gemBase.df * defGems
            );

            // ì¸ì²¸íŠ¸ ë°©í–¥ (HP, ATK, DEF ì¤‘ í•˜ë‚˜)
            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(
                accPctBase.hp + enchantBonus.hp,
                accPctBase.atk + enchantBonus.atk,
                accPctBase.df + enchantBonus.df
              );

              // íœë˜íŠ¸ ì¡°í•©
              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                // ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚°
                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                // ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
                const pendantSlotStr = (pendantVer === "v3")
                  ? manualPendantStr
                  : pendant.map(slot =>
                      ["HP","ATK","DEF"]
                        .map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "")
                        .filter(Boolean)
                        .join(" ")
                    ).join(" / ");

                const pendantLabel = (pendantVer === "v3") ? "ìˆ˜ë™ì…ë ¥" : pendantMode;
                const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                dragonResults.push({
                  B: bValue,
                  dragonNumber: dragonConfig.displayNumber,
                  dragonGrade: dragonConfig.grade,
                  dragonType: dragonConfig.type,
                  accessory: `${accessory.name} Lv${accessory.level}`,
                  gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                  pendant: `${pendantLabel} (${pendantSlotStr})`,
                  enchant: `${enchantLabel} +${ENCHANT}%`,
                  finalStats,
                  eValue,
                  spirit: {
                    flat: { hp: dragonConfig.spirit.flat.hp, atk: dragonConfig.spirit.flat.atk, df: dragonConfig.spirit.flat.df },
                    pct: { hp: dragonConfig.spirit.pct.hp, atk: dragonConfig.spirit.pct.atk, df: dragonConfig.spirit.pct.df },
                    extra: { hp: dragonConfig.spirit.extra.hp, atk: dragonConfig.spirit.extra.atk, df: dragonConfig.spirit.extra.df }
                  },
                  spiritSlots: JSON.parse(JSON.stringify(dragonConfig.spiritSlots)),
                  buff: { hp: dragonConfig.buff.hp, atk: dragonConfig.buff.atk, df: dragonConfig.buff.df },
                  debuff: { hp: dragonConfig.debuff.hp, atk: dragonConfig.debuff.atk, df: dragonConfig.debuff.df }
                });
              }
            }
          }
        }
      }

      // ë“œë˜ê³¤ë³„ ìƒìœ„ ê²°ê³¼ ì €ì¥
      dragonResults.sort((a, b) => b.B - a.B);
      allResults.push({
        dragonNumber: dragonConfig.displayNumber,
        dragonGrade: dragonConfig.grade,
        dragonType: dragonConfig.type,
        results: dragonResults.slice(0, topN)
      });
    });

    // 7. ê²°ê³¼ë¥¼ ì „ì—­ì— ì €ì¥ (ìˆ˜ë™ê³„ì‚°ê¸° ì ìš©ìš©)
    window._lastAutoResults = allResults;

    // 8. ê²°ê³¼ ì¶œë ¥ (íƒ­ í˜•ì‹)
    if (!allResults.length || allResults.every(d => d.results.length === 0)) {
      resultBox.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">ê²°ê³¼ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    // ê²°ê³¼ íƒ­ ìƒì„±
    let tabsHtml = '<div class="dragon-tabs" style="margin-bottom:10px;">';
    allResults.forEach((dragonResult, dragonIdx) => {
      tabsHtml += `<button class="dragon-tab ${dragonIdx === 0 ? 'active' : ''}" onclick="switchResultTab(${dragonIdx})" data-result-idx="${dragonIdx}">ë“œë˜ê³¤ ${dragonResult.dragonNumber}</button>`;
    });
    tabsHtml += '</div>';

    // ê²°ê³¼ íŒ¨ë„ ìƒì„±
    let panelsHtml = '';

    allResults.forEach((dragonResult, dragonIdx) => {
      panelsHtml += `<div class="dragon-settings-panel ${dragonIdx === 0 ? 'active' : ''}" id="resultPanel_${dragonIdx}">`;
      panelsHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      panelsHtml += `â˜… ë“œë˜ê³¤ ${dragonResult.dragonNumber} (${dragonResult.dragonGrade} / ${dragonResult.dragonType})`;
      panelsHtml += `</div>`;

      dragonResult.results.forEach((r, i) => {
        const spiritStr = formatSpiritStr(r.spirit, r.spiritSlots);
        panelsHtml += `
          <div class="result-item" onclick="applyResultToManual(${dragonIdx}, ${i})"
               style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
               onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
            <div style="font-weight:600;color:#1565c0;">[${i + 1}ìœ„] ${r.dragonType} | ${r.accessory}</div>
            <div style="font-size:13px;color:#666;">ì ¬: ${r.gems} | íœë˜íŠ¸: ${r.pendant} | ì¸ì²¸íŠ¸: ${r.enchant}</div>
            <div style="font-size:13px;color:#9c27b0;">ì •ë ¹: ${spiritStr}</div>
            <div style="font-size:13px;margin-top:4px;">
              HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
              E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
            </div>
          </div>
        `;
      });

      panelsHtml += `</div>`;
    });

    resultBox.innerHTML = tabsHtml + panelsHtml;
  }

  // ì •ë ¹ ê°’ì„ ë¬¸ìì—´ë¡œ í¬ë§·í•˜ëŠ” í•¨ìˆ˜
  // ì •ë ¹ ìŠ¬ë¡¯ë³„ ë¬¸ìì—´ í¬ë§· (ì˜ˆ: ATK(24%),DEF(28%),HP(32%),ATK(+120))
  function formatSpiritStr(spirit, spiritSlots) {
    if (!spiritSlots) return '-';
    const parts = [];
    const statNames = { hp: 'HP', atk: 'ATK', df: 'DEF' };

    // ìŠ¬ë¡¯ 1~4 ìˆœì„œëŒ€ë¡œ
    for (let slot = 1; slot <= 4; slot++) {
      const slotData = spiritSlots[`slot${slot}`];
      if (!slotData || slotData.stat === 'none') continue;

      const stat = slotData.stat;
      const type = slotData.type;
      const name = statNames[stat] || stat.toUpperCase();

      if (type === 'flat') {
        const value = SPIRIT_FLAT_TBL[slot][stat];
        parts.push(`${name}(+${value})`);
      } else if (type === 'pct') {
        const value = SPIRIT_PCT_TBL[slot][stat];
        parts.push(`${name}(${value}%)`);
      }
    }

    // ë¶€ê°€ì˜µ
    const subIdx = spiritSlots.sub || 0;
    if (subIdx > 0) {
      const sub = SPIRIT_SUB_OPTIONS[subIdx];
      if (sub.hp > 0) parts.push(`(HP+${sub.hp})`);
      if (sub.atk > 0) parts.push(`(ATK+${sub.atk})`);
      if (sub.df > 0) parts.push(`(DEF+${sub.df})`);
    }

    return parts.length > 0 ? parts.join(',') : '-';
  }

  // ê²°ê³¼ íƒ­ ì „í™˜
  function switchResultTab(idx) {
    document.querySelectorAll('#autoResult .dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#autoResult .dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    document.querySelector(`#autoResult .dragon-tab[data-result-idx="${idx}"]`)?.classList.add('active');
    document.getElementById(`resultPanel_${idx}`)?.classList.add('active');
  }

  // ê²°ê³¼ í´ë¦­ ì‹œ ìˆ˜ë™ê³„ì‚°ê¸°ì— ì ìš©
  function applyResultToManual(dragonIdx, resultIdx) {
    if (!window._lastAutoResults || !window._lastAutoResults[dragonIdx]) {
      alert('ê²°ê³¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const dragonResult = window._lastAutoResults[dragonIdx];
    const result = dragonResult.results[resultIdx];
    if (!result) {
      alert('ê²°ê³¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ìˆ˜ë™ê³„ì‚°ê¸°ì˜ í•´ë‹¹ ë“œë˜ê³¤ ì¸ë±ìŠ¤ (1-based)
    const manualIdx = dragonResult.dragonNumber;

    // ìˆ˜ë™ê³„ì‚°ê¸°ì— ë“œë˜ê³¤ì´ ì—†ìœ¼ë©´ ìë™ ì¶”ê°€
    let needsRender = false;
    while (ManualDragonState.dragons.length < manualIdx) {
      if (ManualDragonState.dragons.length >= ManualDragonState.maxDragons) {
        alert(`ìµœëŒ€ ${ManualDragonState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return;
      }
      const newDragon = new ManualDragonConfig(ManualDragonState.nextId++, dragonResult.dragonGrade, dragonResult.dragonType);
      newDragon.displayNumber = ManualDragonState.dragons.length + 1;
      ManualDragonState.dragons.push(newDragon);
      needsRender = true;
    }
    if (needsRender) {
      renderAllManual();
      updateManualDragonCount();
    }

    // ë“±ê¸‰/íƒ€ì… ì ìš©
    const levelEl = document.getElementById(`d${manualIdx}_m_level`);
    const typeEl = document.getElementById(`d${manualIdx}_m_type`);
    if (levelEl) levelEl.value = dragonResult.dragonGrade;
    if (typeEl) typeEl.value = dragonResult.dragonType;

    // ì ¬ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "HP2 ATK0 DEF3")
    const gemMatch = result.gems.match(/HP(\d+)\s+ATK(\d+)\s+DEF(\d+)/);
    if (gemMatch) {
      const hpCount = parseInt(gemMatch[1]);
      const atkCount = parseInt(gemMatch[2]);
      const defCount = parseInt(gemMatch[3]);

      const gemBase = {
        hp: Number(document.querySelector('input[name="gem_hp"]:checked')?.value || 156),
        atk: Number(document.querySelector('input[name="gem_atk"]:checked')?.value || 39),
        df: Number(document.querySelector('input[name="gem_df"]:checked')?.value || 39)
      };

      let slotIdx = 1;
      // HP ì ¬
      for (let i = 0; i < hpCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'HP', gemBase.hp);
      }
      // ATK ì ¬
      for (let i = 0; i < atkCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'ATK', gemBase.atk);
      }
      // DEF ì ¬
      for (let i = 0; i < defCount && slotIdx <= 5; i++, slotIdx++) {
        applyGemSlot(manualIdx, slotIdx, 'DEF', gemBase.df);
      }
    }

    // ì¥ì‹ êµ¬ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ë°”ë¿”(ì²´/ë°©) Lv20")
    const accMatch = result.accessory.match(/(.+)\s+Lv(\d+)/);
    if (accMatch) {
      const accName = accMatch[1];
      const accLevel = parseInt(accMatch[2]);

      // ACC_TABLEì—ì„œ í•´ë‹¹ ì¥ì‹ êµ¬ ì°¾ê¸°
      const accIndex = ACC_TABLE.findIndex(acc => acc[0] === accName && acc[1] === accLevel);
      if (accIndex !== -1) {
        const accId = `acc_${accIndex}`;
        const accSelect = document.getElementById(`d${manualIdx}_acc_select`);
        if (accSelect) {
          accSelect.value = accId;
          onManualAccessoryChange(manualIdx, accId);
        }
      }
    }

    // ì¸ì²¸íŠ¸ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ATK +21%")
    const enchMatch = result.enchant.match(/(HP|ATK|DEF)\s+\+(\d+)%/);
    if (enchMatch) {
      const enchStat = enchMatch[1];
      const enchValue = parseInt(enchMatch[2]);

      document.getElementById(`d${manualIdx}_m_ench_hp`).value = enchStat === 'HP' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_atk`).value = enchStat === 'ATK' ? enchValue : 0;
      document.getElementById(`d${manualIdx}_m_ench_df`).value = enchStat === 'DEF' ? enchValue : 0;
    }

    // íœë˜íŠ¸ íŒŒì‹± ë° ì ìš© (ì˜ˆ: "ë‹¬ (HP6 / ATK6)")
    const pendMatch = result.pendant.match(/\(([^)]+)\)/);
    if (pendMatch) {
      const pendParts = pendMatch[1].split('/').map(s => s.trim());
      let pendHp = 0, pendAtk = 0, pendDf = 0;

      pendParts.forEach(part => {
        const m = part.match(/(HP|ATK|DEF)(\d+)/);
        if (m) {
          if (m[1] === 'HP') pendHp += parseInt(m[2]);
          else if (m[1] === 'ATK') pendAtk += parseInt(m[2]);
          else if (m[1] === 'DEF') pendDf += parseInt(m[2]);
        }
      });

      document.getElementById(`d${manualIdx}_m_pend_hp`).value = pendHp;
      document.getElementById(`d${manualIdx}_m_pend_atk`).value = pendAtk;
      document.getElementById(`d${manualIdx}_m_pend_df`).value = pendDf;
    }

    // ê²°ê³¼ ê°ì²´ì—ì„œ ì •ë ¹/ë²„í”„/ë””ë²„í”„ ë³µì‚¬
    if (result.spirit) {
      document.getElementById(`d${manualIdx}_sf_hp`).value = result.spirit.flat.hp;
      document.getElementById(`d${manualIdx}_sf_atk`).value = result.spirit.flat.atk;
      document.getElementById(`d${manualIdx}_sf_df`).value = result.spirit.flat.df;
      document.getElementById(`d${manualIdx}_sp_hp`).value = result.spirit.pct.hp;
      document.getElementById(`d${manualIdx}_sp_atk`).value = result.spirit.pct.atk;
      document.getElementById(`d${manualIdx}_sp_df`).value = result.spirit.pct.df;
      document.getElementById(`d${manualIdx}_se_hp`).value = result.spirit.extra.hp;
      document.getElementById(`d${manualIdx}_se_atk`).value = result.spirit.extra.atk;
      document.getElementById(`d${manualIdx}_se_df`).value = result.spirit.extra.df;
    }
    if (result.buff) {
      document.getElementById(`d${manualIdx}_bf_hp`).value = result.buff.hp;
      document.getElementById(`d${manualIdx}_bf_atk`).value = result.buff.atk;
      document.getElementById(`d${manualIdx}_bf_df`).value = result.buff.df;
    }
    if (result.debuff) {
      document.getElementById(`d${manualIdx}_db_hp`).value = result.debuff.hp;
      document.getElementById(`d${manualIdx}_db_atk`).value = result.debuff.atk;
      document.getElementById(`d${manualIdx}_db_df`).value = result.debuff.df;
    }

    // ì ìš© ì™„ë£Œ í‘œì‹œ (íƒ­ ì´ë™ ì—†ì´)
    const resultItem = event?.target?.closest('.result-item');
    if (resultItem) {
      resultItem.style.background = '#c8e6c9';
      setTimeout(() => { resultItem.style.background = '#f8f9fa'; }, 1000);
    }
  }

  // ì ¬ ìŠ¬ë¡¯ ì ìš© í—¬í¼ í•¨ìˆ˜
  function applyGemSlot(manualIdx, slotIdx, type, value) {
    const typeSelect = document.getElementById(`d${manualIdx}_slot_type_${slotIdx}`);
    const valSelect = document.getElementById(`d${manualIdx}_slot_val_${slotIdx}`);
    if (typeSelect) {
      typeSelect.value = type;
      typeSelect.dispatchEvent(new Event('change'));
      setTimeout(() => { if (valSelect) valSelect.value = value; }, 50);
    }
  }

  // ===== Optimize ëª¨ë“œ ê³„ì‚° =====
  function calcAutoOptimizeMode(selectedAcc, gemBase, pendantCombinations, pendantVer, pendantMode, manualPendantStr, pot, col, ENCHANT, accInventoryMap) {
    const resultBox = document.getElementById("autoResult");

    // ê° ë“œë˜ê³¤ì— ëŒ€í•´ ê° ì¥ì‹ êµ¬ì˜ ìµœì  Bê°’ ê³„ì‚°
    const dragonAccScores = [];

    AppState.dragons.forEach((dragonConfig, dragonIdx) => {
      const baseStats = dragon[dragonConfig.grade][dragonConfig.type];
      const spiritFlat = new Stats(dragonConfig.spirit.flat.hp, dragonConfig.spirit.flat.atk, dragonConfig.spirit.flat.df);
      const spiritPct = new Stats(dragonConfig.spirit.pct.hp / 100, dragonConfig.spirit.pct.atk / 100, dragonConfig.spirit.pct.df / 100);
      const spiritExtra = new Stats(dragonConfig.spirit.extra.hp, dragonConfig.spirit.extra.atk, dragonConfig.spirit.extra.df);
      const buff = new Stats(dragonConfig.buff.hp / 100, dragonConfig.buff.atk / 100, dragonConfig.buff.df / 100);
      const debuff = new Stats(dragonConfig.debuff.hp / 100, dragonConfig.debuff.atk / 100, dragonConfig.debuff.df / 100);

      const accScores = [];

      selectedAcc.forEach((accessory, accIdx) => {
        let bestResult = null;
        let bestB = -Infinity;

        const accPctBase = { hp: accessory.hp / 100, atk: accessory.atk / 100, df: accessory.df / 100 };

        // ëª¨ë“  ì¡°í•© ì¤‘ ìµœê³  Bê°’ ì°¾ê¸°
        for (let hpGems = 0; hpGems <= 5; hpGems++) {
          for (let atkGems = 0; atkGems <= 5 - hpGems; atkGems++) {
            const defGems = 5 - hpGems - atkGems;
            const gemTotal = new Stats(gemBase.hp * hpGems, gemBase.atk * atkGems, gemBase.df * defGems);

            for (const enchantDir of ["hp", "atk", "df"]) {
              const enchantBonus = new Stats(
                enchantDir === "hp" ? ENCHANT / 100 : 0,
                enchantDir === "atk" ? ENCHANT / 100 : 0,
                enchantDir === "df" ? ENCHANT / 100 : 0
              );
              const accTotal = new Stats(accPctBase.hp + enchantBonus.hp, accPctBase.atk + enchantBonus.atk, accPctBase.df + enchantBonus.df);

              for (const pendant of pendantCombinations) {
                const pendantSum = {
                  hp: pendant.reduce((sum, slot) => sum + slot[0], 0),
                  atk: pendant.reduce((sum, slot) => sum + slot[1], 0),
                  df: pendant.reduce((sum, slot) => sum + slot[2], 0)
                };
                const pendantStats = (pendantVer === "v3")
                  ? new Stats(pendantSum.hp, pendantSum.atk, pendantSum.df)
                  : new Stats(pendantSum.hp / 100, pendantSum.atk / 100, pendantSum.df / 100);

                const [finalStats, eValue, bValue] = calcPredict(
                  baseStats, gemTotal, pot, accTotal, pendantStats,
                  spiritFlat, spiritPct, spiritExtra, col, buff, debuff
                );

                if (bValue > bestB) {
                  bestB = bValue;
                  const pendantSlotStr = (pendantVer === "v3") ? manualPendantStr : pendant.map(slot =>
                    ["HP","ATK","DEF"].map((stat, i) => slot[i] > 0 ? `${stat}${slot[i]}` : "").filter(Boolean).join(" ")
                  ).join(" / ");
                  const enchantLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchantDir];

                  bestResult = {
                    B: bValue,
                    dragonNumber: dragonConfig.displayNumber,
                    dragonGrade: dragonConfig.grade,
                    dragonType: dragonConfig.type,
                    accessory: `${accessory.name} Lv${accessory.level}`,
                    accIdx: accIdx,
                    accIndex: accessory.index,
                    gems: `HP${hpGems} ATK${atkGems} DEF${defGems}`,
                    pendant: `${pendantVer === "v3" ? "ìˆ˜ë™ì…ë ¥" : pendantMode} (${pendantSlotStr})`,
                    enchant: `${enchantLabel} +${ENCHANT}%`,
                    finalStats,
                    eValue,
                    spirit: {
                      flat: { hp: dragonConfig.spirit.flat.hp, atk: dragonConfig.spirit.flat.atk, df: dragonConfig.spirit.flat.df },
                      pct: { hp: dragonConfig.spirit.pct.hp, atk: dragonConfig.spirit.pct.atk, df: dragonConfig.spirit.pct.df },
                      extra: { hp: dragonConfig.spirit.extra.hp, atk: dragonConfig.spirit.extra.atk, df: dragonConfig.spirit.extra.df }
                    },
                    buff: { hp: dragonConfig.buff.hp, atk: dragonConfig.buff.atk, df: dragonConfig.buff.df },
                    debuff: { hp: dragonConfig.debuff.hp, atk: dragonConfig.debuff.atk, df: dragonConfig.debuff.df }
                  };
                }
              }
            }
          }
        }

        accScores.push({ accIdx, bestB, bestResult });
      });

      dragonAccScores.push({ dragonIdx, dragonConfig, accScores });
    });

    // í—ê°€ë¦¬ì•ˆ ì•Œê³ ë¦¬ì¦˜ ëŒ€ì‹  ê·¸ë¦¬ë”” ë°©ì‹ìœ¼ë¡œ ìµœì  ë°°ë¶„
    // (ë“œë˜ê³¤ ìˆ˜ê°€ ì ìœ¼ë©´ ì¶©ë¶„íˆ íš¨ê³¼ì )
    // ê° ì¥ì‹ êµ¬ëŠ” í•´ë‹¹ ì¥ì‹ êµ¬ì˜ ë³´ìœ  ê°œìˆ˜ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥
    const accUsageCount = new Map(); // accIndex -> ì‚¬ìš© íšŸìˆ˜
    const assignments = [];

    // ëª¨ë“  (ë“œë˜ê³¤, ì¥ì‹ êµ¬) ì¡°í•©ì„ Bê°’ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    const allPairs = [];
    dragonAccScores.forEach(({ dragonIdx, dragonConfig, accScores }) => {
      accScores.forEach(({ accIdx, accIndex, bestB, bestResult }) => {
        if (bestResult) {
          allPairs.push({ dragonIdx, accIdx, accIndex: bestResult.accIndex, bestB, bestResult });
        }
      });
    });
    allPairs.sort((a, b) => b.bestB - a.bestB);

    // ê·¸ë¦¬ë””í•˜ê²Œ ë°°ë¶„ (ê° ë“œë˜ê³¤ì— í•˜ë‚˜ì˜ ì¥ì‹ êµ¬, ì¥ì‹ êµ¬ëŠ” ë³´ìœ ê°œìˆ˜ê¹Œì§€ í• ë‹¹ ê°€ëŠ¥)
    const assignedDragons = new Set();
    for (const pair of allPairs) {
      const accIndex = pair.accIndex;
      const maxInventory = accInventoryMap.get(accIndex) || 1;
      const currentUsage = accUsageCount.get(accIndex) || 0;
      if (!assignedDragons.has(pair.dragonIdx) && currentUsage < maxInventory) {
        assignments.push(pair);
        assignedDragons.add(pair.dragonIdx);
        accUsageCount.set(accIndex, currentUsage + 1);
      }
      if (assignedDragons.size >= AppState.dragons.length) break;
    }

    // ê²°ê³¼ë¥¼ ë“œë˜ê³¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    assignments.sort((a, b) => a.dragonIdx - b.dragonIdx);

    // ì „ì—­ì— ì €ì¥
    const allResults = assignments.map(a => ({
      dragonNumber: a.bestResult.dragonNumber,
      dragonGrade: a.bestResult.dragonGrade,
      dragonType: a.bestResult.dragonType,
      results: [a.bestResult]
    }));
    window._lastAutoResults = allResults;

    // ê²°ê³¼ ì¶œë ¥
    let outputHtml = '';
    let totalB = 0;

    assignments.forEach((assign, idx) => {
      const r = assign.bestResult;
      totalB += r.B;
      const spiritStr = formatSpiritStr(r.spirit, r.spiritSlots);

      outputHtml += `<div style="margin-bottom:15px;">`;
      outputHtml += `<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:10px 15px;border-radius:8px 8px 0 0;font-weight:bold;">`;
      outputHtml += `â˜… ë“œë˜ê³¤ ${r.dragonNumber} (${r.dragonGrade} / ${r.dragonType})`;
      outputHtml += `</div>`;
      outputHtml += `
        <div class="result-item" onclick="applyResultToManual(${idx}, 0)"
             style="background:#f8f9fa;padding:10px 15px;border:1px solid #e0e0e0;border-top:none;cursor:pointer;transition:background 0.2s;"
             onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
          <div style="font-weight:600;color:#1565c0;">[ìµœì ] ${r.dragonType} | ${r.accessory}</div>
          <div style="font-size:13px;color:#666;">ì ¬: ${r.gems} | íœë˜íŠ¸: ${r.pendant} | ì¸ì²¸íŠ¸: ${r.enchant}</div>
          <div style="font-size:13px;color:#9c27b0;">ì •ë ¹: ${spiritStr}</div>
          <div style="font-size:13px;margin-top:4px;">
            HP=<strong>${r.finalStats.hp}</strong> | ATK=<strong>${r.finalStats.atk}</strong> | DEF=<strong>${r.finalStats.df}</strong> |
            E=<strong>${r.eValue.toFixed(0)}</strong> | B=<strong style="color:#d32f2f;">${(r.B/1e6).toFixed(3)}</strong>
          </div>
        </div>
      </div>`;
    });

    outputHtml += `<div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-top:10px;text-align:center;">
      <strong style="color:#2e7d32;font-size:18px;">ì´ B-Value í•©ê³„: ${(totalB/1e6).toFixed(3)}</strong>
    </div>`;

    resultBox.innerHTML = outputHtml;
  }

  // ===== ê²°ê³¼ ê´€ë¦¬ =====
  function clearAllResults() {
    if (confirm('ê³„ì‚° ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      window._lastAutoResults = null;
      document.getElementById("autoResult").innerHTML = '';
      alert("ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }

  function downloadTxt(){
    // ê³„ì‚° ê²°ê³¼ í™•ì¸
    if (!window._lastAutoResults || window._lastAutoResults.length === 0) {
      alert("ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
      return;
    }

    // Excel ì›Œí¬ë¶ ìƒì„±
    const wb = XLSX.utils.book_new();

    // ê° ë“œë˜ê³¤ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
    window._lastAutoResults.forEach((dragonResult) => {
      // ì‹œíŠ¸ ë°ì´í„° ì¤€ë¹„
      const sheetData = [];

      // í—¤ë” í–‰
      sheetData.push(['ìˆœìœ„', 'íƒ€ì…', 'ì¥ì‹ êµ¬', 'ì ¬', 'íœë˜íŠ¸', 'ì¸ì²¸íŠ¸', 'ì •ë ¹', 'HP', 'ATK', 'DEF', 'E', 'B']);

      // ë“œë˜ê³¤ ì •ë³´ í–‰
      sheetData.push([`${dragonResult.dragonGrade} / ${dragonResult.dragonType}`, '', '', '', '', '', '', '', '', '', '', '']);

      // ê²°ê³¼ ë°ì´í„° í–‰
      dragonResult.results.forEach((r, i) => {
        sheetData.push([
          i + 1,
          r.dragonType,
          r.accessory,
          r.gems,
          r.pendant,
          r.enchant,
          formatSpiritStr(r.spirit, r.spiritSlots),
          r.finalStats.hp,
          r.finalStats.atk,
          r.finalStats.df,
          Math.round(r.eValue),
          (r.B / 1e6).toFixed(3)
        ]);
      });

      // ì‹œíŠ¸ ìƒì„± ë° ì›Œí¬ë¶ì— ì¶”ê°€
      const ws = XLSX.utils.aoa_to_sheet(sheetData);

      // ì—´ ë„ˆë¹„ ì„¤ì •
      ws['!cols'] = [
        { wch: 6 },   // ìˆœìœ„
        { wch: 10 },  // íƒ€ì…
        { wch: 18 },  // ì¥ì‹ êµ¬
        { wch: 15 },  // ì ¬
        { wch: 20 },  // íœë˜íŠ¸
        { wch: 12 },  // ì¸ì²¸íŠ¸
        { wch: 35 },  // ì •ë ¹
        { wch: 8 },   // HP
        { wch: 8 },   // ATK
        { wch: 8 },   // DEF
        { wch: 8 },   // E
        { wch: 10 }   // B
      ];

      // ì‹œíŠ¸ ì´ë¦„ (ë“œë˜ê³¤ ë²ˆí˜¸)
      const sheetName = `ë“œë˜ê³¤${dragonResult.dragonNumber}`;
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    // Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    XLSX.writeFile(wb, 'dragon_result.xlsx');
  }

  const gemOptions = {
    HP: [160, 156, 152, 148],
    ATK: [40, 39, 38, 37],
    DEF: [40, 39, 38, 37]
  };

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ìƒíƒœ
  const ManualDragonState = {
    dragons: [],
    maxDragons: 9,
    nextId: 1,
    accessoryAllocation: new Map(),
    selectedForResult: new Set()  // ê²°ê³¼ì— í‘œì‹œí•  ë“œë˜ê³¤ ì„ íƒ
  };

  class ManualDragonConfig {
    constructor(id, grade, type) {
      this.id = id;
      this.displayNumber = 0;
      this.grade = grade;
      this.type = type;
      this.accessoryId = null;
    }
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ì¶”ê°€
  function addManualDragon() {
    if (ManualDragonState.dragons.length >= ManualDragonState.maxDragons) {
      alert(`ìµœëŒ€ ${ManualDragonState.maxDragons}ë§ˆë¦¬ê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    const gradeSelect = document.getElementById('add_manual_dragon_grade');
    const typeSelect = document.getElementById('add_manual_dragon_type');
    const grade = gradeSelect ? gradeSelect.value : '9.0';
    const type = typeSelect ? typeSelect.value : 'ê³µê²©í˜•';

    const newDragon = new ManualDragonConfig(ManualDragonState.nextId++, grade, type);
    newDragon.displayNumber = ManualDragonState.dragons.length + 1;
    ManualDragonState.dragons.push(newDragon);

    renderAllManual();
    updateManualDragonCount();
  }

  // ìˆ˜ë™ê³„ì‚°ê¸° ë“œë˜ê³¤ ì‚­ì œ
  function removeManualDragon(dragonId) {
    const index = ManualDragonState.dragons.findIndex(d => d.id === dragonId);
    if (index === -1) return;

    const dragon = ManualDragonState.dragons[index];
    const oldDisplayNumber = dragon.displayNumber;

    // ì¥ì‹ êµ¬ í•´ì œ
    if (dragon.accessoryId) {
      ManualDragonState.accessoryAllocation.delete(dragon.accessoryId);
    }

    ManualDragonState.dragons.splice(index, 1);

    // ë¦¬ë„˜ë²„ë§ ë° selectedForResult ì—…ë°ì´íŠ¸
    const wasSelected = ManualDragonState.selectedForResult.has(oldDisplayNumber);
    ManualDragonState.selectedForResult.clear();
    ManualDragonState.dragons.forEach((d, i) => {
      d.displayNumber = i + 1;
    });
    // ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒ 3ê°œ ì„ íƒ (ë˜ëŠ” ëª¨ë“  ë“œë˜ê³¤ ì„ íƒ)
    const selectCount = Math.min(3, ManualDragonState.dragons.length);
    for (let i = 0; i < selectCount; i++) {
      ManualDragonState.selectedForResult.add(ManualDragonState.dragons[i].displayNumber);
    }

    renderAllManual();
    updateManualDragonCount();
  }

  function updateManualDragonCount() {
    const countEl = document.getElementById('manualDragonCount');
    if (countEl) {
      countEl.textContent = `(í˜„ì¬: ${ManualDragonState.dragons.length}ë§ˆë¦¬)`;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ 3ë§ˆë¦¬ ë“œë˜ê³¤ ìë™ ìƒì„±
  window.addEventListener('DOMContentLoaded', () => {
    // ê¸°ë³¸ 3ë§ˆë¦¬ ìƒì„±
    for (let i = 0; i < 3; i++) {
      const dragon = new ManualDragonConfig(ManualDragonState.nextId++, '9.0', 'ê³µê²©í˜•');
      dragon.displayNumber = i + 1;
      ManualDragonState.dragons.push(dragon);
    }
    renderAllManual();
    updateManualDragonCount();
  });

  function renderAllManual() {
    const tabsContainer = document.getElementById('manualDragonTabs');
    const inputsWrap = document.getElementById('inputsWrap');
    const allResults = document.getElementById('allResults');

    if (!tabsContainer || !inputsWrap) return;

    tabsContainer.innerHTML = '';
    inputsWrap.innerHTML = '';
    allResults.innerHTML = '';

    if (ManualDragonState.dragons.length === 0) {
      inputsWrap.innerHTML = '<p style="color:#999;text-align:center;padding:20px 0;">ë“œë˜ê³¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
      updateDragonSelectionPanel();
      return;
    }

    // íƒ­ ìƒì„±
    ManualDragonState.dragons.forEach((dragon, index) => {
      const tab = document.createElement('button');
      tab.className = `dragon-tab ${index === 0 ? 'active' : ''}`;
      tab.textContent = `ë“œë˜ê³¤ ${dragon.displayNumber}`;
      tab.dataset.dragonIdx = dragon.displayNumber;
      tab.onclick = () => switchManualDragonTab(dragon.displayNumber);
      tabsContainer.appendChild(tab);
    });

    // íŒ¨ë„ ìƒì„±
    ManualDragonState.dragons.forEach((dragon, index) => {
      renderOneInputAsPanel(dragon.displayNumber, dragon, index === 0);
    });

    // ì„ íƒ íŒ¨ë„ ì—…ë°ì´íŠ¸ ë° ê²°ê³¼ ì‹œíŠ¸ ìƒì„±
    updateDragonSelectionPanel();
    renderSelectedResults();
  }

  // ë“œë˜ê³¤ ì„ íƒ íŒ¨ë„ ì—…ë°ì´íŠ¸
  function updateDragonSelectionPanel() {
    const panel = document.getElementById('dragonSelectPanel');
    const checkboxes = document.getElementById('dragonSelectCheckboxes');

    if (!panel || !checkboxes) return;

    // 4ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ
    if (ManualDragonState.dragons.length < 4) {
      panel.style.display = 'none';
      // 3ë§ˆë¦¬ ì´í•˜ë©´ ëª¨ë‘ ì„ íƒ
      ManualDragonState.selectedForResult.clear();
      ManualDragonState.dragons.forEach(d => ManualDragonState.selectedForResult.add(d.displayNumber));
      return;
    }

    panel.style.display = 'block';

    // ê¸°ë³¸ ì„ íƒ: ì²˜ìŒ 3ê°œ (ì•„ì§ ì„ íƒëœ ê²Œ ì—†ìœ¼ë©´)
    if (ManualDragonState.selectedForResult.size === 0) {
      ManualDragonState.dragons.slice(0, 3).forEach(d => ManualDragonState.selectedForResult.add(d.displayNumber));
    }

    // ì²´í¬ë°•ìŠ¤ ìƒì„±
    checkboxes.innerHTML = ManualDragonState.dragons.map(dragon => {
      const isChecked = ManualDragonState.selectedForResult.has(dragon.displayNumber);
      const isDisabled = !isChecked && ManualDragonState.selectedForResult.size >= 3;
      return `
        <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${isChecked ? '#e8f5e9' : '#fff'};border:1px solid ${isChecked ? '#4caf50' : '#ddd'};border-radius:6px;cursor:${isDisabled ? 'not-allowed' : 'pointer'};">
          <input type="checkbox"
                 ${isChecked ? 'checked' : ''}
                 ${isDisabled ? 'disabled' : ''}
                 onchange="toggleDragonSelection(${dragon.displayNumber}, this.checked)">
          ë“œë˜ê³¤ ${dragon.displayNumber}
        </label>
      `;
    }).join('');
  }

  // ë“œë˜ê³¤ ì„ íƒ í† ê¸€
  function toggleDragonSelection(displayNumber, isSelected) {
    if (isSelected) {
      if (ManualDragonState.selectedForResult.size < 3) {
        ManualDragonState.selectedForResult.add(displayNumber);
      }
    } else {
      // ìµœì†Œ 1ê°œëŠ” ì„ íƒë˜ì–´ì•¼ í•¨
      if (ManualDragonState.selectedForResult.size <= 1) {
        alert('ìµœì†Œ 1ê°œì˜ ë“œë˜ê³¤ì€ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
        updateDragonSelectionPanel(); // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
        return;
      }
      ManualDragonState.selectedForResult.delete(displayNumber);
    }
    updateDragonSelectionPanel();
    renderSelectedResults();
  }

  // ì„ íƒëœ ë“œë˜ê³¤ë§Œ ê²°ê³¼ ì‹œíŠ¸ ìƒì„±
  function renderSelectedResults() {
    const allResults = document.getElementById('allResults');
    if (!allResults) return;

    allResults.innerHTML = '';

    // ì„ íƒëœ ë“œë˜ê³¤ë“¤ì˜ ê²°ê³¼ ì‹œíŠ¸ ìƒì„± (ìˆœì„œ ìœ ì§€)
    ManualDragonState.dragons
      .filter(d => ManualDragonState.selectedForResult.has(d.displayNumber))
      .forEach(dragon => {
        renderOneResult(dragon.displayNumber);
      });
  }

  function renderOneInputAsPanel(idx, dragonConfig, isActive) {
    const inputsWrap = document.getElementById('inputsWrap');
    const panel = document.createElement('div');
    panel.className = `dragon-settings-panel ${isActive ? 'active' : ''}`;
    panel.id = `manualPanel_${idx}`;

    // ë“œë˜ê³¤ ID ì°¾ê¸° (ì‚­ì œìš©)
    const dragonId = dragonConfig ? dragonConfig.id : null;
    const showDelete = ManualDragonState.dragons.length > 1;

    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;margin-bottom:12px;">
        <strong style="font-size:16px;color:var(--accent);">ë“œë˜ê³¤ ${idx}</strong>
        ${showDelete && dragonId ? `<button class="btn-remove" onclick="removeManualDragon(${dragonId})">ì‚­ì œ</button>` : ''}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <fieldset>
          <legend>ë“±ê¸‰ / íƒ€ì…</legend>
          <div class="row">
            <label>ë“±ê¸‰
              <select id="d${idx}_m_level">
                <option value="7.0" ${dragonConfig?.grade === '7.0' ? 'selected' : ''}>7.0</option>
                <option value="8.0" ${dragonConfig?.grade === '8.0' ? 'selected' : ''}>8.0</option>
                <option value="9.0" ${!dragonConfig || dragonConfig?.grade === '9.0' ? 'selected' : ''}>9.0</option>
              </select>
            </label>
            <label>íƒ€ì…
              <select id="d${idx}_m_type">
                <option ${dragonConfig?.type === 'ê³µê²©í˜•' ? 'selected' : ''}>ê³µê²©í˜•</option>
                <option ${dragonConfig?.type === 'ë°©ì–´í˜•' ? 'selected' : ''}>ë°©ì–´í˜•</option>
                <option ${dragonConfig?.type === 'ì²´ë ¥í˜•' ? 'selected' : ''}>ì²´ë ¥í˜•</option>
                <option ${dragonConfig?.type === 'ê³µë°©í˜•' ? 'selected' : ''}>ê³µë°©í˜•</option>
                <option ${dragonConfig?.type === 'ì²´ê³µí˜•' ? 'selected' : ''}>ì²´ê³µí˜•</option>
                <option ${dragonConfig?.type === 'ì²´ë°©í˜•' ? 'selected' : ''}>ì²´ë°©í˜•</option>
              </select>
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>ì¥ì‹ êµ¬ ì„ íƒ</legend>
          <div class="row">
            <select id="d${idx}_acc_select" onchange="onManualAccessoryChange(${idx}, this.value)" style="width:100%;">
              <option value="">-- ì¥ì‹ êµ¬ ì„ íƒ --</option>
              ${renderAccessoryOptions(dragonConfig?.accessoryId)}
            </select>
          </div>
          <div class="row" style="margin-top:6px;">
            <span class="small">ë˜ëŠ” ì§ì ‘ ì…ë ¥:</span>
          </div>
          <div class="row">
            HP <input id="d${idx}_m_acc_hp" type="number" value="0" style="width:55px">%
            ATK <input id="d${idx}_m_acc_atk" type="number" value="0" style="width:55px">%
            DEF <input id="d${idx}_m_acc_df" type="number" value="0" style="width:55px">%
          </div>
        </fieldset>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <fieldset>
          <legend>ì ¬ ìŠ¬ë¡¯ (5ê°œ)</legend>
          <div id="d${idx}_gem_slots"></div>
        </fieldset>

        <fieldset>
          <legend>ì¸ì²¸íŠ¸ / íœë˜íŠ¸ (%)</legend>
          <div class="row">
            <strong>ì¸ì²¸íŠ¸</strong>
            HP <input id="d${idx}_m_ench_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_ench_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_ench_df" type="number" value="0" style="width:50px">
          </div>
          <div class="row" style="margin-top:6px;">
            <strong>íœë˜íŠ¸</strong>
            HP <input id="d${idx}_m_pend_hp" type="number" value="0" style="width:50px">
            ATK <input id="d${idx}_m_pend_atk" type="number" value="0" style="width:50px">
            DEF <input id="d${idx}_m_pend_df" type="number" value="0" style="width:50px">
          </div>
        </fieldset>
      </div>

      <fieldset style="margin-top:12px;">
        <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„</legend>
        <div style="font-weight:700;margin-bottom:6px">(HP / ATK / DEF)</div>
        <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong>
          <input id="d${idx}_sf_hp" type="number" value="0">
          <input id="d${idx}_sf_atk" type="number" value="0">
          <input id="d${idx}_sf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong>
          <input id="d${idx}_sp_hp" type="number" value="0">
          <input id="d${idx}_sp_atk" type="number" value="0">
          <input id="d${idx}_sp_df" type="number" value="0">
          <span class="small">% ì…ë ¥</span>
        </div>
        <div class="row-spirit"><strong>ì •ë ¹ ë¶€ê°€ì˜µ</strong>
          <input id="d${idx}_se_hp" type="number" value="0">
          <input id="d${idx}_se_atk" type="number" value="0">
          <input id="d${idx}_se_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ë²„í”„ (%)</strong>
          <input id="d${idx}_bf_hp" type="number" value="0">
          <input id="d${idx}_bf_atk" type="number" value="0">
          <input id="d${idx}_bf_df" type="number" value="0">
        </div>
        <div class="row-spirit"><strong>ë””ë²„í”„ (%)</strong>
          <input id="d${idx}_db_hp" type="number" value="0">
          <input id="d${idx}_db_atk" type="number" value="0">
          <input id="d${idx}_db_df" type="number" value="0">
        </div>
      </fieldset>
    `;
    inputsWrap.appendChild(panel);
    renderGems(idx);
  }

  function switchManualDragonTab(dragonIdx) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('#manualDragonTabs .dragon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#inputsWrap .dragon-settings-panel').forEach(panel => panel.classList.remove('active'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    document.querySelector(`#manualDragonTabs .dragon-tab[data-dragon-idx="${dragonIdx}"]`)?.classList.add('active');
    document.getElementById(`manualPanel_${dragonIdx}`)?.classList.add('active');
  }

  // ì¥ì‹ êµ¬ ì˜µì…˜ ë Œë”ë§ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
  function renderAccessoryOptions(currentAccId = null) {
    return ACC_TABLE.map((acc, index) => {
      const [name, level, hp, atk, df] = acc;
      const accId = `acc_${index}`;
      const isUsed = ManualDragonState.accessoryAllocation.has(accId) &&
                     ManualDragonState.accessoryAllocation.get(accId) !== currentAccId;
      const usedBy = isUsed ? ManualDragonState.accessoryAllocation.get(accId) : null;
      const usedLabel = usedBy ? ` (ë“œë˜ê³¤ ${usedBy} ì‚¬ìš©ì¤‘)` : '';

      return `<option value="${accId}" ${currentAccId === accId ? 'selected' : ''} ${isUsed ? 'disabled' : ''}>
        ${name} Lv${level} | HP+${hp}% ATK+${atk}% DEF+${df}%${usedLabel}
      </option>`;
    }).join('');
  }

  // ì¥ì‹ êµ¬ ì„ íƒ ë³€ê²½ ì‹œ í˜¸ì¶œ
  function onManualAccessoryChange(dragonIdx, accId) {
    const dragon = ManualDragonState.dragons[dragonIdx - 1];
    if (!dragon) return;

    // ì´ì „ í• ë‹¹ í•´ì œ
    if (dragon.accessoryId) {
      ManualDragonState.accessoryAllocation.delete(dragon.accessoryId);
    }

    if (accId && accId !== '') {
      // ì¤‘ë³µ ì²´í¬
      if (ManualDragonState.accessoryAllocation.has(accId)) {
        alert('ì´ë¯¸ ë‹¤ë¥¸ ë“œë˜ê³¤ì— ì¥ì°©ëœ ì¥ì‹ êµ¬ì…ë‹ˆë‹¤.');
        document.getElementById(`d${dragonIdx}_acc_select`).value = dragon.accessoryId || '';
        return;
      }

      // ìƒˆë¡œìš´ í• ë‹¹
      ManualDragonState.accessoryAllocation.set(accId, dragonIdx);
      dragon.accessoryId = accId;

      // ì¥ì‹ êµ¬ ê°’ ìë™ ì…ë ¥
      const accIndex = parseInt(accId.replace('acc_', ''));
      const accData = ACC_TABLE[accIndex];
      if (accData) {
        document.getElementById(`d${dragonIdx}_m_acc_hp`).value = accData[2];
        document.getElementById(`d${dragonIdx}_m_acc_atk`).value = accData[3];
        document.getElementById(`d${dragonIdx}_m_acc_df`).value = accData[4];
      }
    } else {
      dragon.accessoryId = null;
    }

    // ë‹¤ë¥¸ ë“œë˜ê³¤ì˜ ì¥ì‹ êµ¬ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
    updateAllAccessorySelects();
  }

  // ëª¨ë“  ì¥ì‹ êµ¬ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
  function updateAllAccessorySelects() {
    ManualDragonState.dragons.forEach((dragon, index) => {
      const select = document.getElementById(`d${dragon.displayNumber}_acc_select`);
      if (select) {
        const currentValue = select.value;
        select.innerHTML = `<option value="">-- ì¥ì‹ êµ¬ ì„ íƒ --</option>${renderAccessoryOptions(dragon.accessoryId)}`;
        select.value = currentValue;
      }
    });
  }

  function renderGems(idx){
    const c=document.getElementById(`d${idx}_gem_slots`); c.innerHTML='';
    for(let i=1;i<=5;i++){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `
        <strong style="width:64px;display:inline-block">ì ¬${i}</strong>
        <select id="d${idx}_slot_type_${i}">
          <option value="">--ì¢…ë¥˜--</option>
          <option value="HP">HP</option>
          <option value="ATK">ATK</option>
          <option value="DEF">DEF</option>
        </select>
        <select id="d${idx}_slot_val_${i}">
          <option value="0">--ê°’--</option>
        </select>`;
      c.appendChild(row);

      const typeSel=row.querySelector(`#d${idx}_slot_type_${i}`);
      const valSel=row.querySelector(`#d${idx}_slot_val_${i}`);
      typeSel.addEventListener('change', ()=>{
        valSel.innerHTML = `<option value="0">--ê°’--</option>`;
        const t=typeSel.value;
        if(t && gemOptions[t]){
          gemOptions[t].forEach(v=>{
            const op=document.createElement('option');
            op.value=v; op.textContent=v; valSel.appendChild(op);
          });
        }
      });
    }
  }

function renderOneResult(idx){
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.id = `resultSheet_${idx}`;
  sheet.innerHTML = `
    <div class="name" id="d${idx}_name_display">ë“œë˜ê³¤ ${idx}</div>
    <div class="grid">
      <div class="cell h center">êµ¬ë¶„</div>
      <div class="cell h center">ì²´ë ¥</div>
      <div class="cell h center">ê³µê²©ë ¥</div>
      <div class="cell h center">ë°©ì–´ë ¥</div>

      <div class="cell">ê¸°ë³¸ ìŠ¤íƒ¯</div>
      <div class="cell right" id="d${idx}_c_base_hp">-</div>
      <div class="cell right" id="d${idx}_c_base_atk">-</div>
      <div class="cell right" id="d${idx}_c_base_df">-</div>

      <div class="cell">ì ¬1</div><div class="cell right" id="d${idx}_c_g1_hp">0</div><div class="cell right" id="d${idx}_c_g1_atk">0</div><div class="cell right" id="d${idx}_c_g1_df">0</div>
      <div class="cell">ì ¬2</div><div class="cell right" id="d${idx}_c_g2_hp">0</div><div class="cell right" id="d${idx}_c_g2_atk">0</div><div class="cell right" id="d${idx}_c_g2_df">0</div>
      <div class="cell">ì ¬3</div><div class="cell right" id="d${idx}_c_g3_hp">0</div><div class="cell right" id="d${idx}_c_g3_atk">0</div><div class="cell right" id="d${idx}_c_g3_df">0</div>
      <div class="cell">ì ¬4</div><div class="cell right" id="d${idx}_c_g4_hp">0</div><div class="cell right" id="d${idx}_c_g4_atk">0</div><div class="cell right" id="d${idx}_c_g4_df">0</div>
      <div class="cell">ì ¬5</div><div class="cell right" id="d${idx}_c_g5_hp">0</div><div class="cell right" id="d${idx}_c_g5_atk">0</div><div class="cell right" id="d${idx}_c_g5_df">0</div>

      <div class="cell">ì¥ì‹ êµ¬ %</div><div class="cell right" id="d${idx}_c_acc_hp">0%</div><div class="cell right" id="d${idx}_c_acc_atk">0%</div><div class="cell right" id="d${idx}_c_acc_df">0%</div>
      <div class="cell">ì¸ì²¸íŠ¸ %</div><div class="cell right" id="d${idx}_c_ench_hp">0%</div><div class="cell right" id="d${idx}_c_ench_atk">0%</div><div class="cell right" id="d${idx}_c_ench_df">0%</div>
      <div class="cell">íœë˜íŠ¸ %</div><div class="cell right" id="d${idx}_c_pend_hp">0%</div><div class="cell right" id="d${idx}_c_pend_atk">0%</div><div class="cell right" id="d${idx}_c_pend_df">0%</div>

      <div class="cell">ì •ë ¹ +</div><div class="cell right" id="d${idx}_c_spf_hp">0</div><div class="cell right" id="d${idx}_c_spf_atk">0</div><div class="cell right" id="d${idx}_c_spf_df">0</div>
      <div class="cell">ì •ë ¹ %</div><div class="cell right" id="d${idx}_c_spp_hp">0%</div><div class="cell right" id="d${idx}_c_spp_atk">0%</div><div class="cell right" id="d${idx}_c_spp_df">0%</div>
      <div class="cell">ì •ë ¹ ë¶€ê°€ì˜µ</div><div class="cell right" id="d${idx}_c_spe_hp">0</div><div class="cell right" id="d${idx}_c_spe_atk">0</div><div class="cell right" id="d${idx}_c_spe_df">0</div>
      <div class="cell">ë²„í”„ %</div><div class="cell right" id="d${idx}_c_bf_hp">0%</div><div class="cell right" id="d${idx}_c_bf_atk">0%</div><div class="cell right" id="d${idx}_c_bf_df">0%</div>
      <div class="cell">ë””ë²„í”„ %</div><div class="cell right" id="d${idx}_c_db_hp">0%</div><div class="cell right" id="d${idx}_c_db_atk">0%</div><div class="cell right" id="d${idx}_c_db_df">0%</div>

      <div class="cell section center" style="grid-column:1/5">ìµœì¢… ìŠ¤íƒ¯</div>
      <div class="cell sum">ì²´ë ¥</div><div class="cell big" id="d${idx}_c_fin_hp">-</div>
      <div class="cell sum">ê³µê²©ë ¥</div><div class="cell big" id="d${idx}_c_fin_atk">-</div>
      <div class="cell sum">ë°©ì–´ë ¥</div><div class="cell big" id="d${idx}_c_fin_df">-</div>

      <div class="cell section center" style="grid-column:1/5">ì§€í‘œ</div>
      <div class="cell">E-Value</div><div class="cell big" id="d${idx}_c_eval" style="grid-column:2/5">-</div>
      <div class="cell">B-Value</div><div class="cell big" id="d${idx}_c_bval" style="grid-column:2/5">-</div>
    </div>
  `;
  allResults.appendChild(sheet);
}

  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
  function num(id){ return Number(document.getElementById(id)?.value||0); }

  // ===== ìˆ˜ë™ ê³„ì‚°ê¸° =====
  function manualCalcOne(idx){
    setText(`d${idx}_name_display`, `ë“œë˜ê³¤ ${idx}`);

    const lvl = document.getElementById(`d${idx}_m_level`).value;
    const type = document.getElementById(`d${idx}_m_type`).value;
    const base = dragon[lvl][type];

    // ì ¬ í•©ì‚°
    let g_hp=0, g_atk=0, g_df=0;
    for(let i=1;i<=5;i++){
      const t=document.getElementById(`d${idx}_slot_type_${i}`).value;
      const v=Number(document.getElementById(`d${idx}_slot_val_${i}`).value||0);
      let hp=0, atk=0, df=0;
      if(t==="HP") hp=v; if(t==="ATK") atk=v; if(t==="DEF") df=v;
      g_hp+=hp; g_atk+=atk; g_df+=df;
      setText(`d${idx}_c_g${i}_hp`, hp); setText(`d${idx}_c_g${i}_atk`, atk); setText(`d${idx}_c_g${i}_df`, df);
    }
    const gem = new Stats(g_hp,g_atk,g_df);

    // ì¥ì‹ êµ¬/ì¸ì²¸íŠ¸ (ê³„ì‚°ì€ í•©ì‚°í•´ì„œ, í‘œê¸°ëŠ” ë¶„ë¦¬)
    const accOnly = new Stats(num(`d${idx}_m_acc_hp`)/100, num(`d${idx}_m_acc_atk`)/100, num(`d${idx}_m_acc_df`)/100);
    const enchOnly = new Stats(num(`d${idx}_m_ench_hp`)/100, num(`d${idx}_m_ench_atk`)/100, num(`d${idx}_m_ench_df`)/100);
    const acc = new Stats(accOnly.hp+enchOnly.hp, accOnly.atk+enchOnly.atk, accOnly.df+enchOnly.df);

    const pend = new Stats(num(`d${idx}_m_pend_hp`)/100, num(`d${idx}_m_pend_atk`)/100, num(`d${idx}_m_pend_df`)/100);

    // ì •ë ¹/ë²„í”„/ë””ë²„í”„
    const spf = new Stats(num(`d${idx}_sf_hp`), num(`d${idx}_sf_atk`), num(`d${idx}_sf_df`));
    const spp = new Stats(num(`d${idx}_sp_hp`)/100, num(`d${idx}_sp_atk`)/100, num(`d${idx}_sp_df`)/100);
    const spe = new Stats(num(`d${idx}_se_hp`), num(`d${idx}_se_atk`), num(`d${idx}_se_df`));
    const bf  = new Stats(num(`d${idx}_bf_hp`)/100, num(`d${idx}_bf_atk`)/100, num(`d${idx}_bf_df`)/100);
    const db  = new Stats(num(`d${idx}_db_hp`)/100, num(`d${idx}_db_atk`)/100, num(`d${idx}_db_df`)/100);

    // ìƒìˆ˜
    const pot = new Stats(24,6,6);
    const col = new Stats(240,60,60);

    const [fin, E, B] = calcPredict(base, gem, pot, acc, pend, spf, spp, spe, col, bf, db);

    // ê²°ê³¼ ì‹œíŠ¸
    setText(`d${idx}_c_base_hp`, base.hp);
    setText(`d${idx}_c_base_atk`, base.atk);
    setText(`d${idx}_c_base_df`, base.df);

    // í¼ì„¼íŠ¸ í‘œê¸°(ë¶„ë¦¬)
    setText(`d${idx}_c_acc_hp`, (accOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_atk`, (accOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_acc_df`, (accOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_ench_hp`, (enchOnly.hp*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_atk`, (enchOnly.atk*100).toFixed(0)+'%');
    setText(`d${idx}_c_ench_df`, (enchOnly.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_pend_hp`, document.getElementById(`d${idx}_m_pend_hp`).value + '%');
    setText(`d${idx}_c_pend_atk`, document.getElementById(`d${idx}_m_pend_atk`).value + '%');
    setText(`d${idx}_c_pend_df`, document.getElementById(`d${idx}_m_pend_df`).value + '%');

    setText(`d${idx}_c_spf_hp`, spf.hp); setText(`d${idx}_c_spf_atk`, spf.atk); setText(`d${idx}_c_spf_df`, spf.df);
    setText(`d${idx}_c_spp_hp`, (spp.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_atk`, (spp.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_spp_df`, (spp.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_spe_hp`, spe.hp); setText(`d${idx}_c_spe_atk`, spe.atk); setText(`d${idx}_c_spe_df`, spe.df);
    setText(`d${idx}_c_bf_hp`, (bf.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_atk`, (bf.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_bf_df`, (bf.df*100).toFixed(0)+'%');
    setText(`d${idx}_c_db_hp`, (db.hp*100).toFixed(0)+'%'); setText(`d${idx}_c_db_atk`, (db.atk*100).toFixed(0)+'%'); setText(`d${idx}_c_db_df`, (db.df*100).toFixed(0)+'%');

    setText(`d${idx}_c_fin_hp`, fin.hp);
    setText(`d${idx}_c_fin_atk`, fin.atk);
    setText(`d${idx}_c_fin_df`, fin.df);
    setText(`d${idx}_c_eval`, Math.round(E).toString());
    setText(`d${idx}_c_bval`, (B/1e6).toFixed(3));  // ë‹¨ìœ„ â€˜Mâ€™ í‘œì‹œ ì—†ìŒ
  }

  function manualCalcAll(){
    ManualDragonState.dragons.forEach(dragon => {
      manualCalcOne(dragon.displayNumber);
    });
  }

  function savePngAll(){
    const node = document.getElementById('allResults');
    manualCalcAll(); // ìµœì‹  ê°’ ë³´ì¥
    const w = node.scrollWidth;
    const h = node.scrollHeight;

    html2canvas(node, {
      backgroundColor: null,
      scale: 2,
      width:  w,
      height: h,
      windowWidth:  w,
      windowHeight: h
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='dragon_calculate.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  const autoDiv=document.getElementById('autoCalc');
  const manualDiv=document.getElementById('manualCalc');
  const serverDiv=document.getElementById('serverCalc');
  const btnAuto=document.getElementById('btnAuto');
  const btnManual=document.getElementById('btnManual');
  const btnServer=document.getElementById('btnServer');

  // ê° ëª¨ë“œì˜ ë…ë¦½ì ì¸ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
  let autoScrollPos = 0;
  let manualScrollPos = 0;
  let serverScrollPos = 0;

  // ===== UI ëª¨ë“œ ì „í™˜ =====
  function switchMode(mode){
    if(mode==='auto'){
      manualScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      autoDiv.classList.add('active');
      manualDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnAuto.classList.add('active');
      btnManual.classList.remove('active');
      btnServer.classList.remove('active');

      window.scrollTo(0, autoScrollPos);
    }else if(mode==='manual'){
      autoScrollPos = window.scrollY;
      serverScrollPos = window.scrollY;

      manualDiv.classList.add('active');
      autoDiv.classList.remove('active');
      serverDiv.classList.remove('active');
      btnManual.classList.add('active');
      btnAuto.classList.remove('active');
      btnServer.classList.remove('active');

      window.scrollTo(0, manualScrollPos);
    }else if(mode==='server'){
      autoScrollPos = window.scrollY;
      manualScrollPos = window.scrollY;

      serverDiv.classList.add('active');
      autoDiv.classList.remove('active');
      manualDiv.classList.remove('active');
      btnServer.classList.add('active');
      btnAuto.classList.remove('active');
      btnManual.classList.remove('active');

      window.scrollTo(0, serverScrollPos);
      loadSlotList(); // ìŠ¬ë¡¯ ëª©ë¡ ë¡œë“œ
    }
  }
  btnAuto.onclick=()=>switchMode('auto');
  btnManual.onclick=()=>switchMode('manual');
  btnServer.onclick=()=>switchMode('server');

  // ì ê¸ˆ/ê³µìœ  ì„ íƒ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ í‘œì‹œ
  document.querySelectorAll('input[name="slotType"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const isPrivate = document.querySelector('input[name="slotType"]:checked').value === 'private';
      document.getElementById('slotPasswordRow').style.display = isPrivate ? 'flex' : 'none';
    });
  });

  // ===== Firebase ì„œë²„ ê´€ë¦¬ =====
  // ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (SHA-256)
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  // ìŠ¬ë¡¯ ë§Œë“¤ê¸°
  async function createSlot() {
    const name = document.getElementById('newSlotName').value.trim();
    if (!name) {
      alert('ìŠ¬ë¡¯ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const type = document.querySelector('input[name="slotType"]:checked').value;
    const isPrivate = type === 'private';

    let passwordHash = null;
    if (isPrivate) {
      const password = document.getElementById('slotPassword').value;
      if (!password) {
        alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      passwordHash = await hashPassword(password);
    }

    const slotData = {
      name: name,
      type: type,
      passwordHash: passwordHash,
      createdAt: Date.now(),
      data: []
    };

    try {
      const newSlotRef = window.firebasePush(window.firebaseRef(window.firebaseDB, 'slots'));
      await window.firebaseSet(newSlotRef, slotData);

      alert(`ìŠ¬ë¡¯ "${name}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
      document.getElementById('newSlotName').value = '';
      document.getElementById('slotPassword').value = '';
      loadSlotList();
    } catch (error) {
      console.error('ìŠ¬ë¡¯ ìƒì„± ì˜¤ë¥˜:', error);
      alert('ìŠ¬ë¡¯ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ìŠ¬ë¡¯ ëª©ë¡ ë¡œë“œ
  function loadSlotList() {
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    window.firebaseOnValue(slotsRef, (snapshot) => {
      const slotListEl = document.getElementById('slotList');
      slotListEl.innerHTML = '';

      if (!snapshot.exists()) {
        slotListEl.innerHTML = '<p style="color:#999;text-align:center;padding:40px 0">ì €ì¥ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const slots = snapshot.val();
      Object.keys(slots).forEach(slotId => {
        const slot = slots[slotId];
        const slotBox = document.createElement('div');
        slotBox.style.cssText = 'border:1px solid var(--border);background:#fff;border-radius:8px;padding:12px;margin-bottom:10px';

        const lockIcon = slot.type === 'private' ? 'ğŸ”’ ' : '';
        const dataCount = slot.data ? slot.data.length : 0;
        const createdDate = new Date(slot.createdAt).toLocaleString('ko-KR');

        slotBox.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <strong style="font-size:16px">${lockIcon} ${slot.name}</strong>
              <div style="color:#666;font-size:12px;margin-top:4px">
                ìƒì„±ì¼: ${createdDate} | ì €ì¥ëœ ë°ì´í„°: ${dataCount}ê°œ
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" onclick="viewSlot('${slotId}')" style="background:#4CAF50;color:#fff;border-color:#4CAF50;">ì—´ëŒí•˜ê¸°</button>
              <button class="btn" onclick="clearSlotData('${slotId}')" style="background:#ff9800;color:#fff;border-color:#ff9800;">ë°ì´í„° ë¹„ìš°ê¸°</button>
              <button class="btn" onclick="deleteSlot('${slotId}')" style="background:#f44336;color:#fff;border-color:#f44336;">ìŠ¬ë¡¯ ì‚­ì œ</button>
            </div>
          </div>
        `;
        slotListEl.appendChild(slotBox);
      });
    });
  }

  // ìŠ¬ë¡¯ ì—´ëŒ
  async function viewSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    // ë°ì´í„° í‘œì‹œ - ëª¨ë‹¬ë¡œ ê°œì„ 
    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ëª¨ë‹¬ ìƒì„±
    let modalContent = `
      <div id="viewSlotModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #ddd;padding-bottom:12px;">
            <h3 style="margin:0;color:#111;">ğŸ“ ${slot.name}</h3>
            <button class="btn" onclick="closeViewSlotModal()" style="padding:6px 12px;">ë‹«ê¸°</button>
          </div>

          <!-- ìƒë‹¨ íƒ­ ë° ê²€ìƒ‰/ë‹¤ìš´ë¡œë“œ -->
          <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:8px;">
              <button class="btn primary" id="btnDetailView" onclick="switchViewMode('detail')" style="padding:8px 16px;">ìƒì„¸ ë³´ê¸°</button>
              <button class="btn" id="btnSummaryView" onclick="switchViewMode('summary')" style="padding:8px 16px;">ìš”ì•½ í†µê³„</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="userSearchInput" type="text" placeholder="ìœ ì € ê²€ìƒ‰..." style="padding:6px 12px;border:1px solid #aaa;border-radius:4px;width:150px;">
              <button class="btn" onclick="filterByUser()" style="padding:6px 12px;">ğŸ” ê²€ìƒ‰</button>
              <button class="btn" id="btnExportStats" onclick="exportToExcel()" style="padding:6px 12px;background:#28a745;color:#fff;border-color:#28a745;display:none;">ğŸ“Š í†µê³„ ì €ì¥</button>
            </div>
          </div>

          <div id="viewSlotContent"></div>
          <div id="viewSlotSummary" style="display:none;"></div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // ë°ì´í„°ë¥¼ ì „ì—­ì— ì €ì¥ (í•„í„°ë§ ë° í†µê³„ìš©)
    window._currentSlotData = dataList;

    // ìƒì„¸ ë³´ê¸° ì´ˆê¸° ë Œë”ë§ (í•¨ìˆ˜ ì •ì˜ ì „ì´ë¯€ë¡œ setTimeout ì‚¬ìš©)
    setTimeout(() => window.renderDetailView(dataList), 0);
  }

  // ì—´ëŒ ëª¨ë‹¬ ë‹«ê¸°
  window.closeViewSlotModal = function() {
    const modal = document.getElementById('viewSlotModal');
    if (modal) modal.remove();
    delete window._currentSlotData;
    delete window._currentFilteredData;
  }

  // ë·° ëª¨ë“œ ì „í™˜ (ìƒì„¸ ë³´ê¸° / ìš”ì•½ í†µê³„)
  window.switchViewMode = function(mode) {
    const detailBtn = document.getElementById('btnDetailView');
    const summaryBtn = document.getElementById('btnSummaryView');
    const exportBtn = document.getElementById('btnExportStats');
    const contentDiv = document.getElementById('viewSlotContent');
    const summaryDiv = document.getElementById('viewSlotSummary');

    if (mode === 'detail') {
      detailBtn.classList.add('primary');
      summaryBtn.classList.remove('primary');
      contentDiv.style.display = 'block';
      summaryDiv.style.display = 'none';
      exportBtn.style.display = 'none';
    } else if (mode === 'summary') {
      detailBtn.classList.remove('primary');
      summaryBtn.classList.add('primary');
      contentDiv.style.display = 'none';
      summaryDiv.style.display = 'block';
      exportBtn.style.display = 'inline-block';
      renderSummaryStats();
    }
  }

  // ìš”ì•½ í†µê³„ ë Œë”ë§
  window.renderSummaryStats = function() {
    const summaryDiv = document.getElementById('viewSlotSummary');
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      summaryDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px 0;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    // ë™ì  ë“œë˜ê³¤ ìˆ˜ ê³„ì‚° (ì²« ë²ˆì§¸ ì—”íŠ¸ë¦¬ ê¸°ì¤€)
    const maxDragons = Math.max(...dataList.map(entry => entry.dragons?.length || 0), 3);

    let headerCols = '';
    for (let i = 1; i <= maxDragons; i++) {
      headerCols += `<th style="padding:12px;text-align:center;border:1px solid #ddd;">ë“œë˜ê³¤${i} (ë¹„ë²¨)</th>`;
    }

    let summaryHtml = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#2d6cdf;color:#fff;">
              <th style="padding:12px;text-align:left;border:1px solid #ddd;">ìœ ì €ì´ë¦„</th>
              ${headerCols}
              <th style="padding:12px;text-align:center;border:1px solid #ddd;">í•©ê³„</th>
            </tr>
          </thead>
          <tbody>
    `;

    dataList.forEach((entry, index) => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });

      const total = bValues.reduce((sum, val) => sum + val, 0);
      const rowBg = index % 2 === 0 ? '#f9f9f9' : '#fff';

      let dataCols = '';
      for (let i = 0; i < maxDragons; i++) {
        const value = bValues[i] !== undefined ? bValues[i].toFixed(3) : '-';
        dataCols += `<td style="padding:10px;border:1px solid #ddd;text-align:center;">${value}</td>`;
      }

      summaryHtml += `
        <tr style="background:${rowBg};">
          <td style="padding:10px;border:1px solid #ddd;font-weight:600;">${entry.userName}</td>
          ${dataCols}
          <td style="padding:10px;border:1px solid #ddd;text-align:center;font-weight:700;background:#e3f2fd;">${total.toFixed(3)}</td>
        </tr>
      `;
    });

    summaryHtml += `
          </tbody>
        </table>
      </div>
    `;

    summaryDiv.innerHTML = summaryHtml;
  }

  // ìœ ì € ê²€ìƒ‰ í•„í„°
  window.filterByUser = function() {
    const searchInput = document.getElementById('userSearchInput');
    const searchTerm = searchInput.value.trim().toLowerCase();

    if (!searchTerm) {
      // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„° í‘œì‹œ
      window._currentFilteredData = null;
      renderDetailView(window._currentSlotData);
      renderSummaryStats();
      return;
    }

    // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
    const filtered = window._currentSlotData.filter(entry =>
      entry.userName.toLowerCase().includes(searchTerm)
    );

    if (filtered.length === 0) {
      alert(`"${searchInput.value}" ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }

    window._currentFilteredData = filtered;
    renderDetailView(filtered);
    renderSummaryStats();
  }

  // ìƒì„¸ ë³´ê¸° ì¬ë Œë”ë§
  window.renderDetailView = function(dataList) {
    const contentDiv = document.getElementById('viewSlotContent');
    contentDiv.innerHTML = '';

    dataList.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.style.cssText = 'border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9f9f9;';

      let entryHtml = `
        <div style="background:#2d6cdf;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
          <strong style="font-size:16px;">[${index + 1}] ${entry.userName}</strong>
          <span style="font-size:12px;opacity:0.9;">${new Date(entry.timestamp).toLocaleString('ko-KR')}</span>
        </div>
      `;

      entry.dragons.forEach((dragon, dragonIdx) => {
        const dragonName = dragon.name || `ë“œë˜ê³¤ ${dragonIdx + 1}`;

        // ì €ì¥ëœ ê²°ê³¼ê°’ ì‚¬ìš©
        const finalStats = dragon.finalStats || { hp: 0, atk: 0, df: 0 };
        const eValue = dragon.eValue || 0;
        const bValue = dragon.bValue || 0;

        entryHtml += `
          <div style="border:1px solid #ccc;border-radius:6px;padding:12px;margin-bottom:10px;background:#fff;">
            <h4 style="margin:0 0 10px;color:#2d6cdf;border-bottom:1px solid #eee;padding-bottom:6px;">${dragonName}</h4>

            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:12px;border-radius:6px;margin-bottom:12px;">
              <div style="font-size:14px;font-weight:700;margin-bottom:8px;">ğŸ“Š ìµœì¢… ê³„ì‚° ê²°ê³¼</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;font-size:13px;">
                <div><strong>HP:</strong> ${finalStats.hp.toLocaleString()}</div>
                <div><strong>ATK:</strong> ${finalStats.atk.toLocaleString()}</div>
                <div><strong>DEF:</strong> ${finalStats.df.toLocaleString()}</div>
              </div>
              <div style="border-top:1px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">E-Value (ì´ë²¨)</div>
                  <div style="font-size:18px;font-weight:900;">${eValue.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.2);padding:6px;border-radius:4px;text-align:center;">
                  <div style="font-size:11px;opacity:0.9;">B-Value (ë¹„ë²¨)</div>
                  <div style="font-size:18px;font-weight:900;">${bValue.toFixed(3)}</div>
                </div>
              </div>
            </div>

            <!-- ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ -->
            <div style="display:grid !important;grid-template-columns:1fr 1fr !important;gap:15px;font-size:13px;">

              <!-- ê¸°ë³¸ ì •ë³´ -->
              <div style="display:flex !important;flex-direction:column !important;gap:10px;">
                <div><strong>ë“±ê¸‰/íƒ€ì…:</strong><br>${dragon.level} / ${dragon.type}</div>
              </div>

            </div>
          </div>
        `;
      });

      entryDiv.innerHTML = entryHtml;
      contentDiv.appendChild(entryDiv);
    });
  }

  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (CSV í˜•ì‹)
  window.exportToExcel = function() {
    const dataList = window._currentFilteredData || window._currentSlotData || [];

    if (dataList.length === 0) {
      alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ë™ì  ë“œë˜ê³¤ ìˆ˜ ê³„ì‚°
    const maxDragons = Math.max(...dataList.map(entry => entry.dragons?.length || 0), 3);

    // CSV í—¤ë”
    let headerCols = [];
    for (let i = 1; i <= maxDragons; i++) {
      headerCols.push(`ë“œë˜ê³¤${i}`);
    }
    let csv = `ìœ ì €ì´ë¦„,${headerCols.join(',')},í•©ê³„\n`;

    // CSV ë°ì´í„°
    dataList.forEach(entry => {
      const bValues = entry.dragons.map(dragon => {
        return dragon.bValue || 0;
      });
      const total = bValues.reduce((sum, val) => sum + val, 0);

      let dataCols = [];
      for (let i = 0; i < maxDragons; i++) {
        const value = bValues[i] !== undefined ? bValues[i].toFixed(3) : '0.000';
        dataCols.push(value);
      }

      csv += `${entry.userName},${dataCols.join(',')},${total.toFixed(3)}\n`;
    });

    // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `dragon_stats_${new Date().getTime()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  // ìŠ¬ë¡¯ì˜ ë°ì´í„°ë§Œ ë¹„ìš°ê¸° (ìŠ¬ë¡¯ì€ ìœ ì§€) - ì„ íƒ ì‚­ì œ ë°©ì‹
  async function clearSlotData(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    const dataList = slot.data || [];
    if (dataList.length === 0) {
      alert('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì‚­ì œí•  ë°ì´í„° ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    showDeleteSelectionModal(slotId, slot.name, dataList);
  }

  // ë°ì´í„° ì„ íƒ ì‚­ì œ ëª¨ë‹¬
  function showDeleteSelectionModal(slotId, slotName, dataList) {
    const modalId = 'deleteSelectionModal';

    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    const existingModal = document.getElementById(modalId);
    if (existingModal) existingModal.remove();

    const modalContent = `
      <div id="${modalId}" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999;padding:20px;box-sizing:border-box;">
        <div style="background:#fff;border-radius:12px;max-width:800px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3);">

          <!-- í—¤ë” -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;font-size:20px;">ğŸ—‘ï¸ "${slotName}" ë°ì´í„° ì„ íƒ ì‚­ì œ</h2>
            <button onclick="document.getElementById('${modalId}').remove()" style="background:none;border:none;color:#fff;font-size:28px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;line-height:1;">&times;</button>
          </div>

          <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
          <div style="padding:15px 20px;background:#fff3cd;border-bottom:1px solid #ffc107;color:#856404;">
            <strong>âš ï¸ ì£¼ì˜:</strong> ì„ íƒí•œ ë°ì´í„°ëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. (ì´ ${dataList.length}ê°œ)
          </div>

          <!-- ì „ì²´ ì„ íƒ ì»¨íŠ¸ë¡¤ -->
          <div style="padding:15px 20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:bold;">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="width:18px;height:18px;cursor:pointer;">
              <span>ì „ì²´ ì„ íƒ</span>
            </label>
            <span id="selectedCount" style="color:#666;font-size:14px;">ì„ íƒ: 0ê°œ</span>
          </div>

          <!-- ë°ì´í„° ëª©ë¡ -->
          <div id="deleteDataList" style="flex:1;overflow-y:auto;padding:15px 20px;">
            ${dataList.map((entry, index) => {
              const timestamp = new Date(entry.timestamp).toLocaleString('ko-KR');
              const dragonCount = entry.dragons ? entry.dragons.length : 0;

              return `
                <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:10px;background:#f9f9f9;display:flex;align-items:center;gap:12px;">
                  <input type="checkbox" class="data-checkbox" data-index="${index}" onchange="updateSelectedCount()" style="width:18px;height:18px;cursor:pointer;flex-shrink:0;">
                  <div style="flex:1;">
                    <div style="font-weight:bold;color:#2d6cdf;margin-bottom:4px;">[${index + 1}] ${entry.userName}</div>
                    <div style="font-size:13px;color:#666;">
                      <span>ğŸ“… ${timestamp}</span>
                      <span style="margin-left:12px;">ğŸ‰ ë“œë˜ê³¤ ${dragonCount}ë§ˆë¦¬</span>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- í•˜ë‹¨ ë²„íŠ¼ -->
          <div style="padding:15px 20px;background:#f8f9fa;border-top:1px solid #dee2e6;display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="document.getElementById('${modalId}').remove()" style="padding:10px 20px;background:#6c757d;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;">ì·¨ì†Œ</button>
            <button onclick="executeDeleteSelected('${slotId}')" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">ì„ íƒ í•­ëª© ì‚­ì œ</button>
          </div>

        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);

    // ì „ì²´ ì„ íƒ/í•´ì œ í•¨ìˆ˜
    window.toggleSelectAll = function() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.data-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
      updateSelectedCount();
    };

    // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    window.updateSelectedCount = function() {
      const checkboxes = document.querySelectorAll('.data-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      document.getElementById('selectedCount').textContent = `ì„ íƒ: ${checkedCount}ê°œ`;

      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      selectAllCheckbox.checked = checkedCount === checkboxes.length && checkedCount > 0;
    };

    // ì„ íƒ í•­ëª© ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜
    window.executeDeleteSelected = async function(slotId) {
      const checkboxes = document.querySelectorAll('.data-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

      if (!confirm(`ì„ íƒí•œ ${selectedIndices.length}ê°œì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }

      try {
        // ìŠ¬ë¡¯ ë°ì´í„° ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
        const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
        const snapshot = await window.firebaseGet(slotRef);

        if (!snapshot.exists()) {
          alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const slot = snapshot.val();
        const currentData = slot.data || [];

        // ì„ íƒë˜ì§€ ì•Šì€ í•­ëª©ë§Œ ë‚¨ê¸°ê¸° (ì¸ë±ìŠ¤ ì—­ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì‚­ì œ)
        const newData = currentData.filter((_, index) => !selectedIndices.includes(index));

        // Firebase ì—…ë°ì´íŠ¸
        const dataRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}/data`);
        await window.firebaseSet(dataRef, newData);

        alert(`${selectedIndices.length}ê°œì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('deleteSelectionModal').remove();

        // ìŠ¬ë¡¯ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadSlotList();
      } catch (error) {
        console.error('ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
  }

  // ìŠ¬ë¡¯ ì™„ì „ ì‚­ì œ
  async function deleteSlot(slotId) {
    const slotRef = window.firebaseRef(window.firebaseDB, `slots/${slotId}`);
    const snapshot = await window.firebaseGet(slotRef);

    if (!snapshot.exists()) {
      alert('ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const slot = snapshot.val();

    // ì ê¸ˆëœ ìŠ¬ë¡¯ì€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (slot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== slot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    if (!confirm(`"${slot.name}" ìŠ¬ë¡¯ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ìŠ¬ë¡¯ê³¼ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
      return;
    }

    // í•œ ë²ˆ ë” í™•ì¸
    const confirmText = prompt('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (confirmText !== 'ì‚­ì œ') {
      alert('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      await window.firebaseSet(slotRef, null);
      alert(`"${slot.name}" ìŠ¬ë¡¯ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadSlotList();
    } catch (error) {
      console.error('ìŠ¬ë¡¯ ì‚­ì œ ì˜¤ë¥˜:', error);
      alert('ìŠ¬ë¡¯ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.clearSlotData = clearSlotData;
  window.deleteSlot = deleteSlot;

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¬ë¡¯ ëª©ë¡ ìë™ ë¡œë“œ (Firebase ì´ˆê¸°í™” í›„)
  setTimeout(() => {
    if (window.firebaseDB) {
      loadSlotList();
    }
  }, 1000);

  // ìˆ˜ë™ê³„ì‚°ê¸° ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥
  async function saveToServer() {
    // ìŠ¬ë¡¯ ëª©ë¡ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
    const slotsRef = window.firebaseRef(window.firebaseDB, 'slots');
    const snapshot = await window.firebaseGet(slotsRef);

    if (!snapshot.exists()) {
      alert('ì €ì¥ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì €ì¥ ì„œë²„ íƒ­ì—ì„œ ìŠ¬ë¡¯ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }

    const slots = snapshot.val();
    const slotList = Object.keys(slots).map(id => ({id, ...slots[id]}));

    // 2. ìŠ¬ë¡¯ ì„ íƒ ëª¨ë‹¬ ìƒì„±
    const modalHtml = `
      <div id="slotSelectModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:24px;">
          <h3 style="margin:0 0 16px;color:#111;">ìŠ¬ë¡¯ ì„ íƒ</h3>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">ìœ ì € ì´ë¦„</label>
            <input id="saveUserName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;height:36px;border:1px solid #aaa;border-radius:6px;padding:0 12px;box-sizing:border-box;">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:6px;font-weight:700;">ì €ì¥í•  ìŠ¬ë¡¯</label>
            <div id="slotSelectList" style="border:1px solid #ddd;border-radius:6px;max-height:300px;overflow-y:auto;"></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="closeSlotModal()" style="padding:10px 20px;">ì·¨ì†Œ</button>
            <button class="btn primary" onclick="confirmSlotSelection()" style="padding:10px 20px;">ì €ì¥</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 3. ìŠ¬ë¡¯ ëª©ë¡ ë Œë”ë§
    const slotSelectList = document.getElementById('slotSelectList');
    slotList.forEach((slot, index) => {
      const lockIcon = slot.type === 'private' ? 'ğŸ”’ ' : '';
      const dataCount = slot.data ? slot.data.length : 0;

      const slotItem = document.createElement('div');
      slotItem.style.cssText = 'padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;';
      slotItem.innerHTML = `
        <input type="radio" name="selectedSlot" value="${index}" id="slot_${index}" style="margin-right:8px;">
        <label for="slot_${index}" style="cursor:pointer;display:inline;">
          <strong>${lockIcon} ${slot.name}</strong>
          <span style="color:#666;font-size:12px;margin-left:8px;">(${dataCount}ê°œ ì €ì¥ë¨)</span>
        </label>
      `;
      slotItem.addEventListener('mouseover', () => slotItem.style.background = '#f5f5f5');
      slotItem.addEventListener('mouseout', () => slotItem.style.background = '');
      slotItem.addEventListener('click', (e) => {
        if(e.target.tagName !== 'INPUT') {
          document.getElementById(`slot_${index}`).checked = true;
        }
      });
      slotSelectList.appendChild(slotItem);
    });

    // ìŠ¬ë¡¯ ë¦¬ìŠ¤íŠ¸ë¥¼ ì „ì—­ì— ì €ì¥
    window._slotList = slotList;
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  window.closeSlotModal = function() {
    const modal = document.getElementById('slotSelectModal');
    if (modal) modal.remove();
    delete window._slotList;
  }

  // ìŠ¬ë¡¯ ì„ íƒ í™•ì • ë° ì €ì¥
  window.confirmSlotSelection = async function() {
    const userName = document.getElementById('saveUserName')?.value?.trim();
    if (!userName) {
      alert('ìœ ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const selectedRadio = document.querySelector('input[name="selectedSlot"]:checked');
    if (!selectedRadio) {
      alert('ì €ì¥í•  ìŠ¬ë¡¯ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const selectedIndex = parseInt(selectedRadio.value);
    const selectedSlot = window._slotList[selectedIndex];

    // ì ê¸ˆ ìŠ¬ë¡¯ì´ë©´ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (selectedSlot.type === 'private') {
      const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!password) return;

      const inputHash = await hashPassword(password);
      if (inputHash !== selectedSlot.passwordHash) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    // Helper í•¨ìˆ˜: í…ìŠ¤íŠ¸ ê°’ ê°€ì ¸ì˜¤ê¸°
    const getText = (id) => {
      const el = document.getElementById(id);
      return el ? el.textContent.trim() : '';
    };

    // Helper í•¨ìˆ˜: ìˆ«ì ê°’ ê°€ì ¸ì˜¤ê¸°
    const getNum = (id) => {
      const el = document.getElementById(id);
      const text = el ? el.textContent.trim() : '0';
      return Number(text.replace(/,/g, '')) || 0;
    };

    // ì„ íƒëœ ë“œë˜ê³¤ë§Œ ê³„ì‚°ëœ ê²°ê³¼ê°’ ìˆ˜ì§‘ (4ë§ˆë¦¬ ì´ìƒì¼ ë•ŒëŠ” ì„ íƒëœ ê²ƒë§Œ, 3ë§ˆë¦¬ ì´í•˜ë©´ ëª¨ë‘)
    const dragons = [];
    ManualDragonState.dragons
      .filter(d => ManualDragonState.selectedForResult.has(d.displayNumber))
      .forEach(dragon => {
        const i = dragon.displayNumber;
        const dragonData = {
          level: document.getElementById(`d${i}_m_level`)?.value || '9.0',
          type: document.getElementById(`d${i}_m_type`)?.value || 'ê³µê²©í˜•',
          // ê³„ì‚°ëœ ìµœì¢… ê²°ê³¼ê°’
          finalStats: {
            hp: getNum(`d${i}_c_fin_hp`),
            atk: getNum(`d${i}_c_fin_atk`),
            df: getNum(`d${i}_c_fin_df`)
          },
          eValue: getNum(`d${i}_c_eval`),
          bValue: parseFloat(getText(`d${i}_c_bval`)) || 0
        };

        dragons.push(dragonData);
      });

    // Firebaseì— ì €ì¥
    const saveData = {
      userName: userName,
      timestamp: Date.now(),
      dragons: dragons
    };

    try {
      const currentData = selectedSlot.data || [];
      currentData.push(saveData);

      const slotRef = window.firebaseRef(window.firebaseDB, `slots/${selectedSlot.id}/data`);
      await window.firebaseSet(slotRef, currentData);

      closeSlotModal();
      alert(`"${selectedSlot.name}" ìŠ¬ë¡¯ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
  </script>
</body>
</html>
