<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex, nofollow" />
<title>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{font-family:Consolas,"Noto Sans KR",sans-serif;margin:24px;background:#f7f7f9;color:#111}
.modebar{margin-bottom:16px;display:flex;gap:10px}
.btn{padding:8px 14px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:4px}
.btn.primary{background:#2d6cdf;border-color:#2d6cdf;color:#fff}
.calc-container{display:none}
.calc-container.active{display:block}
iframe{width:100%;border:1px solid #ccc;border-radius:8px;background:#fff}
</style>
</head>
<body>
<h2>ğŸ‰ ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ í†µí•© ê³„ì‚°ê¸°</h2>
<div class="modebar">
  <button class="btn primary" id="btnAuto">ìë™ ê³„ì‚°ê¸°</button>
  <button class="btn" id="btnManual">ìˆ˜ë™ ê³„ì‚°ê¸°</button>
</div>

<!-- ìë™ ê³„ì‚°ê¸° -->
<div id="autoCalc" class="calc-container active">
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<title>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ ê³„ì‚°ê¸°</title>
<style>
  body { font-family: Consolas, "Noto Sans KR", sans-serif; margin: 24px; background:#f7f7f9; }
  h2 { margin-bottom: 8px; }
  .hint { color:#666; margin-bottom: 14px; }
  fieldset { background:#fff; border:1px solid #ccc; padding:12px; margin-bottom:14px; }
  legend { font-weight:bold; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .row label { margin-right:8px; }
  input[type="number"] { width:84px; text-align:center; }
  .acc-list { max-height:180px; overflow:auto; border:1px solid #ddd; padding:8px; background:#fcfcfc; }
  .btn { padding:8px 14px; cursor:pointer; border:1px solid #999; background:#fff; }
  .btn:hover { background:#f0f0f0; }
  .btn.primary { border-color:#2d6cdf; background:#2d6cdf; color:#fff; }
  .toolbar { display:flex; gap:8px; margin:8px 0; flex-wrap:wrap; }
  #result { white-space:pre; background:#111; color:#e5e5e5; padding:12px; border-radius:6px; min-height:220px; }
  .small { color:#888; font-size:12px; }

  /* =========================
     ì •ë ¹ / ë²„í”„ / ë””ë²„í”„ ì „ìš© ì •ë ¬
     ========================= */
  .row-spirit { 
    display: grid; 
    grid-template-columns: 150px 90px 90px 90px auto; 
    align-items: center; 
    column-gap: 8px;
    margin-bottom: 6px; 
  }

  .row-spirit strong { 
    text-align: right; 
    padding-right: 4px; 
    font-size: 14px; 
    font-weight: bold;
  }

  .row-spirit input[type="number"] { 
    width: 84px; 
    height: 28px; 
    text-align: center; 
    border: 1px solid #aaa; 
    border-radius: 4px; 
    font-size: 13px; 
    background: #fff; 
  }

  .row-spirit .small {
    text-align: left;
    color: #888;
    font-size: 12px;
    margin-left: 4px;
  }
</style>
</head>
<body>
  <h2>ë“œë˜ê³¤ ë¹„ë²¨/ì´ë²¨ ê³„ì‚°ê¸°</h2>
  <div class="hint small">ëª¨ë“  ì…ë ¥ ê°’ì€ HP/ATK/DEF ìˆœì„œë¥¼ ë”°ë¦…ë‹ˆë‹¤. Â· made by í—¬ë¦­ìŠ¤</div>

  <!-- ë“±ê¸‰ / íƒ€ì… -->
  <fieldset>
    <legend>ë“±ê¸‰ / íƒ€ì… ì„ íƒ</legend>
    <div class="row">
      <label><input type="radio" name="level" value="7.0" checked>7.0</label>
      <label><input type="radio" name="level" value="8.0">8.0</label>
      <label><input type="radio" name="level" value="9.0">9.0</label>
    </div>
    <div class="row" style="margin-top:6px">
      <label><input type="checkbox" class="dtype" value="ê³µê²©í˜•" checked>ê³µê²©í˜•</label>
      <label><input type="checkbox" class="dtype" value="ë°©ì–´í˜•" checked>ë°©ì–´í˜•</label>
      <label><input type="checkbox" class="dtype" value="ì²´ë ¥í˜•" checked>ì²´ë ¥í˜•</label>
      <label><input type="checkbox" class="dtype" value="ê³µë°©í˜•" checked>ê³µë°©í˜•</label>
      <label><input type="checkbox" class="dtype" value="ì²´ê³µí˜•" checked>ì²´ê³µí˜•</label>
      <label><input type="checkbox" class="dtype" value="ì²´ë°©í˜•" checked>ì²´ë°©í˜•</label>
    </div>
  </fieldset>

  <!-- ì ¬ ì„ íƒ -->
  <fieldset>
    <legend>ì ¬ ì„ íƒ (â€» ë³µìˆ˜ ì„ íƒ ë¶ˆê°€)</legend>
    <div class="row">
      <strong>HP</strong>
      <label><input type="radio" name="gem_hp" value="160">160</label>
      <label><input type="radio" name="gem_hp" value="156" checked>156</label>
      <label><input type="radio" name="gem_hp" value="152">152</label>
      <label><input type="radio" name="gem_hp" value="148">148</label>
    </div>
    <div class="row">
      <strong>ATK</strong>
      <label><input type="radio" name="gem_atk" value="40">40</label>
      <label><input type="radio" name="gem_atk" value="39" checked>39</label>
      <label><input type="radio" name="gem_atk" value="38">38</label>
      <label><input type="radio" name="gem_atk" value="37">37</label>
    </div>
    <div class="row">
      <strong>DEF</strong>
      <label><input type="radio" name="gem_df" value="40">40</label>
      <label><input type="radio" name="gem_df" value="39" checked>39</label>
      <label><input type="radio" name="gem_df" value="38">38</label>
      <label><input type="radio" name="gem_df" value="37">37</label>
    </div>
  </fieldset>

  <!-- ì¥ì‹ êµ¬ -->
  <fieldset>
    <legend>ì¥ì‹ êµ¬ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</legend>
    <div class="toolbar">
      <button class="btn" type="button" onclick="toggleLevel(19)">Lv19 ì „ì²´ ì„ íƒ</button>
      <button class="btn" type="button" onclick="toggleLevel(18)">Lv18 ì „ì²´ ì„ íƒ</button>
      <button class="btn" type="button" onclick="toggleLevel(17)">Lv17 ì „ì²´ ì„ íƒ</button>
      <button class="btn" type="button" onclick="selectNone()">ì „ì²´ í•´ì œ</button>
    </div>
    <div id="accList" class="acc-list"></div>
  </fieldset>

<!-- íœë˜íŠ¸ -->
<fieldset>
  <legend>íœë˜íŠ¸</legend>

  <!-- ë²„ì „ ì„ íƒ -->
  <div class="row" style="margin-bottom:8px;">
    <strong>ë²„ì „ ì„ íƒ:</strong>
    <label><input type="radio" name="pendant_ver" value="v1" checked>Ver1 (ìë™ ë¶„ë°°)</label>
    <label><input type="radio" name="pendant_ver" value="v2">Ver2 (ì§€ì • ë¶„ë°°)</label>
    <label><input type="radio" name="pendant_ver" value="v3">Ver3 (ìˆ˜ë™ ì…ë ¥)</label>
  </div>

  <!-- ìë™ ë¶„ë°°ìš© (Ver1, Ver2 ê³µìš©) -->
  <div class="row" id="pendant_auto_row">
    <strong>ì¢…ë¥˜ / ê°’ ì…ë ¥:</strong>
    <label><input type="radio" name="pendant_mode" value="ë³„" checked>ë³„</label>
    <label><input type="radio" name="pendant_mode" value="ë‹¬">ë‹¬</label>
    <label><input type="radio" name="pendant_mode" value="íƒœì–‘">íƒœì–‘</label>
    <input id="pendant_value" type="number" value="12" style="width:90px;"> %
    <span class="small" id="pendantHint">ë³„ â‰¤ 6, ë‹¬ â‰¤ 12, íƒœì–‘ â‰¤ 18</span>
  </div>

  <!-- Ver2 ì „ìš©: ì§€ì • ìŠ¤íƒ¯ ì„ íƒ -->
  <div class="row" id="pendant_stats_row" style="margin-top:8px; display:none;">
    <strong>Ver2 ìŠ¤íƒ¯ ì„ íƒ:</strong>
    <label><input type="checkbox" class="pendStat" value="HP" checked>HP</label>
    <label><input type="checkbox" class="pendStat" value="ATK" checked>ATK</label>
    <label><input type="checkbox" class="pendStat" value="DEF" checked>DEF</label>
  </div>

  <!-- Ver3 ì „ìš©: ìˆ˜ë™ ì…ë ¥ì¹¸ -->
  <div id="pendant_manual" style="margin-top:8px; display:none; align-items:center; gap:4px;">
  <strong>ìˆ˜ë™ ì…ë ¥:</strong>
  HP <input id="pend_manual_hp" type="number" value="0" style="width:55px; height:24px; font-size:13px; text-align:center;">%
  ATK <input id="pend_manual_atk" type="number" value="0" style="width:55px; height:24px; font-size:13px; text-align:center;">%
  DEF <input id="pend_manual_df" type="number" value="0" style="width:55px; height:24px; font-size:13px; text-align:center;">%
  </div>
</fieldset>

<!-- ì •ë ¹ / ë²„í”„ / ë””ë²„í”„ -->
<fieldset>
  <legend>ì •ë ¹ / ë²„í”„ / ë””ë²„í”„</legend>
  <div style="font-weight:bold; color:black; margin-bottom:6px;">(HP / ATK / DEF)</div>

  <div class="row-spirit"><strong>ì •ë ¹ + (í”Œì˜µ)</strong><input id="sf_hp" type="number" value="0"><input id="sf_atk" type="number" value="0"><input id="sf_df" type="number" value="0"></div>
  <div class="row-spirit"><strong>ì •ë ¹ % (í¼ì˜µ)</strong><input id="sp_hp" type="number" value="0"><input id="sp_atk" type="number" value="0"><input id="sp_df" type="number" value="0"><span class="small">(% ì…ë ¥)</span></div>
  <div class="row-spirit"><strong>ì •ë ¹ ë¶€ê°€ì˜µ</strong><input id="se_hp" type="number" value="0"><input id="se_atk" type="number" value="0"><input id="se_df" type="number" value="0"></div>
  <div class="row-spirit"><strong>ë²„í”„ (%)</strong><input id="bf_hp" type="number" value="0"><input id="bf_atk" type="number" value="0"><input id="bf_df" type="number" value="0"></div>
  <div class="row-spirit"><strong>ë””ë²„í”„ (%)</strong><input id="db_hp" type="number" value="0"><input id="db_atk" type="number" value="0"><input id="db_df" type="number" value="0"></div>
</fieldset>

  <!-- ê¸°íƒ€ -->
  <fieldset><legend>ê¸°íƒ€</legend><div class="row">Top N <input id="top_n" type="number" value="5"></div></fieldset>

  <div class="toolbar">
    <button class="btn primary" type="button" onclick="calc()">ê³„ì‚°í•˜ê¸°</button>
    <button class="btn" type="button" onclick="downloadTxt()">ì €ì¥í•˜ê¸° (.txt)</button>
  </div>

  <h3>ê²°ê³¼</h3>
  <div id="result"></div>

<script>
/* =========================
   ì¥ì‹ êµ¬ í…Œì´ë¸”
   ========================= */
const ACC_TABLE = [
  ["ë°”ë¿”(ê³µ/ë°©)",19,0,10,9],["ë°”ë¿”(ì²´/ë°©)",19,10,0,9],["ë°”ë¿”(ê³µ/ì²´)",19,9,10,0],
  ["ë¶ˆë¿”(ê³µ/ì²´)",19,6,13,0],["ë¶ˆë¿”(ê³µ/ë°©)",19,0,13,6],
  ["ë¬¼ë¿”(ì²´/ë°©)",19,13,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",19,13,6,0],
  ["ëŒ€ë¿”(ë°©/ê³µ)",19,0,6,13],["ëŒ€ë¿”(ë°©/ì²´)",19,6,0,13],
  ["ì—¬ë³´",19,0,0,19],["í™©ë³´",19,0,19,0],["ì•…ë³´",19,19,0,0],
  ["ë°”ë¿”(ê³µ/ë°©)",18,0,9,9],["ë°”ë¿”(ì²´/ë°©)",18,9,0,9],["ë°”ë¿”(ê³µ/ì²´)",18,9,9,0],
  ["ë¶ˆë¿”(ê³µ/ì²´)",18,6,12,0],["ë¶ˆë¿”(ê³µ/ë°©)",18,0,12,6],
  ["ë¬¼ë¿”(ì²´/ë°©)",18,12,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",18,12,6,0],
  ["ëŒ€ë¿”(ë°©/ê³µ)",18,0,6,12],["ëŒ€ë¿”(ë°©/ì²´)",18,6,0,12],
  ["ì—¬ë³´",18,0,0,18],["í™©ë³´",18,0,18,0],["ì•…ë³´",18,18,0,0],
  ["ë°”ë¿”(ê³µ/ë°©)",17,0,9,8],["ë°”ë¿”(ì²´/ë°©)",17,9,0,8],["ë°”ë¿”(ê³µ/ì²´)",17,9,8,0],
  ["ë¶ˆë¿”(ê³µ/ì²´)",17,6,11,0],["ë¶ˆë¿”(ê³µ/ë°©)",17,0,11,6],
  ["ë¬¼ë¿”(ì²´/ë°©)",17,11,0,6],["ë¬¼ë¿”(ì²´/ê³µ)",17,11,6,0],
  ["ëŒ€ë¿”(ë°©/ê³µ)",17,0,6,11],["ëŒ€ë¿”(ë°©/ì²´)",17,6,0,11],
  ["ì—¬ë³´",17,0,0,17],["í™©ë³´",17,0,17,0],["ì•…ë³´",17,17,0,0],
];

/* =========================
   ì¥ì‹ êµ¬ ë Œë”ë§
   ========================= */
let accCheckboxes = [];
const accListEl = document.getElementById('accList');

function renderAccessories() {
  accListEl.innerHTML = '';
  accCheckboxes = [];
  ACC_TABLE.forEach((r, i) => {
    const [n, l, h, a, d] = r;
    const id = 'acc_' + i;
    const line = document.createElement('div');
    line.innerHTML = `<label><input type="checkbox" id="${id}"> ${n} Lv${l} | HP+${h}% ATK+${a}% DEF+${d}%</label>`;
    accListEl.appendChild(line);
    accCheckboxes.push({ id, name: n, level: l, hp: h, atk: a, df: d });
  });
}
renderAccessories();

function selectNone() {
  accCheckboxes.forEach(o => document.getElementById(o.id).checked = false);
}
function toggleLevel(level) {
  const t = accCheckboxes.filter(o => o.level === level);
  const allOn = t.every(o => document.getElementById(o.id).checked);
  t.forEach(o => document.getElementById(o.id).checked = !allOn);
}
// =========================
// íœë˜íŠ¸ ë²„ì „ë³„ UI ì „í™˜
// =========================
document.querySelectorAll('input[name="pendant_ver"]').forEach(r => {
  r.addEventListener('change', () => {
    const v = document.querySelector('input[name="pendant_ver"]:checked').value;

    // Ver3ì¼ ë•Œ â†’ ìë™ì…ë ¥, Ver2ìŠ¤íƒ¯ì¹¸ ìˆ¨ê¸°ê³  ìˆ˜ë™ì…ë ¥ë§Œ í‘œì‹œ
    if (v === "v3") {
      document.getElementById("pendant_auto_row").style.display = "none";
      document.getElementById("pendant_stats_row").style.display = "none";
      document.getElementById("pendant_manual").style.display = "flex";
    } 
    // Ver2ì¼ ë•Œ â†’ ìë™ì…ë ¥ + ìŠ¤íƒ¯ì„ íƒ í‘œì‹œ, ìˆ˜ë™ì…ë ¥ ìˆ¨ê¹€
    else if (v === "v2") {
      document.getElementById("pendant_auto_row").style.display = "flex";
      document.getElementById("pendant_stats_row").style.display = "flex";
      document.getElementById("pendant_manual").style.display = "none";
    } 
    // Ver1ì¼ ë•Œ â†’ ìë™ì…ë ¥ë§Œ í‘œì‹œ, ë‚˜ë¨¸ì§€ ìˆ¨ê¹€
    else {
      document.getElementById("pendant_auto_row").style.display = "flex";
      document.getElementById("pendant_stats_row").style.display = "none";
      document.getElementById("pendant_manual").style.display = "none";
    }
  });
});

// í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ ìƒíƒœ ì„¸íŒ…
window.addEventListener("DOMContentLoaded", () => {
  const def = document.querySelector('input[name="pendant_ver"]:checked');
  if (def) def.dispatchEvent(new Event('change'));
});

/* =========================
   ê³„ì‚° ë¡œì§
   ========================= */
class Stats{constructor(hp,atk,df){this.hp=hp;this.atk=atk;this.df=df;}}
function eVal(s){return s.hp+4*s.atk+4*s.df;}
function bVal(s){return s.hp*s.atk*s.df;}

function calcPredict(base,gem,pot,acc,pend,spf,spp,spe,col,bf,db){
  const s1=new Stats(base.hp+gem.hp+pot.hp, base.atk+gem.atk+pot.atk, base.df+gem.df+pot.df);
  const s2=new Stats(Math.floor(s1.hp*(1+acc.hp)), Math.floor(s1.atk*(1+acc.atk)), Math.floor(s1.df*(1+acc.df)));
  const s3=new Stats(Math.floor(s2.hp*(1+spp.hp)+spf.hp*(1+spp.hp)),
                     Math.floor(s2.atk*(1+spp.atk)+spf.atk*(1+spp.atk)),
                     Math.floor(s2.df*(1+spp.df)+spf.df*(1+spp.df)));
  const s4=new Stats(s3.hp+spe.hp, s3.atk+spe.atk, s3.df+spe.df);
  const s5=new Stats(Math.floor(s4.hp*(1+pend.hp)), Math.floor(s4.atk*(1+pend.atk)), Math.floor(s4.df*(1+pend.df)));
  const s6=new Stats(s5.hp+col.hp, s5.atk+col.atk, s5.df+col.df);
  const f = new Stats(
    s6.hp + Math.floor(base.hp*bf.hp) - Math.floor(base.hp*db.hp),
    s6.atk + Math.floor(base.atk*bf.atk) - Math.floor(base.atk*db.atk),
    s6.df + Math.floor(base.df*bf.df) - Math.floor(base.df*db.df)
  );
  return [f, eVal(f), bVal(f)];
}

const dragon={
 "7.0":{ê³µê²©í˜•:new Stats(876,285,161),ë°©ì–´í˜•:new Stats(788,185,283),ì²´ë ¥í˜•:new Stats(1252,176,176),ê³µë°©í˜•:new Stats(720,242,243),ì²´ê³µí˜•:new Stats(1080,262,133),ì²´ë°©í˜•:new Stats(1080,133,262)},
 "8.0":{ê³µê²©í˜•:new Stats(876,305,161),ë°©ì–´í˜•:new Stats(788,185,303),ì²´ë ¥í˜•:new Stats(1332,176,176),ê³µë°©í˜•:new Stats(720,252,253),ì²´ê³µí˜•:new Stats(1120,272,133),ì²´ë°©í˜•:new Stats(1120,133,272)},
 "9.0":{ê³µê²©í˜•:new Stats(876,325,161),ë°©ì–´í˜•:new Stats(788,185,323),ì²´ë ¥í˜•:new Stats(1412,176,176),ê³µë°©í˜•:new Stats(720,262,263),ì²´ê³µí˜•:new Stats(1160,282,133),ì²´ë°©í˜•:new Stats(1160,133,282)}
};

function genPend(total, mode, selectedStats = ["HP","ATK","DEF"]) {
  const c = [];
  const M = 6;
  if (total <= 0) return [[[0,0,0]]];

  const useHP = selectedStats.includes("HP");
  const useATK = selectedStats.includes("ATK");
  const useDEF = selectedStats.includes("DEF");

  // ì„ íƒëœ ìŠ¤íƒ¯ ì¸ë±ìŠ¤ë§Œ ì‚¬ìš©
  const statIdx = [];
  if (useHP) statIdx.push(0);
  if (useATK) statIdx.push(1);
  if (useDEF) statIdx.push(2);

  if (mode === "ë³„") {
    const v = Math.min(total, M);
    const combos = statIdx.map(i => {
      const a = [0,0,0];
      a[i] = v;
      return [a];
    });
    return combos;
  }

  if (mode === "ë‹¬") {
    for (let x=1;x<=M;x++)
      for (let y=1;y<=M;y++)
        if (x+y===total)
          for (let i of statIdx)
            for (let j of statIdx) {
              const a=[0,0,0]; const b=[0,0,0];
              a[i]=x; b[j]=y;
              c.push([a,b]);
            }
    return c;
  }

  if (mode === "íƒœì–‘") {
    for (let x=1;x<=M;x++)
      for (let y=1;y<=M;y++)
        for (let z=1;z<=M;z++)
          if (x+y+z===total)
            for (let i of statIdx)
              for (let j of statIdx)
                for (let k of statIdx) {
                  const a=[0,0,0], b=[0,0,0], d=[0,0,0];
                  a[i]=x; b[j]=y; d[k]=z;
                  c.push([a,b,d]);
                }
    return c;
  }
  return [[[0,0,0]]];
}

function val(id){ return Number(document.getElementById(id).value||0); }

function calc(){
  const R=document.getElementById("result"); R.textContent="";
  const lvl=document.querySelector('input[name="level"]:checked').value;
  const T={}; document.querySelectorAll(".dtype").forEach(cb=>T[cb.value]=cb.checked);

  const gem={
    hp:Number(document.querySelector('input[name="gem_hp"]:checked').value),
    atk:Number(document.querySelector('input[name="gem_atk"]:checked').value),
    df:Number(document.querySelector('input[name="gem_df"]:checked').value)
  };

  const acc=[]; accCheckboxes.forEach(o=>{ if(document.getElementById(o.id).checked) acc.push(o); });
  if(!acc.length){ R.textContent="ì¥ì‹ êµ¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; return; }

  const pm = document.querySelector('input[name="pendant_mode"]:checked').value;
  const pv = Number(document.getElementById("pendant_value").value || 0);
  const pver = document.querySelector('input[name="pendant_ver"]:checked')?.value || "v1";
  const selectedStats = Array.from(document.querySelectorAll('.pendStat'))
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  const topn = Number(document.getElementById("top_n").value || 5);
  const ench = 21,
        pot = new Stats(24,6,6),
        col = new Stats(240,60,60);

  // ì…ë ¥ ìš”ì†Œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì½ê¸° (ì•”ë¬µ ì „ì—­ ì˜ì¡´ ì œê±°)
  const spf = new Stats(val('sf_hp'), val('sf_atk'), val('sf_df'));
  const spp = new Stats(val('sp_hp')/100, val('sp_atk')/100, val('sp_df')/100);
  const spe = new Stats(val('se_hp'), val('se_atk'), val('se_df'));
  const bf  = new Stats(val('bf_hp')/100, val('bf_atk')/100, val('bf_df')/100);
  const db  = new Stats(val('db_hp')/100, val('db_atk')/100, val('db_df')/100);

  const selT = Object.keys(T).filter(k => T[k]);
  if (!selT.length) {
    R.textContent = "ë“œë˜ê³¤ íƒ€ì…ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    return;
  }

// Ver3 ìˆ˜ë™ì…ë ¥ì€ ë³„/ë‹¬/íƒœì–‘ ì œí•œ ê²€ì‚¬ ìƒëµ
if (pver !== "v3") {
  const lim = {ë³„:6, ë‹¬:12, íƒœì–‘:18}[pm] || 0;
  if (pv > lim || pv <= 0) {
    R.textContent = "íœë˜íŠ¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
    return;
  }
}

// âœ… Ver3 ìˆ˜ë™ì…ë ¥ ëŒ€ì‘ ì¶”ê°€
let pendComb = [];
let slotStrV3 = ""; // 

if (pver === "v3") {
  const ph = Number(document.getElementById("pend_manual_hp")?.value || 0) / 100;
  const pa = Number(document.getElementById("pend_manual_atk")?.value || 0) / 100;
  const pd = Number(document.getElementById("pend_manual_df")?.value || 0) / 100;

  pendComb = [[[ph, pa, pd]]];

  // âœ… í‘œì‹œìš© ë¬¸ìì—´ì„ ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ ì•ˆì „í•˜ê²Œ ìƒì„±
  const fmt = v => Number.isFinite(v) ? (v * 100).toFixed(0) + "%" : "0%";
  slotStrV3 = `HP${fmt(ph)} ATK${fmt(pa)} DEF${fmt(pd)}`;
} else {
  // ê¸°ì¡´ Ver1, Ver2 ìë™ì¡°í•© ë¡œì§
  pendComb = genPend(
    pv,
    pm,
    pver === "v2" ? selectedStats : ["HP", "ATK", "DEF"]
  );

  if (!pendComb.length) {
    R.textContent = "íœë˜íŠ¸ ì¡°í•© ì˜¤ë¥˜";
    return;
  }
}

    const results=[];
  for (const a of acc) {
    const ah = a.hp / 100, aa = a.atk / 100, ad = a.df / 100;
    for (const t of selT) {
      const base = dragon[lvl][t];
      for (let h = 0; h <= 5; h++) {
        for (let at = 0; at <= 5 - h; at++) {
          const d = 5 - h - at;
          const gemTot = new Stats(gem.hp * h, gem.atk * at, gem.df * d);

          for (const enchDir of ["hp", "atk", "df"]) {
            const enchPct = new Stats(
              enchDir === "hp" ? ench / 100 : 0,
              enchDir === "atk" ? ench / 100 : 0,
              enchDir === "df" ? ench / 100 : 0
            );
            const accPct = new Stats(ah + enchPct.hp, aa + enchPct.atk, ad + enchPct.df);
            for (const pend of pendComb) {
              const ph = pend.reduce((s, v) => s + v[0], 0);
              const pa = pend.reduce((s, v) => s + v[1], 0);
              const pd = pend.reduce((s, v) => s + v[2], 0);
              const pendStat =
                pver === "v3"
                ? new Stats(ph, pa, pd)
                : new Stats(ph / 100, pa / 100, pd / 100);  // Ver1,2ëŠ” ê·¸ëŒ€ë¡œ

              const [fin, E, B] = calcPredict(base, gemTot, pot, accPct, pendStat, spf, spp, spe, col, bf, db);
              
              // âœ… í‘œì‹œ ë¬¸ìì—´
              const slotStr = (pver === "v3")
                ? slotStrV3                             // â† ë” ì´ìƒ pendë‚˜ pendStatë¡œ ë§Œë“¤ì§€ ì•ŠìŒ
                : pend.map(s =>
                  ["HP","ATK","DEF"]
                  .map((k, i) => s[i] > 0 ? `${k}${s[i]}` : "")
                  .filter(Boolean)
                  .join(" ")
                          ).join(" / ");

              const pendLabel = (pver === "v3") ? "ìˆ˜ë™ì…ë ¥" : pm;
              const enchLabel = { hp: "HP", atk: "ATK", df: "DEF" }[enchDir];

              const l1 = `${t} | ${a.name} Lv${a.level} | ì ¬: HP${h} ATK${at} DEF${d} | íœë˜íŠ¸: ${pendLabel} (${slotStr}) | ì¸ì²¸íŠ¸: ${enchLabel} +${ench}%\n`;
              const l2 = `HP=${fin.hp} | ATK=${fin.atk} | DEF=${fin.df} | E=${E.toFixed(0)} | B=${(B / 1e6).toFixed(3)}\n`;

              results.push({ B, display_line1: l1, display_line2: l2 });
            }
          }
        }
      }
    }
  }

  if (!results.length) {
    R.textContent = "ê²°ê³¼ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    return;
  }

  results.sort((a, b) => b.B - a.B);
  const out = results
    .slice(0, topn)
    .map((r, i) => `[${i + 1}ìœ„] ${r.display_line1}${r.display_line2}`)
    .join("\n");
  R.textContent = out;
}

/* =========================
   ì €ì¥ ê¸°ëŠ¥
   ========================= */
function downloadTxt(){
  const text=document.getElementById("result").textContent||"";
  if(!text.trim()) return;
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="dragon_result.txt";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
</div>

<!-- ìˆ˜ë™ ê³„ì‚°ê¸° -->
<div id="manualCalc" class="calc-container">
  <!-- ë„¤ ìˆ˜ë™ ê³„ì‚°ê¸° HTML ê·¸ëŒ€ë¡œ ì‚½ì… -->
  <!-- â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ -->
  <!-- (ì—¬ê¸°ì— ìœ„ì—ì„œ ì¤€ ìˆ˜ë™ ê³„ì‚°ê¸° ì „ì²´ ì½”ë“œ ë¶™ì—¬ë„£ê¸°) -->
  <!-- â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘ -->
</div>

<script>
const autoDiv=document.getElementById('autoCalc');
const manualDiv=document.getElementById('manualCalc');
const btnAuto=document.getElementById('btnAuto');
const btnManual=document.getElementById('btnManual');

function switchMode(mode){
  if(mode==='auto'){
    autoDiv.classList.add('active');
    manualDiv.classList.remove('active');
    btnAuto.classList.add('primary');
    btnManual.classList.remove('primary');
  }else{
    manualDiv.classList.add('active');
    autoDiv.classList.remove('active');
    btnManual.classList.add('primary');
    btnAuto.classList.remove('primary');
  }
}
btnAuto.onclick=()=>switchMode('auto');
btnManual.onclick=()=>switchMode('manual');
</script>
</body>
</html>
